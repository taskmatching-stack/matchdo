<!DOCTYPE html>
<html lang="zh-TW" data-theme="custom">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n-title="messages.title">我的對話 - MatchDO 合做</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/theme-custom.css" rel="stylesheet">
    <style>
        /* 整體佈局：由 JS 動態計算剩餘高度，確保輸入框永遠在最下方 */
        .messages-layout { display: flex; min-height: 300px; overflow: hidden; }
        .messages-side { width: 320px; min-width: 240px; border-right: 1px solid #dee2e6; display: flex; flex-direction: column; overflow: hidden; }
        .messages-side .tab-content { flex: 1; overflow-y: auto; }
        .messages-main { flex: 1; display: flex; flex-direction: column; min-width: 0; overflow: hidden; }
        .conv-item, .contact-item { padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid #eee; }
        .conv-item:hover, .contact-item:hover { background: #f8f9fa; }
        .conv-item.active, .contact-item.active { background: #e7f1ff; }
        .conv-item .last-msg { font-size: 0.85rem; color: #6c757d; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        /* noConversation 佔滿剩餘空間 */
        #noConversation { flex: 1; }
        /* 對話面板：flex column 充滿父容器高度，輸入框固定底部 */
        #conversationPanel { flex: 1; display: flex; flex-direction: column; min-height: 0; overflow: hidden; }
        .messages-panel { flex: 1; overflow-y: auto; padding: 1rem; min-height: 0; }
        .msg-bubble { max-width: 80%; width: fit-content; padding: 0.5rem 0.75rem; border-radius: 1rem; margin-bottom: 0.5rem; }
        .msg-bubble.mine { margin-left: auto; background: #0d6efd; color: #fff; }
        .msg-bubble.theirs { background: #e9ecef; }
        /* 純圖片訊息：移除厚底色，只留細邊框 */
        .msg-bubble.img-only { background: transparent !important; padding: 0 !important; border: 1px solid #cfe2ff; }
        .msg-bubble.img-only .msg-time { color: #6c757d !important; margin-top: 2px; display: block; text-align: right; font-size: .7rem; }
        .msg-bubble.img-only .btn-translate { color: #6c757d; }
        .msg-time { font-size: 0.75rem; color: #6c757d; }
        .messages-form { flex-shrink: 0; padding: 0.75rem; border-top: 1px solid #dee2e6; background: #fff; }
        .img-preview-bar { display: flex; gap: 8px; margin-bottom: 6px; align-items: flex-start; }
        .img-preview-item { position: relative; display: inline-block; }
        .img-preview-item img { width: 64px; height: 64px; border-radius: 8px; object-fit: cover; border: 1px solid #dee2e6; display: block; }
        .img-preview-item .remove-img { position: absolute; top: -8px; right: -8px; width: 20px; height: 20px; border-radius: 50%; background: #dc3545; border: none; color: #fff; font-size: 12px; line-height: 1; cursor: pointer; z-index: 5; display: flex; align-items: center; justify-content: center; }
        .msg-image { max-width: 220px; border-radius: 8px; display: block; cursor: pointer; }
        .btn-translate { font-size: .7rem; color: #6c757d; background: none; border: none; padding: 1px 4px; cursor: pointer; }
        .btn-translate:hover { color: #0d6efd; }
        .msg-translation { margin-top: 4px; padding: 4px 8px; background: rgba(0,0,0,.05); border-radius: 6px; font-size: .8rem; color: #555; border-left: 3px solid #0d6efd; }
        .msg-bubble.mine .msg-translation { border-left-color: rgba(255,255,255,.4); background: rgba(255,255,255,.12); color: rgba(255,255,255,.85); }
        @media (max-width: 768px) {
            .messages-layout { flex-direction: column; height: calc(100vh - 130px); }
            .messages-side { width: 100%; max-height: 180px; flex-shrink: 0; }
        }
    </style>
</head>
<body>
    <div id="site-header"></div>
    <div class="container-fluid page-title-bar">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="mb-0 text-dark"><i class="bi bi-chat-dots me-2"></i><span data-i18n="messages.title">我的對話</span></h3>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="/client/dashboard.html" data-i18n="matchedProjects.breadcrumbConsole">控制台</a></li>
                        <li class="breadcrumb-item active" data-i18n="messages.title">我的對話</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
    <div class="container-fluid py-2">
        <div class="messages-layout">
            <div class="messages-side">
                <ul class="nav nav-tabs nav-fill px-2 pt-2" role="tablist">
                    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-conversations" data-i18n="messages.tabConversations">最近對話</a></li>
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-contacts" data-i18n="messages.tabContacts">聯絡清單</a></li>
                </ul>
                <div class="tab-content">
                    <div id="tab-conversations" class="tab-pane show active">
                        <div id="conversationsList"></div>
                        <div id="conversationsEmpty" class="p-3 text-muted small text-center" style="display:none;" data-i18n="messages.emptyConversations">尚無對話</div>
                    </div>
                    <div id="tab-contacts" class="tab-pane">
                        <div id="contactsList"></div>
                        <div id="contactsEmpty" class="p-3 text-muted small text-center" style="display:none;" data-i18n="messages.emptyContacts">尚未儲存聯絡</div>
                    </div>
                </div>
            </div>
            <div class="messages-main">
                <div id="noConversation" class="d-flex align-items-center justify-content-center flex-grow-1 text-muted">
                    <div class="text-center"><i class="bi bi-chat-left-text" style="font-size:3rem;"></i><p class="mt-2" data-i18n="messages.selectConversation">從左側選擇對話或聯絡人</p></div>
                </div>
                <div id="conversationPanel" style="display: none;">
                    <div class="d-flex align-items-center border-bottom px-3 py-2">
                        <span id="conversationTitle" class="fw-bold"></span>
                        <div class="ms-auto">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnToggleContact" title=""><i class="bi bi-person-plus"></i></button>
                        </div>
                    </div>
                    <div class="messages-panel" id="messagesPanel"></div>
                    <div class="messages-form">
                        <div id="imgPreviewBar" class="img-preview-bar" style="display:none;"></div>
                        <div class="input-group">
                            <label class="btn btn-outline-secondary" style="cursor:pointer;" title="上傳圖片">
                                <i class="bi bi-image"></i>
                                <input type="file" id="imgFileInput" accept="image/*" style="display:none;">
                            </label>
                            <button type="button" class="btn btn-outline-secondary" id="btnAssetPicker" title="從數位資產庫選取" data-bs-toggle="modal" data-bs-target="#assetPickerModal">
                                <i class="bi bi-collection"></i>
                            </button>
                            <input type="text" class="form-control" id="messageInput" data-i18n-placeholder="messages.inputPlaceholder" placeholder="輸入訊息..." maxlength="2000">
                            <button class="btn btn-primary" type="button" id="btnSend" data-i18n="messages.send">送出</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/config/auth-config.js"></script>
    <script src="/js/auth-middleware.js"></script>
    <script src="/js/i18n.js"></script>
    <script src="/js/site-header.js"></script>
    <script>
        (function() {
            let token = null;
            let currentConversationId = null;
            let currentOtherUserId = null;
            let contactSet = new Set();

            async function getToken() {
                if (token) return token;
                try {
                    const s = await (window.AuthService && AuthService.getSession ? AuthService.getSession() : null);
                    token = s && s.access_token ? s.access_token : null;
                } catch (e) { token = null; }
                return token;
            }

            function headers() { return { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }; }

            async function loadConversations() {
                const res = await fetch('/api/direct-conversations', { headers: { 'Authorization': 'Bearer ' + token } });
                const data = await res.json();
                const list = (data.conversations || []);
                const el = document.getElementById('conversationsList');
                const empty = document.getElementById('conversationsEmpty');
                el.innerHTML = '';
                if (list.length === 0) { empty.style.display = 'block'; return; }
                empty.style.display = 'none';
                list.forEach(c => {
                    const name = (c.display && c.display.full_name) || c.other_user_id.slice(0, 8) + '…';
                    const last = c.last_message ? (c.last_message.body || '').substring(0, 40) : '';
                    const div = document.createElement('div');
                    div.className = 'conv-item' + (currentConversationId === c.id ? ' active' : '');
                    div.dataset.conversationId = c.id;
                    div.dataset.otherUserId = c.other_user_id;
                    div.dataset.displayName = name;
                    div.innerHTML = '<div class="fw-bold">' + escapeHtml(name) + '</div><div class="last-msg">' + escapeHtml(last) + '</div>';
                    div.addEventListener('click', () => selectConversation(c.id, c.other_user_id, name));
                    el.appendChild(div);
                });
            }

            async function loadContacts() {
                const res = await fetch('/api/contact-list', { headers: { 'Authorization': 'Bearer ' + token } });
                const data = await res.json();
                const list = (data.contacts || []);
                contactSet = new Set(list.map(c => c.saved_user_id));
                const el = document.getElementById('contactsList');
                const empty = document.getElementById('contactsEmpty');
                el.innerHTML = '';
                if (list.length === 0) { empty.style.display = 'block'; return; }
                empty.style.display = 'none';
                list.forEach(c => {
                    const name = (c.display && c.display.full_name) || (c.saved_user_id || '').slice(0, 8) + '…';
                    const div = document.createElement('div');
                    div.className = 'contact-item' + (currentOtherUserId === c.saved_user_id ? ' active' : '');
                    div.dataset.userId = c.saved_user_id;
                    div.innerHTML = '<div class="fw-bold">' + escapeHtml(name) + '</div>';
                    div.addEventListener('click', () => openOrSelectConversation(c.saved_user_id, name));
                    el.appendChild(div);
                });
                updateContactButton();
            }

            async function openOrSelectConversation(otherUserId, displayName, productId) {
                // 1. 建立/取得對話
                let convData = {};
                try {
                    const convRes = await fetch('/api/direct-conversations', {
                        method: 'POST',
                        headers: headers(),
                        body: JSON.stringify({ other_user_id: otherUserId })
                    });
                    if (!convRes.ok) {
                        const errBody = await convRes.json().catch(() => ({}));
                        console.error('建立對話失敗:', convRes.status, errBody);
                        alert('無法開啟對話：' + (errBody.error || convRes.status));
                        return;
                    }
                    convData = await convRes.json();
                } catch (e) { console.error('建立對話請求失敗:', e); alert('網路錯誤，請稍後再試'); return; }

                // 優先用 API 回傳的顯示名稱
                const resolvedName = displayName || convData.display_name || otherUserId.slice(0, 8) + '…';

                // 2. 加入聯絡清單
                try {
                    await fetch('/api/contact-list', {
                        method: 'POST',
                        headers: headers(),
                        body: JSON.stringify({ user_id: otherUserId })
                    });
                } catch (e) { console.warn('加入聯絡清單失敗:', e); }

                // 3. 重新載入清單並開啟對話
                await loadContacts();
                if (convData.conversation_id) {
                    selectConversation(convData.conversation_id, otherUserId, resolvedName);
                }
            }

            function selectConversation(conversationId, otherUserId, displayName) {
                currentConversationId = conversationId;
                currentOtherUserId = otherUserId;
                document.getElementById('noConversation').style.display = 'none';
                document.getElementById('conversationPanel').style.display = '';
                document.getElementById('conversationTitle').textContent = displayName || otherUserId.slice(0, 8) + '…';
                document.querySelectorAll('.conv-item, .contact-item').forEach(n => {
                    n.classList.toggle('active', (n.dataset.conversationId === conversationId) || (n.dataset.userId === otherUserId));
                });
                updateContactButton();
                loadMessages();
            }

            function t(k) { return (window.i18n && window.i18n.t) ? window.i18n.t(k) : k; }
            function updateContactButton() {
                const btn = document.getElementById('btnToggleContact');
                if (!currentOtherUserId) { btn.style.display = 'none'; return; }
                btn.style.display = 'inline-block';
                const inList = contactSet.has(currentOtherUserId);
                btn.title = inList ? t('messages.removeFromContacts') : t('messages.addToContacts');
                btn.innerHTML = inList ? '<i class="bi bi-person-dash"></i> ' + t('messages.removeFromContacts') : '<i class="bi bi-person-plus"></i> ' + t('messages.addToContacts');
                btn.onclick = () => toggleContact(inList);
            }

            function toggleContact(remove) {
                const url = remove ? '/api/contact-list/' + encodeURIComponent(currentOtherUserId) : '/api/contact-list';
                const opts = { method: remove ? 'DELETE' : 'POST', headers: headers() };
                if (!remove) opts.body = JSON.stringify({ user_id: currentOtherUserId });
                fetch(url, opts).then(r => { if (r.ok) loadContacts(); });
            }

            function loadMessages() {
                if (!currentConversationId) return;
                const panel = document.getElementById('messagesPanel');
                panel.innerHTML = '<div class="text-center py-3 text-muted">' + t('messages.loading') + '</div>';
                fetch('/api/direct-conversations/' + currentConversationId + '/messages', { headers: { 'Authorization': 'Bearer ' + token } })
                    .then(r => r.json())
                    .then(data => {
                        panel.innerHTML = '';
                        (data.messages || []).forEach(m => renderMessage(m));
                        panel.scrollTop = panel.scrollHeight;
                    });
            }

            async function sendMessage() {
                const input = document.getElementById('messageInput');
                const body = (input.value || '').trim();
                if (!body && !pendingImageBlob) return;
                if (!currentConversationId) return;
                const panel = document.getElementById('messagesPanel');

                if (body) {
                    input.value = '';
                    const data = await fetch('/api/direct-conversations/' + currentConversationId + '/messages', {
                        method: 'POST', headers: headers(), body: JSON.stringify({ body })
                    }).then(r => r.json());
                    if (data.message) renderMessage(Object.assign({}, data.message, { is_mine: true }));
                }

                if (pendingImageBlob) {
                    const fd = new FormData();
                    fd.append('image', pendingImageBlob, 'image.jpg');
                    clearImagePreview();
                    const data2 = await fetch('/api/direct-conversations/' + currentConversationId + '/messages/image', {
                        method: 'POST', headers: { 'Authorization': 'Bearer ' + token }, body: fd
                    }).then(r => r.json());
                    if (data2.message) renderMessage(Object.assign({}, data2.message, { is_mine: true }));
                }

                panel.scrollTop = panel.scrollHeight;
                loadConversations();
            }

            function escapeHtml(s) { const d = document.createElement('div'); d.textContent = s == null ? '' : s; return d.innerHTML; }

            // ── 圖片壓縮（Canvas，PNG/JPG 轉 JPEG 輸出）─────────────────
            let pendingImageBlob = null;
            function compressImage(file) {
                return new Promise(function(resolve, reject) {
                    var MAX_DIM = 2000, TARGET_KB = 1800;
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        var img = new Image();
                        img.onload = function() {
                            var w = img.width, h = img.height;
                            if (w > MAX_DIM || h > MAX_DIM) { var r = Math.min(MAX_DIM/w, MAX_DIM/h); w = Math.round(w*r); h = Math.round(h*r); }
                            var canvas = document.createElement('canvas');
                            canvas.width = w; canvas.height = h;
                            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                            var q = 0.88;
                            (function tryBlob() {
                                canvas.toBlob(function(blob) {
                                    if (!blob) return reject(new Error('壓縮失敗'));
                                    if (blob.size > TARGET_KB * 1024 && q > 0.45) { q -= 0.08; tryBlob(); }
                                    else resolve(blob);
                                }, 'image/jpeg', q);  // PNG 也轉成 JPEG 輸出
                            })();
                        };
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }
            window.clearImagePreview = function() {
                pendingImageBlob = null;
                var bar = document.getElementById('imgPreviewBar');
                bar.innerHTML = ''; bar.style.display = 'none';
                document.getElementById('imgFileInput').value = '';
            };

            // ── 訊息泡泡渲染（含圖片、翻譯按鈕）────────────────────────
            function renderMessage(m) {
                const panel = document.getElementById('messagesPanel');
                const div = document.createElement('div');
                var imgOnly = !!m.image_url && !m.body;
                div.className = 'msg-bubble ' + (m.is_mine ? 'mine' : 'theirs') + (imgOnly ? ' img-only' : '');
                let html = '';
                if (m.body) html += '<div>' + escapeHtml(m.body) + '</div>';
                if (m.image_url) html += '<img class="msg-image" src="' + escapeHtml(m.image_url) + '" alt="圖片">';
                html += '<div style="display:flex;align-items:center;gap:6px;margin-top:2px;">'
                    + '<span class="msg-time">' + (m.created_at ? new Date(m.created_at).toLocaleString('zh-TW') : '') + '</span>'
                    + (m.id ? '<button class="btn-translate" data-mid="' + escapeHtml(m.id) + '"><i class="bi bi-translate"></i> 翻譯(-1點)</button>' : '')
                    + '</div>';
                div.innerHTML = html;
                if (m.image_url) {
                    div.querySelector('.msg-image').addEventListener('click', function() { window.open(this.src, '_blank'); });
                }
                if (m.id) {
                    div.querySelector('.btn-translate').addEventListener('click', function() { doTranslate(m.id, div); });
                }
                panel.appendChild(div);
            }

            async function doTranslate(msgId, div) {
                const btn = div.querySelector('.btn-translate');
                if (btn) btn.disabled = true;
                try {
                    const res = await fetch('/api/direct-messages/' + msgId + '/translate', {
                        method: 'POST', headers: { 'Authorization': 'Bearer ' + token }
                    });
                    const data = await res.json();
                    if (!res.ok) { alert(data.error || '翻譯失敗'); return; }
                    let trDiv = div.querySelector('.msg-translation');
                    if (!trDiv) { trDiv = document.createElement('div'); trDiv.className = 'msg-translation'; div.appendChild(trDiv); }
                    trDiv.innerHTML = '<small style="opacity:.65">' + escapeHtml(data.target_lang || '') + '</small><div>' + escapeHtml(data.translated || '') + '</div>';
                    if (data.points_used) {
                        var toast = document.createElement('div');
                        toast.style.cssText = 'position:fixed;bottom:80px;right:20px;background:#333;color:#fff;padding:8px 14px;border-radius:8px;font-size:.82rem;z-index:9999;';
                        toast.textContent = '扣除 ' + data.points_used + ' 點，餘額 ' + data.new_balance + ' 點';
                        document.body.appendChild(toast);
                        setTimeout(function() { toast.remove(); }, 2500);
                    }
                } catch(e) { alert('翻譯失敗'); }
                finally { if (btn) btn.disabled = false; }
            }

            // ── 動態設定 messages-layout 高度，讓輸入框永遠貼在底部 ──
            function fixLayoutHeight() {
                var layout = document.querySelector('.messages-layout');
                if (!layout) return;
                var top = layout.getBoundingClientRect().top + window.scrollY;
                layout.style.height = Math.max(300, window.innerHeight - top) + 'px';
            }
            window.addEventListener('resize', fixLayoutHeight);
            // navbar 非同步渲染，等一下再算一次
            setTimeout(fixLayoutHeight, 100);
            setTimeout(fixLayoutHeight, 600);

            document.addEventListener('DOMContentLoaded', async function() {
                fixLayoutHeight();
                const whenReady = (window.i18n && window.i18n.ready) ? window.i18n.ready : Promise.resolve();
                whenReady.then(function() {
                    if (window.i18n && window.i18n.applyPage) window.i18n.applyPage();
                    var titleText = (window.i18n && window.i18n.t) ? window.i18n.t('messages.title') + ' - MatchDO' : '我的對話 - MatchDO';
                    var titleEl = document.querySelector('title');
                    if (titleEl) titleEl.textContent = titleText;
                    updateContactButton();
                });
                const ok = await AuthMiddleware.requireAuth();
                if (!ok) return;
                token = await getToken();
                if (!token) { window.location.href = '/login.html'; return; }
                await loadConversations();
                await loadContacts();
                const params = new URLSearchParams(window.location.search);
                const convId = params.get('conversation_id');
                const openUserId = params.get('open');
                const openProductId = params.get('product_id') || null;
                if (convId) {
                    const list = document.querySelectorAll('.conv-item[data-conversation-id="' + convId + '"]');
                    if (list.length) list[0].click();
                } else if (openUserId) {
                    await openOrSelectConversation(openUserId, '', openProductId);
                    history.replaceState({}, '', window.location.pathname);
                }
                document.getElementById('btnSend').addEventListener('click', sendMessage);
                document.getElementById('messageInput').addEventListener('keydown', function(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
                // 資產庫 Modal：分頁切換 + 點選傳送
                var _assetTab = 'products';
                async function loadAssetGrid(tab) {
                    if (!currentConversationId) {
                        document.getElementById('assetGrid').innerHTML = '<div class="col-12 text-center text-muted py-4">請先選擇一個對話</div>';
                        return;
                    }
                    _assetTab = tab;
                    var grid = document.getElementById('assetGrid');
                    grid.innerHTML = '<div class="col-12 text-center text-muted py-4"><div class="spinner-border spinner-border-sm me-1"></div>載入中…</div>';

                    var items = [];
                    try {
                        if (tab === 'products') {
                            var res = await fetch('/api/custom-products', { headers: { 'Authorization': 'Bearer ' + token } });
                            var data = await res.json();
                            items = (data.products || []).map(function(p) {
                                var url = (p.image_urls && p.image_urls[0]) || p.ai_generated_image_url || p.reference_image_url || '';
                                return { url: url, title: p.title || '未命名' };
                            }).filter(function(i) { return !!i.url; });
                        } else {
                            var res2 = await fetch('/api/me/favorites', { headers: { 'Authorization': 'Bearer ' + token } });
                            var data2 = await res2.json();
                            items = (data2.favorites || []).map(function(f) {
                                var item = f.item || {};
                                var url = item.image_url || item.cover_image_url || (item.image_urls && item.image_urls[0]) || '';
                                return { url: url, title: item.title || item.name || '已收藏' };
                            }).filter(function(i) { return !!i.url; });
                        }
                    } catch(e) {
                        grid.innerHTML = '<div class="col-12 text-center text-muted py-4">載入失敗</div>';
                        return;
                    }

                    if (!items.length) {
                        grid.innerHTML = '<div class="col-12 text-center text-muted py-4">' + (tab === 'products' ? '數位資產庫尚無作品' : '尚無收藏作品') + '</div>';
                        return;
                    }

                    grid.innerHTML = items.map(function(it) {
                        return '<div class="col-4 col-md-3">'
                            + '<div class="card h-100 asset-card" style="cursor:pointer;" data-url="' + escapeHtml(it.url) + '">'
                            + '<img src="' + escapeHtml(it.url) + '" class="card-img-top" style="height:90px;object-fit:cover;" onerror="this.closest(\'.asset-card\').style.display=\'none\'">'
                            + '<div class="card-body p-1"><small class="text-muted" style="font-size:.7rem;display:block;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;">' + escapeHtml(it.title) + '</small></div>'
                            + '</div></div>';
                    }).join('');

                    grid.querySelectorAll('.asset-card').forEach(function(card) {
                        card.addEventListener('click', async function() {
                            var imgUrl = this.dataset.url;
                            bootstrap.Modal.getInstance(document.getElementById('assetPickerModal')).hide();
                            var r = await fetch('/api/direct-conversations/' + currentConversationId + '/messages/asset-url', {
                                method: 'POST',
                                headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                                body: JSON.stringify({ image_url: imgUrl })
                            }).then(function(r) { return r.json(); });
                            if (r.message) { renderMessage(Object.assign({}, r.message, { is_mine: true })); document.getElementById('messagesPanel').scrollTop = 99999; loadConversations(); }
                        });
                    });
                }

                document.getElementById('assetPickerModal').addEventListener('show.bs.modal', function() {
                    document.querySelectorAll('#assetPickerTabs .nav-link').forEach(function(a) { a.classList.toggle('active', a.dataset.tab === _assetTab); });
                    loadAssetGrid(_assetTab);
                });
                document.getElementById('assetPickerTabs').addEventListener('click', function(e) {
                    e.preventDefault();
                    var a = e.target.closest('[data-tab]');
                    if (!a) return;
                    document.querySelectorAll('#assetPickerTabs .nav-link').forEach(function(l) { l.classList.remove('active'); });
                    a.classList.add('active');
                    loadAssetGrid(a.dataset.tab);
                });

                document.getElementById('imgFileInput').addEventListener('change', async function() {
                    var file = this.files[0];
                    if (!file) return;
                    try {
                        pendingImageBlob = await compressImage(file);
                        var url = URL.createObjectURL(pendingImageBlob);
                        var bar = document.getElementById('imgPreviewBar');
                        bar.style.display = 'flex';
                        bar.innerHTML = '<div class="img-preview-item"><img src="' + url + '"><button class="remove-img" onclick="clearImagePreview()">✕</button></div>';
                    } catch(e) { alert('圖片處理失敗'); }
                });
            });
        })();
    </script>
    <!-- 數位資產庫選取 Modal -->
    <div class="modal fade" id="assetPickerModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header pb-0">
                    <div class="w-100">
                        <h5 class="modal-title mb-2"><i class="bi bi-images me-2"></i>選取圖片傳送</h5>
                        <ul class="nav nav-tabs" id="assetPickerTabs">
                            <li class="nav-item"><a class="nav-link active" href="#" data-tab="products">我的作品</a></li>
                            <li class="nav-item"><a class="nav-link" href="#" data-tab="favorites">我的最愛</a></li>
                        </ul>
                    </div>
                    <button type="button" class="btn-close ms-2 align-self-start mt-1" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="assetGrid" class="row g-2">
                        <div class="col-12 text-center text-muted py-4"><div class="spinner-border spinner-border-sm me-1"></div>載入中…</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <small class="text-muted me-auto">點選圖片即可傳送</small>
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                </div>
            </div>
        </div>
    </div>

    <div id="site-footer"></div>
    <script src="/js/site-footer.js"></script>
</body>
</html>
