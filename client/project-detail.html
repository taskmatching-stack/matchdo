<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="utf-8">
    <title>專案詳情 - MatchDO 合做</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <!-- Favicon -->
    <link href="/img/favicon.ico" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&family=Space+Grotesk&display=swap" rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="/css/style.css" rel="stylesheet">
    <style>
        .section-label { font-size: 1rem; color: #333; }
        #projectItemsHeader { cursor: pointer; }
        #projectItemsHeader:hover { background-color: rgba(0,0,0,.02); }
    </style>

    <!-- Supabase Auth -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/config/auth-config.js"></script>
    <script src="/js/auth-middleware.js"></script>
    <script src="/js/site-header.js"></script>
</head>

<body>
    <!-- 共用前台導覽 -->
    <div id="site-header"></div>

    <!-- Page Header Start -->
    <div class="container-fluid page-title-bar">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="mb-0 text-dark">專案詳情</h3>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="/index.html">首頁</a></li>
                        <li class="breadcrumb-item"><a href="dashboard.html">控制台</a></li>
                        <li class="breadcrumb-item"><a href="my-projects.html">我的專案</a></li>
                        <li class="breadcrumb-item active">專案詳情</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
    <!-- Page Header End -->

    <!-- Project Detail Start -->
    <div class="container-xxl py-3">
        <div class="container">
            <!-- 載入中 -->
            <div id="loadingSection" class="text-center py-5">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
                <p class="mt-3 text-muted">載入專案資料中...</p>
            </div>

            <!-- 未選專案時：顯示專案選擇列表（帳號有多個專案時可直接選） -->
            <div id="projectPickerSection" class="d-none">
                <div class="card border-0 shadow-sm">
                    <div class="card-body py-4">
                        <h4 class="mb-3"><i class="fas fa-folder-open me-2 text-primary"></i>請選擇要查看的專案</h4>
                        <p class="text-muted mb-3">您尚未指定要查看的專案，請從下方選擇一個專案進入詳情與發包流程。</p>
                        <div id="projectPickerList" class="mb-3">
                            <p class="text-muted mb-0"><span class="spinner-border spinner-border-sm me-2"></span>載入專案列表中...</p>
                        </div>
                        <div class="d-flex gap-2 flex-wrap">
                            <a href="/client/my-projects.html" class="btn btn-outline-primary btn-sm">返回我的專案</a>
                            <a href="/index.html#ai-estimate" class="btn btn-success btn-sm"><i class="fas fa-plus me-1"></i>建立新專案</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 錯誤訊息（指定了 ID 但載入失敗時顯示） -->
            <div id="errorSection" class="d-none">
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-circle fa-4x text-warning mb-4"></i>
                    <h4 class="mb-3" id="errorMessage">載入失敗</h4>
                    <p class="text-muted mb-4" id="errorSubMessage">請確認專案 ID 是否正確，或從專案列表選擇要查看的專案</p>
                    <div class="d-flex gap-2 justify-content-center">
                        <a href="/client/my-projects.html" class="btn btn-primary">
                            <i class="fas fa-list me-2"></i>返回專案列表
                        </a>
                        <a href="/index.html#ai-estimate" class="btn btn-success">
                            <i class="fas fa-plus me-2"></i>建立新專案
                        </a>
                    </div>
                </div>
            </div>

            <!-- 專案內容 -->
            <div id="projectContent" class="d-none">
                <!-- 流程說明卡（對齊 browse-projects） -->
                <div class="card border-0 bg-light mb-4">
                    <div class="card-body py-3">
                        <h6 class="mb-2"><i class="fas fa-route me-2 text-primary"></i>流程說明（與承包商端對應）</h6>
                        <p class="small text-muted mb-0">
                            <strong>① 專案與工項</strong>（下方編輯專案與分包項目）→
                            <strong>② 預媒合</strong>：勾選工項後試算符合度 →
                            <strong>③ 送出媒合</strong>：勾選後送出 →
                            <strong>④ 已媒合專家</strong>：列表在頁面下方（可「移除此廠商」）。
                            <span class="ms-2"><a href="#" class="btn btn-outline-danger btn-sm py-0" onclick="deleteProject(); return false;"><i class="fas fa-trash me-1"></i>刪除專案</a></span>
                        </p>
                    </div>
                </div>

                <!-- ① 專案與工項 -->
                <p class="section-label mb-2"><strong>① 專案與工項</strong></p>
                <!-- 專案基本資訊 -->
                <div class="row mb-3">
                    <!-- 專案封面圖片 -->
                    <div class="col-lg-4 mb-3">
                        <div class="card border-0 shadow-sm">
                            <img id="projectCoverImage" src="" class="card-img-top" alt="專案封面" style="height: 300px; object-fit: cover;">
                            <div class="card-body">
                                <h6 class="mb-2">封面圖片</h6>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="uploadCoverImage()">
                                        <i class="fas fa-upload me-1"></i>上傳照片
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="generateAICoverImage()">
                                        <i class="fas fa-magic me-1"></i>AI 生成（20 點）
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="useDefaultImage()">
                                        <i class="fas fa-undo me-1"></i>使用預設圖
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-8">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body p-4">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h2 class="mb-0" id="projectTitle">專案名稱</h2>
                                    <span id="projectStatus" class="badge bg-primary">進行中</span>
                                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p class="text-muted mb-2">
                            <i class="fas fa-tag me-2"></i>
                            分類：<span id="projectCategory">居家</span>
                        </p>
                    </div>
                                    <div class="col-md-6">
                                        <p class="text-muted mb-2">
                                            <i class="fas fa-calendar me-2"></i>
                                            建立時間：<span id="projectCreated">2026-02-05</span>
                                        </p>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h5 class="mb-0">專案詳細描述</h5>
                                        <button class="btn btn-sm btn-outline-primary d-none" id="addCustomFieldBtn" onclick="addNewCustomField()">
                                            <i class="fas fa-plus me-1"></i>新增自訂欄位
                                        </button>
                                    </div>
                                    <div id="descriptionDisplayArea">
                                        <p id="projectDescription" class="text-muted" style="white-space: pre-line;">專案描述載入中...</p>
                                        <div id="requiredFieldsHint" class="small text-muted mt-2 d-none"></div>
                                    </div>
                                    <div id="descriptionEditArea" class="d-none">
                                        <textarea id="editDescriptionInput" class="form-control" rows="5"></textarea>
                                    </div>
                                </div>

                                <!-- 專案設計圖（上傳的圖片預覽與網址） -->
                                <div class="mb-3" id="designImagesCard">
                                    <h5 class="mb-2"><i class="fas fa-images me-2 text-info"></i>專案設計圖</h5>
                                    <div id="designImagesList" class="row g-2">
                                        <!-- 動態產生縮圖與網址 -->
                                    </div>
                                    <p class="small text-muted mt-2 mb-0" id="designImagesEmpty">尚無上傳的設計圖。從首頁「AI 辨識項目」上傳圖片建立專案後會顯示於此。</p>
                                </div>
                                
                                <!-- 動態欄位顯示/編輯區 -->
                                <div id="dynamicFieldsSection" class="mt-4 pt-3 border-top d-none">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5 class="mb-0"><i class="fas fa-info-circle me-2 text-info"></i>分類專屬需求</h5>
                                        <button class="btn btn-sm btn-outline-primary d-none" id="addCustomFieldBtn" onclick="addNewCustomField()">
                                            <i class="fas fa-plus me-1"></i>新增欄位
                                        </button>
                                    </div>
                                    <div id="dynamicFieldsContainer" class="row g-3">
                                        <!-- 動態產生 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- 快速操作（① 區塊內，btn-sm） -->
                <div class="card border-0 bg-light mb-3">
                    <div class="card-body py-2">
                        <div class="d-flex gap-2 flex-wrap align-items-center">
                            <button class="btn btn-sm btn-primary" onclick="editProject(this)">
                                <i class="fas fa-edit me-1"></i>編輯專案
                            </button>
                            <button class="btn btn-sm btn-info text-white" onclick="preMatchProject()">
                                <i class="fas fa-search-dollar me-1"></i>預媒合測試
                            </button>
                            <button class="btn btn-sm btn-success" onclick="manageItems()">
                                <i class="fas fa-tasks me-1"></i>管理分包項目
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="addNewItem()">
                                <i class="fas fa-plus me-1"></i>新增項目
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 分包項目表格（① 內，可收合） -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div id="projectItemsCard" class="card border-0 shadow-sm">
                            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center cursor-pointer" role="button" data-bs-toggle="collapse" data-bs-target="#collapseProjectItems" aria-expanded="true" aria-controls="collapseProjectItems" id="projectItemsHeader">
                                    <h5 class="mb-0 text-muted d-flex align-items-center">
                                    <i class="fas fa-chevron-down me-2" id="projectItemsCollapseIcon"></i>分包項目
                                </h5>
                                <button class="btn btn-primary btn-sm" type="button" onclick="event.stopPropagation(); addNewItem();">
                                    <i class="fas fa-plus me-1"></i>新增項目
                                </button>
                            </div>
                            <div id="collapseProjectItems" class="collapse show">
                            <div class="card-body p-4">
                                <div class="mb-3" id="batchActionsBar" style="display: none;">
                                    <div class="d-flex gap-2">
                                        <span class="badge bg-secondary align-self-center" id="selectedCount">已選 0 項</span>
                                        <button class="btn btn-primary btn-sm" onclick="createPackageFromSelected()">
                                            <i class="fas fa-box me-1"></i>組成統包組
                                        </button>
                                        <button class="btn btn-success btn-sm" onclick="publishSelectedItems(event)">
                                            <i class="fas fa-paper-plane me-1"></i>送出媒合
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm" onclick="clearSelection()">
                                            <i class="fas fa-times me-1"></i>取消選擇
                                        </button>
                                    </div>
                                </div>
                                <div id="categoryUnitsHint" class="alert alert-light border small mb-2 py-2 d-none">
                                    <i class="fas fa-ruler-combined me-1 text-info"></i>
                                    <span id="categoryUnitsHintText">載入該分類專家使用單位…</span>
                                </div>
                                <div id="projectItemsSection">
                                    <div class="table-responsive">
                                        <table class="table table-bordered" id="itemsTable">
                                            <thead>
                                                <tr>
                                                    <th width="50"><input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)"></th>
                                                    <th width="80">狀態</th>
                                                    <th>項目名稱</th>
                                                    <th>說明</th>
                                                    <th width="140" title="與專家報價標籤對齊才易媒合">標籤 (TAGS)</th>
                                                    <th width="90">數量</th>
                                                    <th width="80">單位</th>
                                                    <th width="120">總預算下限（元）</th>
                                                    <th width="120">總預算上限（元）</th>
                                                    <th width="100">操作</th>
                                                </tr>
                                            </thead>
                                            <tbody id="itemsTableBody">
                                                <tr>
                                                    <td colspan="10" class="text-center text-muted">載入中...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <p class="small text-muted mb-2"><i class="fas fa-tags me-1"></i>工項「標籤 (TAGS)」來自資料庫 <code>project_items.requirements.tags</code>，會與專家報價的標籤對齊媒合。可在此欄直接新增（輸入後 Enter 或逗號）／點 × 移除，會即時寫入資料庫。<br><i class="fas fa-edit me-1"></i>草稿與已發包項目皆可編輯，其他欄位修改後可按「儲存本頁修改」。</p>
                                    <div class="d-flex gap-2 mb-2 flex-wrap align-items-center">
                                        <button type="button" class="btn btn-secondary" id="addRow">新增項目</button>
                                        <button type="button" class="btn btn-success" id="saveAllTableBtn" onclick="saveAllTableEdits()" style="display: none;">
                                            <i class="fas fa-save me-1"></i>儲存本頁修改
                                        </button>
                                        <button type="button" class="btn btn-outline-primary" id="saveDescTableBtn" onclick="saveDescriptionItemsToProject()" style="display: none;">
                                            <i class="fas fa-cloud-upload-alt me-1"></i>暫存至專案描述
                                        </button>
                                        <span class="small text-muted" id="tableSaveHint">修改後請點「儲存本頁修改」或「暫存至專案描述」</span>
                                    </div>
                                </div>
                            </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ② 預媒合 -->
                <p class="section-label mb-2"><strong>② 預媒合</strong></p>
                <p class="small text-muted mb-2">請先在上方 ① 勾選工項，再點「預媒合測試」試算符合度。</p>
                <div id="preMatchResultArea" class="row mb-4" style="display: none;">
                    <div class="col-12">
                        <div class="card border-0 bg-light">
                            <div class="card-body">
                                <h6 class="mb-3">
                                    <i class="fas fa-chart-bar me-2 text-primary"></i>預算分析結果
                                    <small class="text-muted fw-normal ms-2">（依您填寫的項目預算區間，估算市場符合度）</small>
                                </h6>
                                <p class="small text-muted mb-3">
                                    <strong>說明：</strong>預算合理度＝報價落在您預算區間內的專家比例；符合專家數＝目前資料庫中符合條件的專家人數；預期回應＝預估會報價的專家數量。<br>
                                    <span class="text-primary small">您填的是「總價＋數量／單位」、專家填的是「單價」：系統以「專家單價×您的數量＝專家總價」再與您的總預算區間比對（專家有階梯定價時會依您的數量取對應單價）。</span> 點「查看詳細分析」可看媒合區間與市場價格說明。
                                </p>
                                <div class="row g-3 mb-3">
                                    <div class="col-md-4">
                                        <div class="text-center p-3 bg-white rounded">
                                            <div class="display-6 fw-bold mb-1" id="budgetStatusPercent">--</div>
                                            <small class="text-muted">預算合理度</small>
                                            <div class="progress mt-2" style="height: 8px;">
                                                <div id="budgetProgressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-center p-3 bg-white rounded">
                                            <div class="display-6 fw-bold mb-1 text-success" id="matchExpertCount">--</div>
                                            <small class="text-muted">符合專家數</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-center p-3 bg-white rounded">
                                            <div class="h4 fw-bold mb-1 text-info" id="estimatedResponses">--</div>
                                            <small class="text-muted">預期回應</small>
                                        </div>
                                    </div>
                                </div>
                                <div id="budgetStatusMessage" class="alert mb-0" role="alert">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <span id="budgetStatusText">正在分析...</span>
                                </div>
                                <div class="mt-3">
                                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#detailedAnalysis">
                                        <small class="text-muted"><i class="fas fa-chevron-down me-1"></i>查看詳細分析</small>
                                    </a>
                                    <div class="collapse mt-2" id="detailedAnalysis">
                                        <div class="card card-body bg-white small">
                                            <div id="detailedAnalysisContent"></div>
                                        </div>
                                    </div>
                                </div>
                                <!-- 同類專家常用 TAGS（預媒合後顯示，供發案方參考修正） -->
                                <div id="expertTagsSuggestionBlock" class="mt-3" style="display: none;">
                                    <hr class="my-3">
                                    <h6 class="mb-2"><i class="fas fa-tags me-2 text-secondary"></i>同類專家常用標籤 <small class="text-muted fw-normal">（點擊標籤可加入「已勾選工項」並自動儲存）</small></h6>
                                    <div id="expertTagsSuggestionList" class="d-flex flex-wrap gap-1 small"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ③ 送出媒合（說明） -->
                <p class="section-label mb-2"><strong>③ 送出媒合</strong></p>
                <div class="card border-0 bg-light mb-3">
                    <div class="card-body py-2">
                        <p class="small text-muted mb-2">勾選要發包的工項後，請在上方「① 專案與工項」的<strong>分包項目</strong>表格使用「送出媒合」按鈕。</p>
                        <button type="button" class="btn btn-sm btn-outline-success" onclick="scrollToSendMatch()">
                            <i class="fas fa-arrow-up me-1"></i>前往送出媒合
                        </button>
                    </div>
                </div>

                <!-- ④ 已媒合專家 -->
                <p class="section-label mb-2"><strong>④ 已媒合專家</strong></p>
                <div id="sectionMatchedExperts" class="card border-0 shadow-sm">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0"><i class="fas fa-user-tie me-2 text-success"></i>已媒合專家</h5>
                    </div>
                    <div class="card-body p-4">
                        <p class="small text-muted mb-3">送出媒合後，符合條件的專家會列於下方。點擊按鈕載入列表。</p>
                        <button type="button" class="btn btn-sm btn-outline-primary mb-3" id="btnLoadMatchedExperts" onclick="loadMatchedExpertsOnClick()">
                            <i class="fas fa-list me-1"></i>顯示已媒合專家
                        </button>
                        <div id="matchedExpertsList">
                            <p class="text-muted text-center py-4 small mb-0">
                                <i class="fas fa-hand-pointer me-1"></i>點擊上方「顯示已媒合專家」載入列表
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Project Detail End -->

    <!-- 編輯項目 Modal -->
    <div class="modal fade" id="editItemModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-edit me-2"></i>編輯項目
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editItemId">
                    
                    <div class="mb-3">
                        <label class="form-label">項目名稱 *</label>
                        <input type="text" class="form-control" id="editItemName" placeholder="例如：客廳木地板施工">
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">數量</label>
                                <input type="number" class="form-control" id="editItemQuantity" min="0" step="0.01" placeholder="例如：30">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">單位</label>
                                <div id="editItemUnitWrapper"></div>
                                <div class="form-text">單位僅供對照參考，不參與篩選</div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">總預算下限（元）</label>
                                <input type="number" class="form-control" id="editItemBudgetMin" min="0" placeholder="例：70000">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">總預算上限（元）</label>
                                <input type="number" class="form-control" id="editItemBudgetMax" min="0" placeholder="例：100000">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">說明</label>
                        <textarea class="form-control" id="editItemDescription" rows="3" placeholder="補充說明..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveItemEdit()">
                        <i class="fas fa-save me-1"></i>儲存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 與專家線上對話 Modal -->
    <div class="modal fade" id="contactExpertModal" tabindex="-1" aria-labelledby="contactExpertModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="contactExpertModalLabel">
                        <i class="fas fa-comments me-2"></i>與 <span id="contactExpertName">廠商</span> 的對話
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="關閉"></button>
                </div>
                <div class="modal-body p-0 d-flex flex-column" style="min-height: 320px;">
                    <div id="contactExpertMessages" class="p-3 flex-grow-1 overflow-auto" style="min-height: 260px; max-height: 400px;">
                        <p class="text-muted text-center py-4" id="contactExpertMessagesEmpty">載入對話中...</p>
                    </div>
                    <div class="border-top p-3 bg-light">
                        <div class="input-group">
                            <textarea class="form-control" id="contactExpertInput" rows="2" placeholder="輸入訊息（Enter 送出、Shift+Enter 換行）..." maxlength="2000" onkeydown="if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendExpertMessage(); }"></textarea>
                            <button type="button" class="btn btn-primary" id="contactExpertSendBtn" onclick="sendExpertMessage()">
                                <i class="fas fa-paper-plane me-1"></i>送出
                            </button>
                        </div>
                        <small class="text-muted">站內訊息，雙方皆可於本專案對話中查看</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Back to Top -->
    <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="bi bi-arrow-up"></i></a>

    <!-- AI 生成封面圖片 Modal -->
    <div class="modal fade" id="aiGenerateModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-magic me-2"></i>AI 生成專案封面圖片
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- 說明 -->
                    <div class="alert alert-info mb-4">
                        <h6 class="alert-heading">
                            <i class="fas fa-info-circle me-2"></i>關於 AI 生成封面圖
                        </h6>
                        <p class="mb-0">
                            AI 將根據您的專案描述生成一張專業的封面圖片。
                            您可以選擇是否避開機密內容，以保護商業機密。
                        </p>
                    </div>

                    <!-- 專案內容預覽 -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-file-alt me-2"></i>專案內容預覽
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label text-muted">專案名稱</label>
                                <p class="mb-0" id="aiModalTitle">-</p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label text-muted">分類</label>
                                <p class="mb-0" id="aiModalCategory">-</p>
                            </div>
                            <div class="mb-0">
                                <label class="form-label text-muted">專案描述</label>
                                <p class="mb-0" id="aiModalDescription" style="max-height: 150px; overflow-y: auto;">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- 專案圖片預覽 -->
                    <div class="card mb-3" id="aiModalImagesCard">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-images me-2"></i>專案圖片（<span id="imageCount">0</span> 張）
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="aiModalImages" class="row g-2">
                                <!-- 動態生成圖片縮圖 -->
                            </div>
                        </div>
                    </div>

                    <!-- 機密內容設定 -->
                    <div class="card mb-3 border-warning">
                        <div class="card-header bg-warning bg-opacity-10">
                            <h6 class="mb-0">
                                <i class="fas fa-shield-alt me-2"></i>機密內容保護設定
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="avoidConfidential" checked>
                                <label class="form-check-label" for="avoidConfidential">
                                    <strong>避開機密內容生成</strong>
                                    <small class="d-block text-muted mt-1">
                                        AI 將只使用分類、風格等基本資訊生成通用示意圖，不會參考您的具體需求描述和圖片內容
                                    </small>
                                </label>
                            </div>
                            
                            <div id="confidentialWarning" class="alert alert-warning mb-0 d-none">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>注意：</strong>取消勾選後，AI 將參考您的完整專案描述和圖片內容生成封面圖。
                                請確保您願意讓 AI 分析這些內容。
                            </div>
                        </div>
                    </div>

                    <!-- AI 生成提示詞預覽 -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-robot me-2"></i>AI 生成參考資訊
                            </h6>
                        </div>
                        <div class="card-body">
                            <textarea id="aiPromptPreview" class="form-control" rows="4" readonly 
                                      style="font-size: 0.9rem; background-color: #f8f9fa;"></textarea>
                            <small class="text-muted d-block mt-2">
                                這是 AI 將會使用的資訊摘要。您可以檢查後再決定是否生成。
                            </small>
                        </div>
                    </div>

                    <!-- 點數消耗提示 -->
                    <div class="alert alert-success mb-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-coins me-2"></i>
                                <strong>消耗點數：</strong>20 點
                            </div>
                            <div>
                                <i class="fas fa-wallet me-2"></i>
                                <strong>目前餘額：</strong><span id="currentCredits">載入中...</span> 點
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>取消
                    </button>
                    <button type="button" class="btn btn-primary" onclick="confirmAIGeneration()" id="confirmAIBtn">
                        <i class="fas fa-magic me-2"></i>確認生成（20 點）
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/lib/wow/wow.min.js"></script>
    <script src="/lib/easing/easing.min.js"></script>
    <script src="/lib/waypoints/waypoints.min.js"></script>
    <script src="/lib/owlcarousel/owl.carousel.min.js"></script>

    <!-- Template Javascript -->
    <script src="/js/main.js"></script>
    <script src="/js/site-header.js"></script>
    
    <!-- Category Default Images -->
    <script src="/config/category-default-images.js"></script>

    <!-- Project Detail Script -->
    <script>
        let currentUser = null;
        let projectId = null;
        let projectData = null;
        function escapeHtml(s) {
            if (s == null) return '';
            const t = String(s);
            return t.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }
        let aiGenerateModal = null;
        let allProjectItems = []; // 存儲所有項目資料供編輯使用
        let currentDynamicData = {}; // 存儲目前專案的動態欄位數據
        let isEditing = false; // 新增：編輯狀態旗標

        // 載入動態欄位配置與數據
        async function loadDynamicFields() {
            if (!projectData || !projectData.category) return;
            
            const container = document.getElementById('dynamicFieldsContainer');
            const section = document.getElementById('dynamicFieldsSection');
            
            try {
                // 1. 取得主分類的 key
                let categoryKey = projectData.category;
                
                // 如果 category 是中文名稱，轉換為 key
                const categoryNameToKey = {
                    '居家': 'home',
                    '活動': 'event',
                    '學習': 'learn',
                    '運動': 'health',
                    '美業': 'beauty',
                    '商業': 'business',
                    '其他': 'other'
                };
                
                // 如果是中文名稱，轉換；如果已經是 key，保持不變
                if (categoryNameToKey[categoryKey]) {
                    categoryKey = categoryNameToKey[categoryKey];
                }
                
                console.log('📂 專案分類:', projectData.category, '→ key:', categoryKey);

                // 2. 從新 API 讀取子分類的 form_config
                const response = await fetch(`/api/subcategories?category_key=${categoryKey}`);
                if (!response.ok) {
                    console.error('API 錯誤:', response.status);
                    return;
                }
                
                const apiData = await response.json();
                console.log('✅ 載入子分類配置:', apiData);
                
                // 轉換成 sub_configs 格式
                const subConfigs = {};
                if (apiData.success && Array.isArray(apiData.subcategories)) {
                    apiData.subcategories.forEach(sub => {
                        subConfigs[sub.name] = Array.isArray(sub.form_config) ? sub.form_config : [];
                    });
                }
                
                console.log('📋 子分類配置:', subConfigs);
                
                // 2. 取得目前專案儲存的數據 (從 description JSON 讀取)
                let savedFields = {};
                if (projectData.description) {
                    try {
                        const desc = JSON.parse(projectData.description);
                        savedFields = desc.dynamic_fields || {};
                    } catch(e) {
                        console.warn('無法解析 description JSON');
                    }
                }
                currentDynamicData = savedFields;
                console.log('💾 已儲存的欄位數據:', savedFields);

                // 3. 取得專案的子分類
                let subcats = [];
                
                // 優先從 subcategory 欄位讀取
                if (projectData.subcategory && Array.isArray(projectData.subcategory)) {
                    subcats = projectData.subcategory;
                } else if (projectData.description) {
                    // 降級從 description JSON 讀取
                    try {
                        const descJson = JSON.parse(projectData.description);
                        if (descJson.subcategory && Array.isArray(descJson.subcategory)) {
                            subcats = descJson.subcategory;
                        }
                    } catch(e) {}
                }

                console.log('📌 專案子分類:', subcats);
                
                if (subcats.length === 0) {
                    console.warn('此專案未選擇子分類');
                    return;
                }

                // 4. 必填欄位說明（顯示在專案詳細描述區）
                const requiredLabels = [];
                const allFieldLabels = [];
                subcats.forEach(sub => {
                    (subConfigs[sub] || []).forEach(f => {
                        if (f.label) allFieldLabels.push(f.label);
                        if (f.required && f.label) requiredLabels.push(f.label);
                    });
                });
                const hintEl = document.getElementById('requiredFieldsHint');
                if (hintEl) {
                    if (allFieldLabels.length > 0) {
                        hintEl.classList.remove('d-none');
                        const requiredText = requiredLabels.length > 0
                            ? '本專案必填欄位：' + [...new Set(requiredLabels)].join('、')
                            : '本專案可填寫欄位：' + [...new Set(allFieldLabels)].join('、');
                        hintEl.innerHTML = '<i class="fas fa-info-circle me-1"></i>' + requiredText + '（請在下方「分類專屬需求」填寫）';
                    } else {
                        hintEl.classList.add('d-none');
                    }
                }

                // 5. 渲染欄位
                let html = '';
                let hasFields = false;

                subcats.forEach(sub => {
                    const fields = subConfigs[sub] || [];
                    console.log(`📝 渲染子分類「${sub}」的欄位:`, fields);
                    
                    if (fields.length > 0) {
                        hasFields = true;
                        
                        // 添加子分類標題
                        html += `<div class="col-12 mt-3"><h6 class="text-primary border-bottom pb-2">${sub}</h6></div>`;
                        
                        fields.forEach(f => {
                            const fieldName = f.name || (f.label || '').replace(/\s+/g, '_');
                            const val = (savedFields[sub] && savedFields[sub][f.label]) || '';
                            const fieldUnit = f.unit ? ` (${f.unit})` : '';
                            const requiredBadge = f.required ? ' <span class="text-danger">*</span>' : '';
                            const displayVal = val || '<span class="text-muted">未填寫</span>';
                            
                            let editFieldHtml = '';
                            if (f.type === 'select') {
                                const optionsHtml = '<option value="">請選擇</option>' + (f.options || []).map(opt => 
                                    `<option value="${opt}" ${opt === val ? 'selected' : ''}>${opt}</option>`
                                ).join('');
                                editFieldHtml = `<select class="form-select form-select-sm detail-dynamic-field" data-sub="${sub}" data-label="${f.label}">${optionsHtml}</select>`;
                            } else if (f.type === 'textarea') {
                                editFieldHtml = `<textarea class="form-control form-control-sm detail-dynamic-field" rows="3" data-sub="${sub}" data-label="${f.label}" placeholder="${f.placeholder || ''}">${val}</textarea>`;
                            } else if (f.type === 'number') {
                                editFieldHtml = `<input type="number" class="form-control form-control-sm detail-dynamic-field" 
                                    data-sub="${sub}" data-label="${f.label}" value="${val}" placeholder="${f.placeholder || ''}" step="0.01">`;
                            } else {
                                editFieldHtml = `<input type="text" class="form-control form-control-sm detail-dynamic-field" 
                                    data-sub="${sub}" data-label="${f.label}" value="${val}" placeholder="${f.placeholder || ''}">`;
                            }

                            html += `
                                <div class="col-md-6 mb-3">
                                    <label class="form-label small fw-bold">${f.label}${fieldUnit}${requiredBadge}</label>
                                    <div class="field-value-area" id="val-display-${sub}-${fieldName}">
                                        <div class="form-control-plaintext border-bottom pb-1">${displayVal}</div>
                                    </div>
                                    <div class="field-edit-area d-none" id="val-edit-${sub}-${fieldName}">
                                        ${editFieldHtml}
                                    </div>
                                </div>
                            `;
                        });
                    }
                });

                if (hasFields) {
                    container.innerHTML = html;
                    section.classList.remove('d-none');
                    console.log('✅ 動態欄位已渲染');
                } else {
                    console.warn('⚠️  沒有可顯示的動態欄位');
                }

            } catch (err) {
                console.error('載入動態欄位失敗:', err);
            }
        }

        // 從 URL 取得專案 ID（支援 ?id= / ?project=，以及 hash #id= / #project=）
        function getProjectIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            let id = params.get('id') || params.get('project') || null;
            if (!id && window.location.hash) {
                const hash = window.location.hash.replace(/^#/, '');
                const hashParams = new URLSearchParams(hash);
                id = hashParams.get('id') || hashParams.get('project') || null;
            }
            return id || null;
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // 1. 檢查登入與 role=client（發案者）
                const ok = await AuthMiddleware.requireAuth();
                if (!ok) return;
                currentUser = await AuthService.getCurrentUser();
                
                projectId = getProjectIdFromUrl();
                if (!projectId) {
                    showProjectPicker();
                    await loadProjectPickerList();
                    return;
                }

                // 2. 循序載入，確保 projectData 存在
                await loadProjectData();
                
                if (projectData) {
                    // ④ 已媒合專家改為按鈕觸發載入，不在此自動載入
                    await Promise.all([
                        loadDynamicFields(),
                        loadProjectItems()
                    ]);
                }

                console.log('=== Project Detail 初始化完成 ===');
            } catch (error) {
                console.error('💥 初始化失敗:', error);
                showError(error.message);
            }
        });

        // 載入專案資料
        async function loadProjectData() {
            try {
                const { data, error } = await AuthService.supabase
                    .from('projects')
                    .select('*')
                    .eq('id', projectId)
                    .eq('owner_id', currentUser.id)
                    .single();

                if (error) throw error;
                if (!data) throw new Error('專案不存在或無權限查看');

                projectData = data;
                await loadUnitOptionsForCategory(data.category);

                // 顯示專案資訊
                document.getElementById('projectTitle').textContent = data.title || '未命名專案';
                document.getElementById('projectCreated').textContent = new Date(data.created_at).toLocaleDateString('zh-TW');
                
                // 顯示分類與子分類
                let categoryDisplay = data.category || '未分類';
                
                // 如果 category 是 key (例如 'home')，轉換為中文名稱
                const categoryMap = {
                    'home': '居家',
                    'event': '活動',
                    'learn': '學習',
                    'health': '運動',
                    'beauty': '美業',
                    'business': '商業',
                    'other': '其他'
                };
                if (categoryMap[categoryDisplay]) {
                    categoryDisplay = categoryMap[categoryDisplay];
                }
                
                let subcats = [];
                // 優先從 subcategory 欄位讀取
                if (data.subcategory && Array.isArray(data.subcategory)) {
                    subcats = data.subcategory;
                } else if (data.description) {
                    // 降級從 description 讀取
                    try {
                        const descJson = JSON.parse(data.description);
                        if (descJson.subcategory && Array.isArray(descJson.subcategory)) {
                            subcats = descJson.subcategory;
                        }
                    } catch(e) {}
                }
                
                if (subcats.length > 0) {
                    categoryDisplay += ` > ${subcats.join(', ')}`;
                }
                document.getElementById('projectCategory').textContent = categoryDisplay;
                // 解析 description
                let descText = '無描述';
                if (data.description) {
                    try {
                        const descJson = JSON.parse(data.description);
                        // 如果是我們系統產生的 JSON，嘗試提取有意義的資訊
                        if (descJson.user_description) {
                            descText = descJson.user_description; // 優先顯示使用者輸入的描述
                        } else if (descJson.prompt) {
                            // 判斷這是否為原始提示詞，如果是，則顯示友善的預設文字
                            if (descJson.prompt.includes('你是專業')) {
                                descText = 'AI 已根據您的需求完成初步估價分析。請檢視下方「分包項目管理」區塊，您可以自由增刪項目、調整數量，或將項目組合成統包發包。確認無誤後，請點擊「發佈專案」以開始媒合專家。';
                            } else {
                                descText = descJson.prompt;
                            }
                        } else if (typeof descJson === 'string') {
                            descText = descJson;
                        }
                    } catch (e) {
                        descText = data.description; // 非 JSON，直接顯示
                    }
                }
                
                document.getElementById('projectDescription').innerText = descText;

                // 顯示專案設計圖（description.files）預覽與網址
                renderDesignImages(data);

                // 顯示封面圖片（轉為絕對網址以確保可顯示）
                const coverImage = toAbsoluteUrl(getProjectCoverImage(data));
                document.getElementById('projectCoverImage').src = coverImage;
                
                // 狀態標籤
                const statusBadge = document.getElementById('projectStatus');
                const statusMap = {
                    'draft': { text: '編輯中', class: 'bg-info' },
                    'analyzing': { text: '編輯中', class: 'bg-info' },
                    'editing': { text: '編輯中', class: 'bg-info' },
                    'open': { text: '已發佈', class: 'bg-primary' },
                    'in_progress': { text: '施工中', class: 'bg-warning' },
                    'completed': { text: '已完成', class: 'bg-success' },
                    'cancelled': { text: '已取消', class: 'bg-secondary' }
                };
                const status = statusMap[data.status] || { text: '未知', class: 'bg-secondary' };
                statusBadge.textContent = status.text;
                statusBadge.className = `badge ${status.class}`;

                // 顯示內容區
                document.getElementById('loadingSection').classList.add('d-none');
                document.getElementById('projectPickerSection').classList.add('d-none');
                document.getElementById('projectContent').classList.remove('d-none');
                
            } catch (error) {
                console.error('❌ 載入專案失敗:', error);
                document.getElementById('loadingSection').classList.add('d-none');
                document.getElementById('projectPickerSection').classList.add('d-none');
                document.getElementById('errorSection').classList.remove('d-none');
                document.getElementById('errorMessage').textContent = error.message;
            }
        }

        // 載入專案工項：優先 project_items 表；若為空則顯示「我的專案」存在 description 裡的項目，並可同步為分包項目後發包
        async function loadProjectItems() {
            if (!projectId) return;
            try {
                const { data: items, error } = await AuthService.supabase
                    .from('project_items')
                    .select('id, item_name, item_description, category_name, subcategory, quantity, unit, budget_min, budget_max, requirements, status')
                    .eq('project_id', projectId)
                    .order('created_at', { ascending: true });

                if (error) throw error;
                allProjectItems = items || [];

                if (allProjectItems.length > 0) {
                    // 標籤以資料庫 project_items.requirements.tags 為準；若為空則用「我的專案」description 內同項目的 tags 補齊（僅顯示用，儲存仍寫入 DB）
                    let descItems = [];
                    if (projectData && projectData.description) {
                        try {
                            const descJson = JSON.parse(projectData.description);
                            if (descJson.items && Array.isArray(descJson.items)) descItems = descJson.items;
                        } catch (e) {}
                    }
                    const norm = (s) => (s || '').toString().trim();
                    const itemsToRender = allProjectItems.map((item) => {
                        const existingTags = item.requirements && Array.isArray(item.requirements.tags) ? item.requirements.tags : [];
                        const itemName = norm(item.item_name);
                        const itemDesc = norm(item.item_description || item.spec);
                        const descItem = descItems.find(d => norm(d.item_name) === itemName && norm(d.spec || d.item_description) === itemDesc);
                        const descTags = descItem && Array.isArray(descItem.tags) ? descItem.tags : [];
                        const tags = existingTags.length ? existingTags : descTags;
                        return { ...item, requirements: { ...(item.requirements || {}), tags } };
                    });
                    renderProjectItemsTable(itemsToRender, true);
                    hideSyncBanner();
                    const saveAllBtn = document.getElementById('saveAllTableBtn');
                    const saveDescBtn = document.getElementById('saveDescTableBtn');
                    if (saveAllBtn) saveAllBtn.style.display = 'inline-block';
                    if (saveDescBtn) saveDescBtn.style.display = 'none';
                    return;
                }

                // project_items 為空：嘗試從專案描述（我的專案編輯頁存的 items）顯示
                let descItems = [];
                if (projectData && projectData.description) {
                    try {
                        const descJson = JSON.parse(projectData.description);
                        if (descJson.items && Array.isArray(descJson.items)) descItems = descJson.items;
                    } catch (e) {}
                }

                if (descItems.length > 0) {
                    renderDescriptionItemsWithSync(descItems);
                    const saveAllBtn = document.getElementById('saveAllTableBtn');
                    const saveDescBtn = document.getElementById('saveDescTableBtn');
                    if (saveAllBtn) saveAllBtn.style.display = 'none';
                    if (saveDescBtn) saveDescBtn.style.display = 'inline-block';
                    return;
                }

                document.getElementById('itemsTableBody').innerHTML = `
                    <tr><td colspan="10" class="text-center text-muted">尚無項目。請在「我的專案」編輯頁新增項目後回到此頁，或點「新增項目」在此填寫數量、單位與總預算</td></tr>
                `;
                hideSyncBanner();
                const saveAllBtn = document.getElementById('saveAllTableBtn');
                const saveDescBtn = document.getElementById('saveDescTableBtn');
                if (saveAllBtn) saveAllBtn.style.display = 'none';
                if (saveDescBtn) saveDescBtn.style.display = 'none';
            } catch (error) {
                console.error('載入工項失敗:', error);
                document.getElementById('itemsTableBody').innerHTML = `<tr><td colspan="10" class="text-center text-danger">載入失敗</td></tr>`;
                hideSyncBanner();
            }
        }

        function renderProjectItemsTable(items, fromDb) {
            if (!fromDb) return;
            const statusText = (s) => (s === 'published' ? '已發包' : s === 'draft' ? '草稿' : (s || '草稿'));
            const statusClass = (s) => (s === 'published' ? 'bg-primary' : 'bg-secondary');
            // 草稿與已發包皆可編輯，不對已發包欄位加 readonly/disabled
            document.getElementById('itemsTableBody').innerHTML = items.map(item => `
                <tr data-item-id="${item.id}" data-status="${attrEscape(item.status || 'draft')}">
                    <td class="text-center"><input type="checkbox" class="item-checkbox" value="${item.id}" onchange="updateSelection()" title="草稿與已發包皆可勾選預媒合"></td>
                    <td class="text-center"><span class="badge ${statusClass(item.status)}">${statusText(item.status)}</span></td>
                    <td><input type="text" class="form-control form-control-sm" value="${attrEscape(item.item_name || '')}" data-item-id="${item.id}" data-field="item_name" onchange="saveItemCell(this)"></td>
                    <td><input type="text" class="form-control form-control-sm" value="${attrEscape(item.item_description || item.spec || '')}" data-item-id="${item.id}" data-field="item_description" onchange="saveItemCell(this)"></td>
                    <td class="small item-tags-cell">
                        <div class="item-tags-container d-flex flex-wrap align-items-center gap-1" data-item-id="${item.id}">
                            ${(item.requirements && Array.isArray(item.requirements.tags) ? item.requirements.tags : []).map(t => `
                                <span class="badge bg-light text-dark border tag-chip" data-tag="${attrEscape(t)}">${attrEscape(t)} <button type="button" class="border-0 bg-transparent p-0 ms-1 text-muted" style="font-size:0.75em;line-height:1" aria-label="移除" onclick="removeItemTag('${item.id}', this)">&times;</button></span>
                            `).join('')}
                            <input type="text" class="form-control form-control-sm border-0 p-0 item-tag-input" style="min-width:4rem;max-width:7rem" placeholder="新增" data-item-id="${item.id}" onkeydown="onItemTagInputKeydown(event, this)" onblur="addItemTagFromInput(this)">
                        </div>
                    </td>
                    <td><input type="number" class="form-control form-control-sm" min="0" step="0.01" value="${item.quantity != null ? item.quantity : ''}" data-item-id="${item.id}" data-field="quantity" onchange="saveItemCell(this)"></td>
                    <td>${unitOptions.length > 0 ? `<select class="form-select form-select-sm" data-item-id="${item.id}" data-field="unit" onchange="saveItemCell(this)">${unitSelectOptions(item.unit)}</select>` : `<input type="text" class="form-control form-control-sm" value="${attrEscape(item.unit || '')}" placeholder="單位" data-item-id="${item.id}" data-field="unit" onchange="saveItemCell(this)">`}</td>
                    <td><input type="number" class="form-control form-control-sm" min="0" value="${item.budget_min != null ? item.budget_min : ''}" data-item-id="${item.id}" data-field="budget_min" onchange="saveItemCell(this)"></td>
                    <td><input type="number" class="form-control form-control-sm" min="0" value="${item.budget_max != null ? item.budget_max : ''}" data-item-id="${item.id}" data-field="budget_max" onchange="saveItemCell(this)"></td>
                    <td class="text-center">
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteItem('${item.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        async function saveItemCell(input) {
            const itemId = input.dataset.itemId;
            const field = input.dataset.field;
            let value = input.value.trim();
            if (field === 'quantity') value = value === '' ? null : parseFloat(value);
            else if (field === 'budget_min' || field === 'budget_max') value = value === '' ? null : parseInt(value, 10);
            if (!itemId || field === undefined || !projectId) return;
            try {
                const session = await AuthService.getSession();
                const token = session?.access_token;
                if (!token) {
                    alert('請先登入後再儲存');
                    return;
                }
                const res = await fetch(`/api/projects/${projectId}/items/${itemId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({ field, value })
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    throw new Error(data.error || '儲存失敗');
                }
                const item = allProjectItems.find(i => i.id === itemId);
                if (item) item[field] = value;
            } catch (e) {
                console.error('儲存失敗:', e);
                alert('儲存失敗：' + (e.message || ''));
            }
        }

        /** 將工項標籤陣列寫入 DB（PATCH requirements.tags） */
        async function saveItemTags(itemId, tagsArray) {
            const pid = projectId || getProjectIdFromUrl();
            if (!itemId || !pid) {
                alert('無法儲存：缺少專案或項目 ID，請確認網址含有專案 id（例如 ?id=xxx）並重新整理。');
                return;
            }
            const tags = Array.isArray(tagsArray) ? tagsArray : [];
            try {
                const session = await AuthService.getSession();
                const token = session?.access_token;
                if (!token) {
                    alert('請先登入後再儲存');
                    return;
                }
                const res = await fetch(`/api/projects/${pid}/items/${itemId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({ requirements: { tags }, tags })
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) throw new Error(data.error || '儲存失敗');
                const item = allProjectItems.find(i => i.id === itemId);
                if (item) {
                    if (!item.requirements) item.requirements = {};
                    item.requirements.tags = tagsArray || [];
                }
            } catch (e) {
                console.error('儲存標籤失敗:', e);
                alert('儲存標籤失敗：' + (e.message || ''));
            }
        }

        function removeItemTag(itemId, btn) {
            const chip = btn.closest('.tag-chip');
            const container = chip && chip.closest('.item-tags-container');
            if (!chip || !container) return;
            const tag = chip.getAttribute('data-tag');
            const currentTags = [...container.querySelectorAll('.tag-chip')].map(c => c.getAttribute('data-tag')).filter(Boolean);
            const newTags = currentTags.filter(t => t !== tag);
            saveItemTags(itemId, newTags).then(() => chip.remove());
        }

        function onItemTagInputKeydown(event, input) {
            if (event.key === 'Enter' || event.key === ',') {
                event.preventDefault();
                addItemTagFromInput(input);
            }
        }

        function addItemTagFromInput(input) {
            const val = (input.value || '').trim();
            if (!val) return;
            const itemId = input.getAttribute('data-item-id');
            const container = input.closest('.item-tags-container');
            if (!itemId || !container) return;
            const currentTags = [...container.querySelectorAll('.tag-chip')].map(c => c.getAttribute('data-tag')).filter(Boolean);
            if (currentTags.includes(val)) {
                input.value = '';
                return;
            }
            const newTags = [...currentTags, val];
            const attrEscape = (s) => String(s).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            saveItemTags(itemId, newTags).then(() => {
                const span = document.createElement('span');
                span.className = 'badge bg-light text-dark border tag-chip';
                span.setAttribute('data-tag', val);
                span.innerHTML = attrEscape(val) + ' <button type="button" class="border-0 bg-transparent p-0 ms-1 text-muted" style="font-size:0.75em;line-height:1" aria-label="移除" onclick="removeItemTag(\'' + itemId + '\', this)">&times;</button>';
                container.insertBefore(span, input);
                input.value = '';
            });
        }

        /** 點擊推薦標籤：將該標籤加入「已勾選」的工項並寫入 DB */
        function addRecommendedTagToSelectedItems(badgeEl) {
            const tag = badgeEl && badgeEl.getAttribute && badgeEl.getAttribute('data-tag');
            if (!tag) return;
            const checkedIds = Array.from(document.querySelectorAll('.item-checkbox:checked')).map(cb => cb.value).filter(Boolean);
            if (checkedIds.length === 0) {
                alert('請先勾選要加入標籤的工項（在下方表格勾選一筆或多筆項目）');
                return;
            }
            const attrEscape = (s) => String(s).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            checkedIds.forEach(itemId => {
                const tr = document.querySelector(`#itemsTableBody tr[data-item-id="${itemId}"]`);
                const container = tr && tr.querySelector('.item-tags-container');
                if (!container) return;
                const currentTags = [...container.querySelectorAll('.tag-chip')].map(c => c.getAttribute('data-tag')).filter(Boolean);
                if (currentTags.includes(tag)) return;
                const newTags = [...currentTags, tag];
                const input = container.querySelector('.item-tag-input');
                saveItemTags(itemId, newTags).then(() => {
                    const span = document.createElement('span');
                    span.className = 'badge bg-light text-dark border tag-chip';
                    span.setAttribute('data-tag', tag);
                    span.innerHTML = attrEscape(tag) + ' <button type="button" class="border-0 bg-transparent p-0 ms-1 text-muted" style="font-size:0.75em;line-height:1" aria-label="移除" onclick="removeItemTag(\'' + itemId + '\', this)">&times;</button>';
                    container.insertBefore(span, input);
                });
            });
        }

        /** 儲存本頁修改：將表格中所有「已同步」項目的目前輸入一次寫入後端 */
        async function saveAllTableEdits() {
            const rows = document.querySelectorAll('#itemsTableBody tr[data-item-id]');
            if (rows.length === 0) {
                alert('目前沒有可儲存的項目。請先點「同步為分包項目」將項目寫入後，再於表格中修改並儲存。');
                return;
            }
            const session = await AuthService.getSession();
            const token = session?.access_token;
            if (!token) {
                alert('請先登入後再儲存');
                return;
            }
            let saved = 0;
            let failed = 0;
            for (const tr of rows) {
                const itemId = tr.getAttribute('data-item-id');
                if (!itemId) continue;
                const get = (field) => {
                    const input = tr.querySelector(`[data-field="${field}"]`);
                    if (!input) return null;
                    const v = input.value.trim();
                    if (v === '') return null;
                    if (field === 'quantity') {
                        const n = parseFloat(v);
                        return isNaN(n) ? null : n;
                    }
                    if (field === 'budget_min' || field === 'budget_max') {
                        const n = parseInt(v, 10);
                        return isNaN(n) ? null : n;
                    }
                    return v;
                };
                const tagsContainer = tr.querySelector('.item-tags-container');
                const tags = tagsContainer ? [...tagsContainer.querySelectorAll('.tag-chip')].map(c => c.getAttribute('data-tag')).filter(Boolean) : [];
                const updates = {
                    item_name: (get('item_name') || '未命名').toString(),
                    item_description: (get('item_description') ?? get('spec') ?? null),
                    quantity: get('quantity'),
                    unit: get('unit') || null,
                    budget_min: get('budget_min'),
                    budget_max: get('budget_max')
                };
                const body = { updates };
                if (tags.length >= 0) body.requirements = { tags };
                try {
                    const res = await fetch(`/api/projects/${projectId}/items/${itemId}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                        body: JSON.stringify(body)
                    });
                    const data = await res.json().catch(() => ({}));
                    if (res.ok) saved++; else failed++;
                } catch (_) {
                    failed++;
                }
            }
            if (saved > 0) {
                if (allProjectItems && allProjectItems.length) {
                    for (const tr of rows) {
                        const itemId = tr.getAttribute('data-item-id');
                        const item = allProjectItems.find(i => i.id === itemId);
                        if (!item) continue;
                        ['item_name', 'item_description', 'quantity', 'unit', 'budget_min', 'budget_max'].forEach(field => {
                            const input = tr.querySelector(`[data-field="${field}"]`);
                            if (input) item[field] = input.value.trim() === '' ? null : (field === 'quantity' ? parseFloat(input.value) : (field === 'budget_min' || field === 'budget_max' ? parseInt(input.value, 10) : input.value));
                        });
                        const tagsContainer = tr.querySelector('.item-tags-container');
                        if (tagsContainer) {
                            const tags = [...tagsContainer.querySelectorAll('.tag-chip')].map(c => c.getAttribute('data-tag')).filter(Boolean);
                            if (!item.requirements) item.requirements = {};
                            item.requirements.tags = tags;
                        }
                    }
                }
                alert('已儲存 ' + saved + ' 筆項目。' + (failed > 0 ? '（' + failed + ' 筆失敗）' : ''));
            } else if (failed > 0) {
                alert('儲存失敗，請檢查登入狀態或稍後再試。');
            }
        }

        /** 暫存至專案描述：在尚未同步時，先將表格內容寫入專案的 description.items，避免重填遺失 */
        async function saveDescriptionItemsToProject() {
            const rows = document.querySelectorAll('#itemsTableBody tr[data-desc-idx]');
            if (rows.length === 0) {
                alert('目前沒有可暫存的項目。');
                return;
            }
            const items = [];
            for (const tr of rows) {
                const get = (field) => {
                    const input = tr.querySelector(`[data-field="${field}"]`);
                    return input ? input.value.trim() : '';
                };
                const q = get('quantity');
                const bMin = get('budget_min');
                const bMax = get('budget_max');
                items.push({
                    item_name: get('item_name') || '未命名',
                    spec: get('spec') || get('item_description') || '',
                    quantity: q === '' ? null : parseFloat(q),
                    unit: get('unit') || '',
                    budget_min: bMin === '' ? null : parseInt(bMin, 10),
                    budget_max: bMax === '' ? null : parseInt(bMax, 10)
                });
            }
            try {
                const res = await fetch('/api/projects/update-items', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ project_id: projectId, items })
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    throw new Error(data.error || '暫存失敗');
                }
                alert('已暫存 ' + items.length + ' 筆至專案描述。重新整理頁面後仍會保留。');
            } catch (e) {
                console.error('暫存失敗:', e);
                alert('暫存失敗：' + (e.message || ''));
            }
        }

        function attrEscape(s) {
            if (s == null) return '';
            return String(s).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;');
        }
        // 計價單位：只用「該分類」專家報價實際使用的單位（從 API 撈，不硬編碼）
        let unitOptions = [];
        async function loadUnitOptionsForCategory(category) {
            unitOptions = [];
            const el = document.getElementById('categoryUnitsHint');
            const textEl = document.getElementById('categoryUnitsHintText');
            if (!category) {
                if (el) el.classList.add('d-none');
                return;
            }
            try {
                const res = await fetch(`/api/listings/units-by-category?category=${encodeURIComponent(category)}`);
                const data = await res.json().catch(() => ({}));
                const units = (data.units && Array.isArray(data.units)) ? data.units : [];
                unitOptions = units;
                if (textEl) {
                    if (units.length > 0) {
                        textEl.textContent = '該分類專家常用單位（僅供對照參考，不參與篩選）：' + units.join('、');
                    } else {
                        textEl.textContent = '此分類尚無專家報價。您可先填寫單位（例：瓶、ml、式），之後同分類發包端會看到相同選項。';
                    }
                }
                if (el) el.classList.remove('d-none');
            } catch (e) {
                if (textEl) textEl.textContent = '單位僅供對照參考，不參與媒合篩選。';
                if (el) el.classList.remove('d-none');
            }
        }
        function unitSelectOptions(selectedValue) {
            const v = (selectedValue || '').trim();
            let opts = (unitOptions.length ? unitOptions : (v ? [v] : [])).map(u => `<option value="${attrEscape(u)}" ${u === v ? 'selected' : ''}>${u}</option>`);
            if (v && unitOptions.length > 0 && !unitOptions.includes(v)) opts.push(`<option value="${attrEscape(v)}" selected>${attrEscape(v)}</option>`);
            return '<option value="">請選擇</option>' + opts.join('');
        }
        function renderDescriptionItemsWithSync(descItems) {
            showSyncBanner(descItems.length);
            document.getElementById('itemsTableBody').innerHTML = descItems.map((item, idx) => `
                <tr data-desc-idx="${idx}">
                    <td class="text-center"><input type="checkbox" class="item-desc-checkbox" value="${idx}" title="同步後此勾選才可發包" onchange="updateSelection()"></td>
                    <td class="text-center text-muted">—</td>
                    <td><input type="text" class="form-control form-control-sm" value="${attrEscape(item.item_name || '')}" placeholder="項目名稱" data-field="item_name"></td>
                    <td><input type="text" class="form-control form-control-sm" value="${attrEscape(item.spec || '')}" placeholder="說明" data-field="spec"></td>
                    <td class="small">${(item.tags && Array.isArray(item.tags) ? item.tags : []).map(t => `<span class="badge bg-light text-dark border me-1">${attrEscape(t)}</span>`).join('') || '—'}</td>
                    <td><input type="number" class="form-control form-control-sm" value="${item.quantity != null ? item.quantity : ''}" min="0" step="0.01" placeholder="數量" data-field="quantity"></td>
                    <td>${unitOptions.length > 0 ? `<select class="form-select form-select-sm" data-field="unit">${unitSelectOptions(item.unit)}</select>` : `<input type="text" class="form-control form-control-sm" value="${attrEscape(item.unit || '')}" placeholder="單位" data-field="unit">`}</td>
                    <td><input type="number" class="form-control form-control-sm" value="${item.budget_min != null ? item.budget_min : ''}" min="0" placeholder="下限" data-field="budget_min"></td>
                    <td><input type="number" class="form-control form-control-sm" value="${item.budget_max != null ? item.budget_max : ''}" min="0" placeholder="上限" data-field="budget_max"></td>
                    <td class="text-center"><span class="text-muted small">填好後點上方「同步為分包項目」</span></td>
                </tr>
            `).join('');
        }

        let syncBannerEl = null;
        function showSyncBanner(count) {
            if (syncBannerEl) return;
            const section = document.getElementById('projectItemsSection');
            syncBannerEl = document.createElement('div');
            syncBannerEl.className = 'alert alert-warning mb-3';
            syncBannerEl.innerHTML = `
                <strong><i class="fas fa-sync-alt me-2"></i>以下 ${count} 筆項目來自「我的專案」編輯頁，尚未寫入分包項目表。</strong>
                <p class="mb-2 mt-2">要發包請先點「同步為分包項目」，系統會寫入數量、單位；之後您可在此補填總預算並勾選送出媒合。</p>
                <button type="button" class="btn btn-primary" onclick="syncDescriptionItemsToProjectItems()">
                    <i class="fas fa-sync me-1"></i>同步為分包項目
                </button>
            `;
            section.insertBefore(syncBannerEl, section.querySelector('.table-responsive'));
        }
        function hideSyncBanner() {
            if (syncBannerEl) { syncBannerEl.remove(); syncBannerEl = null; }
        }

        async function syncDescriptionItemsToProjectItems() {
            if (!projectId || !projectData) return;
            const rows = document.querySelectorAll('#itemsTableBody tr[data-desc-idx]');
            if (rows.length === 0) { alert('沒有可同步的項目'); return; }
            let descItems = [];
            try {
                const descJson = JSON.parse(projectData.description || '{}');
                if (descJson.items && Array.isArray(descJson.items)) descItems = descJson.items;
            } catch (e) {}
            const items = [];
            for (const tr of rows) {
                const idx = parseInt(tr.getAttribute('data-desc-idx'), 10);
                const descItem = descItems[idx] || {};
                const get = (field) => {
                    const input = tr.querySelector(`[data-field="${field}"]`);
                    return input ? input.value.trim() : '';
                };
                const quantityRaw = get('quantity');
                const budgetMinRaw = get('budget_min');
                const budgetMaxRaw = get('budget_max');
                items.push({
                    item_name: get('item_name') || '未命名',
                    item_description: get('spec') || null,
                    category_name: projectData.category || null,
                    subcategory: (projectData.subcategory && projectData.subcategory[0]) || null,
                    quantity: quantityRaw === '' ? null : parseFloat(quantityRaw),
                    unit: get('unit') || null,
                    budget_min: budgetMinRaw === '' ? null : parseInt(budgetMinRaw, 10),
                    budget_max: budgetMaxRaw === '' ? null : parseInt(budgetMaxRaw, 10),
                    tags: Array.isArray(descItem.tags) ? descItem.tags : []
                });
            }
            try {
                const session = await AuthService.getSession();
                const token = session?.access_token;
                if (!token) {
                    alert('請先登入後再同步');
                    return;
                }
                const res = await fetch(`/api/projects/${projectId}/sync-items`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({ items })
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    throw new Error(data.error || '同步失敗');
                }
                const count = data.count ?? items.length;
                // 直接用 API 回傳的項目渲染表格，確保是 project_items 的勾選框（item-checkbox），送出媒合才認得
                if (data.items && data.items.length > 0) {
                    allProjectItems = data.items;
                    renderProjectItemsTable(allProjectItems, true);
                    hideSyncBanner();
                    const saveAllBtn = document.getElementById('saveAllTableBtn');
                    const saveDescBtn = document.getElementById('saveDescTableBtn');
                    if (saveAllBtn) saveAllBtn.style.display = 'inline-block';
                    if (saveDescBtn) saveDescBtn.style.display = 'none';
                } else {
                    await loadProjectItems();
                }
                alert('已同步 ' + count + ' 筆項目。請勾選要發包的項目後點「送出媒合」。');
            } catch (err) {
                console.error('同步失敗:', err);
                alert('同步失敗：' + (err.message || '請稍後再試'));
            }
        }


        // 複製到剪貼簿
        function copyToClipboard(text, label) {
            navigator.clipboard.writeText(text).then(() => {
                alert(`✅ ${label} 已複製：${text}`);
            }).catch(err => {
                console.error('複製失敗:', err);
                alert(`❌ 複製失敗，請手動複製：${text}`);
            });
        }

        // （載入分包項目已改為上方從 project_items 表載入）

        // 更新項目欄位
        async function updateItem(itemId, field, value) {
            try {
                const updates = {};
                if (field === 'quantity') {
                    updates[field] = parseFloat(value) || null;
                } else {
                    updates[field] = value;
                }

                const { error } = await AuthService.supabase
                    .from('project_items')
                    .update(updates)
                    .eq('id', itemId);

                if (error) throw error;

                // 更新全域資料
                const item = allProjectItems.find(i => i.id === itemId);
                if (item) item[field] = updates[field];

            } catch (error) {
                console.error('❌ 更新失敗:', error);
                alert('❌ 更新失敗：' + error.message);
            }
        }

        // 刪除項目
        async function deleteItem(itemId) {
            if (!confirm('確定要刪除此項目嗎？')) return;

            try {
                const { error } = await AuthService.supabase
                    .from('project_items')
                    .delete()
                    .eq('id', itemId);

                if (error) throw error;

                await loadProjectItems();
            } catch (error) {
                console.error('❌ 刪除失敗:', error);
                alert('❌ 刪除失敗：' + error.message);
            }
        }

        // 新增項目
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('addRow')?.addEventListener('click', () => {
                const tbody = document.getElementById('itemsTableBody');
                if (tbody.querySelector('tr td[colspan="10"]')) tbody.innerHTML = '';
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td></td>
                    <td><input type="text" name="item_name" class="form-control form-control-sm" placeholder="項目名稱"></td>
                    <td><input type="text" name="item_description" class="form-control form-control-sm" placeholder="說明"></td>
                    <td><input type="number" name="quantity" class="form-control form-control-sm" min="0" step="0.01" placeholder="數量"></td>
                    <td>${unitOptions.length > 0 ? `<select name="unit" class="form-select form-select-sm"><option value="">單位</option>${unitOptions.map(u => `<option value="${u}">${u}</option>`).join('')}</select>` : `<input type="text" name="unit" class="form-control form-control-sm" placeholder="單位">`}</td>
                    <td><input type="number" name="budget_min" class="form-control form-control-sm" min="0" placeholder="下限"></td>
                    <td><input type="number" name="budget_max" class="form-control form-control-sm" min="0" placeholder="上限"></td>
                    <td><button type="button" class="btn btn-sm btn-primary" onclick="saveNewItem(this)">儲存</button></td>
                `;
                tbody.appendChild(newRow);
            });

            // 分包項目收合時切換箭頭圖示
            const collapseEl = document.getElementById('collapseProjectItems');
            const iconEl = document.getElementById('projectItemsCollapseIcon');
            if (collapseEl && iconEl) {
                collapseEl.addEventListener('show.bs.collapse', () => {
                    iconEl.classList.remove('fa-chevron-right');
                    iconEl.classList.add('fa-chevron-down');
                });
                collapseEl.addEventListener('hide.bs.collapse', () => {
                    iconEl.classList.remove('fa-chevron-down');
                    iconEl.classList.add('fa-chevron-right');
                });
            }
        });

        // 儲存新項目（數量、單位、總預算供媒合：發包數量×承包商單價＝總價比對）
        async function saveNewItem(btn) {
            const row = btn.closest('tr');
            const item_name = row.querySelector('[name="item_name"]').value.trim();
            const item_description = row.querySelector('[name="item_description"]').value.trim();
            const quantity = parseFloat(row.querySelector('[name="quantity"]').value) || null;
            const unit = (row.querySelector('[name="unit"]').value || '').trim();
            const budget_min = parseInt(row.querySelector('[name="budget_min"]').value, 10) || null;
            const budget_max = parseInt(row.querySelector('[name="budget_max"]').value, 10) || null;

            if (!item_name) {
                alert('請輸入項目名稱');
                return;
            }
            if (unit && (!quantity || quantity <= 0)) {
                alert('有填單位時請填寫數量（供媒合計算）');
                return;
            }
            if (budget_min != null && budget_max != null && budget_max < budget_min) {
                alert('總預算上限不可小於下限');
                return;
            }

            try {
                const { error } = await AuthService.supabase
                    .from('project_items')
                    .insert([{
                        project_id: projectId,
                        item_name,
                        item_description: item_description || null,
                        category_name: projectData?.category || null,
                        subcategory: projectData?.subcategory?.[0] || null,
                        quantity,
                        unit: unit || null,
                        budget_min,
                        budget_max,
                        status: 'draft'
                    }])
                    .select()
                    .single();

                if (error) throw error;
                await loadProjectItems();
            } catch (error) {
                console.error('❌ 新增失敗:', error);
                alert('❌ 新增失敗：' + error.message);
            }
        }

        // 開啟編輯項目 Modal（依 itemId 從 allProjectItems 載入；單位依該分類 API 動態為下拉或文字輸入）
        function openEditItemModal(itemId) {
            const item = allProjectItems.find(i => i.id === itemId);
            if (!item) return;
            document.getElementById('editItemId').value = item.id;
            document.getElementById('editItemName').value = item.item_name || '';
            document.getElementById('editItemQuantity').value = item.quantity != null ? item.quantity : '';
            const unitVal = (item.unit || '').trim();
            const wrap = document.getElementById('editItemUnitWrapper');
            if (wrap) {
                if (unitOptions.length > 0) {
                    wrap.innerHTML = '<select class="form-select" id="editItemUnit">' + unitSelectOptions(unitVal) + '</select>';
                } else {
                    wrap.innerHTML = '<input type="text" class="form-control" id="editItemUnit" placeholder="例：瓶、ml、式">';
                    const inp = document.getElementById('editItemUnit');
                    if (inp) inp.value = unitVal;
                }
            }
            document.getElementById('editItemBudgetMin').value = item.budget_min != null ? item.budget_min : '';
            document.getElementById('editItemBudgetMax').value = item.budget_max != null ? item.budget_max : '';
            document.getElementById('editItemDescription').value = item.item_description || '';
            new bootstrap.Modal(document.getElementById('editItemModal')).show();
        }

        // 儲存編輯項目（寫回 project_items，含數量、單位、總預算）
        async function saveItemEdit() {
            const itemId = document.getElementById('editItemId').value;
            if (!itemId) return;
            const item_name = document.getElementById('editItemName').value.trim();
            const quantity = parseFloat(document.getElementById('editItemQuantity').value) || null;
            const unit = (document.getElementById('editItemUnit').value || '').trim();
            const budget_min = parseInt(document.getElementById('editItemBudgetMin').value, 10) || null;
            const budget_max = parseInt(document.getElementById('editItemBudgetMax').value, 10) || null;
            const item_description = document.getElementById('editItemDescription').value.trim();
            if (!item_name) { alert('請輸入項目名稱'); return; }
            if (budget_min != null && budget_max != null && budget_max < budget_min) { alert('總預算上限不可小於下限'); return; }
            try {
                const { error } = await AuthService.supabase
                    .from('project_items')
                    .update({
                        item_name,
                        item_description: item_description || null,
                        quantity,
                        unit: unit || null,
                        budget_min,
                        budget_max
                    })
                    .eq('id', itemId);
                if (error) throw error;
                bootstrap.Modal.getInstance(document.getElementById('editItemModal')).hide();
                await loadProjectItems();
            } catch (error) {
                console.error('❌ 更新失敗:', error);
                alert('❌ 更新失敗：' + error.message);
            }
        }

        /** 從廠商列表移除單筆媒合記錄（先從畫面移除該卡片，再呼叫 API；失敗則重新載入還原） */
        async function removeMatchedExpert(matchId, buttonEl) {
            if (!matchId || !projectId) return;
            if (!confirm('確定要從廠商列表中移除此廠商？')) return;
            const card = buttonEl && buttonEl.closest ? buttonEl.closest('.card') : null;
            if (card) card.remove();
            const container = document.getElementById('matchedExpertsList');
            if (container && container.querySelectorAll('.card').length === 0) {
                container.innerHTML = '<p class="text-muted mb-0">目前無媒合廠商，可勾選項目後點「送出媒合」重新發包。</p>';
            }
            try {
                const session = await AuthService.getSession();
                const token = session?.access_token;
                if (!token) { alert('請先登入'); await loadMatchedExperts(); return; }
                const res = await fetch(`/api/projects/${projectId}/matches/${matchId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) throw new Error(data.error || '刪除失敗');
            } catch (e) {
                console.error('移除廠商失敗:', e);
                alert('移除失敗：' + (e.message || '') + '，已還原列表');
                await loadMatchedExperts();
            }
        }

        // 載入媒合專家（含廠商聯絡資料，與預媒合差別：此為實際媒合結果且顯示聯絡方式）
        async function loadMatchedExpertsOnClick() {
            const btn = document.getElementById('btnLoadMatchedExperts');
            const listEl = document.getElementById('matchedExpertsList');
            if (btn) btn.disabled = true;
            if (listEl) listEl.innerHTML = '<p class="text-muted text-center py-4 small mb-0"><span class="spinner-border spinner-border-sm me-2"></span>載入中...</p>';
            try {
                await loadMatchedExperts();
            } finally {
                if (btn) btn.disabled = false;
            }
        }

        async function loadMatchedExperts() {
            const container = document.getElementById('matchedExpertsList');
            if (!container) return;
            try {
                const session = await AuthService.getSession();
                const token = session?.access_token;
                if (!token) return;
                const res = await fetch(`/api/projects/${projectId}/matched-experts`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const list = await res.json().catch(() => []);
                if (!res.ok || !Array.isArray(list)) return;
                renderMatchedExpertsWithContact(list);
            } catch (error) {
                console.warn('載入媒合專家失敗（可能尚未發包）:', error?.message || error);
            }
        }

        // 承包商作品區塊（報價媒體 + 專家作品集）
        function renderContractorWorks(item) {
            const media = item.listing_media || { images: [], youtube_urls: [], media_embeds: [] };
            const portfolio = item.portfolio || [];
            const hasMedia = (media.images && media.images.length) || (media.youtube_urls && media.youtube_urls.length) || (media.media_embeds && media.media_embeds.length);
            const hasPortfolio = portfolio.length > 0;
            if (!hasMedia && !hasPortfolio) return '';
            const imgBlocks = (media.images || []).slice(0, 10).map(url => `<a href="${escapeHtml(url)}" target="_blank" rel="noopener" class="d-inline-block me-2 mb-2"><img src="${escapeHtml(url)}" alt="" class="rounded" style="max-width:120px;max-height:90px;object-fit:cover;"></a>`).join('');
            const ytBlocks = (media.youtube_urls || []).slice(0, 5).map(url => {
                const vid = (url.match(/(?:v=|\/)([a-zA-Z0-9_-]{11})(?:\?|&|$)/) || [])[1] || '';
                if (!vid) return `<a href="${escapeHtml(url)}" target="_blank" rel="noopener" class="btn btn-sm btn-outline-danger me-2 mb-2"><i class="fab fa-youtube me-1"></i>影片</a>`;
                return `<div class="d-inline-block me-2 mb-2"><iframe width="200" height="113" src="https://www.youtube.com/embed/${escapeHtml(vid)}" frameborder="0" allowfullscreen></iframe></div>`;
            }).join('');
            const embedBlocks = (media.media_embeds || []).slice(0, 3).map(e => {
                const html = (e && typeof e === 'object' && e.html) ? e.html : (typeof e === 'string' ? e : '');
                if (!html) return '';
                return `<div class="d-inline-block me-2 mb-2 media-embed-wrap" style="max-width:280px;">${html}</div>`;
            }).filter(Boolean).join('');
            const portfolioBlocks = portfolio.slice(0, 8).map(p => `
                <div class="d-inline-block text-center me-3 mb-3">
                    ${p.image_url ? `<a href="${escapeHtml(p.image_url)}" target="_blank" rel="noopener"><img src="${escapeHtml(p.image_url)}" alt="" class="rounded" style="width:100px;height:80px;object-fit:cover;"></a>` : ''}
                    <div class="small mt-1">${escapeHtml(p.title || '')}</div>
                </div>
            `).join('');
            return `
                <div class="border-top mt-3 pt-3">
                    <h6 class="text-primary mb-2"><i class="fas fa-images me-2"></i>承包商作品</h6>
                    ${hasMedia ? `<div class="mb-3"><strong class="small text-muted">本報價媒體</strong><div class="mt-1">${imgBlocks}${ytBlocks}${embedBlocks}</div></div>` : ''}
                    ${hasPortfolio ? `<div><strong class="small text-muted">專家作品集</strong><div class="mt-1">${portfolioBlocks}</div></div>` : ''}
                </div>
            `;
        }

        // 渲染媒合專家（含聯絡資料，由 API 一次帶回）
        function renderMatchedExpertsWithContact(list) {
            const container = document.getElementById('matchedExpertsList');
            if (!container) return;
            if (!list || list.length === 0) {
                container.innerHTML = '<p class="text-muted mb-0">目前無媒合廠商，可勾選項目後點「送出媒合」重新發包。</p>';
                return;
            }
            const html = list.map(item => {
                const score = Math.round(Number(item.match_score) || 0);
                const c = item.contact || {};
                const contactLines = [];
                if (c.phone) contactLines.push(`<div class="mb-1"><i class="fas fa-phone me-1"></i>${escapeHtml(c.phone)}</div>`);
                if (c.mobile) contactLines.push(`<div class="mb-1"><i class="fas fa-mobile me-1"></i>${escapeHtml(c.mobile)}</div>`);
                if (c.line_id) contactLines.push(`<div class="mb-1"><i class="fab fa-line me-1"></i>${escapeHtml(c.line_id)}</div>`);
                if (c.email) contactLines.push(`<div class="mb-1"><i class="fas fa-envelope me-1"></i>${escapeHtml(c.email)}</div>`);
                const contactHtml = contactLines.length > 0 ? contactLines.join('') : '<small class="text-muted">該廠商尚未填寫聯絡資訊</small>';
                return `
                    <div class="card mb-3 border-primary">
                        <div class="card-body p-4">
                            <div class="row">
                                <div class="col-md-8">
                                    <h5 class="mb-2">
                                        <i class="fas fa-user-circle me-2 text-primary"></i>
                                        ${escapeHtml(item.expert_name || '廠商')}
                                    </h5>
                                    <p class="text-muted mb-2">${escapeHtml(item.listing_title || '')}</p>
                                    <p class="mb-2">${escapeHtml(item.listing_description || '')}</p>
                                    ${(item.listing_tags && item.listing_tags.length) ? `<p class="mb-3 small"><span class="text-muted">標籤：</span>${item.listing_tags.map(t => `<span class="badge bg-light text-dark border me-1">${escapeHtml(t)}</span>`).join('')}</p>` : ''}
                                    <div class="mb-3">
                                        <span class="me-3"><i class="fas fa-star text-warning me-1"></i>媒合分數：<strong>${score} 分</strong></span>
                                    </div>
                                    <div class="alert alert-info mb-0">
                                        <h6 class="mb-2"><i class="fas fa-phone me-2"></i>聯絡方式</h6>
                                        <div>${contactHtml}</div>
                                    </div>
                                    <p class="mb-0 mt-2"><a href="/expert/profile-view.html?expert_id=${encodeURIComponent(item.expert_id)}" class="text-primary small" target="_blank" rel="noopener"><i class="fas fa-user me-1"></i>查看專家自介</a></p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="progress mb-2" style="height: 25px;">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: ${score}%">${score}%</div>
                                    </div>
                                    <button type="button" class="btn btn-primary w-100 mb-2" data-expert-id="${item.expert_id}" data-expert-name="${escapeHtml(item.expert_name || '廠商')}" onclick="contactExpert(this)">
                                        <i class="fas fa-comments me-2"></i>站內對話（此頁）
                                    </button>
                                    <a href="/client/messages.html?open=${encodeURIComponent(item.expert_id)}" class="btn btn-success w-100 mb-2">
                                        <i class="fas fa-paper-plane me-2"></i>前往訊息頁
                                    </a>
                                    <button class="btn btn-outline-danger btn-sm w-100" onclick="removeMatchedExpert('${item.match_id}', this)" title="從廠商列表移除此筆">
                                        <i class="fas fa-times me-1"></i>移除此廠商
                                    </button>
                                </div>
                            </div>
                            ${renderContractorWorks(item)}
                        </div>
                    </div>
                `;
            }).join('');
            container.innerHTML = html;
        }

        // 工具函數
        function getStatusColor(status) {
            const colors = {
                'draft': 'secondary',
                'published': 'primary',
                'matched': 'success',
                'assigned': 'info',
                'in_progress': 'warning',
                'completed': 'success',
                'cancelled': 'danger'
            };
            return colors[status] || 'secondary';
        }

        function getStatusText(status) {
            const texts = {
                'draft': '草稿',
                'published': '已發包',
                'matched': '已媒合',
                'assigned': '已指派',
                'in_progress': '進行中',
                'completed': '已完成',
                'cancelled': '已取消'
            };
            return texts[status] || '未知';
        }

        function showError(message) {
            document.getElementById('loadingSection').classList.add('d-none');
            document.getElementById('projectPickerSection').classList.add('d-none');
            document.getElementById('errorSection').classList.remove('d-none');
            document.getElementById('errorMessage').textContent = message;
        }

        function showProjectPicker() {
            document.getElementById('loadingSection').classList.add('d-none');
            document.getElementById('errorSection').classList.add('d-none');
            document.getElementById('projectContent').classList.add('d-none');
            document.getElementById('projectPickerSection').classList.remove('d-none');
        }

        async function loadProjectPickerList() {
            const container = document.getElementById('projectPickerList');
            if (!container) return;
            try {
                const { data: projects, error } = await AuthService.supabase
                    .from('projects')
                    .select('id, title, category, status, created_at')
                    .eq('owner_id', currentUser.id)
                    .order('created_at', { ascending: false });
                if (error) throw error;
                if (!projects || projects.length === 0) {
                    container.innerHTML = '<p class="text-muted mb-0">您尚未建立任何專案。<a href="/index.html#ai-estimate">建立第一個專案</a></p>';
                    return;
                }
                const basePath = window.location.pathname.split('/').slice(0, -1).join('/') || '/client';
                const detailUrl = (id) => basePath + '/project-detail.html?id=' + encodeURIComponent(id);
                container.innerHTML = projects.map(p => {
                    const title = (p.title || '未命名專案').substring(0, 50);
                    const date = p.created_at ? new Date(p.created_at).toLocaleDateString('zh-TW') : '';
                    return `<div class="d-flex align-items-center justify-content-between border-bottom py-2">
                        <span class="text-truncate me-2">${escapeHtml(title)}</span>
                        <span class="small text-muted me-2">${escapeHtml(p.category || '')} · ${date}</span>
                        <a href="${detailUrl(p.id)}" class="btn btn-sm btn-primary">查看詳情</a>
                    </div>`;
                }).join('');
            } catch (e) {
                console.error('載入專案列表失敗:', e);
                container.innerHTML = '<p class="text-danger mb-0">無法載入專案列表，請<a href="/client/my-projects.html">前往我的專案</a>重試。</p>';
            }
        }

        // 操作函數（暫時跳轉或提示）
        async function editProject() {
            const btn = event.currentTarget;
            
            if (!isEditing) {
                // 進入編輯模式
                isEditing = true;
                btn.innerHTML = '<i class="fas fa-save me-2"></i>儲存變更';
                btn.className = 'btn btn-success';

                document.getElementById('descriptionDisplayArea').classList.add('d-none');
                document.getElementById('descriptionEditArea').classList.remove('d-none');
                
                // 設定編輯框內容
                const currentDesc = document.getElementById('projectDescription').innerText;
                document.getElementById('editDescriptionInput').value = currentDesc;

                // 顯示「新增欄位」按鈕
                const addFieldBtn = document.getElementById('addCustomFieldBtn');
                if (addFieldBtn) addFieldBtn.classList.remove('d-none');

                // 顯示所有動態欄位的編輯區
                document.querySelectorAll('.field-value-area').forEach(el => el.classList.add('d-none'));
                document.querySelectorAll('.field-edit-area').forEach(el => el.classList.remove('d-none'));
                
                // 顯示動態欄位區塊
                document.getElementById('dynamicFieldsSection').classList.remove('d-none');
                
            } else {
                // 執行儲存
                await saveProjectChanges(btn);
            }
        }


        /**
         * 新增自訂動態欄位
         */
        function addNewCustomField() {
            const container = document.getElementById('dynamicFieldsContainer');
            const label = prompt('請輸入欄位標題 (例如：材質、偏好顏色):');
            if (!label) return;

            const html = `
                <div class="col-md-6 mb-3">
                    <label class="form-label small fw-bold">${label}</label>
                    <div class="field-value-area d-none">
                        <div class="form-control-plaintext border-bottom pb-1 text-muted">編輯中...</div>
                    </div>
                    <div class="field-edit-area">
                        <input type="text" class="form-control form-control-sm detail-dynamic-field" 
                            data-sub="自訂" data-label="${label}" value="" placeholder="請輸入內容">
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            document.getElementById('dynamicFieldsSection').classList.remove('d-none');
        }

        async function saveProjectChanges(btn) {
            const newDescText = document.getElementById('editDescriptionInput').value;
            
            // 收集動態欄位數據
            const dynamicData = {};
            document.querySelectorAll('.detail-dynamic-field').forEach(el => {
                const sub = el.dataset.sub;
                const label = el.dataset.label;
                const val = el.value;
                if (!dynamicData[sub]) dynamicData[sub] = {};
                dynamicData[sub][label] = val;
            });

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>儲存中...';

            try {
                // 1. 取得最新資料以更新 JSON
                const { data: current, error: fError } = await AuthService.supabase
                    .from('projects')
                    .select('description')
                    .eq('id', projectId)
                    .single();
                
                if (fError) throw fError;

                let descJson = {};
                try { descJson = JSON.parse(current.description || '{}'); } catch(e) {}
                
                descJson.user_description = newDescText;
                descJson.dynamic_fields = dynamicData;

                // 2. 寫回資料庫
                const { error: uError } = await AuthService.supabase
                    .from('projects')
                    .update({ 
                        description: JSON.stringify(descJson)
                    })
                    .eq('id', projectId);

                if (uError) throw uError;

                // 3. 恢復顯示模式
                isEditing = false;
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-edit me-2"></i>編輯專案';
                btn.className = 'btn btn-primary';

                document.getElementById('projectDescription').innerText = newDescText;
                document.getElementById('descriptionDisplayArea').classList.remove('d-none');
                document.getElementById('descriptionEditArea').classList.add('d-none');

                // 隱藏動態欄位的編輯區
                document.querySelectorAll('.field-value-area').forEach(el => el.classList.remove('d-none'));
                document.querySelectorAll('.field-edit-area').forEach(el => el.classList.add('d-none'));

                // 重新載入動態欄位以更新顯示內容
                await loadDynamicFields();

                alert('✅ 專案資訊已更新！');

            } catch (err) {
                console.error('儲存失敗:', err);
                alert('❌ 儲存失敗：' + err.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save me-2"></i>儲存變更';
            }
        }

        function manageItems() {
            window.location.href = `project-items.html?id=${projectId}`;
        }

        function deleteProject() {
            if (confirm('確定要刪除此專案嗎？此操作無法復原。')) {
                alert('刪除功能開發中');
            }
        }

        /**
         * 預媒合測試（基於項目預算）
         * 只取「已勾選」的項目：以 checkbox 為唯一依據，再從對應的那一列讀取預算。
         */
        function getItemsBudgetFromDOM() {
            const tbody = document.getElementById('itemsTableBody');
            if (!tbody) return null;
            const checkedBoxes = tbody.querySelectorAll('.item-checkbox:checked, .item-desc-checkbox:checked');
            if (checkedBoxes.length === 0) return null;
            const items = [];
            checkedBoxes.forEach(cb => {
                const tr = cb.closest('tr');
                if (!tr) return;
                const minIn = tr.querySelector('[data-field="budget_min"]');
                const maxIn = tr.querySelector('[data-field="budget_max"]');
                const qtyIn = tr.querySelector('[data-field="quantity"]');
                const unitIn = tr.querySelector('[data-field="unit"]');
                const vMin = minIn && minIn.value.trim() !== '' ? parseInt(minIn.value, 10) : null;
                const vMax = maxIn && maxIn.value.trim() !== '' ? parseInt(maxIn.value, 10) : null;
                const qty = qtyIn && qtyIn.value.trim() !== '' ? parseFloat(qtyIn.value) : null;
                const unit = unitIn && unitIn.value.trim() !== '' ? unitIn.value.trim() : null;
                items.push({ budget_min: isNaN(vMin) ? null : vMin, budget_max: isNaN(vMax) ? null : vMax, quantity: qty, unit });
            });
            return items.length ? items : null;
        }
        function getItemsBudgetFromDesc() {
            let descJson = {};
            try {
                descJson = JSON.parse(projectData.description || '{}');
            } catch(e) {}
            const descItems = descJson.items || [];
            return descItems.map(it => ({
                budget_min: it.budget_min ?? it.budget_max ?? null,
                budget_max: it.budget_max ?? it.budget_min ?? null,
                quantity: it.quantity ?? null,
                unit: it.unit ?? null
            }));
        }
        /** 從項目中取「代表性」數量與單位，供預媒合用（數量不同會有不同報價／階梯定價） */
        function getRepresentativeQuantityAndUnit(items) {
            if (!items || items.length === 0) return { quantity: null, unit: null };
            const withQty = items.find(it => it.quantity != null && it.quantity > 0 && it.unit);
            if (withQty) return { quantity: withQty.quantity, unit: withQty.unit || null };
            if (allProjectItems && allProjectItems.length > 0) {
                const first = allProjectItems.find(it => it.quantity != null && it.quantity > 0 && it.unit);
                if (first) return { quantity: first.quantity, unit: first.unit || null };
            }
            return { quantity: null, unit: null };
        }
        async function preMatchProject() {
            try {
                // 只算「已勾選」的項目（與送出媒合一致）
                let items = getItemsBudgetFromDOM();
                if (!items || items.length === 0) {
                    const checkedIds = Array.from(document.querySelectorAll('.item-checkbox:checked')).map(cb => cb.value);
                    const checkedDescIdx = Array.from(document.querySelectorAll('.item-desc-checkbox:checked')).map(cb => parseInt(cb.value, 10));
                    if (allProjectItems && allProjectItems.length > 0 && checkedIds.length > 0) {
                        items = allProjectItems.filter(it => checkedIds.includes(it.id)).map(it => ({ budget_min: it.budget_min, budget_max: it.budget_max, quantity: it.quantity, unit: it.unit }));
                    } else if (checkedDescIdx.length > 0) {
                        const descItems = getItemsBudgetFromDesc() || [];
                        items = checkedDescIdx.filter(i => i >= 0 && i < descItems.length).map(i => descItems[i]);
                    }
                }
                if (!items || items.length === 0) {
                    alert('⚠️ 請先勾選要預媒合的項目\n\n在下方表格勾選一筆或多筆項目後，再點預媒合測試。');
                    return;
                }
                const itemsWithBudget = items.filter(item => (item.budget_min != null && item.budget_min > 0) || (item.budget_max != null && item.budget_max > 0));
                if (itemsWithBudget.length === 0) {
                    alert('⚠️ 勾選的項目尚未填寫預算\n\n請在表格中填寫「總預算下限」或「總預算上限」後再試。');
                    return;
                }
                const totalBudgetMin = itemsWithBudget.reduce((sum, item) => sum + (item.budget_min ?? item.budget_max ?? 0), 0);
                const totalBudgetMax = itemsWithBudget.reduce((sum, item) => sum + (item.budget_max ?? item.budget_min ?? 0), 0);
                const totalBudgetMinAdjusted = totalBudgetMin > 0 ? Math.floor(totalBudgetMin * 0.8) : totalBudgetMin;
                const totalBudgetMaxAdjusted = totalBudgetMax > 0 ? Math.ceil(totalBudgetMax * 1.2) : totalBudgetMax;
                const totalBudget = Math.round((totalBudgetMin + totalBudgetMax) / 2);
                // 代表性數量與單位：供後端依「數量×單價」與階梯定價比對（數量不同會有不同報價）
                const { quantity: repQty, unit: repUnit } = getRepresentativeQuantityAndUnit(itemsWithBudget);
                
                // 顯示載入中
                const resultArea = document.getElementById('preMatchResultArea');
                resultArea.style.display = 'block';
                
                document.getElementById('budgetStatusPercent').innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
                document.getElementById('matchExpertCount').textContent = '--';
                document.getElementById('estimatedResponses').textContent = '--';
                document.getElementById('budgetStatusText').textContent = '正在分析全台專家資料庫...';
                document.getElementById('budgetStatusMessage').className = 'alert alert-info mb-0';
                
                // 從「畫面上」已勾選工項的標籤欄收集 tags（與表格顯示一致，避免剛新增的標籤沒被送出）
                const checkedIds = Array.from(document.querySelectorAll('.item-checkbox:checked')).map(cb => cb.value);
                let previewTags = [];
                if (checkedIds.length > 0) {
                    const tagSet = new Set();
                    checkedIds.forEach(itemId => {
                        const tr = document.querySelector(`#itemsTableBody tr[data-item-id="${itemId}"]`);
                        const container = tr && tr.querySelector('.item-tags-container');
                        if (container) {
                            container.querySelectorAll('.tag-chip').forEach(chip => {
                                const t = chip.getAttribute('data-tag');
                                if (t) tagSet.add(t);
                            });
                        }
                    });
                    previewTags = [...tagSet];
                    // 若畫面上沒有 tag-chip（例如尚未載入表格），才用 allProjectItems 當後備
                    if (previewTags.length === 0 && allProjectItems) {
                        previewTags = [...new Set(allProjectItems.filter(it => checkedIds.includes(it.id)).flatMap(it => (it.requirements && it.requirements.tags) || []))];
                    }
                }
                const previewBody = {
                    project_id: projectId,
                    category: projectData.category,
                    subcategory: projectData.subcategory || [],
                    budget_min: totalBudgetMinAdjusted,
                    budget_max: totalBudgetMaxAdjusted,
                    quantity: repQty,
                    unit: repUnit
                };
                if (previewTags.length > 0) previewBody.tags = previewTags;
                const response = await fetch('/api/match/preview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(previewBody)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || '預媒合測試失敗');
                }
                
                // 顯示結果
                const percentage = Math.round(result.match_percentage || 0);
                const matchedCount = result.matched_experts || 0; // 報價落在您預算區間內的專家人數
                const totalCount = result.total_experts || 0; // 符合單位／條件的專家數（分母）
                const totalInCategory = result.total_in_category != null ? result.total_in_category : totalCount; // 該分類總專家數（未篩單位）
                const noExpertsForUnit = result.no_experts_for_unit === true; // 0 是因為單位／條件篩掉，非預算
                const expertsTagMatchOnly = result.experts_tag_match_only || 0; // 僅標籤相符的專家人數（未篩單位）
                const unitsUsedByTagMatched = result.units_used_by_tag_matched || []; // 上述專家使用的單位
                const estimatedResponses = result.estimated_responses || '未知';
                const budgetStatus = result.budget_status || 'normal';
                const avgMarketPrice = result.avg_market_price || 0;
                const useUnitPricing = result.use_unit_pricing === true;
                
                // 根據符合度設定樣式
                let statusClass = 'success';
                let progressBarClass = 'bg-success';
                let statusText = '預算合理，符合度高';
                
                if (matchedCount === 0) {
                    statusClass = 'warning';
                    progressBarClass = 'bg-warning';
                    statusText = '目前尚無符合的專家';
                } else if (percentage < 30) {
                    statusClass = 'danger';
                    progressBarClass = 'bg-danger';
                    statusText = '符合專家較少，建議調整預算';
                } else if (percentage < 60) {
                    statusClass = 'warning';
                    progressBarClass = 'bg-warning';
                    statusText = '符合度中等';
                }
                
                // 根據預算狀態與是否有專家設定提示（沒專家時不顯示「高於／低於市場」以免矛盾）
                let budgetAdvice = '';
                const isRealData = result.is_real_data || false;
                
                if (matchedCount === 0) {
                    if (expertsTagMatchOnly > 0 && unitsUsedByTagMatched.length > 0) {
                        const unitList = unitsUsedByTagMatched.join('、');
                        budgetAdvice = `<div class="small text-warning mt-2"><i class="fas fa-ruler-combined me-1"></i><strong>有 ${expertsTagMatchOnly} 位專家標籤相符</strong>，但使用的單位與您填寫的不一致。請在下方表格將工項「單位」改為：<strong>${unitList}</strong>，再重新按預媒合測試。</div>`;
                    } else {
                        budgetAdvice = '<div class="small text-warning mt-2"><i class="fas fa-info-circle me-1"></i>目前資料庫中尚無符合此項目（分類／標籤）的專家，與預算高低無關。請確認專案分類與工項標籤 (TAGS) 是否與專家端一致；單位僅供對照，不參與篩選。</div>';
                    }
                } else if (budgetStatus === 'low') {
                    budgetAdvice = '<div class="small text-warning mt-2"><i class="fas fa-arrow-down me-1"></i>您的預算低於市場平均成交價約 20%，可能獲得較少回應</div>';
                } else if (budgetStatus === 'high') {
                    budgetAdvice = '<div class="small text-success mt-2"><i class="fas fa-arrow-up me-1"></i>您的預算高於市場平均成交價約 20%，預期獲得較多專家回應</div>';
                } else {
                    budgetAdvice = '<div class="small text-info mt-2"><i class="fas fa-check me-1"></i>您的預算在市場平均範圍內</div>';
                }
                
                // 更新顯示區域
                resultArea.style.display = 'block';
                
                // 更新卡片數據
                document.getElementById('budgetStatusPercent').innerHTML = `${percentage}<small class="fs-6">%</small>`;
                document.getElementById('budgetProgressBar').style.width = `${percentage}%`;
                document.getElementById('budgetProgressBar').className = `progress-bar ${progressBarClass}`;
                
                document.getElementById('matchExpertCount').textContent = matchedCount;
                document.getElementById('estimatedResponses').textContent = estimatedResponses;
                
                // 更新狀態說明
                document.getElementById('budgetStatusMessage').className = `alert alert-${statusClass} mb-0`;
                document.getElementById('budgetStatusText').innerHTML = `
                    <strong>${statusText}</strong><br>
                    <span class="text-success small"><i class="fas fa-check-double me-1"></i>已納入 <strong>${itemsWithBudget.length}</strong> 個勾選項目（非全部項目）</span><br>
                    總預算區間中點：<strong>${(totalBudget || 0).toLocaleString()} 元</strong>
                    <small class="text-muted">（${itemsWithBudget.length} 個勾選項目加總：${totalBudgetMin.toLocaleString()}～${totalBudgetMax.toLocaleString()} 元，中點 = (${totalBudgetMin.toLocaleString()}+${totalBudgetMax.toLocaleString()})÷2）</small>
                    ${budgetAdvice}
                `;
                
                // 詳細分析內容（顯示邏輯：先篩單位→再算預算區間內人數，避免「0 專家卻有市場價」的混淆）
                const quantityNote = useUnitPricing && repQty && repUnit
                    ? `<p class="mb-2 small text-success"><i class="fas fa-calculator me-1"></i><strong>已依數量與單位計算：</strong>使用「單價×數量」與專家階梯定價（數量不同報價不同）比對，代表數量 ${repQty} ${repUnit}。</p>`
                    : '';
                const tagMatchUnitHint = (totalCount === 0 && expertsTagMatchOnly > 0 && unitsUsedByTagMatched.length > 0)
                    ? `<li class="text-success"><strong>有 ${expertsTagMatchOnly} 位專家標籤相符</strong>，請將工項單位改為：${unitsUsedByTagMatched.join('、')} 後再試。</li>`
                    : '';
                const totalInCategoryLine = (isRealData && totalInCategory !== totalCount)
                    ? `<li>該分類總專家數：${totalInCategory} 位</li><li>符合標籤條件的專家：${totalCount} 位（單位僅供對照，不參與篩選）</li>${tagMatchUnitHint}`
                    : `<li>該分類總專家數：${totalCount} 位${!isRealData ? '（模擬數據）' : ''}</li>${tagMatchUnitHint}`;
                // 有「數量×單位」時，後端回傳的是單價；與您預算比對的是總價，故顯示總價（單價×數量）才不會矛盾
                const marketTotalDisplay = (useUnitPricing && repQty) ? Math.round(avgMarketPrice * repQty) : avgMarketPrice;
                const marketPriceLine = avgMarketPrice > 0
                    ? `<li>${noExpertsForUnit ? '參考市場價（該子分類）：' : '市場估算成交價（總價）：'}約 ${marketTotalDisplay.toLocaleString()} 元${useUnitPricing && repQty ? ` <span class="text-muted">（單價約 ${avgMarketPrice.toLocaleString()} 元 × 數量 ${repQty}）</span>` : ''}${noExpertsForUnit ? ' <span class="text-warning">目前無符合此單位的專家</span>' : ''}</li>`
                    : '';
                document.getElementById('detailedAnalysisContent').innerHTML = `
                    ${quantityNote}
                    <p class="mb-2"><strong>媒合範圍分析：</strong></p>
                    <ul class="mb-2">
                        <li>您的預算區間：${totalBudgetMin.toLocaleString()} ~ ${totalBudgetMax.toLocaleString()} 元</li>
                        <li>媒合區間：${totalBudgetMin.toLocaleString()} ~ ${totalBudgetMax.toLocaleString()} 元（±20%）</li>
                        ${totalInCategoryLine}
                        <li><strong>報價區間符合的專家：${matchedCount} 位</strong>（${totalCount > 0 ? `在符合單位／標籤條件的專家中，${percentage}% 報價落在您預算內` : '需先有符合單位／標籤條件的專家才能比對預算'}）</li>
                        ${marketPriceLine}
                    </ul>
                    <p class="mb-0 small text-muted">
                        <i class="fas fa-lightbulb me-1"></i>
                        <strong>說明：</strong>${totalCount === 0 ? '目前無符合標籤條件的專家，故不顯示市場估算價。請確認工項標籤 (TAGS) 是否與專家端一致；單位僅供對照，不參與篩選。' : '上列「市場估算成交價」與您的預算區間同為總價，可比較預算是否高於或低於市場。'}
                        ${percentage >= 60 && matchedCount > 0 ? '您的預算在合理範圍內，預期可獲得足夠的專家回應。' : totalCount > 0 && matchedCount === 0 ? '建議適度調整預算以獲得更多專家回應。' : ''}
                    </p>
                `;
                
                // 同類專家常用標籤（供發案方參考修正工項 TAGS）
                const expertTagsBlock = document.getElementById('expertTagsSuggestionBlock');
                const expertTagsList = document.getElementById('expertTagsSuggestionList');
                if (expertTagsBlock && expertTagsList) {
                    const expertTags = result.expert_tags_in_category || [];
                    if (expertTags.length > 0) {
                        expertTagsBlock.style.display = 'block';
                        expertTagsList.innerHTML = expertTags.map(({ tag, count }) =>
                            `<span class="badge bg-light text-dark border me-1 mb-1" style="cursor:pointer" role="button" tabindex="0" data-tag="${attrEscape(tag)}" onclick="addRecommendedTagToSelectedItems(this)" onkeydown="if(event.key==='Enter')addRecommendedTagToSelectedItems(this)" title="點擊加入已勾選工項的標籤並儲存（${count} 位專家使用）">${attrEscape(tag)} <small class="text-muted">${count}</small></span>`
                        ).join('');
                    } else {
                        expertTagsBlock.style.display = 'none';
                    }
                }
                
            } catch (error) {
                console.error('❌ 預媒合測試失敗:', error);
                const resultArea = document.getElementById('preMatchResultArea');
                if (resultArea) {
                    resultArea.style.display = 'block';
                    document.getElementById('budgetStatusMessage').className = 'alert alert-danger mb-0';
                    document.getElementById('budgetStatusText').innerHTML = `<i class="fas fa-exclamation-circle me-2"></i>預媒合測試失敗：${error.message}`;
                    const expertTagsBlock = document.getElementById('expertTagsSuggestionBlock');
                    if (expertTagsBlock) expertTagsBlock.style.display = 'none';
                } else {
                    alert('❌ 預媒合測試失敗：' + error.message);
                }
            }
        }

        function addNewItem() {
            window.location.href = `project-items.html?id=${projectId}&action=new`;
        }

        // 選擇管理（預媒合／送出媒合只會用「已勾選」的項目）
        function updateSelection() {
            const itemChecked = document.querySelectorAll('.item-checkbox:checked').length;
            const descChecked = document.querySelectorAll('.item-desc-checkbox:checked').length;
            const count = itemChecked + descChecked;
            
            // 更新選擇數量顯示
            document.getElementById('selectedCount').textContent = `已選 ${count} 項`;
            
            // 顯示/隱藏批量操作列
            const actionsBar = document.getElementById('batchActionsBar');
            if (count > 0) {
                actionsBar.style.display = 'block';
            } else {
                actionsBar.style.display = 'none';
            }
        }

        // 全選/取消全選
        function toggleSelectAll(checkbox) {
            const itemCheckboxes = document.querySelectorAll('.item-checkbox');
            const descCheckboxes = document.querySelectorAll('.item-desc-checkbox');
            itemCheckboxes.forEach(cb => { cb.checked = checkbox.checked; });
            descCheckboxes.forEach(cb => { cb.checked = checkbox.checked; });
            updateSelection();
        }

        // 清除選擇
        function clearSelection() {
            document.querySelectorAll('.item-checkbox').forEach(cb => cb.checked = false);
            document.querySelectorAll('.item-desc-checkbox').forEach(cb => cb.checked = false);
            const selectAllEl = document.getElementById('selectAll');
            if (selectAllEl) selectAllEl.checked = false;
            updateSelection();
        }

        /** 捲動到「分包項目」表格區，方便使用者找到「送出媒合」按鈕 */
        function scrollToSendMatch() {
            const el = document.getElementById('projectItemsCard');
            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // 從選中項目建立統包組
        async function createPackageFromSelected() {
            const checkboxes = document.querySelectorAll('.item-checkbox:checked');
            const selectedIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedIds.length < 2) {
                alert('⚠️ 請至少選擇 2 個項目才能組成統包');
                return;
            }

            const groupName = prompt('請輸入統包組名稱:', `統包組 ${Date.now().toString().slice(-4)}`);
            if (!groupName) return;

            await createPackageGroup(selectedIds, groupName);
            clearSelection();
        }

        // 建立統包組（調用資料庫函數）
        async function createPackageGroup(itemIndices, groupName) {
            try {
                // itemIndices 是選中項目的索引，需要轉換為實際的 item IDs
                // 但目前表格中的項目是從 description.items 解析的，沒有 ID
                // 需要先將這些項目保存到 project_items 表
                
                alert('⚠️ 統包組功能需要先將項目保存到資料庫\n\n請點擊「管理分包項目」按鈕，在項目管理頁面中創建統包組。');
                
                // TODO: 實現完整統包組功能
                // 步驟 1: 將 description.items 保存到 project_items 表
                // 步驟 2: 調用資料庫函數 create_package_group
                // 步驟 3: 重新載入並顯示統包組
                
            } catch (error) {
                console.error('❌ 建立統包組失敗:', error);
                alert('❌ 建立統包組失敗：' + error.message);
            }
        }

        // 送出選中項目進行媒合
        async function publishSelectedItems(ev) {
            const checkboxes = document.querySelectorAll('.item-checkbox:checked');
            const selectedIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedIds.length === 0) {
                alert('⚠️ 請至少選擇 1 個項目');
                return;
            }

            if (!confirm(`確定要將選中的 ${selectedIds.length} 個項目送出媒合嗎？\n\n媒合引擎將會：\n✓ 分析每個項目需求\n✓ 搜尋符合的專家\n✓ 計算媒合分數\n✓ 建立媒合記錄`)) {
                return;
            }

            const btn = (ev && ev.currentTarget) ? ev.currentTarget : (ev && ev.target ? ev.target.closest('button') : null);
            const originalText = btn ? btn.innerHTML : '';

            try {
                // 顯示載入中
                if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>媒合中...'; }
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>媒合中...';
                
                // 使用已載入的專案 ID（與 loadProjectData 一致），避免 URL 參數與後端不一致
                const pid = (projectData && projectData.id) ? projectData.id : projectId;
                if (!pid) {
                    throw new Error('找不到專案，請重新從「我的專案」進入此頁');
                }
                // 與預媒合相同：專案資料由前端一併帶上（前端已用登入者身份讀過 projectData），後端不再查 projects 就不會「找不到專案」
                const session = await AuthService.getSession();
                const headers = { 'Content-Type': 'application/json' };
                if (session?.access_token) headers['Authorization'] = 'Bearer ' + session.access_token;
                const response = await fetch('/api/match/run-split', {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({
                        project_id: pid,
                        item_ids: selectedIds,
                        owner_id: projectData?.owner_id || null,
                        project_location: projectData?.project_location || null
                    })
                });

                const resultText = await response.text();
                let result;
                try { result = resultText ? JSON.parse(resultText) : {}; } catch (_) { result = { error: '伺服器回傳異常' }; }
                if (!response.ok) {
                    throw new Error(result.error || result.details || '發包失敗');
                }

                // 顯示結果
                let resultMessage = `✅ ${result.message}\n\n`;
                resultMessage += `📊 媒合統計：\n`;
                resultMessage += `- 發包項目數：${result.total_items}\n`;
                resultMessage += `- 媒合專家數：${result.total_matches}\n\n`;
                
                if (result.results && result.results.length > 0) {
                    resultMessage += `📋 各項目媒合結果：\n`;
                    result.results.forEach(r => {
                        resultMessage += `\n【${r.item_name}】\n`;
                        resultMessage += `  媒合到 ${r.matched_count} 位專家\n`;
                        if (r.top_matches && r.top_matches.length > 0) {
                            resultMessage += `  Top 3 專家：\n`;
                            r.top_matches.slice(0, 3).forEach((m, i) => {
                                resultMessage += `    ${i + 1}. ${m.listing_title} (分數: ${m.score})\n`;
                            });
                        }
                    });
                }
                
                alert(resultMessage);
                
                // 恢復按鈕、重新載入項目與媒合專家列表（含廠商聯絡資料）
                if (btn) { btn.disabled = false; btn.innerHTML = originalText; }
                clearSelection();
                await loadProjectItems();
                await loadMatchedExperts();
                // 捲動到「④ 已媒合專家」區塊，讓使用者看到更新後的廠商列表
                const section4 = document.getElementById('sectionMatchedExperts');
                if (section4) section4.scrollIntoView({ behavior: 'smooth', block: 'start' });

            } catch (error) {
                console.error('❌ 送出媒合失敗:', error);
                alert('❌ 送出媒合失敗：' + error.message);
                
                if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>送出媒合'; }
            }
        }

        // 線上對話：目前對話 id、專家 id/名稱（Modal 用）
        let currentConversationId = null;
        let currentContactExpertId = null;
        let currentContactExpertName = '';

        async function contactExpert(buttonEl) {
            const expertId = (buttonEl && buttonEl.dataset?.expertId) ? buttonEl.dataset.expertId : buttonEl;
            const expertName = (buttonEl && buttonEl.dataset?.expertName) ? buttonEl.dataset.expertName : '廠商';
            if (!expertId) { alert('無法取得專家資訊'); return; }
            const pid = projectId || getProjectIdFromUrl();
            if (!pid) { alert('無法取得專案 ID'); return; }
            const session = await AuthService.getSession();
            const token = session?.access_token;
            if (!token) { alert('請先登入'); return; }

            document.getElementById('contactExpertName').textContent = expertName;
            document.getElementById('contactExpertMessagesEmpty').textContent = '載入對話中...';
            document.getElementById('contactExpertMessages').innerHTML = '<p class="text-muted text-center py-4">載入對話中...</p>';
            document.getElementById('contactExpertInput').value = '';
            currentContactExpertId = expertId;
            currentContactExpertName = expertName;
            currentConversationId = null;

            const modal = new bootstrap.Modal(document.getElementById('contactExpertModal'));
            modal.show();

            try {
                const res = await fetch(`/api/projects/${pid}/conversations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({ expert_id: expertId })
                });
                const data = await res.json();
                if (!res.ok) {
                    document.getElementById('contactExpertMessages').innerHTML = '<p class="text-danger text-center py-4">' + (data.error || '無法載入對話') + '</p>';
                    return;
                }
                currentConversationId = data.conversation_id;
                renderContactExpertMessages(data.messages || []);
            } catch (e) {
                document.getElementById('contactExpertMessages').innerHTML = '<p class="text-danger text-center py-4">連線失敗，請稍後再試</p>';
            }
        }

        function renderContactExpertMessages(messages) {
            const container = document.getElementById('contactExpertMessages');
            if (!messages.length) {
                container.innerHTML = '<p class="text-muted text-center py-4" id="contactExpertMessagesEmpty">尚無訊息，輸入下方內容開始對話</p>';
                return;
            }
            document.getElementById('contactExpertMessagesEmpty')?.remove();
            container.innerHTML = messages.map(m => {
                const time = m.created_at ? new Date(m.created_at).toLocaleString('zh-TW', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : '';
                const align = m.is_mine ? 'end' : 'start';
                const bg = m.is_mine ? 'primary' : 'light';
                return `<div class="d-flex justify-content-${align} mb-2"><div class="rounded px-3 py-2 bg-${bg} text-${m.is_mine ? 'white' : 'dark'} shadow-sm" style="max-width: 80%;"><div class="small opacity-75">${escapeHtml(m.body)}</div><div class="small mt-1 opacity-75">${time}</div></div></div>`;
            }).join('');
            container.scrollTop = container.scrollHeight;
        }

        async function sendExpertMessage() {
            if (!currentConversationId) return;
            const input = document.getElementById('contactExpertInput');
            const body = (input.value || '').trim();
            if (!body) return;
            const session = await AuthService.getSession();
            const token = session?.access_token;
            if (!token) { alert('請先登入'); return; }

            const btn = document.getElementById('contactExpertSendBtn');
            btn.disabled = true;
            try {
                const res = await fetch(`/api/conversations/${currentConversationId}/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({ body })
                });
                const data = await res.json();
                if (!res.ok) {
                    alert(data.error || '發送失敗');
                    return;
                }
                input.value = '';
                const list = document.querySelectorAll('#contactExpertMessages .d-flex');
                const lastMsg = data.message;
                if (lastMsg) {
                    const time = lastMsg.created_at ? new Date(lastMsg.created_at).toLocaleString('zh-TW', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : '';
                    const html = `<div class="d-flex justify-content-end mb-2"><div class="rounded px-3 py-2 bg-primary text-white shadow-sm" style="max-width: 80%;"><div class="small opacity-75">${escapeHtml(lastMsg.body)}</div><div class="small mt-1 opacity-75">${time}</div></div></div>`;
                    document.getElementById('contactExpertMessages').insertAdjacentHTML('beforeend', html);
                    document.getElementById('contactExpertMessages').scrollTop = document.getElementById('contactExpertMessages').scrollHeight;
                }
            } catch (e) {
                alert('連線失敗，請稍後再試');
            }
            btn.disabled = false;
        }
        
        // ==================== 封面圖片管理功能 ====================
        
        /**
         * 上傳封面圖片
         */
        async function uploadCoverImage() {
            // 建立檔案選擇器
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                // 檢查檔案大小（限制 5MB）
                if (file.size > 5 * 1024 * 1024) {
                    alert('檔案大小不可超過 5MB');
                    return;
                }
                
                try {
                    // 顯示載入中
                    const img = document.getElementById('projectCoverImage');
                    const originalSrc = img.src;
                    img.style.opacity = '0.5';
                    
                    // 上傳到 Supabase Storage
                    // 清理檔名：移除中文和特殊字元，避免 Storage 錯誤
                    const timestamp = Date.now();
                    const ext = file.name.split('.').pop();
                    const cleanName = file.name
                        .replace(/\.[^.]+$/, '')  // 移除副檔名
                        .replace(/[^a-zA-Z0-9]/g, '-')  // 非英數字轉 -
                        .replace(/-+/g, '-')  // 合併連續 -
                        .replace(/^-|-$/g, '')  // 移除頭尾 -
                        .substring(0, 50);  // 限制長度
                    const fileName = `project-covers/${projectId}/${timestamp}-${cleanName || 'cover'}.${ext}`;
                    const { data, error } = await AuthService.supabase.storage
                        .from('project-images')
                        .upload(fileName, file, {
                            cacheControl: '3600',
                            upsert: false
                        });
                    
                    if (error) throw error;
                    
                    // 取得公開 URL
                    const { data: { publicUrl } } = AuthService.supabase.storage
                        .from('project-images')
                        .getPublicUrl(fileName);
                    
                    // 更新資料庫
                    const { error: updateError } = await AuthService.supabase
                        .from('projects')
                        .update({
                            cover_image_type: 'uploaded',
                            cover_image_url: publicUrl,
                            cover_image_category: null
                        })
                        .eq('id', projectId);
                    
                    if (updateError) throw updateError;
                    
                    // 更新顯示
                    img.src = publicUrl;
                    img.style.opacity = '1';
                    projectData.cover_image_type = 'uploaded';
                    projectData.cover_image_url = publicUrl;
                    
                    alert('✅ 封面圖片已更新');
                    
                } catch (error) {
                    console.error('上傳失敗:', error);
                    alert('❌ 上傳失敗：' + error.message);
                    img.style.opacity = '1';
                }
            };
            
            input.click();
        }
        
        /**
         * AI 生成封面圖片
         */
        async function generateAICoverImage() {
            try {
                // 載入用戶點數
                await loadUserCredits();
                
                // 填充 Modal 內容
                document.getElementById('aiModalTitle').textContent = projectData.title || '未命名專案';
                document.getElementById('aiModalCategory').textContent = projectData.category || '未分類';
                document.getElementById('aiModalDescription').textContent = projectData.description || '無描述';
                
                // 載入專案圖片
                await loadProjectImages();
                
                // 更新 AI 提示詞預覽
                updateAIPromptPreview();
                
                // 顯示 Modal
                aiGenerateModal.show();
                
            } catch (error) {
                console.error('開啟 AI 生成失敗:', error);
                alert('❌ ' + error.message);
            }
        }
        
        /**
         * 載入用戶點數餘額
         */
        async function loadUserCredits() {
            try {
                const { data, error } = await AuthService.supabase
                    .from('user_credits')
                    .select('balance')
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (error && error.code !== 'PGRST116') throw error;
                
                const balance = data?.balance || 0;
                document.getElementById('currentCredits').textContent = balance;
                
                // 檢查點數是否足夠
                if (balance < 20) {
                    document.getElementById('confirmAIBtn').disabled = true;
                    document.getElementById('currentCredits').parentElement.classList.add('text-danger');
                    document.getElementById('currentCredits').parentElement.innerHTML = 
                        '<i class="fas fa-exclamation-triangle me-2"></i>點數不足（需要 20 點）';
                }
            } catch (error) {
                console.error('載入點數失敗:', error);
                document.getElementById('currentCredits').textContent = '載入失敗';
            }
        }
        
        /** 將相對路徑轉為絕對 URL（Supabase 等已是 https 則不變） */
        function toAbsoluteUrl(url) {
            if (!url || typeof url !== 'string') return '';
            if (url.startsWith('http://') || url.startsWith('https://')) return url;
            const origin = window.location.origin || '';
            return (origin + (url.startsWith('/') ? '' : '/') + url);
        }

        /**
         * 顯示專案設計圖（description.files）：縮圖 + 可複製的圖片網址
         */
        function renderDesignImages(project) {
            const card = document.getElementById('designImagesCard');
            const listEl = document.getElementById('designImagesList');
            const emptyEl = document.getElementById('designImagesEmpty');
            let files = [];
            if (project && project.description) {
                try {
                    const desc = typeof project.description === 'string' ? JSON.parse(project.description) : project.description;
                    if (desc.files && Array.isArray(desc.files)) files = desc.files;
                } catch (e) {}
            }
            if (files.length === 0) {
                listEl.innerHTML = '';
                emptyEl.classList.remove('d-none');
                return;
            }
            emptyEl.classList.add('d-none');
            listEl.innerHTML = files.map((f, i) => {
                const url = (f.url || f).toString();
                const absUrl = toAbsoluteUrl(url);
                const name = (f.filename || f.originalname || `圖片${i + 1}`).toString();
                return `
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card border h-100">
                            <img src="${absUrl}" class="card-img-top" style="height: 120px; object-fit: cover;" alt="${name}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22><rect fill=%22%23eee%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2250%22 fill=%22%23999%22 text-anchor=%22middle%22 dy=%22.3em%22>無法載入</text></svg>'">
                            <div class="card-body p-2">
                                <small class="d-block text-truncate" title="${name}">${name}</small>
                                <div class="input-group input-group-sm mt-1">
                                    <input type="text" class="form-control form-control-sm" value="${absUrl}" readonly id="designImageUrl${i}">
                                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="navigator.clipboard.writeText(document.getElementById('designImageUrl${i}').value); this.textContent='已複製';">複製</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        /**
         * 載入專案圖片（含 description.files，供 AI 生成封面 Modal 使用）
         */
        async function loadProjectImages() {
            try {
                let allImages = [];
                // 1) 專案建立時上傳的設計圖（description.files）
                if (projectData && projectData.description) {
                    try {
                        const desc = typeof projectData.description === 'string' ? JSON.parse(projectData.description) : projectData.description;
                        if (desc.files && Array.isArray(desc.files))
                            allImages = desc.files.map(f => toAbsoluteUrl(f.url || f));
                    } catch (e) {}
                }
                // 2) project_items 的 images
                const { data: items, error } = await AuthService.supabase
                    .from('project_items')
                    .select('images')
                    .eq('project_id', projectId);
                if (!error && items && items.length > 0) {
                    items.forEach(item => {
                        if (item.images && Array.isArray(item.images))
                            item.images.forEach(u => allImages.push(toAbsoluteUrl(u)));
                    });
                }
                allImages = [...new Set(allImages)];

                document.getElementById('imageCount').textContent = allImages.length;
                const imagesContainer = document.getElementById('aiModalImages');
                if (allImages.length === 0) {
                    imagesContainer.innerHTML = '<p class="text-muted text-center">此專案暫無上傳圖片</p>';
                    document.getElementById('aiModalImagesCard').classList.add('d-none');
                } else {
                    document.getElementById('aiModalImagesCard').classList.remove('d-none');
                    imagesContainer.innerHTML = allImages.slice(0, 6).map(img => `
                        <div class="col-4 col-md-2">
                            <img src="${img}" class="img-fluid rounded" 
                                 style="width: 100%; height: 80px; object-fit: cover;" 
                                 alt="專案圖片" onerror="this.style.background='#eee';this.alt='無法載入';">
                        </div>
                    `).join('');
                    if (allImages.length > 6) {
                        imagesContainer.innerHTML += `
                            <div class="col-4 col-md-2">
                                <div class="bg-light rounded d-flex align-items-center justify-content-center" style="height: 80px;">
                                    <span class="text-muted">+${allImages.length - 6} 張</span>
                                </div>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('載入圖片失敗:', error);
                document.getElementById('aiModalImages').innerHTML = '<p class="text-danger">載入圖片失敗</p>';
            }
        }
        
        /**
         * 更新 AI 提示詞預覽
         */
        function updateAIPromptPreview() {
            const avoidConfidential = document.getElementById('avoidConfidential').checked;
            
            // 顯示/隱藏警告
            if (avoidConfidential) {
                document.getElementById('confidentialWarning').classList.add('d-none');
            } else {
                document.getElementById('confidentialWarning').classList.remove('d-none');
            }
            
            let prompt = '';
            
            if (avoidConfidential) {
                // 避開機密內容：只使用分類和基本風格
                prompt = `生成一張專業的${projectData.category || '專案'}封面圖片。

參考資訊：
- 分類：${projectData.category || '未分類'}
- 風格：現代、專業、簡潔
- 色調：符合${projectData.category || '該領域'}的專業形象

⚠️ 已啟用機密保護：不會使用您的專案描述和圖片內容`;
            } else {
                // 使用完整內容
                prompt = `根據以下專案資訊生成封面圖片：

專案名稱：${projectData.title || '未命名'}
分類：${projectData.category || '未分類'}
描述：${(projectData.description || '無描述').substring(0, 200)}${projectData.description?.length > 200 ? '...' : ''}

⚠️ 將參考您的完整專案描述和圖片內容生成`;
            }
            
            document.getElementById('aiPromptPreview').value = prompt;
        }
        
        /**
         * 確認 AI 生成
         */
        async function confirmAIGeneration() {
            const avoidConfidential = document.getElementById('avoidConfidential').checked;
            
            if (!avoidConfidential) {
                if (!confirm('確定要使用完整專案內容生成封面圖嗎？AI 將會分析您的專案描述和圖片。')) {
                    return;
                }
            }
            
            try {
                const btn = document.getElementById('confirmAIBtn');
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>生成中...';
                
                const img = document.getElementById('projectCoverImage');
                img.style.opacity = '0.5';
                
                // 呼叫 AI 生成 API
                const response = await fetch('/api/ai/generate-project-cover', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        projectId: projectId,
                        title: projectData.title,
                        description: avoidConfidential ? null : projectData.description,
                        category: projectData.category,
                        avoidConfidential: avoidConfidential,
                        useImages: !avoidConfidential
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || '生成失敗');
                }
                
                const result = await response.json();
                
                // 更新顯示
                img.src = result.imageUrl;
                img.style.opacity = '1';
                projectData.cover_image_type = 'ai_generated';
                projectData.cover_image_url = result.imageUrl;
                
                // 關閉 Modal
                aiGenerateModal.hide();
                
                alert(`✅ AI 封面圖片已生成！\n消耗點數：${result.pointsUsed} 點\n剩餘點數：${result.remainingCredits} 點`);
                
                // 更新點數顯示
                document.getElementById('currentCredits').textContent = result.remainingCredits;
                
            } catch (error) {
                console.error('AI 生成失敗:', error);
                alert('❌ ' + error.message);
            } finally {
                const btn = document.getElementById('confirmAIBtn');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic me-2"></i>確認生成（20 點）';
                img.style.opacity = '1';
            }
        }
        
        /**
         * 使用預設圖片
         */
        async function useDefaultImage() {
            try {
                const img = document.getElementById('projectCoverImage');
                img.style.opacity = '0.5';
                
                // 更新資料庫
                const { error } = await AuthService.supabase
                    .from('projects')
                    .update({
                        cover_image_type: 'default',
                        cover_image_url: null,
                        cover_image_category: projectData.category
                    })
                    .eq('id', projectId);
                
                if (error) throw error;
                
                // 取得預設圖片
                const defaultImage = getCategoryDefaultImage(projectData.category);
                
                // 更新顯示
                img.src = defaultImage;
                img.style.opacity = '1';
                projectData.cover_image_type = 'default';
                projectData.cover_image_url = null;
                projectData.cover_image_category = projectData.category;
                
                alert('✅ 已恢復為預設圖片');
                
            } catch (error) {
                console.error('更新失敗:', error);
                alert('❌ 更新失敗：' + error.message);
                img.style.opacity = '1';
            }
        }
    </script>
    <div id="site-footer"></div>
    <script src="/js/site-footer.js"></script>
</body>
</html>
