# Phase 1.8：廠商端媒合專案 — 規劃

**最後更新**：2026-02-06  
**狀態**：✅ 第一版已實作（API + 專家端 UI）

---

## 一、目標與原則

### 1.1 目標

- **由報價廠商（專家）來媒合專案需求**：專家端可主動尋找、篩選「開放中的專案」，並進行預媒合或正式媒合。
- **與發案端互補**：發案端是「專案 → 勾選工項 → 送出媒合 → 系統推薦廠商」；廠商端是「我的報價 → 瀏覽適合的專案 → 預媒合／申請媒合」。

### 1.2 原則（與現有一致）

- **可預媒合**：專家在正式媒合前，可先看「自己符合多少筆專案」或「某專案自己是否符合」。
- **不鎖聯絡方式**：媒合成功後，**雙方直接看到聯絡方式**（電話、LINE、Email），無申請解鎖、付費解鎖、審核流程。
- 價格範圍僅用於後台媒合算法，不在前端公開顯示。

---

## 二、流程概覽

```
專家登入 → 瀏覽「可媒合專案」列表（依分類/標籤/地區篩選）
         → 預媒合：看自己符合多少專案（或單一專案是否符合）
         → 主動申請媒合（或一鍵媒合符合的專案）
         → 媒合成功 → 雙方直接看到聯絡方式 + 可站內聯繫
```

---

## 三、功能細項（規劃）

### 3.1 專家端「可媒合專案」列表

- **資料來源**：專案已存在、且至少有一筆「已發包」或「開放媒合」的 `project_items`（或依產品定義：例如專案狀態為 open_for_match）。
- **列表內容**（不暴露預算具體數字）：專案標題、分類、子分類、地區、工項摘要、標籤、發包項目數等。
- **篩選**：依專家自己的報價（listings）所屬分類／子分類／標籤／服務區域，篩選出「可能符合」的專案。
- **排除**：已與該專家媒合過的專案（已有 match 記錄）可標示或排除，避免重複。

### 3.2 預媒合（專家端）

- **情境 A — 看自己符合多少專案**：  
  輸入：當前登入專家（其 listings）。  
  輸出：符合條件的專案數量（或列表筆數）、可選「市場估算」說明（與發案端預媒合類似，僅統計不洩漏個資）。
- **情境 B — 看單一專案自己是否符合**：  
  輸入：`project_id`、當前專家。  
  輸出：是否符合、預估媒合分數區間或「符合/不符合」+ 簡要原因（例如：分類符合、標籤重疊、地區在服務範圍內）。

- **API 建議**：
  - `GET /api/match/vendor/preview-count`：回傳當前專家「符合的專案數量」或依篩選條件的統計。
  - `POST /api/match/vendor/preview-project`：傳入 `project_id`，回傳該專家對此專案的預媒合結果（是否符合、分數區間或簡要原因）。

- **與現有演算法對齊**：使用與 run-split 相同的評分邏輯（分類、子分類、價格區間、標籤、地點過濾），僅視角改為「以專家為中心」查詢專案。

### 3.3 主動媒合（專家端）

- **觸發方式**（二擇一或並存，依產品決定）：
  - **方案 A**：專家對「單一專案」點選「申請媒合」→ 後端對該專案執行一次以該專家為對象的媒合邏輯，若通過則寫入 `matches`。
  - **方案 B**：專家勾選多筆專案後「一鍵媒合」→ 後端對每筆專案跑媒合（僅考慮該專家），通過者寫入 `matches`。

- **寫入**：仍寫入既有 `matches` 表（project_id、listing_id、expert_id、match_score、match_reasons 等），與發案端 run-split 產生的記錄格式一致，方便兩端共用「媒合結果」與「聯絡方式直接顯示」。

- **API 建議**：
  - `POST /api/match/vendor/apply`  
    Body: `{ project_id, listing_id? }`  
    若未傳 listing_id，則以該專家所有符合該專案工項的 listing 擇一或全部寫入 match（依產品規則）。

### 3.4 聯絡方式與聯繫

- **不鎖聯絡方式**：媒合成功後，發案者在專案詳情「媒合專家列表」看到專家聯絡方式；專家在「媒合專案」或「專案詳情」看到發案者聯絡方式（若發案者已填且開放）。
- **站內聯繫**：沿用現有 conversations / messages 與「立即聯繫」Modal，專家端可增加「查看對話／回覆」入口。

### 3.5 前端頁面（建議）

- **expert/matched-projects.html**（既有）：可擴充為「我已媒合的專案」+ 入口到「可媒合專案」列表。
- **expert/browse-projects.html**（新增，或合併在 matched-projects 分頁）：可媒合專案列表、篩選、預媒合按鈕、申請媒合按鈕。
- **expert/project-detail.html**（專家查看專案詳情）：專案摘要、預媒合結果、申請媒合按鈕、媒合成功後顯示發案者聯絡方式與站內聯繫。

---

## 四、資料與 API 對齊

- **matches 表**：沿用既有結構；`source` 或備註可區分「發案端 run-split」與「廠商端申請」。
- **專案可見性**：需定義「開放給廠商瀏覽/媒合」的規則（例如：專案狀態、project_items 已發包狀態），避免未開放專案被廠商看到。
- **權限**：專家僅能對自己申請媒合、僅能看自己有權看到的專案與聯絡方式（媒合成功後）。

---

## 五、檢查清單（待執行時勾選）

- [x] 定義「可媒合專案」查詢條件（專案/項目狀態、可見範圍）：已發包 `project_items`（status=published）
- [ ] API：`GET /api/match/vendor/preview-count` 或等價（可選；目前以列表 + 單專案預媒合為主）
- [x] API：`POST /api/match/vendor/preview-project`
- [x] API：`POST /api/match/vendor/apply`
- [x] 專家端「可媒合專案」列表頁：`expert/browse-projects.html`
- [x] 專家端預媒合 UI（單專案預覽 Modal）
- [x] 專家端申請媒合按鈕與成功後聯絡方式顯示（「我已媒合的專案」顯示發案者聯絡方式）
- [x] 不鎖聯絡方式：發案者聯絡方式在媒合成功後對專家可見（`GET /api/match/vendor/my-matches` 回傳 contact）
- [x] 更新 PHASE.md、matchdo-roadmap.md、matchdo-todo.md 進度

---

## 六、與現有文件對應

- **媒合演算法**：與 `docs/MATCHING-ALGORITHM-V2.md`、`server.js` 內 run-split / preview 邏輯對齊，僅改為「以專家為查詢中心」。
- **聯絡方式原則**：與 `docs/matchdo-roadmap.md`、`docs/PHASE.md` 一致（媒合成功即顯示、不鎖、無解鎖流程）。
- **預媒合**：與發案端 `POST /api/match/preview` 概念對齊，改為專家端視角。
