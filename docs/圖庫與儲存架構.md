# 圖庫／儲存資料夾架構

更新：2026-02-06

---

## 一、雲端圖庫（主要）：Supabase Storage

目前**新上傳的圖片**皆存於 Supabase Storage，不再寫入本機 `uploads/`。  
對應的 **Bucket 與路徑** 如下。

### 1. Bucket：`project-images`

| 用途 | 路徑前綴 (pathPrefix) | 說明 |
|------|------------------------|------|
| 專案設計圖／AI 辨識上傳 | `{owner_id}` 或 `anon` | 首頁 AI 辨識、專案設計圖；path = `owner_id`（去掉連字號）或 `anon` |
| 專案封面 | 同上或專用子目錄 | 由專案詳情上傳封面時使用 |

**實際路徑範例**：`project-images/abc123def456/1738xxxx-xxxx.jpg`  
**取得 URL**：`supabase.storage.from('project-images').getPublicUrl(objectPath)` → 回傳 publicUrl 寫入 DB（如 `projects.description.files[].url`、專案封面欄位）。

---

### 2. Bucket：`custom-products`

| 用途 | 路徑前綴 (pathPrefix) | 說明 |
|------|------------------------|------|
| AI 生成產品圖 | `generated` | 產品設計 AI 生成的一張圖 |
| 客製產品上傳圖 | `product` | 分析客製產品時使用者上傳的圖片 |
| 廠商相關圖 | `manufacturer/{manufacturer_id}` | 廠商頭像／作品圖等（若後台有上傳） |

**實際路徑範例**：
- `custom-products/generated/1738xxxx-xxxx.png`
- `custom-products/product/1738xxxx-xxxx.jpg`
- `custom-products/manufacturer/{uuid}/1738xxxx-xxxx.jpg`

**文件曾提**：後台分類圖可放 `custom-products/portfolio/{category_key}/檔名`（見 `docs/portfolio-images-upload-and-seed.md`），實作依當時後台需求為準。

---

### 3. 建立與權限

- **建立方式**：在 Supabase Dashboard → Storage 執行 **`docs/create-storage-bucket.sql`**，會建立 `project-images`、`custom-products` 兩桶及 RLS policies。
- **權限**：公開讀取；已登入可上傳／更新；刪除僅限指定 admin email（腳本內可改）。

---

## 二、本機／專案內靜態圖（非使用者上傳）

| 路徑 | 說明 |
|------|------|
| **`/img/`**（對應 `public/img/` 或專案根底下 `img/`） | 全站靜態圖：favicon、預設圖等；部分頁面用 `../img/favicon.ico`、`/img/favicon.ico` |
| **`public/img/categories/`** | 分類預設圖，如 `default-project.svg`；後台或首頁顯示用 |
| **`public/iStudio-1.0.0/img/`** | iStudio 版型內建圖（含 categories 等） |
| **`public/admin/assets/.../img/`** | 後台版型用圖（如 flags、preloader） |

前端引用時多為：`/img/favicon.ico`、`/img/categories/default-project.svg`。

---

## 三、本機暫存（已棄用於新上傳）

| 路徑 | 說明 |
|------|------|
| **`uploads/`**（專案根目錄） | 舊版上傳暫存；目前 server 已改為 `multer.memoryStorage()`，**新上傳不再寫入**；`.gitignore` 已含 `uploads/`，僅保留 `app.use('/uploads', express.static(uploadDir))` 供舊連結相容 |

新圖一律存 Supabase，回傳與 DB 皆為 Supabase 的 **publicUrl**。

---

## 四、架構總覽（樹狀）

```
圖庫／儲存

├── 雲端（Supabase Storage）※ 主要圖庫
│   ├── project-images/
│   │   └── {owner_id 或 anon}/{timestamp}-{random}.{ext}   ← 專案設計圖、封面等
│   │
│   └── custom-products/
│       ├── generated/{檔名}                                  ← AI 生成產品圖
│       ├── product/{檔名}                                    ← 客製產品上傳圖
│       └── manufacturer/{manufacturer_id}/{檔名}             ← 廠商圖（若有）
│
├── 本機靜態（版型／預設圖）
│   ├── public/img/                     ← favicon、全站共用
│   │   └── categories/                 ← 分類預設圖，如 default-project.svg
│   ├── public/iStudio-1.0.0/img/       ← iStudio 版型圖
│   └── public/admin/.../img/            ← 後台版型圖
│
└── 本機暫存（舊）
    └── uploads/                         ← 已不用於新上傳，僅相容舊 URL
```

---

## 五、DB 與 URL 對應

- **專案**：`projects.description.files[].url`、專案封面欄位 → 存 **Supabase publicUrl**（或舊的 `/uploads/xxx`，待遷移）。
- **客製產品**：`custom_products` 相關欄位（如 `reference_image_url`、`ai_generated_image_url`、或分析流程的 `image_urls`）→ 存 **Supabase publicUrl**。
- **廠商**：若實作廠商作品圖，URL 存於廠商表或 `manufacturer_portfolio`，同樣為 **Supabase publicUrl**。

前端顯示時直接使用後端／DB 回傳的完整 URL，不需再拼路徑。
