# 分類系統：正確的原始設計（依專案文件）

依 `docs/` 內既有 schema 與後端說明整理，**前後端應只使用同一組資料**。

---

## 〇、原始分類項目（唯一正本）

- **出處**：`docs/insert-categories-and-subcategories.sql`、`docs/MATCHING-ALGORITHM-V2.md`
- **主分類 7 個**：`home` 居家裝潢、`video` 影片製作、`web` 網站開發、`app` APP 開發、`ai` AI 導入、`marketing` 數位行銷、`design` 平面設計
- **子分類共 81 個**，每筆有英文 key（如 `home__interior_design`）與中文 name（如 室內設計）
- **預設檔**：`public/config/default-categories.json` 與上述 SQL 一致，後台「一鍵匯入預設分類」會寫入此 7+81 至資料庫。

---

## 一、資料來源（唯一）

- **主分類**：表 `ai_categories`  
  欄位：`key`, `name`, `prompt`, `image_url`, `updated_at`  
  僅存主分類，不存子分類名單。

- **子分類**：表 `ai_subcategories`  
  欄位：`key`, `name`, `category_key`, **`prompt`**, `image_url`, **`form_config`**, `sort_order`, `created_at`, `updated_at`  
  每筆一則子分類，`category_key` 對應 `ai_categories.key`。

出處：`docs/ai-subcategories-schema.sql`、`docs/backend-structure.md`、`docs/migrate-categories-split.sql`。

---

## 二、欄位用途（不要混用）

| 表 / 欄位 | 用途 |
|-----------|------|
| **ai_categories.prompt** | 該主分類的 AI 估價提示詞（可含 `{subcategory}`，由後端替換成子分類名稱）。 |
| **ai_subcategories.prompt** | 該子分類的 AI 提示詞；**空白則繼承主分類**。為獨立欄位，不應塞進 `form_config`。 |
| **ai_subcategories.form_config** | 專案詳情頁「分類專屬需求」的**動態欄位**（必問問題）。格式為 JSONB：陣列或物件，例如 `[{ "name", "label", "type", "required", ... }]`。不用來存子分類的 AI 提示詞。 |

出處：`docs/ai-subcategories-schema.sql`（有 `prompt` 與 `form_config` 兩欄）、`docs/subcategory-default-fields.md`（form_config 為欄位陣列）。

---

## 三、API 與資料流（同一組資料）

- **GET /api/categories**  
  只從 `ai_categories` + `ai_subcategories` 讀取，組出：
  - 每個主分類：`key`, `name`, `prompt`, `sub`（子分類名稱陣列）, `sub_configs`（子分類名稱 → 該子分類的設定，應含 `prompt` 與必要時 `form_config` 的對應）。
- **PUT /api/categories**  
  只寫入 `ai_categories` 與 `ai_subcategories`，不寫入別的表或本地 JSON 當作正式來源。
- **GET /api/subcategories?category_key=xxx**  
  只從 `ai_subcategories` 讀取該主分類下的子分類與 `form_config`（及必要時的 prompt）。

前台、後台、AI 估價全部以以上 API 為準，**不應再從 js/ai-categories.js 或本地 JSON 當主要來源**（文件：`matchdo-todo.md` 已註「前後台雙重來源需統一」、「將 ai-categories.js 改為純備援」）。

---

## 四、子分類 key 與名稱

- **key**：唯一，建議格式 `主分類key__子分類英文或代碼`，例：`home__cleaning`、`wedding__photography`。  
  出處：`docs/ai-subcategories-schema.sql` COMMENT。
- **name**：顯示名稱（中文），例：清潔服務、室內設計。

---

## 五、form_config 的原始用途

- 定義專案詳情頁「分類專屬需求」的欄位（必填/選填）。
- 欄位格式：`name`, `label`, `type`（text/number/textarea/select）, `required`, `unit`, `placeholder`, `options`。  
  出處：`docs/subcategory-default-fields.md`。
- 寫入方式：後台「分類管理」編輯、或執行 `docs/seed-subcategory-form-config.sql`、`docs/seed-home-subcategory-fields.sql` 等。

---

## 六、總結（原本的分類方式）

1. **唯一資料來源**：主分類 = `ai_categories`，子分類 = `ai_subcategories`；API 只讀寫這兩張表。
2. **主分類提示詞**：存在 `ai_categories.prompt`。
3. **子分類提示詞**：存在 **`ai_subcategories.prompt`**（獨立欄位），空白時繼承主分類；**不要**把子分類提示詞塞進 `form_config`。
4. **子分類表單設定**：存在 **`ai_subcategories.form_config`**，只放動態欄位定義，不放 AI 提示詞。
5. **前後端一致**：後台與前台都透過 GET/PUT `/api/categories` 與 `/api/subcategories` 使用同一組資料，不再使用雙重來源。

若目前實作把「子分類提示詞」寫在 `form_config` 裡，應改回使用 `ai_subcategories.prompt`，並讓 GET/PUT 都依此讀寫，才符合上述原始設計。
