<!DOCTYPE html>
<html lang="zh-TW" data-theme="custom">
<head>
    <meta charset="utf-8">
    <title>廠商詳情 - MATCHDO 合做</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="index, follow">
    <link rel="icon" href="/img/favicon.ico">
    <link rel="apple-touch-icon" href="/img/apple-touch-icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&family=Space+Grotesk&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/theme-custom.css" rel="stylesheet">

    <style>
        .profile-hero {
            background: linear-gradient(135deg, #2d4059 0%, #445D7E 100%);
            color: #fff; padding: 2.5rem 0 2rem;
        }
        .profile-avatar {
            width: 90px; height: 90px; border-radius: 50%;
            background: rgba(255,255,255,.15); display: flex;
            align-items: center; justify-content: center;
            font-size: 2.5rem; color: #fff; flex-shrink: 0;
            border: 3px solid rgba(255,255,255,.3);
            overflow: hidden;
        }
        .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .verified-badge { display: inline-flex; align-items: center; gap: 4px; background: rgba(255,255,255,.2); border-radius: 20px; padding: 2px 10px; font-size: 0.78rem; }
        .rating-stars { color: #f5c518; letter-spacing: 1px; }

        /* 社群連結 */
        .social-links { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .social-link {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 0.35rem 0.75rem; border-radius: 8px;
            font-size: 0.82rem; font-weight: 500; text-decoration: none;
            border: 1px solid #dee2e6; color: #444;
            background: #fff; transition: all .15s;
        }
        .social-link:hover { transform: translateY(-1px); box-shadow: 0 3px 8px rgba(0,0,0,.1); color: #2d4059; }
        .social-link .si { font-size: 1.1rem; }
        .social-link.fb  { border-color: #1877f2; color: #1877f2; }
        .social-link.ig  { border-color: #e1306c; color: #e1306c; }
        .social-link.x   { border-color: #000; color: #000; }
        .social-link.threads { border-color: #000; color: #000; }
        .social-link.line { border-color: #06c755; color: #06c755; }
        .social-link.wa  { border-color: #25d366; color: #25d366; }
        .social-link.web { border-color: #445D7E; color: #445D7E; }
        .social-link.email { border-color: #6c757d; color: #6c757d; }
        .social-link.phone { border-color: #445D7E; color: #445D7E; }

        /* 服務地區標籤 */
        .area-tag {
            display: inline-block; padding: 0.2rem 0.6rem;
            background: #e8ecf0; border-radius: 6px;
            font-size: 0.78rem; color: #445D7E; font-weight: 500;
        }
        /* 能力標籤 */
        .cap-tag {
            display: inline-block; padding: 0.2rem 0.6rem;
            background: #f0f4f8; border-radius: 6px;
            font-size: 0.78rem; color: #5c6470;
        }

        /* 作品卡片 */
        .portfolio-card {
            border: 1px solid rgba(68,93,126,.15);
            border-radius: 12px; overflow: hidden;
            background: #fff; transition: transform .15s, box-shadow .15s;
        }
        .portfolio-card:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(68,93,126,.12); }
        .portfolio-img {
            width: 100%; aspect-ratio: 4/3; object-fit: cover;
            background: #f0f4f8; display: block;
        }
        .portfolio-no-img {
            width: 100%; aspect-ratio: 4/3;
            background: #f0f4f8; display: flex;
            align-items: center; justify-content: center;
            color: #adb5bd; font-size: 2rem;
        }
        .before-after-wrap { position: relative; }
        .before-label, .after-label {
            position: absolute; bottom: 6px;
            font-size: 0.65rem; background: rgba(0,0,0,.55); color: #fff;
            padding: 1px 6px; border-radius: 3px;
        }
        .before-label { left: 6px; }
        .after-label { right: 6px; }

        /* 區塊標題 */
        .section-title {
            font-size: 1rem; font-weight: 700; color: #2d4059;
            border-left: 3px solid #445D7E; padding-left: 0.6rem;
            margin-bottom: 0.75rem;
        }
        .card-section { background: #fff; border-radius: 12px; padding: 1.25rem 1.5rem; border: 1px solid rgba(68,93,126,.12); margin-bottom: 1.25rem; }
    </style>
</head>
<body class="bg-light">
    <div id="site-header"></div>

    <!-- Hero -->
    <div class="profile-hero" id="profileHero" style="display:none;">
        <div class="container">
            <a href="/vendors.html" class="btn btn-sm btn-outline-light mb-3"><i class="bi bi-arrow-left me-1"></i>返回廠商列表</a>
            <div class="d-flex align-items-center gap-3 flex-wrap">
                <div class="profile-avatar" id="heroAvatar"><i class="bi bi-building"></i></div>
                <div>
                    <div class="d-flex align-items-center gap-2 flex-wrap mb-1">
                        <h1 class="h3 mb-0 fw-bold" id="heroName">—</h1>
                        <span class="verified-badge d-none" id="heroBadge"><i class="bi bi-patch-check-fill"></i> 認證廠商</span>
                    </div>
                    <div class="d-flex align-items-center gap-3 flex-wrap opacity-85 small">
                        <span class="rating-stars" id="heroRating"></span>
                        <span id="heroLocation" class="d-none"><i class="bi bi-geo-alt me-1"></i><span id="heroLocationText"></span></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 載入中 -->
    <div id="pageLoading" class="text-center py-5">
        <div class="spinner-border text-primary mb-3" style="width:2.5rem;height:2.5rem;" role="status"></div>
        <p class="text-muted">載入廠商資料中…</p>
    </div>
    <!-- 錯誤 -->
    <div id="pageError" class="container py-5 text-center d-none">
        <i class="bi bi-exclamation-circle display-4 text-muted"></i>
        <p class="mt-3 text-muted">找不到此廠商，或已下架。</p>
        <a href="/vendors.html" class="btn btn-outline-primary mt-1">返回廠商列表</a>
    </div>

    <!-- 主內容 -->
    <div id="profileBody" class="container py-4 d-none">
        <div class="row g-4">

            <!-- 左欄：資訊 -->
            <div class="col-lg-4">

                <!-- 簡介 -->
                <div class="card-section" id="sectionDesc" style="display:none;">
                    <div class="section-title"><i class="bi bi-person-lines-fill me-1"></i>廠商簡介</div>
                    <p id="vendorDesc" class="mb-0 text-secondary" style="font-size:.9rem;line-height:1.7;"></p>
                </div>

                <!-- 服務地區 -->
                <div class="card-section" id="sectionArea" style="display:none;">
                    <div class="section-title"><i class="bi bi-geo-alt-fill me-1"></i><span data-i18n="vendor.serviceArea">服務地區</span></div>
                    <div id="vendorAreas"></div>
                </div>

                <!-- 專業能力 -->
                <div class="card-section" id="sectionCaps" style="display:none;">
                    <div class="section-title"><i class="bi bi-tools me-1"></i>專業能力</div>
                    <div id="vendorCaps" class="d-flex flex-wrap gap-2"></div>
                </div>

                <!-- 聯繫方式 & 社群 -->
                <div class="card-section" id="sectionSocial" style="display:none;">
                    <div class="section-title"><i class="bi bi-share-fill me-1"></i>聯繫 & 社群</div>
                    <div class="social-links" id="vendorSocial"></div>
                </div>

            </div>

            <!-- 右欄：作品集 -->
            <div class="col-lg-8">
                <div class="section-title"><i class="bi bi-images me-1"></i>作品集</div>
                <div id="portfolioEmpty" class="text-center py-5 text-muted d-none">
                    <i class="bi bi-image display-4"></i>
                    <p class="mt-3">此廠商尚未上傳作品。</p>
                </div>
                <div id="portfolioGrid" class="row g-3"></div>
            </div>
        </div>
    </div>

    <div id="site-footer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/config/auth-config.js"></script>
    <script src="/js/i18n.js"></script>
    <script src="/js/site-header.js"></script>
    <script src="/js/site-footer.js"></script>
    <script>
    (function () {
        var id = new URLSearchParams(location.search).get('id');
        if (!id) { showError(); return; }

        fetch('/api/manufacturers/' + encodeURIComponent(id))
            .then(function (r) { return r.ok ? r.json() : Promise.reject(r.status); })
            .then(renderProfile)
            .catch(showError);

        function showError() {
            document.getElementById('pageLoading').classList.add('d-none');
            document.getElementById('pageError').classList.remove('d-none');
        }

        function starsHTML(rating) {
            if (!rating) return '';
            var full = Math.round(rating);
            var s = '';
            for (var i = 1; i <= 5; i++) s += i <= full ? '★' : '☆';
            return s + ' <span style="color:#fff;opacity:.8;font-size:.85em;">' + rating.toFixed(1) + '</span>';
        }

        function renderProfile(v) {
            document.getElementById('pageLoading').classList.add('d-none');
            document.getElementById('profileBody').classList.remove('d-none');
            document.getElementById('profileHero').style.display = '';

            // 更新頁籤標題
            document.title = (v.name || '廠商詳情') + ' - MATCHDO 合做';

            // Hero
            document.getElementById('heroName').textContent = v.name || '廠商';
            if (v.verified) document.getElementById('heroBadge').classList.remove('d-none');
            if (v.rating) document.getElementById('heroRating').innerHTML = starsHTML(v.rating);
            if (v.location) {
                document.getElementById('heroLocationText').textContent = v.location;
                document.getElementById('heroLocation').classList.remove('d-none');
            }

            // 簡介
            if (v.specialty) {
                document.getElementById('vendorDesc').textContent = v.specialty;
                document.getElementById('sectionDesc').style.display = '';
            }

            // 服務地區（contact.service_area 陣列 or 字串，分組顯示）
            var contact = v.contact || {};
            var areas = contact.service_area;
            if (areas) {
                if (typeof areas === 'string') areas = areas.split(/[,，、\s]+/).map(function(s){return s.trim();}).filter(Boolean);
                if (Array.isArray(areas) && areas.length > 0) {
                    var AREA_GROUPS = [
                        { group: '北部', zh: ['臺北','新北','基隆','桃園','新竹縣','新竹市','宜蘭'], en: 'North Taiwan' },
                        { group: '中部', zh: ['臺中','苗栗','彰化','南投','雲林'], en: 'Central Taiwan' },
                        { group: '南部', zh: ['高雄','臺南','嘉義縣','嘉義市','屏東','澎湖'], en: 'South Taiwan' },
                        { group: '東部', zh: ['花蓮','臺東'], en: 'East Taiwan' },
                        { group: '離島', zh: ['金門','連江'], en: 'Outlying Islands' },
                        { group: '海外', zh: ['海外'], en: 'Overseas' }
                    ];
                    var areaEl = document.getElementById('vendorAreas');
                    var isEn = (document.documentElement.lang || '').startsWith('en');
                    // 先歸組，再顯示
                    var grouped = [], ungrouped = [];
                    var usedAreas = {};
                    AREA_GROUPS.forEach(function(g) {
                        var matched = areas.filter(function(a){ return g.zh.some(function(z){ return z === a || a.includes(z) || z.includes(a); }); });
                        if (matched.length > 0) {
                            grouped.push({ label: isEn ? g.en : g.group, items: matched });
                            matched.forEach(function(a){ usedAreas[a] = true; });
                        }
                    });
                    ungrouped = areas.filter(function(a){ return !usedAreas[a]; });
                    var html = '';
                    grouped.forEach(function(g) {
                        html += '<div class="d-flex align-items-center flex-wrap gap-1 mb-1">';
                        html += '<span class="text-muted me-1" style="font-size:.72rem;white-space:nowrap;">' + g.label + '：</span>';
                        g.items.forEach(function(a){ html += '<span class="area-tag">' + a + '</span>'; });
                        html += '</div>';
                    });
                    ungrouped.forEach(function(a){ html += '<span class="area-tag">' + a + '</span>'; });
                    areaEl.innerHTML = html;
                    document.getElementById('sectionArea').style.display = '';
                }
            }

            // 專業能力
            var caps = v.capabilities;
            if (caps) {
                if (typeof caps === 'string') caps = caps.split(/[,，、]+/).map(function(s){return s.trim();}).filter(Boolean);
                if (Array.isArray(caps) && caps.length > 0) {
                    var capEl = document.getElementById('vendorCaps');
                    caps.forEach(function (c) {
                        var span = document.createElement('span');
                        span.className = 'cap-tag';
                        span.textContent = c;
                        capEl.appendChild(span);
                    });
                    document.getElementById('sectionCaps').style.display = '';
                }
            }

            // 社群 & 聯繫
            var socialEl = document.getElementById('vendorSocial');
            var socialDefs = [
                { key: 'facebook',  cls: 'fb',     icon: 'bi-facebook',       label: 'Facebook', prefix: 'https://facebook.com/' },
                { key: 'instagram', cls: 'ig',     icon: 'bi-instagram',      label: 'Instagram', prefix: 'https://instagram.com/' },
                { key: 'twitter',   cls: 'x',      icon: 'bi-twitter-x',      label: 'X (Twitter)', prefix: 'https://x.com/' },
                { key: 'threads',   cls: 'threads',icon: 'bi-threads',        label: 'Threads',  prefix: 'https://threads.net/@' },
                { key: 'line_id',   cls: 'line',   icon: 'bi-line',           label: 'LINE',     prefix: 'https://line.me/ti/p/~' },
                { key: 'whatsapp',  cls: 'wa',     icon: 'bi-whatsapp',       label: 'WhatsApp', prefix: 'https://wa.me/' },
                { key: 'url',       cls: 'web',    icon: 'bi-globe2',         label: '官網',     prefix: '' },
                { key: 'email',     cls: 'email',  icon: 'bi-envelope-fill',  label: 'Email',    prefix: 'mailto:' },
                { key: 'phone',     cls: 'phone',  icon: 'bi-telephone-fill', label: '電話',     prefix: 'tel:' }
            ];
            var hasSocial = false;
            socialDefs.forEach(function (def) {
                var val = (contact[def.key] || '').trim();
                if (!val) return;
                hasSocial = true;
                var a = document.createElement('a');
                a.className = 'social-link ' + def.cls;
                var href = def.prefix
                    ? (val.startsWith('http') || val.startsWith('mailto:') || val.startsWith('tel:') ? val : def.prefix + val)
                    : val;
                a.href = href;
                a.target = (def.key === 'email' || def.key === 'phone') ? '_self' : '_blank';
                a.rel = 'noopener noreferrer';
                a.innerHTML = '<i class="bi ' + def.icon + ' si"></i>' + def.label;
                socialEl.appendChild(a);
            });
            if (hasSocial) document.getElementById('sectionSocial').style.display = '';

            // 作品集
            var portfolio = v.portfolio || [];
            var grid = document.getElementById('portfolioGrid');
            if (portfolio.length === 0) {
                document.getElementById('portfolioEmpty').classList.remove('d-none');
            } else {
                portfolio.forEach(function (p) {
                    var col = document.createElement('div');
                    col.className = 'col-sm-6 col-md-4';
                    var hasAfter = !!p.image_url;
                    var hasBefore = !!p.image_url_before;
                    var imgHTML = '';
                    if (hasAfter && hasBefore) {
                        imgHTML = '<div class="before-after-wrap">' +
                            '<div class="row g-1">' +
                            '<div class="col-6 position-relative">' +
                            '<img src="' + escHtml(p.image_url_before) + '" class="portfolio-img" style="aspect-ratio:1/1;" loading="lazy" alt="改前">' +
                            '<span class="before-label">改前</span></div>' +
                            '<div class="col-6 position-relative">' +
                            '<img src="' + escHtml(p.image_url) + '" class="portfolio-img" style="aspect-ratio:1/1;" loading="lazy" alt="改後">' +
                            '<span class="after-label">改後</span></div>' +
                            '</div></div>';
                    } else if (hasAfter) {
                        imgHTML = '<img src="' + escHtml(p.image_url) + '" class="portfolio-img" loading="lazy" alt="' + escHtml(p.title || '') + '">';
                    } else {
                        imgHTML = '<div class="portfolio-no-img"><i class="bi bi-image"></i></div>';
                    }
                    var tagsHTML = (p.tags || []).map(function(t){ return '<span class="cap-tag">' + escHtml(t) + '</span>'; }).join('');
                    col.innerHTML = '<div class="portfolio-card">' + imgHTML +
                        '<div class="p-2">' +
                        (p.title ? '<div class="fw-semibold small mb-1" style="color:#2d4059">' + escHtml(p.title) + '</div>' : '') +
                        (p.design_highlight ? '<div class="text-muted small mb-1" style="font-size:.75rem;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;">' + escHtml(p.design_highlight) + '</div>' : '') +
                        (tagsHTML ? '<div class="d-flex flex-wrap gap-1 mt-1">' + tagsHTML + '</div>' : '') +
                        '</div></div>';
                    grid.appendChild(col);
                });
            }
        }

        function escHtml(s) {
            return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }
    })();
    </script>
</body>
</html>
