<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>靈感牆資料夾編輯 - MATCHDO 合做</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet" />
  <link href="/css/theme-colors.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    .folder-card { border: 1px solid #dee2e6; border-radius: 12px; padding: 1rem; margin-bottom: 0.75rem; background: #fff; }
    .folder-card .cover-thumb { width: 80px; height: 56px; object-fit: cover; border-radius: 8px; }
    .folder-edit-panel { background: #fff; border: 1px solid #dee2e6; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
  </style>
</head>
<body class="bg-light">
  <div id="site-header"></div>

  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h4 mb-0">靈感牆資料夾編輯</h1>
      <a href="/index.html" class="btn btn-outline-secondary btn-sm">返回首頁</a>
    </div>

    <div id="loginRequired" class="alert alert-warning" style="display:none;">
      請先 <a href="/login.html">登入</a> 後使用資料夾編輯。
    </div>
    <div id="forbiddenPanel" class="alert alert-info" style="display:none;">
      僅 1800 方案或管理員可編輯靈感牆資料夾。若您已訂閱 1800 方案仍無法使用，請聯繫客服。
    </div>

    <div id="editorPanel" style="display:none;">
      <p class="text-muted small mb-3">管理首頁靈感牆上的「系列」資料夾（標題、網址代碼、封面、描述、排序與啟用狀態）。</p>

      <div class="folder-edit-panel">
        <h5 class="mb-3" id="formTitle">新增資料夾</h5>
        <input type="hidden" id="editId" value="" />
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label" for="folderTitle">標題 <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="folderTitle" placeholder="例：系列一" required />
          </div>
          <div class="col-md-6">
            <label class="form-label" for="folderSlug">網址代碼（slug）</label>
            <input type="text" class="form-control" id="folderSlug" placeholder="例：collection-1" />
            <div class="form-text">留空可自動依標題產生；不可與其他資料夾重複。</div>
          </div>
          <div class="col-12">
            <label class="form-label" for="folderCover">封面圖片網址</label>
            <input type="url" class="form-control" id="folderCover" placeholder="https://..." />
          </div>
          <div class="col-12">
            <label class="form-label" for="folderDesc">描述</label>
            <textarea class="form-control" id="folderDesc" rows="2" placeholder="選填"></textarea>
          </div>
          <div class="col-md-4">
            <label class="form-label" for="folderSort">排序數字</label>
            <input type="number" class="form-control" id="folderSort" value="0" />
            <div class="form-text">數字越小越前面。</div>
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <div class="form-check">
              <input type="checkbox" class="form-check-input" id="folderActive" checked />
              <label class="form-check-label" for="folderActive">啟用（顯示於靈感牆）</label>
            </div>
          </div>
          <div class="col-12">
            <label class="form-label">顯示於哪些分類（可複選）</label>
            <div id="folderCategoryChecks" class="d-flex flex-wrap gap-2"></div>
            <div class="form-text">勾選的分類在首頁篩選時會顯示此資料夾；不勾選任何一個表示「全部分類都顯示」。</div>
          </div>
          <div class="col-12">
            <button type="button" class="btn btn-primary" id="btnSaveFolder">儲存</button>
            <button type="button" class="btn btn-outline-secondary ms-2" id="btnCancelEdit" style="display:none;">取消編輯</button>
            <span id="saveStatus" class="ms-2 small"></span>
          </div>
        </div>
      </div>

      <h6 class="mb-2">現有資料夾</h6>
      <div id="folderList"></div>
      <p id="folderListEmpty" class="text-muted small">尚無資料夾，請在上方新增。</p>
    </div>
  </div>

  <script src="/config/auth-config.js"></script>
  <script src="/js/site-header.js"></script>
  <script>
(function () {
  var session = null;
  var items = [];
  var categories = [];

  function show(el, visible) { if (el) el.style.display = visible ? '' : 'none'; }
  function setStatus(msg, isErr) {
    var s = document.getElementById('saveStatus');
    if (s) { s.textContent = msg; s.style.color = isErr ? '#dc3545' : '#198754'; }
  }

  function getAuthHeaders() {
    if (!session || !session.access_token) return {};
    return { 'Authorization': 'Bearer ' + session.access_token, 'Content-Type': 'application/json' };
  }

  function renderCategoryChecks(selectedKeys) {
    var container = document.getElementById('folderCategoryChecks');
    if (!container) return;
    selectedKeys = selectedKeys || [];
    container.innerHTML = categories.map(function (c) {
      var key = c.key || '';
      var name = c.name || key;
      var checked = selectedKeys.indexOf(key) !== -1;
      return '<div class="form-check form-check-inline"><input type="checkbox" class="form-check-input folder-cat-check" data-key="' + key.replace(/"/g, '&quot;') + '" id="folderCat-' + key.replace(/[^a-zA-Z0-9_-]/g, '_') + '" ' + (checked ? 'checked' : '') + ' /><label class="form-check-label small" for="folderCat-' + key.replace(/[^a-zA-Z0-9_-]/g, '_') + '">' + (name || key).replace(/</g, '&lt;') + '</label></div>';
    }).join('') || '<span class="text-muted small">尚無分類，請先至後台設定訂製品分類。</span>';
  }

  function getSelectedCategoryKeys() {
    var keys = [];
    document.querySelectorAll('#folderCategoryChecks .folder-cat-check:checked').forEach(function (cb) {
      var k = cb.getAttribute('data-key');
      if (k) keys.push(k);
    });
    return keys;
  }

  function clearForm() {
    document.getElementById('editId').value = '';
    document.getElementById('formTitle').textContent = '新增資料夾';
    document.getElementById('folderTitle').value = '';
    document.getElementById('folderSlug').value = '';
    document.getElementById('folderCover').value = '';
    document.getElementById('folderDesc').value = '';
    document.getElementById('folderSort').value = '0';
    document.getElementById('folderActive').checked = true;
    renderCategoryChecks([]);
    document.getElementById('btnCancelEdit').style.display = 'none';
    setStatus('', false);
  }

  function loadList() {
    fetch('/api/media-collections', { headers: getAuthHeaders() })
      .then(function (r) {
        if (r.status === 403) { show(document.getElementById('editorPanel'), false); show(document.getElementById('forbiddenPanel'), true); return null; }
        return r.json();
      })
      .then(function (data) {
        if (!data || !data.items) return;
        items = data.items;
        var listEl = document.getElementById('folderList');
        var emptyEl = document.getElementById('folderListEmpty');
        if (!listEl) return;
        if (items.length === 0) {
          listEl.innerHTML = '';
          show(emptyEl, true);
          return;
        }
        show(emptyEl, false);
        listEl.innerHTML = items.map(function (p) {
          var cover = p.cover_image_url ? '<img class="cover-thumb" src="' + p.cover_image_url + '" alt="" />' : '<span class="text-muted small">無封面</span>';
          var active = p.is_active ? '是' : '否';
          var keysLabel = Array.isArray(p.category_keys) && p.category_keys.length ? ' · 分類 ' + p.category_keys.length + ' 個' : ' · 全部分類';
          return '<div class="folder-card d-flex align-items-center flex-wrap gap-3" data-id="' + p.id + '">' +
            '<div class="flex-shrink-0">' + cover + '</div>' +
            '<div class="flex-grow-1">' +
              '<strong>' + (p.title || '-') + '</strong>' +
              (p.slug ? ' <code class="small">' + p.slug + '</code>' : '') +
              '<br /><span class="small text-muted">排序 ' + (p.sort_order != null ? p.sort_order : 0) + ' · 啟用 ' + active + keysLabel + '</span>' +
            '</div>' +
            '<button type="button" class="btn btn-sm btn-outline-primary edit-folder-btn" data-id="' + p.id + '">編輯</button>' +
            '</div>';
        }).join('');

        listEl.querySelectorAll('.edit-folder-btn').forEach(function (btn) {
          btn.addEventListener('click', function () {
            var id = btn.getAttribute('data-id');
            var p = items.find(function (x) { return x.id === id; });
            if (!p) return;
            document.getElementById('editId').value = p.id;
            document.getElementById('formTitle').textContent = '編輯資料夾';
            document.getElementById('folderTitle').value = p.title || '';
            document.getElementById('folderSlug').value = p.slug || '';
            document.getElementById('folderCover').value = p.cover_image_url || '';
            document.getElementById('folderDesc').value = p.description || '';
            document.getElementById('folderSort').value = p.sort_order != null ? p.sort_order : 0;
            document.getElementById('folderActive').checked = p.is_active !== false;
            var keys = Array.isArray(p.category_keys) ? p.category_keys : [];
            if (categories.length) renderCategoryChecks(keys); else fetch('/api/custom-product-categories').then(function (r) { return r.json(); }).then(function (d) { categories = d.categories || []; renderCategoryChecks(keys); });
            document.getElementById('btnCancelEdit').style.display = '';
            setStatus('', false);
          });
        });
      })
      .catch(function () {
        setStatus('載入失敗', true);
      });
  }

  function saveFolder() {
    var id = document.getElementById('editId').value.trim();
    var title = document.getElementById('folderTitle').value.trim();
    var slug = document.getElementById('folderSlug').value.trim();
    var cover = document.getElementById('folderCover').value.trim();
    var desc = document.getElementById('folderDesc').value.trim();
    var sortOrder = parseInt(document.getElementById('folderSort').value, 10) || 0;
    var isActive = document.getElementById('folderActive').checked;
    if (!title) { setStatus('請填寫標題', true); return; }

    var categoryKeys = getSelectedCategoryKeys();
    var payload = { title: title, slug: slug || undefined, cover_image_url: cover || null, description: desc || null, sort_order: sortOrder, is_active: isActive, category_keys: categoryKeys };
    var url = id ? '/api/media-collections/' + id : '/api/media-collections';
    var method = id ? 'PUT' : 'POST';

    setStatus('儲存中…', false);
    fetch(url, {
      method: method,
      headers: getAuthHeaders(),
      body: JSON.stringify(payload)
    })
      .then(function (r) {
        if (!r.ok) return r.json().then(function (j) { throw new Error(j.error || r.statusText); });
        return r.json();
      })
      .then(function () {
        setStatus('已儲存', false);
        clearForm();
        loadList();
      })
      .catch(function (err) {
        setStatus(err.message || '儲存失敗', true);
      });
  }

  document.getElementById('btnSaveFolder').addEventListener('click', saveFolder);
  document.getElementById('btnCancelEdit').addEventListener('click', clearForm);

  async function init() {
    try {
      session = await (window.AuthService && AuthService.getSessionForApi ? AuthService.getSessionForApi() : (AuthService && AuthService.getSession ? AuthService.getSession() : Promise.resolve(null)));
      if (!session || !session.access_token) {
        show(document.getElementById('loginRequired'), true);
        show(document.getElementById('editorPanel'), false);
        show(document.getElementById('forbiddenPanel'), false);
        return;
      }
      show(document.getElementById('loginRequired'), false);

      var canResp = await fetch('/api/me/can-edit-media-folders', { headers: getAuthHeaders() });
      var canData = canResp.ok ? await canResp.json() : {};
      if (!canData.allowed) {
        show(document.getElementById('forbiddenPanel'), true);
        show(document.getElementById('editorPanel'), false);
        return;
      }
      show(document.getElementById('forbiddenPanel'), false);
      show(document.getElementById('editorPanel'), true);
      fetch('/api/custom-product-categories').then(function (r) { return r.json(); }).then(function (data) {
        categories = data.categories || [];
        renderCategoryChecks([]);
      }).catch(function () { categories = []; });
      loadList();
    } catch (e) {
      show(document.getElementById('loginRequired'), true);
      show(document.getElementById('editorPanel'), false);
    }
  }
  init();
})();
  </script>
</body>
</html>
