<!DOCTYPE html>
<!-- 【不准修改】首頁路由：server.js 內 /iStudio-1.0.0/ 導向 / 的設定勿刪勿改。此檔為根路徑首頁。 -->
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>MATCHDO - 合做</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta name="keywords" content="客製產品,AI設計,廠商媒合,合做,訂製,MATCHDO">
    <meta name="description" content="MATCHDO 合做 — AI 輔助客製產品設計，上傳設計圖或文字描述，自動媒合優質廠商，一站式從設計到生產。">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="MATCHDO 合做">
    <meta property="og:title" content="MATCHDO 合做 - AI 客製產品設計 × 廠商媒合平台">
    <meta property="og:description" content="AI 輔助設計 × 廠商媒合 × 客製生產，上傳設計圖或文字描述，讓您的創意快速落地。">
    <meta property="og:image" content="https://matchdo.cc/img/og-home.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:url" content="https://matchdo.cc/">
    <meta property="og:locale" content="zh_TW">
    <meta property="og:locale:alternate" content="en_US">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="MATCHDO 合做 - AI 客製產品設計 × 廠商媒合平台">
    <meta name="twitter:description" content="AI 輔助設計 × 廠商媒合 × 客製生產，讓您的創意快速落地。">
    <meta name="twitter:image" content="https://matchdo.cc/img/og-home.jpg">

    <!-- Canonical -->
    <link rel="canonical" href="https://matchdo.cc/">
    <link rel="alternate" hreflang="zh-TW" href="https://matchdo.cc/">
    <link rel="alternate" hreflang="en" href="https://matchdo.cc/?lang=en">
    <link rel="alternate" hreflang="x-default" href="https://matchdo.cc/">

    <!-- Favicon -->
    <link href="/iStudio-1.0.0/img/favicon.ico" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&family=Space+Grotesk&display=swap" rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="/iStudio-1.0.0/lib/animate/animate.min.css" rel="stylesheet">
    <link href="/iStudio-1.0.0/lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="/iStudio-1.0.0/css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="/iStudio-1.0.0/css/style.css" rel="stylesheet">
    <!-- 全站共用樣式（含 Navbar Logo 置中） -->
    <link href="/css/style.css" rel="stylesheet">

    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "MATCHDO 合做",
      "alternateName": "MatchDO",
      "url": "https://matchdo.cc",
      "logo": {
        "@type": "ImageObject",
        "url": "https://matchdo.cc/img/matchdo-logo.png"
      },
      "description": "AI 輔助客製產品設計平台，媒合優質廠商，一站式從設計到生產。",
      "foundingDate": "2025",
      "areaServed": "TW",
      "availableLanguage": ["Chinese", "English"]
    }
    </script>
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "MATCHDO 合做",
      "url": "https://matchdo.cc",
      "potentialAction": {
        "@type": "SearchAction",
        "target": {
          "@type": "EntryPoint",
          "urlTemplate": "https://matchdo.cc/custom/gallery.html?search={search_term_string}"
        },
        "query-input": "required name=search_term_string"
      }
    }
    </script>
</head>

<body>
    <!-- 移除原樣板載入 Spinner，保留簡潔頁面 -->


    <!-- 共用前台導覽：由 site-header.js 統一渲染，勿在此重複寫 inline navbar -->
    <div id="site-header"></div>

    <!-- 媒體牆：Pinterest 風 — 白底、圖片塞滿版面，左右留白一致、縮圖約 8 格寬 -->
    <div class="container-fluid px-0" id="media-wall-section">
        <div class="container-fluid media-wall-inner py-3">
            <style>
                #media-wall-section { background-color: #ffffff !important; width: 100%; max-width: 100%; box-sizing: border-box; }
                #media-wall-section .container-fluid { background-color: transparent !important; max-width: 100%; padding-left: 0.5rem; padding-right: 0.5rem; }
                /* 縮小左右留白，讓網格盡量貼齊視窗；大螢幕再縮一點留白 */
                #media-wall-section .media-wall-inner { padding-left: 0.5rem; padding-right: 0.5rem; }
                @media (min-width: 576px) { #media-wall-section .media-wall-inner { padding-left: 0.75rem; padding-right: 0.75rem; } }
                @media (min-width: 1200px) { #media-wall-section .media-wall-inner { padding-left: 0.5rem; padding-right: 0.5rem; } #media-wall-section .container-fluid { padding-left: 0.5rem; padding-right: 0.5rem; } }
                #media-wall-section .d-flex.flex-wrap { margin-bottom: 0.5rem; }
                /* 網格填滿可用寬度，左右對稱、Chrome/Edge 一致；不設 max-width 讓寬螢幕也塞滿 */
                #media-wall-grid-wrap { width: 100%; max-width: 100%; margin-left: 0; margin-right: 0; box-sizing: border-box; }
                /* 欄用 minmax(260px, 1fr) 讓最後一欄擴充填滿，列固定高度維持方形感 */
                #media-wall-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); grid-auto-rows: 260px; grid-auto-flow: dense; gap: 8px; }
                #media-wall-grid .media-wall-item { min-height: 0; }
                #media-wall-grid .media-wall-1x2 { grid-column: span 1; grid-row: span 2; min-height: 0; }
                #media-wall-grid .card { border: none; border-radius: 8px; overflow: hidden; box-shadow: none; height: 100%; display: flex; flex-direction: column; background: transparent; }
                #media-wall-grid .card:hover { box-shadow: 0 2px 8px rgba(0,0,0,.12); }
                #media-wall-grid .card .media-wall-card-link { display: flex; flex-direction: column; flex: 1; min-height: 0; text-decoration: none; color: inherit; }
                #media-wall-grid .card .card-img-wrap { width: 100%; flex: 1; min-height: 0; background: #f0f0f0; position: relative; }
                #media-wall-grid .card .card-img-wrap > img { display: block; width: 100%; height: 100%; object-fit: cover; }
                #media-wall-grid .card .card-img-wrap::after { content: ''; position: absolute; inset: 0; background: rgba(0,0,0,.15); pointer-events: none; transition: opacity .2s ease; }
                #media-wall-grid .card:hover .card-img-wrap::after { opacity: 0; }
                #media-wall-grid .card .card-title-overlay { position: absolute; left: 0; right: 0; bottom: 0; padding: 6px 8px; background: linear-gradient(transparent, rgba(0,0,0,.6)); color: #fff; font-size: 0.7rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
                #media-wall-grid .card .card-img-wrap img[src*="placehold.co"] { filter: grayscale(1); }
                #media-wall-grid .card .card-img-wrap .media-wall-placeholder { background: #e8e8e8 !important; color: #888 !important; font-size: 0.7rem; display: flex !important; align-items: center; justify-content: center; width: 100%; height: 100%; min-height: 80px; background-image: repeating-linear-gradient(0deg, transparent 0, transparent 9px, rgba(255,255,255,.05) 9px, rgba(255,255,255,.05) 10px), repeating-linear-gradient(90deg, transparent 0, transparent 9px, rgba(255,255,255,.05) 9px, rgba(255,255,255,.05) 10px) !important; }
                #media-wall-grid .card .card-img-wrap .media-wall-placeholder span { color: #888; }
                /* 1x2 資料夾：直列兩格 */
                #media-wall-grid .media-wall-1x2 .card .card-img-wrap.collection-grid { display: grid; grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; gap: 2px; padding: 2px; }
                #media-wall-grid .media-wall-1x2 .card .card-img-wrap.collection-grid img { width: 100%; height: 100%; object-fit: cover; display: block; }
                /* 對比卡：圖區內填滿，overlay 滑桿（垂直線+圓形把手） */
                .comparison-slider-wrap { position: absolute; inset: 0; width: 100%; height: 100%; }
                .comparison-slider-wrap img.slider-bg { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
                .comparison-slider-wrap img.slider-fg { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
                .comparison-slider-wrap .slider-overlay { position: absolute; inset: 0; pointer-events: none; }
                .comparison-slider-wrap .slider-overlay input[type="range"] { position: absolute; inset: 0; width: 100%; height: 100%; margin: 0; opacity: 0; cursor: ew-resize; pointer-events: auto; }
                .comparison-slider-wrap .slider-line { position: absolute; top: 0; bottom: 0; width: 2px; background: #445D7E; left: 50%; margin-left: -1px; pointer-events: none; box-shadow: 0 0 2px rgba(0,0,0,.25); }
                .comparison-slider-wrap .slider-handle { position: absolute; top: 50%; left: 50%; width: 28px; height: 28px; margin: -14px 0 0 -14px; background: #fff; border: 2px solid #445D7E; border-radius: 50%; display: flex; align-items: center; justify-content: center; pointer-events: none; box-shadow: 0 1px 4px rgba(0,0,0,.25); font-size: 12px; color: #445D7E; }
                .comparison-slider-wrap .slider-hint { position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); padding: 2px 8px; background: rgba(0,0,0,.5); color: #fff; font-size: 0.6rem; border-radius: 4px; white-space: nowrap; pointer-events: none; }
                #media-wall-grid .media-wall-1x2 .card .card-img-wrap { aspect-ratio: unset; min-height: 0; }
                #media-wall-grid .media-wall-1x2 .card { min-height: 0; }
                /* ── 愛心按鈕 ── */
                .mw-fav-btn { position:absolute; top:6px; left:6px; z-index:12; width:30px; height:30px; border:none; background:#445D7E; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:16px; line-height:1; box-shadow:0 1px 6px rgba(0,0,0,.3); transition:transform .15s,background .12s; }
                .mw-fav-btn:hover { transform:scale(1.18); background:#3a5169; }
                .mw-fav-btn.active { color:#ff6b6b; }
                .mw-fav-btn:not(.active) { color:rgba(255,255,255,.85); }
                .mw-fav-btn:not(.active):hover { color:#ff6b6b; }
                /* 管理員：在首頁關閉個別圖片顯示 */
                #media-wall-grid .card { position: relative; }
                #media-wall-grid .media-wall-admin-hide { position: absolute; top: 4px; right: 4px; z-index: 10; padding: 2px 6px; font-size: 0.65rem; background: rgba(0,0,0,.7); color: #fff; border: none; border-radius: 4px; cursor: pointer; margin-left: 2px; }
                #media-wall-grid .media-wall-admin-hide:hover { background: #445D7E; }
                #media-wall-grid .media-wall-admin-delete { right: 4px; left: auto; top: 4px; margin-left: 0; background: rgba(180,60,60,.9); }
                #media-wall-grid .media-wall-admin-delete:hover { background: #c0392b; }
                #media-wall-grid .media-wall-admin-actions { position: absolute; top: 4px; right: 4px; z-index: 10; display: flex; gap: 2px; }
                /* 分類篩選：標籤形式，非下拉 */
                #media-wall-filter { margin-bottom: 0.75rem; }
                #media-wall-filter .filter-row { display: flex; flex-wrap: wrap; align-items: center; gap: 0.35rem; margin-bottom: 0.35rem; }
                #media-wall-filter .filter-row:last-child { margin-bottom: 0; }
                #media-wall-filter .filter-tag { display: inline-block; padding: 0.25rem 0.5rem; font-size: 0.8rem; border-radius: 6px; border: 1px solid #445D7E; color: #445D7E; background: #fff; cursor: pointer; text-decoration: none; }
                #media-wall-filter .filter-tag:hover { background: #f0f4f8; color: #3a5169; }
                #media-wall-filter .filter-tag.active { background: #445D7E; color: #fff; border-color: #445D7E; }
                #media-wall-filter .filter-tag.filter-sub { font-size: 0.75rem; padding: 0.2rem 0.4rem; border-color: #8a96a6; color: #5c6470; }
                #media-wall-filter .filter-tag.filter-sub:hover, #media-wall-filter .filter-tag.filter-sub.active { border-color: #445D7E; color: #445D7E; }
                #media-wall-filter .filter-tag.filter-sub.active { background: #e8ecf0; }
            </style>
            <div class="d-flex flex-wrap align-items-center justify-content-center gap-2 mb-2">
                <input type="search" id="media-wall-search" class="form-control form-control-sm" data-i18n-placeholder="home.searchPlaceholder" placeholder="搜尋作品（標題或提示詞）" style="max-width: 280px;" autocomplete="off">
                <button type="button" id="media-wall-search-btn" class="btn btn-sm btn-outline-primary" data-i18n="home.searchBtn">搜尋</button>
                <button type="button" id="mw-fav-filter-btn" class="btn btn-sm btn-outline-secondary" title="只顯示我的收藏作品">
                    <i class="bi bi-heart me-1"></i>我的收藏<span class="fav-count"></span>
                </button>
                <button type="button" id="media-wall-load-more" class="btn btn-sm btn-outline-secondary d-none" data-i18n="home.loadMore">載入更多</button>
            </div>
            <div id="media-wall-filter" class="mb-2 d-none">
                <div id="media-wall-filter-main" class="filter-row"></div>
                <div id="media-wall-filter-sub" class="filter-row d-none"></div>
            </div>
            <!-- 我的最愛縮圖列已移除，改由「我的收藏」過濾按鈕控制格線顯示 -->
            <div id="media-wall-grid-wrap">
                <div id="media-wall-grid">
                    <!-- 由 JS 載入 /api/media-wall -->
                </div>
            </div>
            <div id="media-wall-empty" class="text-center text-muted py-5 d-none"><span data-i18n="home.emptyPrefix">目前尚無作品展示，歡迎來</span> <a href="/custom/" data-i18n="home.emptyLink">客製產品</a> <span data-i18n="home.emptySuffix">創作。</span></div>
            <div id="media-wall-loading" class="text-center py-4" data-i18n="home.loading">載入中...</div>
            <!-- 點擊卡片放大：限制不超出視窗、樣式統一（lightbox 本體已移至 body 下，避免背後版面被擠壓） -->
            <style>
                html { scrollbar-gutter: stable; }
                body.modal-open { overflow: hidden; padding-right: 0 !important; margin-right: 0 !important; }
                #media-wall-lightbox .media-wall-modal-dialog { width: 100%; max-width: min(720px, 94vw); max-height: 90vh; margin: 1rem auto; box-sizing: border-box; }
                #media-wall-lightbox .modal-content { width: 100%; max-width: 100%; max-height: 90vh; border-radius: 12px; border: 1px solid rgba(68,93,126,.25); box-shadow: 0 12px 40px rgba(68,93,126,.25); overflow: hidden; display: flex; flex-direction: column; box-sizing: border-box; }
                #media-wall-lightbox .modal-header { padding: 0.75rem 1rem; background: #f0f4f8; border-bottom: 1px solid #445D7E; }
                #media-wall-lightbox .modal-title { font-size: 1rem; font-weight: 600; color: #445D7E; }
                #media-wall-lightbox .modal-body { padding: 0; flex: 1; min-height: 0; overflow-x: hidden; overflow-y: auto; background: #f5f7fa; text-align: center; position: relative; display: flex; align-items: stretch; max-width: 100%; box-sizing: border-box; }
                #media-wall-lightbox #media-wall-lightbox-body { flex: 1; min-height: 200px; padding: 0.5rem; display: flex; align-items: center; justify-content: center; position: relative; max-width: 100%; overflow: hidden; box-sizing: border-box; }
                #media-wall-lightbox #media-wall-lightbox-body-inner { width: 100%; max-width: 100%; height: 100%; min-height: 200px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; box-sizing: border-box; }
                #media-wall-lightbox #media-wall-lightbox-body-inner img { max-width: 100%; max-height: 78vh; width: auto; height: auto; object-fit: contain; border-radius: 8px; box-shadow: 0 2px 12px rgba(68,93,126,.2); }
                /* 詳情疊在圖底部，與主色同色系 */
                #media-wall-lightbox #media-wall-lightbox-detail { position: absolute; left: 0; right: 0; bottom: 0; padding: 0.4rem 0.6rem 0.5rem; background: linear-gradient(transparent, rgba(45,64,89,.95)); color: #fff; text-align: left; font-size: 0.7rem; }
                #media-wall-lightbox #media-wall-lightbox-detail .detail-label { color: rgba(255,255,255,.85); margin-bottom: 0; margin-right: 0.25rem; }
                #media-wall-lightbox #media-wall-lightbox-detail .detail-value { color: #fff; margin-bottom: 0.15rem; word-break: break-word; display: inline; }
                #media-wall-lightbox #media-wall-lightbox-detail .detail-row { margin-bottom: 0.15rem; }
                #media-wall-lightbox #media-wall-lightbox-detail .detail-row:last-child { margin-bottom: 0; }
                #media-wall-lightbox .modal-footer { padding: 0.6rem 1rem; background: #fff; border-top: 1px solid rgba(68,93,126,.2); }
                /* lightbox 固定覆蓋整個視窗，不參與背後版面排版 */
                #media-wall-lightbox { position: fixed; inset: 0; z-index: 1055; overflow-x: hidden; overflow-y: auto; }
                #media-wall-lightbox .modal-dialog { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); margin: 0; max-height: 90vh; }
            </style>
        </div>
    </div>

    <!-- 放大閱讀 lightbox：放在 body 下，避免背後版面被擠壓 -->
    <div class="modal fade" id="media-wall-lightbox" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered media-wall-modal-dialog">
            <div class="modal-content">
                <div class="modal-header py-2">
                    <h6 class="modal-title" id="media-wall-lightbox-title"></h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0 text-center">
                    <div id="media-wall-lightbox-body" style="min-height:120px;">
                        <div id="media-wall-lightbox-body-inner"></div>
                        <div id="media-wall-lightbox-detail" class="d-none">
                            <div class="detail-row" id="media-wall-lightbox-category-row" style="display:none;"><span class="detail-label" data-i18n="home.mainCategory">主分類</span><span id="media-wall-lightbox-category" class="detail-value"></span></div>
                            <div class="detail-row" id="media-wall-lightbox-subcategory-row" style="display:none;"><span class="detail-label" data-i18n="home.subcategory">子分類</span><span id="media-wall-lightbox-subcategory" class="detail-value"></span></div>
                            <div class="detail-row"><span class="detail-label" data-i18n="home.prompt">提示詞</span><span id="media-wall-lightbox-prompt" class="detail-value"></span></div>
                            <div class="detail-row"><span class="detail-label" data-i18n="home.seed">SEED</span><span id="media-wall-lightbox-seed" class="detail-value"></span></div>
                            <div class="detail-row"><span class="detail-label" data-i18n="home.account">帳號</span><span id="media-wall-lightbox-owner" class="detail-value"></span></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer py-2 flex-wrap gap-1">
                    <!-- 愛心收藏按鈕，放最左，me-auto 將其他按鈕推右 -->
                    <button type="button" id="media-wall-lightbox-fav" class="btn btn-outline-secondary btn-sm me-auto" title="加入收藏">
                        <i class="bi bi-heart"></i> <span id="media-wall-lightbox-fav-label">收藏</span>
                    </button>
                    <!-- 廠商作品專用：站內聯絡按鈕（comparison 類型才顯示） -->
                    <button type="button" id="media-wall-lightbox-contact" class="btn btn-success btn-sm d-none" title="聯絡廠商">
                        <i class="bi bi-chat-dots me-1"></i>聯絡廠商
                    </button>
                    <button type="button" id="media-wall-lightbox-scene-sim" class="btn btn-outline-primary btn-sm" data-i18n="home.sceneSim">實境模擬</button>
                    <button type="button" id="media-wall-lightbox-link" class="btn btn-primary btn-sm" data-i18n="home.findVendor">找廠商訂製</button>
                    <button type="button" id="media-wall-lightbox-redesign" class="btn btn-outline-primary btn-sm" data-i18n="home.redesign">再設計</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal" data-i18n="home.close">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 共用前台頁腳（由 site-common.js 載入） -->
    <div id="site-footer"></div>


    <!-- Back to Top -->
    <a href="#!" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="bi bi-arrow-up"></i></a>


    <!-- JavaScript Libraries（Bootstrap 需在 site-header 前，供 navbar 使用） -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Supabase / 登入：放頁尾，不阻塞首屏，登入按鈕已由上方 inline 先畫出 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/config/auth-config.js"></script>
    <script src="/js/auth-middleware.js"></script>
    <script src="/js/i18n.js"></script>
    <script src="/js/site-header.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            if (window.AuthService) {
                try {
                    var hash = (window.location && window.location.hash) || '';
                    var isOAuthReturn = hash.indexOf('access_token') !== -1 || hash.indexOf('refresh_token') !== -1;
                    if (isOAuthReturn) await new Promise(function (r) { setTimeout(r, 500); });
                    var session = await AuthService.getSession();
                    var user = session && session.user;
                    if (user) {
                        var profile = await AuthService.getUserProfile();
                        if (!profile && typeof AuthService.createOrUpdateUser === 'function') {
                            await AuthService.createOrUpdateUser(user.id, {
                                email: user.email,
                                full_name: (user.user_metadata && user.user_metadata.full_name) || '',
                                avatar_url: (user.user_metadata && user.user_metadata.avatar_url) || ''
                            });
                        }
                        var returnUrl = typeof sessionStorage !== 'undefined' && sessionStorage.getItem('auth_return_url');
                        if (returnUrl && returnUrl !== '/login.html' && returnUrl.indexOf('login') === -1) {
                            try { sessionStorage.removeItem('auth_return_url'); } catch (e) {}
                            var go = (returnUrl.charAt(0) === '/') ? returnUrl : '/' + returnUrl;
                            window.location.replace(go);
                            return;
                        }
                    }
                } catch (e) { console.warn('createOrUpdateUser:', e && e.message); }
            }
            if (window.i18n && window.i18n.ready) {
                window.i18n.ready.then(function () {
                    if (window.i18n && window.i18n.applyPage) window.i18n.applyPage();
                });
            }
        });
    </script>
    <script src="/iStudio-1.0.0/lib/wow/wow.min.js"></script>
    <script src="/iStudio-1.0.0/lib/easing/easing.min.js"></script>
    <script src="/iStudio-1.0.0/lib/waypoints/waypoints.min.js"></script>
    <script src="/iStudio-1.0.0/lib/owlcarousel/owl.carousel.min.js"></script>

    <!-- Template Javascript -->
    <script src="/js/ai-categories.js"></script>
    <script src="/iStudio-1.0.0/js/site-common.js"></script>
    <script src="/js/main.js"></script>
    <script>
        (function () {
            var grid = document.getElementById('media-wall-grid');
            var empty = document.getElementById('media-wall-empty');
            var loading = document.getElementById('media-wall-loading');
            var loadMoreBtn = document.getElementById('media-wall-load-more');
            var searchInput = document.getElementById('media-wall-search');
            var searchBtn = document.getElementById('media-wall-search-btn');
            if (!grid) return;

            /* ═══ 我的最愛（登入才可用，同步雲端） ═══ */
            var favCache = null;          // 記憶體快取，null 表示尚未從 DB 載入
            var favUserLoggedIn = false;  // 是否已登入
            var showingFavoritesOnly = false;

            // 取 Auth token
            async function getFavToken() {
                if (typeof AuthService === 'undefined') return null;
                try {
                    var s = await AuthService.getSession();
                    return (s && (s.access_token || (s.session && s.session.access_token))) || null;
                } catch(e) { return null; }
            }

            // 顯示登入提示 toast
            function showLoginToast() {
                var existing = document.getElementById('mw-login-toast');
                if (existing) existing.remove();
                var t = document.createElement('div');
                t.id = 'mw-login-toast';
                t.style.cssText = 'position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#445D7E;color:#fff;padding:10px 20px;border-radius:8px;z-index:9999;font-size:0.9rem;box-shadow:0 4px 12px rgba(0,0,0,.25);display:flex;align-items:center;gap:10px;';
                t.innerHTML = '<i class="bi bi-person-circle"></i> 請先登入才能使用收藏功能 <a href="/login.html" style="color:#ffd;text-decoration:underline;white-space:nowrap;">前往登入</a>';
                document.body.appendChild(t);
                setTimeout(function() { if (t.parentNode) t.remove(); }, 3500);
            }

            // 讀快取
            function loadFavs() { return favCache || []; }

            // 寫快取 + 更新過濾按鈕計數
            function saveFavs(arr) {
                favCache = arr;
                var btn = document.getElementById('mw-fav-filter-btn');
                if (btn) {
                    var n = arr.length;
                    var countEl = btn.querySelector('.fav-count');
                    if (countEl) countEl.textContent = n ? ' (' + n + ')' : '';
                }
            }

            function isFavorite(id) { return loadFavs().some(function(f){ return f.id === String(id); }); }

            // 從 DB 拉取（登入後呼叫）
            async function syncFavsFromDB() {
                var token = await getFavToken();
                if (!token) { favUserLoggedIn = false; return; }
                favUserLoggedIn = true;
                try {
                    var r = await fetch('/api/me/favorites', { headers: { Authorization: 'Bearer ' + token } });
                    if (!r.ok) return;
                    var d = await r.json();
                    var dbFavs = (d.favorites || []).map(function(f){ return { id: f.id, item: f.item || {}, savedAt: f.savedAt || Date.now() }; });
                    saveFavs(dbFavs);
                    updateAllFavButtons();
                } catch(e) { console.warn('收藏 DB 同步失敗:', e); }
            }

            // 重新同步格線所有愛心按鈕
            function updateAllFavButtons() {
                grid.querySelectorAll('.mw-fav-btn').forEach(function(btn) {
                    var favId = btn.getAttribute('data-fav-id');
                    var faved = isFavorite(favId);
                    btn.classList.toggle('active', faved);
                    var icon = btn.querySelector('i');
                    if (icon) icon.className = faved ? 'bi bi-heart-fill' : 'bi bi-heart';
                    btn.title = faved ? '已加入收藏' : '加入收藏';
                });
            }

            // 切換收藏（未登入 → 提示登入；登入 → 即時更新記憶體 + 背景寫 DB）
            async function toggleFavorite(id, item, btn) {
                if (!favUserLoggedIn) { showLoginToast(); return; }
                var favs = loadFavs();
                var idx = favs.findIndex(function(f){ return f.id === String(id); });
                var isNowFaved;
                if (idx >= 0) {
                    favs.splice(idx, 1);
                    isNowFaved = false;
                } else {
                    favs.push({ id: String(id), item: item || {}, savedAt: Date.now() });
                    isNowFaved = true;
                }
                saveFavs(favs);
                // 即時更新按鈕外觀
                if (btn) {
                    btn.classList.toggle('active', isNowFaved);
                    var icon = btn.querySelector('i');
                    if (icon) icon.className = isNowFaved ? 'bi bi-heart-fill' : 'bi bi-heart';
                    btn.title = isNowFaved ? '已加入收藏' : '加入收藏';
                }
                // 若正在顯示收藏模式且取消收藏，即時移除卡片
                if (showingFavoritesOnly && !isNowFaved) {
                    var wrap = btn && btn.closest('.media-wall-item');
                    if (wrap) wrap.remove();
                    if (!grid.querySelector('.media-wall-item')) renderFavoritesEmptyState();
                }
                // 背景寫 DB
                var token = await getFavToken();
                if (token) {
                    try {
                        await fetch('/api/me/favorites', {
                            method: 'POST',
                            headers: { Authorization: 'Bearer ' + token, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ item_id: String(id), item_data: item || {} })
                        });
                    } catch(e) { console.warn('收藏 API 失敗:', e); }
                }
            }

            // 縮圖列已移除（改由格線過濾顯示），保留空函數供舊呼叫點相容
            function renderFavSection() {}

            // 「我的收藏」過濾：只顯示已收藏作品
            function renderFavoritesGrid() {
                var favs = loadFavs();
                grid.innerHTML = '';
                if (!favs.length) { renderFavoritesEmptyState(); return; }
                favs.forEach(function(f) {
                    var item = f.item || {};
                    // 還原為 renderOne 接受的格式（title 已是 escaped，需 decode 讓 renderOne 再 escape 一次）
                    var div = document.createElement('div');
                    div.innerHTML = item.title || '';
                    var rawTitle = div.textContent;
                    var p = {
                        id: f.id, type: item.type || 'user_design',
                        title: rawTitle, image_url: item.image_url || '',
                        image_url_before: item.image_url_before || '',
                        cover_image_url: item.cover_image_url || '',
                        image_urls: item.image_urls || null,
                        link: item.link || '',
                        generation_prompt: item.generation_prompt || null,
                        generation_seed: item.generation_seed || null,
                        owner_display: item.owner_display || null,
                        category_key: item.category_key || null,
                        subcategory_key: item.subcategory_key || null
                    };
                    var wrap = renderOne(p, adminOpts);
                    if (wrap) grid.appendChild(wrap);
                });
                grid.classList.remove('d-none');
                if (empty) empty.classList.add('d-none');
                if (loading) loading.classList.add('d-none');
                if (loadMoreBtn) loadMoreBtn.classList.add('d-none');
            }
            function renderFavoritesEmptyState() {
                grid.innerHTML = '<div class="text-center py-5 text-muted w-100"><i class="bi bi-heart display-4 d-block mb-3"></i><div>尚無收藏作品</div><div class="small mt-1">在作品左上角按愛心即可加入收藏</div></div>';
                grid.classList.remove('d-none');
                if (empty) empty.classList.add('d-none');
                if (loadMoreBtn) loadMoreBtn.classList.add('d-none');
            }

            // 開 lightbox（從最愛縮圖點擊用）
            function syncLightboxFavBtn(favId, item) {
                var btn = document.getElementById('media-wall-lightbox-fav');
                var label = document.getElementById('media-wall-lightbox-fav-label');
                if (!btn) return;
                var faved = isFavorite(favId);
                btn.dataset.favId = favId;
                try { btn.dataset.favItem = JSON.stringify(item); } catch(e) {}
                if (faved) {
                    btn.className = 'btn btn-danger btn-sm me-auto';
                    var ic = btn.querySelector('i'); if (ic) ic.className = 'bi bi-heart-fill';
                    btn.title = '已加入收藏';
                    if (label) label.textContent = '已收藏';
                } else {
                    btn.className = 'btn btn-outline-secondary btn-sm me-auto';
                    var ic = btn.querySelector('i'); if (ic) ic.className = 'bi bi-heart';
                    btn.title = '加入收藏';
                    if (label) label.textContent = '收藏';
                }
            }
            function openLightboxForItem(item) {
                var titleEl = document.getElementById('media-wall-lightbox-title');
                var bodyEl = document.getElementById('media-wall-lightbox-body-inner');
                var linkEl = document.getElementById('media-wall-lightbox-link');
                var contactBtn = document.getElementById('media-wall-lightbox-contact');
                if (titleEl) titleEl.textContent = item.title || '';

                // 「找廠商訂製」vs「查看廠商頁」依類型調整
                var isVendorItem = (item.type === 'comparison' || item.type === 'collection');
                var mUserId = item.manufacturer_user_id || null;
                var mfrId = item.manufacturer_id || null;

                if (linkEl) {
                    linkEl.onclick = null;
                    if (isVendorItem && mfrId) {
                        // 廠商作品（comparison / collection）→ 直接跳廠商詳情頁
                        var destUrl = '/vendor-profile.html?id=' + encodeURIComponent(mfrId);
                        linkEl.innerHTML = '<i class="bi bi-person-badge me-1"></i>查看廠商詳情';
                        linkEl.onclick = function() { window.location.href = destUrl; };
                        linkEl.style.display = 'inline-block';
                    } else if (isVendorItem && item.link && item.link.indexOf('collection.html') !== -1) {
                        // 有 slug 的資料夾但無廠商 ID → 查看系列
                        var collUrl = item.link;
                        linkEl.innerHTML = '<i class="bi bi-images me-1"></i>查看系列圖片';
                        linkEl.onclick = function() { window.location.href = collUrl; };
                        linkEl.style.display = 'inline-block';
                    } else if (item.type === 'user_design') {
                        // 用戶設計 → 瀏覽廠商列表找人接單
                        linkEl.innerHTML = '<i class="bi bi-building me-1"></i>找廠商訂製';
                        linkEl.onclick = function() { window.location.href = '/vendors.html'; };
                        linkEl.style.display = 'inline-block';
                    } else if (item.link) {
                        var fallUrl = item.link;
                        linkEl.innerHTML = '<i class="bi bi-building me-1"></i>找廠商訂製';
                        linkEl.onclick = function() { window.location.href = fallUrl; };
                        linkEl.style.display = 'inline-block';
                    } else {
                        linkEl.innerHTML = '<i class="bi bi-building me-1"></i>找廠商';
                        linkEl.onclick = function() { window.location.href = '/vendors.html'; };
                        linkEl.style.display = 'inline-block';
                    }
                }

                var imgUrl = item.image_url || item.cover_image_url || '';
                if (bodyEl) bodyEl.innerHTML = imgUrl ? '<img src="' + imgUrl.replace(/"/g,'&quot;') + '" alt="">' : '<p class="text-muted py-4 mb-0">無圖</p>';
                var detailWrap = document.getElementById('media-wall-lightbox-detail');
                if (detailWrap) detailWrap.classList.add('d-none');
                var favId = item.id || (item.title + item.type);
                syncLightboxFavBtn(favId, item);

                // 廠商聯絡按鈕：廠商上傳的項目且有 manufacturer_user_id 時顯示站內聯絡
                if (contactBtn) {
                    if (isVendorItem && mUserId) {
                        contactBtn.classList.remove('d-none');
                        contactBtn.innerHTML = '<i class="bi bi-chat-dots me-1"></i>聯絡廠商';
                        contactBtn.onclick = function() {
                            if (!favUserLoggedIn) { showLoginToast(); return; }
                            window.location.href = '/client/messages.html?open=' + encodeURIComponent(mUserId);
                        };
                    } else if (isVendorItem && mfrId) {
                        // 有廠商ID但無用戶帳號 → 引導到廠商頁
                        contactBtn.classList.remove('d-none');
                        contactBtn.innerHTML = '<i class="bi bi-person-badge me-1"></i>查看廠商';
                        contactBtn.onclick = function() {
                            window.location.href = '/vendor-profile.html?id=' + encodeURIComponent(mfrId);
                        };
                    } else if (isVendorItem) {
                        // 廠商項目但無任何ID → 引導到廠商列表
                        contactBtn.classList.remove('d-none');
                        contactBtn.innerHTML = '<i class="bi bi-building me-1"></i>瀏覽廠商';
                        contactBtn.onclick = function() { window.location.href = '/vendors.html'; };
                    } else {
                        // user_design：不顯示廠商聯絡（用「找廠商訂製」按鈕代替）
                        contactBtn.classList.add('d-none');
                        contactBtn.onclick = null;
                    }
                }
                if (window.bootstrap) { var m = new bootstrap.Modal(document.getElementById('media-wall-lightbox')); m.show(); }
            }
            /* ═══ 結束 我的最愛 ═══ */
            var currentPage = 1;
            var currentQ = '';
            var perPage = 20;
            function esc(s) { return (s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }
            function escAttr(s) { return (s || '').replace(/"/g, '&quot;').replace(/</g, '&lt;'); }
            function renderOne(p, opts) {
                    var wrap = document.createElement('div');
                    var cls = 'media-wall-item';
                    if (p.type === 'collection' || p.size === '1x2') cls += ' media-wall-1x2';
                    if (p.type === 'comparison') cls += ' media-wall-comparison';
                    wrap.className = cls;
                    wrap.setAttribute('data-type', p.type || '');
                    if (p.id) wrap.setAttribute('data-id', p.id);
                    var link = escAttr(p.link || '/custom/gallery.html');
                    var title = esc(p.title);
                    var content = '';
                    var wrapExtra = '';
                    var placeholdAfter = 'https://placehold.co/400x300/555/aaa?text=%E5%AF%A6%E5%93%81';
                    var placeholdBefore = 'https://placehold.co/400x300/888/ccc?text=%E6%A6%82%E5%BF%B5';
                    if (p.type === 'user_design') {
                        var img = (p.image_url || '').trim();
                        content = (img ? '<img src="' + escAttr(img) + '" alt="">' : '<div class="media-wall-placeholder"><span>無圖</span></div>');
                    } else if (p.type === 'comparison') {
                        var compAfter = (p.image_url || '').trim() || placeholdAfter;
                        var compBefore = (p.image_url_before || '').trim() || placeholdBefore;
                        content = '<div class="comparison-slider-wrap"><img class="slider-bg" src="' + escAttr(compAfter) + '" alt="實品"><img class="slider-fg" src="' + escAttr(compBefore) + '" alt="概念" style="clip-path:inset(0 50% 0 0)"><div class="slider-overlay"><div class="slider-line" style="left:50%; margin-left:-1px"></div><div class="slider-handle" style="left:50%; margin-left:-14px">⇄</div><span class="slider-hint">左右移動滑桿可對照效果</span><input type="range" min="0" max="100" value="50"></div></div>';
                    } else if (p.type === 'collection') {
                        var cov = (p.cover_image_url || '').trim();
                        var urls = p.image_urls && Array.isArray(p.image_urls) ? p.image_urls : (cov ? [cov, cov] : []);
                        if (urls.length === 0) {
                            content = '<div class="media-wall-placeholder"><span>系列</span></div>';
                        } else {
                            wrapExtra = ' collection-grid';
                            var two = [urls[0], urls[1] || urls[0]];
                            content = two.map(function (u) { return '<img src="' + escAttr(u) + '" alt="">'; }).join('');
                        }
                    } else {
                        var img = (p.image_url || p.cover_image_url || '').trim();
                        content = (img ? '<img src="' + escAttr(img) + '" alt="">' : '<div class="media-wall-placeholder"><span>—</span></div>');
                    }
                    var dataItem = { id: String(p.id || (p.title + p.type)), type: p.type, title: title, link: p.link || '/custom/gallery.html', image_url: (p.image_url || '').trim(), image_url_before: (p.image_url_before || '').trim(), cover_image_url: (p.cover_image_url || '').trim() };
                    if (p.type === 'comparison' || p.type === 'collection') {
                        dataItem.manufacturer_id = p.manufacturer_id || null;
                        dataItem.manufacturer_user_id = p.manufacturer_user_id || null;
                        dataItem.manufacturer_name = p.manufacturer_name || null;
                    }
                    if (p.type === 'collection') dataItem.image_urls = (p.image_urls && Array.isArray(p.image_urls) && p.image_urls.length) ? p.image_urls : ((p.cover_image_url ? [p.cover_image_url, p.cover_image_url] : []));
                    if (p.type === 'user_design') {
                        var promptText = (p.analysis_json && p.analysis_json.generation_prompt) || p.generation_prompt || p.title || '';
                        var seedStr = (p.analysis_json && p.analysis_json.generation_seed != null) ? String(p.analysis_json.generation_seed) : (p.generation_seed != null ? String(p.generation_seed) : '');
                        dataItem.generation_prompt = promptText || null;
                        dataItem.generation_seed = seedStr !== '' ? seedStr : null;
                        dataItem.owner_display = p.owner_display || null;
                        dataItem.category_key = p.category_key || p.category || null;
                        dataItem.subcategory_key = p.subcategory_key || null;
                    }
                    wrap.setAttribute('data-item', JSON.stringify(dataItem));
                    var isFaved = isFavorite(p.id || (p.title + p.type));
                    wrap.innerHTML = '<div class="card"><a href="#" class="media-wall-card-link text-decoration-none text-dark"><div class="card-img-wrap' + wrapExtra + '">' + content + '<div class="card-title-overlay">' + title + '</div></div></a><button type="button" class="mw-fav-btn' + (isFaved ? ' active' : '') + '" title="' + (isFaved ? '已加入收藏' : '加入收藏') + '" data-fav-id="' + escAttr(String(p.id || (p.title + p.type))) + '"><i class="bi ' + (isFaved ? 'bi-heart-fill' : 'bi-heart') + '"></i></button></div>';
                    // 愛心按鈕事件
                    var favBtn = wrap.querySelector('.mw-fav-btn');
                    if (favBtn) {
                        favBtn.addEventListener('click', function(e) {
                            e.preventDefault(); e.stopPropagation();
                            var favId = favBtn.getAttribute('data-fav-id');
                            toggleFavorite(favId, dataItem, favBtn);
                        });
                    }
                    if (opts && opts.isAdmin && p.id && p.id !== 'demo-comparison') {
                        var card = wrap.querySelector('.card');
                        if (card) {
                            var actions = document.createElement('div');
                            actions.className = 'media-wall-admin-actions';
                            var hideBtn = document.createElement('button');
                            hideBtn.type = 'button';
                            hideBtn.className = 'media-wall-admin-hide';
                            hideBtn.textContent = '隱藏';
                            hideBtn.title = '從首頁隱藏，可還原';
                            hideBtn.addEventListener('click', function (e) {
                                e.preventDefault();
                                e.stopPropagation();
                                var type = wrap.getAttribute('data-type');
                                var id = wrap.getAttribute('data-id');
                                if (!type || !id) return;
                                (opts.getToken || function () { return Promise.resolve(null); })().then(function (token) {
                                    if (!token) { alert('請先登入'); return; }
                                    fetch('/api/admin/media-wall-item', {
                                        method: 'PATCH',
                                        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ type: type, id: id, show: false })
                                    }).then(function (r) { return r.json(); }).then(function (data) {
                                        if (data.success) wrap.remove();
                                        else alert(data.error || '無法關閉顯示');
                                    }).catch(function () { alert('無法關閉顯示'); });
                                });
                            });
                            var deleteBtn = document.createElement('button');
                            deleteBtn.type = 'button';
                            deleteBtn.className = 'media-wall-admin-hide media-wall-admin-delete';
                            deleteBtn.textContent = '刪除';
                            deleteBtn.title = '用戶設計會永久刪除；對比/系列僅從首頁隱藏';
                            deleteBtn.addEventListener('click', function (e) {
                                e.preventDefault();
                                e.stopPropagation();
                                var type = wrap.getAttribute('data-type');
                                var id = wrap.getAttribute('data-id');
                                if (!type || !id) return;
                                if (type === 'user_design' && !confirm('確定要永久刪除這張作品？刪除後無法復原。')) return;
                                (opts.getToken || function () { return Promise.resolve(null); })().then(function (token) {
                                    if (!token) { alert('請先登入'); return; }
                                    fetch('/api/admin/media-wall-item', {
                                        method: 'DELETE',
                                        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ type: type, id: id })
                                    }).then(function (r) { return r.json(); }).then(function (data) {
                                        if (data.success) wrap.remove();
                                        else alert(data.error || '無法刪除');
                                    }).catch(function () { alert('無法刪除'); });
                                });
                            });
                            actions.appendChild(hideBtn);
                            actions.appendChild(deleteBtn);
                            card.appendChild(actions);
                        }
                    }
                    var compWrap = wrap.querySelector('.comparison-slider-wrap');
                    if (compWrap) {
                        var range = compWrap.querySelector('input[type="range"]');
                        var fg = compWrap.querySelector('img.slider-fg');
                        var line = compWrap.querySelector('.slider-line');
                        var handle = compWrap.querySelector('.slider-handle');
                        function setPos(v) {
                            var val = Math.max(0, Math.min(100, Number(v)));
                            if (range) range.value = val;
                            if (fg) fg.style.clipPath = 'inset(0 ' + (100 - val) + '% 0 0)';
                            if (line) { line.style.left = val + '%'; line.style.marginLeft = '-1px'; }
                            if (handle) { handle.style.left = val + '%'; handle.style.marginLeft = '-14px'; }
                        }
                        function pctFromEvent(e) {
                            var rect = compWrap.getBoundingClientRect();
                            var x = (e.touches && e.touches[0] ? e.touches[0].clientX : e.clientX) - rect.left;
                            return Math.max(0, Math.min(100, (x / rect.width) * 100));
                        }
                        if (range) {
                            range.addEventListener('input', function () { setPos(Number(this.value)); });
                            range.addEventListener('mousedown', function (e) {
                                e.preventDefault();
                                e.stopPropagation();
                                setPos(pctFromEvent(e));
                                var onMove = function (ev) { setPos(pctFromEvent(ev)); ev.preventDefault(); };
                                var onUp = function () { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); };
                                document.addEventListener('mousemove', onMove);
                                document.addEventListener('mouseup', onUp);
                            });
                            range.addEventListener('click', function (e) { e.stopPropagation(); });
                            compWrap.addEventListener('touchstart', function (e) {
                                if (e.target !== range) return;
                                setPos(pctFromEvent(e));
                                var onMove = function (ev) { setPos(pctFromEvent(ev)); ev.preventDefault(); };
                                var onEnd = function () { document.removeEventListener('touchmove', onMove); document.removeEventListener('touchend', onEnd); };
                                document.addEventListener('touchmove', onMove, { passive: false });
                                document.addEventListener('touchend', onEnd);
                            });
                        }
                    }
                    return wrap;
            }
            var adminOpts = { isAdmin: false, getToken: function () { return Promise.resolve(null); } };
            var currentCategoryKey = '';
            var currentSubcategoryKey = '';

            // ── 我的收藏 過濾按鈕 ──
            var favFilterBtn = document.getElementById('mw-fav-filter-btn');
            if (favFilterBtn) {
                favFilterBtn.addEventListener('click', function () {
                    if (!favUserLoggedIn) { showLoginToast(); return; }
                    showingFavoritesOnly = !showingFavoritesOnly;
                    favFilterBtn.classList.toggle('btn-danger', showingFavoritesOnly);
                    favFilterBtn.classList.toggle('btn-outline-secondary', !showingFavoritesOnly);
                    var icon = favFilterBtn.querySelector('i');
                    if (icon) icon.className = showingFavoritesOnly ? 'bi bi-heart-fill me-1' : 'bi bi-heart me-1';
                    if (showingFavoritesOnly) {
                        renderFavoritesGrid();
                    } else {
                        loadMediaWall(1, searchInput ? searchInput.value.trim() : '', false, adminOpts);
                    }
                });
            }

            // 頁面載入後同步 DB 收藏（僅登入時）
            (function () {
                if (typeof AuthService !== 'undefined') {
                    AuthService.onAuthStateChange(function (event, session) {
                        if (session && session.user) {
                            syncFavsFromDB();
                        } else {
                            // 登出：清空快取、重設按鈕
                            favUserLoggedIn = false;
                            saveFavs([]);
                            updateAllFavButtons();
                            if (showingFavoritesOnly) {
                                showingFavoritesOnly = false;
                                if (favFilterBtn) {
                                    favFilterBtn.classList.remove('btn-danger');
                                    favFilterBtn.classList.add('btn-outline-secondary');
                                    var icon = favFilterBtn.querySelector('i');
                                    if (icon) icon.className = 'bi bi-heart me-1';
                                }
                                loadMediaWall(1, '', false, adminOpts);
                            }
                        }
                    });
                    syncFavsFromDB();
                }
            })();
            var categoriesData = { categories: [] };
            var categoriesLang = '';
            function buildMediaWallUrl(page, q) {
                var url = '/api/media-wall?per_page=' + perPage + '&page=' + page + (q ? '&q=' + encodeURIComponent(q) : '');
                if (currentCategoryKey) url += '&category_key=' + encodeURIComponent(currentCategoryKey);
                if (currentSubcategoryKey) url += '&subcategory_key=' + encodeURIComponent(currentSubcategoryKey);
                return url;
            }
            function loadMediaWall(page, q, append, opts) {
                opts = opts || adminOpts;
                if (!append) { grid.innerHTML = ''; loading.classList.remove('d-none'); empty.classList.add('d-none'); }
                var url = buildMediaWallUrl(page, q);
                fetch(url).then(function (r) { return r.json(); }).then(function (data) {
                    loading.classList.add('d-none');
                    if (data.error) { if (!append) { empty.classList.remove('d-none'); empty.innerHTML = '無法載入作品牆，請稍後再試。'; } return; }
                    var items = data.items || [];
                    if (!append && items.length === 0) { empty.classList.remove('d-none'); loadMoreBtn.classList.add('d-none'); return; }
                    empty.classList.add('d-none');
                    items.sort(function (a, b) { return ((a.type === 'collection' || a.size === '1x2') ? 0 : 1) - ((b.type === 'collection' || b.size === '1x2') ? 0 : 1); });
                    items.forEach(function (p) { grid.appendChild(renderOne(p, opts)); });
                    currentPage = page;
                    currentQ = q;
                    renderFavSection();
                    if (loadMoreBtn) loadMoreBtn.classList.toggle('d-none', items.length < perPage);
                }).catch(function () {
                    loading.classList.add('d-none');
                    if (!append) { empty.classList.remove('d-none'); empty.innerHTML = '無法載入作品牆，請稍後再試。'; }
                });
            }
            function runFilterMain(key) {
                currentCategoryKey = key || '';
                currentSubcategoryKey = '';
                var subRowEl = document.getElementById('media-wall-filter-sub');
                if (subRowEl) { subRowEl.classList.add('d-none'); subRowEl.innerHTML = ''; }
                renderFilterTags();
                loadMediaWall(1, currentQ, false, adminOpts);
            }
            function runFilterSub(subKey) {
                currentSubcategoryKey = subKey || '';
                renderFilterTags();
                loadMediaWall(1, currentQ, false, adminOpts);
            }
            function renderFilterTags() {
                var mainRow = document.getElementById('media-wall-filter-main');
                var subRow = document.getElementById('media-wall-filter-sub');
                var filterEl = document.getElementById('media-wall-filter');
                if (!mainRow) return;
                mainRow.innerHTML = '';
                var isEn = categoriesLang && String(categoriesLang).toLowerCase().indexOf('zh') !== 0;
                var allMain = document.createElement('span');
                allMain.className = 'filter-tag' + (currentCategoryKey === '' ? ' active' : '');
                allMain.textContent = isEn ? 'All' : '全部';
                allMain.role = 'button';
                allMain.tabIndex = 0;
                allMain.addEventListener('click', function () { runFilterMain(''); });
                allMain.addEventListener('keydown', function (e) { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); runFilterMain(''); } });
                mainRow.appendChild(allMain);
                (categoriesData.categories || []).forEach(function (c) {
                    var tag = document.createElement('span');
                    tag.className = 'filter-tag' + (currentCategoryKey === (c.key || '') ? ' active' : '');
                    tag.textContent = c.name || c.key || '';
                    tag.role = 'button';
                    tag.tabIndex = 0;
                    tag.dataset.categoryKey = c.key || '';
                    var keyVal = tag.dataset.categoryKey;
                    tag.addEventListener('click', function () { runFilterMain(keyVal); });
                    tag.addEventListener('keydown', function (e) { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); runFilterMain(keyVal); } });
                    mainRow.appendChild(tag);
                });
                if (currentCategoryKey && categoriesData.categories.length) {
                    var cat = categoriesData.categories.find(function (x) { return (x.key || '') === currentCategoryKey; });
                    if (cat && cat.subcategories && cat.subcategories.length) {
                        subRow.classList.remove('d-none');
                        subRow.innerHTML = '';
                        var subLabel = document.createElement('span');
                        subLabel.className = 'filter-sub-label';
                        subLabel.textContent = isEn ? 'Subcategory: ' : '子分類：';
                        subLabel.style.cssText = 'font-size:0.75rem;color:#5c6470;margin-right:0.25rem;align-self:center;';
                        subRow.appendChild(subLabel);
                        var backTag = document.createElement('span');
                        backTag.className = 'filter-tag filter-sub';
                        backTag.textContent = isEn ? '← Back' : '← 上一層';
                        backTag.role = 'button';
                        backTag.title = '回到大分類';
                        backTag.addEventListener('click', function () { runFilterMain(''); });
                        backTag.addEventListener('keydown', function (e) { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); runFilterMain(''); } });
                        subRow.appendChild(backTag);
                        var allSub = document.createElement('span');
                        allSub.className = 'filter-tag filter-sub' + (currentSubcategoryKey === '' ? ' active' : '');
                        allSub.textContent = isEn ? 'All' : '全部';
                        allSub.role = 'button';
                        allSub.addEventListener('click', function () { runFilterSub(''); });
                        allSub.addEventListener('keydown', function (e) { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); runFilterSub(''); } });
                        subRow.appendChild(allSub);
                        cat.subcategories.forEach(function (sub) {
                            var st = document.createElement('span');
                            st.className = 'filter-tag filter-sub' + (currentSubcategoryKey === (sub.key || '') ? ' active' : '');
                            st.textContent = sub.name || sub.key || '';
                            st.role = 'button';
                            st.dataset.subKey = sub.key || '';
                            var subKeyVal = st.dataset.subKey || '';
                            st.addEventListener('click', function () { runFilterSub(subKeyVal); });
                            st.addEventListener('keydown', function (e) { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); runFilterSub(subKeyVal); } });
                            subRow.appendChild(st);
                        });
                    }
                }
                if (filterEl) filterEl.classList.remove('d-none');
            }
            (async function () {
                if (window.AuthService && AuthService.getUserProfile && AuthService.getSession) {
                    try {
                        var profile = await AuthService.getUserProfile();
                        var session = await AuthService.getSession();
                        if (profile && profile.role === 'admin') adminOpts.isAdmin = true;
                        var token = (session && session.access_token) || (session && session.session && session.session.access_token);
                        if (token) {
                            adminOpts.getToken = function () { return AuthService.getSession().then(function (s) { return (s && s.access_token) || (s && s.session && s.session.access_token) || null; }); };
                        }
                    } catch (e) {}
                }
                try {
                    var lang = '';
                    if (window.location && window.location.search) {
                        var p = new URLSearchParams(window.location.search);
                        lang = p.get('lang') || '';
                    }
                    if (!lang) try { lang = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) || ''; } catch (e) {}
                    if (!lang && window.i18n && typeof window.i18n.getLang === 'function') lang = window.i18n.getLang() || '';
                    var catUrl = '/api/custom-product-categories';
                    if (lang && String(lang).toLowerCase().indexOf('zh') !== 0) catUrl += '?lang=' + encodeURIComponent(String(lang).split('-')[0]);
                    categoriesLang = lang || '';
                    var catRes = await fetch(catUrl);
                    var catJson = await catRes.json();
                    if (catJson && catJson.categories && catJson.categories.length) categoriesData = catJson;
                } catch (e) {}
                renderFilterTags();
                loadMediaWall(1, '', false, adminOpts);
            })();
            if (searchBtn && searchInput) {
                searchBtn.addEventListener('click', function () { loadMediaWall(1, searchInput.value.trim(), false, adminOpts); });
                searchInput.addEventListener('keydown', function (e) { if (e.key === 'Enter') { e.preventDefault(); loadMediaWall(1, searchInput.value.trim(), false, adminOpts); } });
            }
            if (loadMoreBtn) loadMoreBtn.addEventListener('click', function () { loadMediaWall(currentPage + 1, currentQ, true, adminOpts); });
            grid.addEventListener('click', function (e) {
                var a = e.target.closest('a.media-wall-card-link');
                if (!a) return;
                e.preventDefault();
                var wrap = a.closest('.media-wall-item');
                var data = wrap && wrap.getAttribute('data-item');
                if (!data) return;
                var item = JSON.parse(data);
                var titleEl = document.getElementById('media-wall-lightbox-title');
                var bodyEl = document.getElementById('media-wall-lightbox-body-inner');
                var linkEl = document.getElementById('media-wall-lightbox-link');
                if (titleEl) titleEl.textContent = item.title || '';
                if (linkEl) {
                    linkEl.onclick = null;
                    var _dest = item.manufacturer_id
                        ? '/vendor-profile.html?id=' + encodeURIComponent(item.manufacturer_id)
                        : (item.link || '/vendors.html');
                    var _label = item.manufacturer_id ? '<i class="bi bi-person-badge me-1"></i>查看廠商詳情'
                        : '<i class="bi bi-building me-1"></i>找廠商訂製';
                    linkEl.innerHTML = _label;
                    linkEl.onclick = (function(d){ return function(){ window.location.href = d; }; })(_dest);
                    linkEl.style.display = 'inline-block';
                }
                var rBtn = document.getElementById('media-wall-lightbox-redesign');
                if (rBtn) {
                    var imgForBtn = (item.type === 'comparison' && item.image_url_before) ? (item.image_url_before || '').trim() : (item.image_url || item.cover_image_url || '').trim();
                    rBtn.dataset.imageUrl = imgForBtn;
                    var mainKey = (item.category_key || item.category || '').trim();
                    if (!mainKey && item.category_keys && Array.isArray(item.category_keys) && item.category_keys.length > 0) mainKey = String(item.category_keys[0] || '').trim();
                    rBtn.dataset.categoryKey = mainKey;
                    rBtn.dataset.subcategoryKey = (item.subcategory_key || '').trim();
                    rBtn.style.display = rBtn.dataset.imageUrl ? 'inline-block' : 'none';
                }
                bodyEl.removeAttribute('data-design-image-url');
                var placeholdAfter = 'https://placehold.co/400x300/555/aaa?text=%E5%AF%A6%E5%93%81';
                var placeholdBefore = 'https://placehold.co/400x300/888/ccc?text=%E6%A6%82%E5%BF%B5';
                if (item.type === 'comparison' && (item.image_url || item.image_url_before)) {
                    var after = item.image_url || placeholdAfter;
                    var before = item.image_url_before || placeholdBefore;
                    bodyEl.dataset.designImageUrl = before;
                    bodyEl.innerHTML = '<div class="comparison-slider-wrap" style="position:relative;width:100%;max-width:100%;height:78vh;min-height:320px;margin:0 auto;overflow:hidden;"><img class="slider-bg" src="' + after.replace(/"/g, '&quot;') + '" alt="實品" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;object-position:center"><img class="slider-fg" src="' + before.replace(/"/g, '&quot;') + '" alt="概念" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;object-position:center;clip-path:inset(0 50% 0 0)"><div class="slider-overlay" style="position:absolute;inset:0"><div class="slider-line" style="position:absolute;top:0;bottom:0;width:2px;background:#445D7E;left:50%;margin-left:-1px"></div><div class="slider-handle" style="position:absolute;top:50%;left:50%;width:28px;height:28px;margin:-14px 0 0 -14px;background:#fff;border:2px solid #445D7E;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#445D7E">⇄</div><span class="slider-hint" style="position:absolute;bottom:8px;left:50%;transform:translateX(-50%);padding:2px 8px;background:rgba(0,0,0,.5);color:#fff;font-size:0.65rem;border-radius:4px;white-space:nowrap;">左右移動滑桿可對照效果</span><input type="range" min="0" max="100" value="50" style="position:absolute;inset:0;width:100%;height:100%;opacity:0;cursor:ew-resize"></div></div>';
                    var compWrap = bodyEl.querySelector('.comparison-slider-wrap');
                    var range = compWrap && compWrap.querySelector('input[type="range"]');
                    if (range && compWrap) {
                        var fg = compWrap.querySelector('img.slider-fg');
                        var line = compWrap.querySelector('.slider-line');
                        var handle = compWrap.querySelector('.slider-handle');
                        function setPos(v) {
                            var val = Math.max(0, Math.min(100, Number(v)));
                            if (range) range.value = val;
                            if (fg) fg.style.clipPath = 'inset(0 ' + (100 - val) + '% 0 0)';
                            if (line) { line.style.left = val + '%'; line.style.marginLeft = '-1px'; }
                            if (handle) { handle.style.left = val + '%'; handle.style.marginLeft = '-14px'; }
                        }
                        function pctFromEvent(ev) {
                            var r = compWrap.getBoundingClientRect();
                            var x = (ev.touches && ev.touches[0] ? ev.touches[0].clientX : ev.clientX) - r.left;
                            return Math.max(0, Math.min(100, (x / r.width) * 100));
                        }
                        range.addEventListener('input', function () { setPos(Number(this.value)); });
                        range.addEventListener('mousedown', function (ev) {
                            ev.preventDefault();
                            setPos(pctFromEvent(ev));
                            var onMove = function (e) { setPos(pctFromEvent(e)); e.preventDefault(); };
                            var onUp = function () { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); };
                            document.addEventListener('mousemove', onMove);
                            document.addEventListener('mouseup', onUp);
                        });
                        compWrap.addEventListener('touchstart', function (ev) {
                            if (ev.target !== range) return;
                            setPos(pctFromEvent(ev));
                            var onMove = function (e) { setPos(pctFromEvent(e)); e.preventDefault(); };
                            var onEnd = function () { document.removeEventListener('touchmove', onMove); document.removeEventListener('touchend', onEnd); };
                            document.addEventListener('touchmove', onMove, { passive: false });
                            document.addEventListener('touchend', onEnd);
                        });
                    }
                } else if (item.type === 'collection' && item.image_urls && item.image_urls.length > 0) {
                    var imgs = item.image_urls.slice(0, 20).map(function (u) { return '<img src="' + (u || '').replace(/"/g, '&quot;') + '" alt="" style="max-width:100%;height:auto;object-fit:contain;">'; });
                    bodyEl.innerHTML = '<div class="d-flex flex-wrap gap-2 justify-content-center align-items-start p-2" style="max-height:78vh;overflow-y:auto;">' + imgs.join('') + '</div>';
                } else {
                    var imgUrl = item.image_url || item.cover_image_url || '';
                    var noImageText = (window.i18n && window.i18n.t) ? window.i18n.t('home.noImage') : '無圖';
                    bodyEl.innerHTML = imgUrl ? '<img src="' + imgUrl.replace(/"/g, '&quot;') + '" alt="">' : '<p class="text-muted py-4 mb-0">' + noImageText + '</p>';
                }
                // 同步 lightbox 愛心按鈕狀態
                var lbFavId = item.id || (item.title + item.type);
                syncLightboxFavBtn(lbFavId, item);

                function setLightboxDetailAndShow(cats) {
                    var detailWrap = document.getElementById('media-wall-lightbox-detail');
                    var categoryRow = document.getElementById('media-wall-lightbox-category-row');
                    var categoryEl = document.getElementById('media-wall-lightbox-category');
                    var subcategoryRow = document.getElementById('media-wall-lightbox-subcategory-row');
                    var subcategoryEl = document.getElementById('media-wall-lightbox-subcategory');
                    var promptEl = document.getElementById('media-wall-lightbox-prompt');
                    var seedEl = document.getElementById('media-wall-lightbox-seed');
                    var ownerEl = document.getElementById('media-wall-lightbox-owner');
                    if (item.type === 'user_design' && detailWrap) {
                        detailWrap.classList.remove('d-none');
                        var catKey = item.category_key || item.category || '';
                        var subKey = item.subcategory_key || '';
                        var catLabel = ''; var subLabel = '';
                        if (cats && cats.length) {
                            var cat = catKey ? cats.find(function (c) { return (c.key || '') === catKey; }) : null;
                            if (cat) catLabel = cat.name || catKey;
                            if (subKey && cat && cat.subcategories && cat.subcategories.length) {
                                var sub = cat.subcategories.find(function (s) { return (s.key || '') === subKey; });
                                subLabel = sub ? (sub.name || subKey) : subKey;
                            } else if (subKey) subLabel = subKey;
                        }
                        if (categoryRow && categoryEl) { categoryEl.textContent = catLabel || catKey || '（無）'; categoryRow.style.display = (catKey || catLabel) ? '' : 'none'; }
                        if (subcategoryRow && subcategoryEl) { subcategoryEl.textContent = subLabel || '（無）'; subcategoryRow.style.display = subLabel ? '' : 'none'; }
                        if (promptEl) promptEl.textContent = item.generation_prompt || '（無）';
                        if (seedEl) seedEl.textContent = (item.generation_seed != null && item.generation_seed !== '') ? String(item.generation_seed) : '（無）';
                        if (ownerEl) ownerEl.textContent = item.owner_display || '（無）';
                    } else if (detailWrap) {
                        detailWrap.classList.add('d-none');
                        if (categoryRow) categoryRow.style.display = 'none';
                        if (subcategoryRow) subcategoryRow.style.display = 'none';
                    }
                    if (window.i18n && typeof window.i18n.applyPage === 'function') window.i18n.applyPage();
                    var modal = new bootstrap.Modal(document.getElementById('media-wall-lightbox'));
                    modal.show();
                }
                var currentLang = '';
                if (window.location && window.location.search) { var lp = new URLSearchParams(window.location.search); currentLang = lp.get('lang') || ''; }
                if (!currentLang) try { currentLang = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) || ''; } catch (err) {}
                if (!currentLang && window.i18n && typeof window.i18n.getLang === 'function') currentLang = window.i18n.getLang() || '';
                var useEn = currentLang && String(currentLang).toLowerCase().indexOf('zh') !== 0;
                if (item.type === 'user_design' && useEn && (item.category_key || item.category || item.subcategory_key)) {
                    var url = '/api/custom-product-categories?lang=' + encodeURIComponent(String(currentLang).split('-')[0]);
                    fetch(url).then(function (r) { return r.json(); }).then(function (json) {
                        var cats = (json && json.categories && json.categories.length) ? json.categories : (categoriesData.categories || []);
                        setLightboxDetailAndShow(cats);
                    }).catch(function () { setLightboxDetailAndShow(categoriesData.categories || []); });
                } else {
                    setLightboxDetailAndShow(categoriesData.categories || []);
                }
            });
            // ── lightbox 愛心按鈕 ──
            var lbFavBtn = document.getElementById('media-wall-lightbox-fav');
            if (lbFavBtn) {
                lbFavBtn.addEventListener('click', function () {
                    var favId = this.dataset.favId;
                    var item = {};
                    try { item = JSON.parse(this.dataset.favItem || '{}'); } catch (e) {}
                    // 同步格線上對應的縮圖愛心按鈕
                    var gridCardBtn = grid ? grid.querySelector('.mw-fav-btn[data-fav-id="' + (favId || '').replace(/"/g, '&quot;') + '"]') : null;
                    toggleFavorite(favId, item, gridCardBtn);
                    // 更新 lightbox 愛心按鈕本身
                    syncLightboxFavBtn(favId, item);
                });
            }

            var redesignBtn = document.getElementById('media-wall-lightbox-redesign');
            if (redesignBtn) {
                redesignBtn.addEventListener('click', function () {
                    var url = (this.dataset.imageUrl || '').trim();
                    if (url) {
                        try {
                            sessionStorage.setItem('redesignImageUrl', url);
                            sessionStorage.setItem('redesignCategoryKey', this.dataset.categoryKey || '');
                            sessionStorage.setItem('redesignSubcategoryKey', this.dataset.subcategoryKey || '');
                        } catch (e) {}
                        window.location.href = '/custom-product.html';
                    }
                });
            }
            var sceneSimBtn = document.getElementById('media-wall-lightbox-scene-sim');
            if (sceneSimBtn) {
                sceneSimBtn.addEventListener('click', function () {
                    var inner = document.getElementById('media-wall-lightbox-body-inner');
                    var url = (inner && inner.dataset.designImageUrl) || (inner && inner.querySelector('img') && inner.querySelector('img').src) || (inner && inner.querySelector('.slider-fg') && inner.querySelector('.slider-fg').src) || (inner && inner.querySelector('.slider-bg') && inner.querySelector('.slider-bg').src);
                    if (url) {
                        try { sessionStorage.setItem('sceneSimImageUrl', url); } catch (e) {}
                        window.location.href = '/custom-product.html?tab=scene-sim';
                    }
                });
            }
            var lightboxLink = document.getElementById('media-wall-lightbox-link');
            if (lightboxLink) {
                lightboxLink.addEventListener('click', function (e) {
                    var href = (this.href || '').trim();
                    if (href && href !== '#' && href.indexOf('javascript') !== 0) {
                        e.preventDefault();
                        try {
                            var blob = new Blob([JSON.stringify({ action: 'find_vendor' })], { type: 'application/json' });
                            if (navigator.sendBeacon) navigator.sendBeacon('/api/track-design-action', blob);
                        } catch (err) {}
                        window.open(href, '_blank', 'noopener');
                    }
                });
            }
            if (window.i18n && window.i18n.ready) window.i18n.ready.then(function () { if (window.i18n.applyPage) window.i18n.applyPage(); });
        })();
    </script>
</body>

</html>