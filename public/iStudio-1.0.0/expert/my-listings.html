<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="utf-8">
    <title>我的報價 - MatchDO 合做</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <!-- Favicon -->
    <link href="../img/favicon.ico" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&family=Space+Grotesk&display=swap" rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="../css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="../css/style.css" rel="stylesheet">
</head>

<body>
    <!-- 共用前台導覽 -->
    <div id="site-header"></div>

    <!-- Page Header Start -->
    <div class="container-fluid page-title-bar">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="mb-0 text-dark" data-i18n="myListings.title">我的報價</h3>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="../index.html" data-i18n="myListings.breadcrumbHome">首頁</a></li>
                        <li class="breadcrumb-item active" data-i18n="myListings.title">我的報價</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
    <!-- Page Header End -->

    <!-- My Listings Start -->
    <div class="container-xxl py-3">
        <div class="container">
            <!-- 新增按鈕 -->
            <div class="mb-3">
                <a href="listing-form.html" class="btn btn-primary py-3 px-5">
                    <i class="bi bi-plus-circle me-2"></i><span data-i18n="myListings.addListing">新增報價</span>
                </a>
            </div>

            <!-- 報價列表 -->
            <div id="listingsContainer">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden" data-i18n="myCustomProducts.loading">載入中...</span>
                    </div>
                    <p class="mt-3" data-i18n="myListings.loading">載入報價中...</p>
                </div>
            </div>
        </div>
    </div>
    <!-- My Listings End -->

    <!-- Footer Start -->
    <div class="container-fluid bg-dark text-body footer mt-5 pt-5">
        <div class="container py-5">
            <div class="row g-5">
                <div class="col-lg-12 text-center">
                    <p class="mb-0">&copy; <a class="text-primary" href="#">MatchDO 合做</a>. All Rights Reserved.</p>
                </div>
            </div>
        </div>
    </div>
    <!-- Footer End -->

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Supabase Auth -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/config/auth-config.js"></script>
    <script src="/js/auth-middleware.js"></script>
    <script src="/js/i18n.js"></script>
    <script src="../js/site-header.js"></script>

    <script>
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async () => {
            if (window.i18n && window.i18n.ready) {
                window.i18n.ready.then(function () { window.i18n.applyPage(); });
            }
            // 檢查登入狀態
            const isAuth = await AuthMiddleware.requireAuth();
            if (!isAuth) return;

            currentUser = await AuthService.getCurrentUser();
            loadMyListings();
        });

        async function loadMyListings() {
            const container = document.getElementById('listingsContainer');
            
            try {
                const { data: listings, error } = await supabaseClient
                    .from('listings')
                    .select('*')
                    .eq('expert_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!listings || listings.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <i class="bi bi-inbox" style="font-size: 4rem; color: #ddd;"></i>
                            <h4 class="mt-3">尚無報價項目</h4>
                            <p class="text-muted">點擊上方「新增報價」按鈕開始建立您的第一個報價</p>
                        </div>
                    `;
                    return;
                }

                const listingsHTML = listings.map(listing => `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h5 class="card-title">${listing.title}</h5>
                                    <p class="card-text">${listing.description}</p>
                                    <div class="text-muted small">
                                        <span class="badge bg-primary me-2">${listing.category}</span>
                                        <span>價格: $${listing.price_min?.toLocaleString()} - $${listing.price_max?.toLocaleString()}</span>
                                        <span class="ms-3">交期: ${listing.delivery_days || 'N/A'} 天</span>
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <span class="badge ${listing.status === 'active' ? 'bg-success' : 'bg-secondary'} mb-2">
                                        ${listing.status === 'active' ? '上架中' : '已下架'}
                                    </span>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary me-2" onclick="editListing('${listing.id}')">
                                            <i class="bi bi-pencil"></i> 編輯
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteListing('${listing.id}')">
                                            <i class="bi bi-trash"></i> 刪除
                                        </button>
                                    </div>
                                    <div class="mt-2 text-muted small">
                                        瀏覽: ${listing.views_count} | 詢問: ${listing.inquiries_count}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = listingsHTML;

            } catch (error) {
                console.error('載入報價失敗:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        載入失敗：${error.message}
                    </div>
                `;
            }
        }

        async function editListing(listingId) {
            window.location.href = `listing-form.html?id=${listingId}`;
        }

        async function deleteListing(listingId) {
            if (!confirm('確定要刪除此報價嗎？此操作無法復原。')) return;

            try {
                const { error } = await supabaseClient
                    .from('listings')
                    .delete()
                    .eq('id', listingId);

                if (error) throw error;

                alert('刪除成功！');
                loadMyListings();
            } catch (error) {
                console.error('刪除失敗:', error);
                alert('刪除失敗：' + error.message);
            }
        }
    </script>
</body>

</html>
