<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的數位資產 - MatchDO 合做</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .product-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        .status-badge {
            font-size: 0.85rem;
            padding: 0.35rem 0.75rem;
        }
        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
        }
        .empty-state {
            padding: 4rem 2rem;
            text-align: center;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div id="site-header"></div>

    <div class="container py-5">
        <div class="row mb-4">
            <div class="col">
                <h2><i class="bi bi-images me-2"></i><span data-i18n="myCustomProducts.title">我的數位資產</span></h2>
                <p class="text-muted" data-i18n="myCustomProducts.subtitle">顯示所有生成過的圖片</p>
            </div>
            <div class="col-auto">
                <a href="/custom-product.html" class="btn btn-primary">
                    <i class="bi bi-plus-lg me-2"></i><span data-i18n="myCustomProducts.btnCreate">建立新產品</span>
                </a>
            </div>
        </div>

        <!-- 載入中 -->
        <div id="loadingSpinner" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden" data-i18n="myCustomProducts.loading">載入中...</span>
            </div>
            <p class="mt-3 text-muted" data-i18n="myCustomProducts.loadingList">載入產品列表...</p>
        </div>

        <!-- 產品列表 -->
        <div id="productsList" class="row g-4" style="display: none;"></div>

        <!-- 空白狀態 -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <i class="bi bi-inbox" style="font-size: 4rem; color: #dee2e6;"></i>
            <h4 class="mt-3" data-i18n="myCustomProducts.emptyTitle">尚無客製產品</h4>
            <p data-i18n="myCustomProducts.emptyDesc">立即建立您的第一個客製化產品需求</p>
            <a href="/custom-product.html" class="btn btn-primary mt-3">
                <i class="bi bi-plus-lg me-2"></i><span data-i18n="myCustomProducts.btnStartCreate">開始建立</span>
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Supabase Auth -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/config/auth-config.js"></script>
    <script src="/js/auth-middleware.js"></script>
    <script src="/js/i18n.js"></script>
    <script src="../js/site-header.js"></script>

    <script>

        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async () => {
            if (window.i18n && window.i18n.ready) {
                window.i18n.ready.then(function () { window.i18n.applyPage(); });
            }
            // 檢查登入狀態
            const isAuth = await AuthMiddleware.requireAuth();
            if (!isAuth) return;

            currentUser = await AuthService.getCurrentUser();
            
            // 載入產品列表
            await loadProducts();
        });

        async function loadProducts() {
            try {
                const session = await AuthService.getSession();
                const token = session?.access_token;

                if (!token) {
                    throw new Error('未找到有效的登入 token');
                }

                const response = await fetch('/api/custom-products', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || '載入失敗');
                }

                const products = data.products || [];

                // 隱藏載入動畫
                document.getElementById('loadingSpinner').style.display = 'none';

                if (products.length === 0) {
                    document.getElementById('emptyState').style.display = 'block';
                } else {
                    document.getElementById('productsList').style.display = 'flex';
                    renderProducts(products);
                }

            } catch (error) {
                console.error('載入產品列表失敗:', error);
                document.getElementById('loadingSpinner').style.display = 'none';
                showAlert(((window.i18n && window.i18n.t) ? window.i18n.t('myCustomProducts.loadFail') : '載入產品列表失敗') + ': ' + error.message, 'danger');
            }
        }

        function renderProducts(products) {
            const container = document.getElementById('productsList');
            container.innerHTML = '';

            products.forEach(product => {
                const card = createProductCard(product);
                container.appendChild(card);
            });
        }

        function createProductCard(product) {
            const col = document.createElement('div');
            col.className = 'col-md-6 col-lg-4';

            const statusInfo = getStatusInfo(product.status);
            const imageUrl = product.ai_generated_image_url || product.reference_image_url || 'https://via.placeholder.com/400x300?text=No+Image';

            col.innerHTML = `
                <div class="card product-card h-100">
                    <img src="${imageUrl}" class="card-img-top product-image" alt="${product.title}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="card-title mb-0">${escapeHtml(product.title)}</h5>
                            <span class="badge ${statusInfo.class} status-badge">${statusInfo.text}</span>
                        </div>
                        <p class="card-text text-muted small">${escapeHtml(product.description.substring(0, 100))}${product.description.length > 100 ? '...' : ''}</p>
                        <div class="text-muted small mb-3">
                            <i class="bi bi-calendar me-1"></i>${formatDate(product.created_at)}
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary btn-sm" onclick="viewProduct('${product.id}')">
                                <i class="bi bi-eye me-1"></i>${(window.i18n && window.i18n.t) ? window.i18n.t('myCustomProducts.viewDetail') : '查看詳情'}
                            </button>
                            <a href="/client/find-makers.html${(product.category || product.category_key) ? '?category_key=' + encodeURIComponent(product.category || product.category_key) + (product.subcategory_key ? '&subcategory_key=' + encodeURIComponent(product.subcategory_key) : '') : ''}" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-shop me-1"></i>找製作方
                            </a>
                            ${product.status === 'draft' ? `
                                <button class="btn btn-outline-success btn-sm" onclick="matchProduct('${product.id}')">
                                    <i class="bi bi-search me-1"></i>${(window.i18n && window.i18n.t) ? window.i18n.t('myCustomProducts.startMatch') : '開始媒合'}
                                </button>
                            ` : ''}
                            ${product.status === 'matched' ? `
                                <button class="btn btn-success btn-sm" onclick="viewMatches('${product.id}')">
                                    <i class="bi bi-people me-1"></i>${(window.i18n && window.i18n.t) ? window.i18n.t('myCustomProducts.viewVendors') : '查看廠商'}
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;

            return col;
        }

        function getStatusInfo(status) {
            var t = window.i18n && window.i18n.t ? window.i18n.t.bind(window.i18n) : function (k) { return k; };
            var statusMap = {
                'draft': { text: t('myCustomProducts.statusDraft'), class: 'bg-secondary' },
                'analyzing': { text: t('myCustomProducts.statusAnalyzing'), class: 'bg-info' },
                'matched': { text: t('myCustomProducts.statusMatched'), class: 'bg-success' },
                'contacted': { text: t('myCustomProducts.statusContacted'), class: 'bg-warning' },
                'completed': { text: t('myCustomProducts.statusCompleted'), class: 'bg-primary' }
            };
            return statusMap[status] || { text: status, class: 'bg-secondary' };
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-TW', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit' 
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        window.viewProduct = function(productId) {
            window.location.href = `/client/custom-product-detail.html?id=${productId}`;
        };

        window.matchProduct = async function(productId) {
            var msg = (window.i18n && window.i18n.t) ? window.i18n.t('myCustomProducts.confirmMatch') : '確定要開始媒合廠商嗎？';
            if (!confirm(msg)) return;

            try {
                const session = await AuthService.getSession();
                const token = session?.access_token;

                const response = await fetch(`/api/custom-products/${productId}/match`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || '媒合失敗');
                }

                showAlert((window.i18n && window.i18n.t) ? window.i18n.t('myCustomProducts.matchSuccess') : '媒合成功！正在跳轉...', 'success');
                setTimeout(() => {
                    window.location.href = `/client/custom-product-detail.html?id=${productId}`;
                }, 1500);

            } catch (error) {
                console.error('媒合失敗:', error);
                showAlert(((window.i18n && window.i18n.t) ? window.i18n.t('myCustomProducts.matchFail') : '媒合失敗') + ': ' + error.message, 'danger');
            }
        };

        window.viewMatches = function(productId) {
            window.location.href = `/client/custom-product-detail.html?id=${productId}`;
        };

        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }
    </script>
</body>
</html>
