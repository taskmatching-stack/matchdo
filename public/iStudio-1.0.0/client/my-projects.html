<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="utf-8">
    <title>我的專案 - MatchDO 合做</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <!-- Favicon -->
    <link href="../img/favicon.ico" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&family=Space+Grotesk&display=swap" rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="../css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="../css/style.css" rel="stylesheet">
</head>

<body>
    <!-- 共用前台導覽 -->
    <div id="site-header"></div>

    <!-- Page Header Start -->
    <div class="container-fluid page-title-bar">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="mb-0 text-dark" data-i18n="myProjects.title">我的專案</h3>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="../index.html" data-i18n="myProjects.breadcrumbHome">首頁</a></li>
                        <li class="breadcrumb-item active" data-i18n="myProjects.breadcrumbMyProjects">我的專案</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
    <!-- Page Header End -->

    <!-- My Projects Start -->
    <div class="container-xxl py-2">
        <div class="container">
            <div class="text-center mx-auto mb-3" style="max-width: 600px;">
                <h6 class="text-primary" data-i18n="myProjects.sectionTitle">My Projects</h6>
                <h1 class="mb-3" data-i18n="myProjects.heading">查看您的所有專案</h1>
            </div>

            <!-- 專案列表 -->
            <div id="projectsContainer">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden" data-i18n="myProjects.loading">載入中...</span>
                    </div>
                    <p class="mt-3" data-i18n="myProjects.loading">載入專案中...</p>
                </div>
            </div>
        </div>
    </div>
    <!-- My Projects End -->

    <!-- Footer Start -->
    <div class="container-fluid bg-dark text-body footer mt-3 pt-3">
        <div class="container py-3">
            <div class="row g-5">
                <div class="col-lg-12 text-center">
                    <p class="mb-0">&copy; <a class="text-primary" href="#">MatchDO 合做</a>. All Rights Reserved.</p>
                </div>
            </div>
        </div>
    </div>
    <!-- Footer End -->

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Supabase Auth -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/config/auth-config.js"></script>
    <script src="/js/auth-middleware.js"></script>
    <script src="/js/i18n.js"></script>
    <script src="/js/site-header.js"></script>
    
    <!-- Category Default Images -->
    <script src="/config/category-default-images.js"></script>

    <script>
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async () => {
            if (window.i18n && window.i18n.ready) {
                window.i18n.ready.then(function () { window.i18n.applyPage(); });
            }
            // 檢查登入狀態
            const isAuth = await AuthMiddleware.requireAuth();
            if (!isAuth) return;

            currentUser = await AuthService.getCurrentUser();
            loadMyProjects();
        });

        async function loadMyProjects() {
            const container = document.getElementById('projectsContainer');
            
            try {
                const { data: projects, error } = await supabaseClient
                    .from('projects')
                    .select('*')
                    .eq('owner_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('查詢錯誤:', error);
                    // 不管是權限問題還是其他錯誤，都顯示友好的空狀態
                    var t2 = window.i18n && window.i18n.t ? window.i18n.t.bind(window.i18n) : function (k) { return k; };
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <i class="bi bi-folder-x" style="font-size: 4rem; color: #ddd;"></i>
                            <h4 class="mt-3">` + t2('myProjects.emptyTitle') + `</h4>
                            <p class="text-muted">` + t2('myProjects.emptyPrefix') + `<a href="../index.html#ai-estimate" class="text-decoration-none">` + t2('myProjects.emptyLink') + `</a>` + t2('myProjects.emptySuffix') + `</p>
                        </div>
                    `;
                    return;
                }

                if (!projects || projects.length === 0) {
                    var t3 = window.i18n && window.i18n.t ? window.i18n.t.bind(window.i18n) : function (k) { return k; };
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <i class="bi bi-folder-x" style="font-size: 4rem; color: #ddd;"></i>
                            <h4 class="mt-3">` + t3('myProjects.emptyTitle') + `</h4>
                            <p class="text-muted">` + t3('myProjects.emptyPrefix') + `<a href="../index.html#ai-estimate" class="text-decoration-none">` + t3('myProjects.emptyLink') + `</a>` + t3('myProjects.emptySuffix') + `</p>
                        </div>
                    `;
                    return;
                }

                const projectsHTML = projects.map(project => {
                    var t = window.i18n && window.i18n.t ? window.i18n.t.bind(window.i18n) : function (k) { return k; };
                const statusBadge = {
                        'analyzing': '<span class="badge bg-info">' + t('myProjects.statusAnalyzing') + '</span>',
                        'matched': '<span class="badge bg-success">' + t('myProjects.statusMatched') + '</span>',
                        'in_progress': '<span class="badge bg-primary">' + t('myProjects.statusInProgress') + '</span>',
                        'completed': '<span class="badge bg-secondary">' + t('myProjects.statusCompleted') + '</span>',
                        'cancelled': '<span class="badge bg-danger">' + t('myProjects.statusCancelled') + '</span>'
                    };

                    const analysisData = project.analysis || {};
                    const items = analysisData.items || [];
                    
                    // 取得專案封面圖片（使用新的三層策略）
                    const coverImage = getProjectCoverImage(project);

                    return `
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <img src="${coverImage}" class="img-fluid rounded" alt="${project.category || '專案'}" style="width: 100%; height: 200px; object-fit: cover;">
                                </div>
                                <div class="col-md-9">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <h5 class="card-title">${t('myProjects.projectLabel')} #${project.id.substring(0, 8)}</h5>
                                        ${statusBadge[project.status] || statusBadge.analyzing}
                                    </div>
                                    
                                    ${project.category ? '<p class="mb-2"><strong>' + t('myProjects.category') + ':</strong> ' + project.category + '</p>' : ''}
                                    
                                    ${items.length > 0 ? `
                                        <p class="mb-2"><strong>` + t('myProjects.analysisItems') + `:</strong></p>
                                        <ul class="mb-3">
                                            ${items.slice(0, 3).map(item => `
                                                <li>${item.name || item.item_name} - ${item.estimated_price || 'N/A'}</li>
                                            `).join('')}
                                            ${items.length > 3 ? `<li class="text-muted">...等 ${items.length - 3} 項</li>` : ''}
                                        </ul>
                                    ` : ''}
                                    
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div class="text-muted small">
                                            <i class="bi bi-clock me-1"></i>
                                            ${new Date(project.created_at).toLocaleString('zh-TW')}
                                        </div>
                                        <a href="/client/project-detail.html?id=${project.id}" class="btn btn-primary btn-sm">
                                            <i class="bi bi-eye me-1"></i>${t('myProjects.viewDetail')}
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');

                container.innerHTML = projectsHTML;

            } catch (error) {
                console.error('載入專案失敗:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        載入失敗：${error.message}
                    </div>
                `;
            }
        }
    </script>
</body>

</html>
