<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的訊息 - MatchDO</title>
    <link rel="icon" href="/img/favicon.ico">
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <style>
        html, body { height: 100%; overflow: hidden; }
        .msg-layout { display: flex; height: calc(100vh - 56px); overflow: hidden; }

        /* 左欄：對話列表 */
        .conv-list {
            width: 300px; min-width: 240px; border-right: 1px solid #dee2e6;
            display: flex; flex-direction: column; background: #fff; flex-shrink: 0;
        }
        .conv-list-header { padding: 12px 16px; border-bottom: 1px solid #dee2e6; font-weight: 600; font-size: .95rem; }
        .conv-items { flex: 1; overflow-y: auto; }
        .conv-item {
            display: flex; align-items: center; gap: 10px; padding: 12px 14px;
            border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background .12s;
        }
        .conv-item:hover { background: #f8f9fa; }
        .conv-item.active { background: #e8f0fe; }
        .conv-avatar {
            width: 42px; height: 42px; border-radius: 50%; background: #6c757d;
            display: flex; align-items: center; justify-content: center; color: #fff;
            font-weight: 700; font-size: 1rem; flex-shrink: 0; overflow: hidden;
        }
        .conv-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .conv-info { flex: 1; min-width: 0; }
        .conv-name { font-weight: 600; font-size: .9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .conv-preview { font-size: .78rem; color: #6c757d; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .conv-time { font-size: .72rem; color: #adb5bd; white-space: nowrap; }

        /* 右欄：聊天區 */
        .chat-area { flex: 1; display: flex; flex-direction: column; min-width: 0; background: #f8f9fa; }
        .chat-header {
            padding: 10px 16px; background: #fff; border-bottom: 1px solid #dee2e6;
            display: flex; align-items: center; gap: 10px; flex-shrink: 0;
        }
        .chat-messages {
            flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 10px;
        }
        .chat-empty { margin: auto; text-align: center; color: #adb5bd; }

        /* 訊息泡泡 */
        .msg-row { display: flex; gap: 8px; max-width: 75%; }
        .msg-row.mine { align-self: flex-end; flex-direction: row-reverse; }
        .msg-row.theirs { align-self: flex-start; }
        .msg-avatar {
            width: 32px; height: 32px; border-radius: 50%; background: #6c757d;
            display: flex; align-items: center; justify-content: center; color: #fff;
            font-size: .8rem; font-weight: 700; flex-shrink: 0; align-self: flex-end;
        }
        .msg-bubble-wrap { display: flex; flex-direction: column; gap: 2px; }
        .msg-row.mine .msg-bubble-wrap { align-items: flex-end; }
        .msg-bubble {
            padding: 9px 13px; border-radius: 18px; font-size: .9rem; line-height: 1.45;
            word-break: break-word; position: relative;
        }
        .msg-row.mine .msg-bubble { background: #0d6efd; color: #fff; border-bottom-right-radius: 4px; }
        .msg-row.theirs .msg-bubble { background: #fff; border: 1px solid #dee2e6; border-bottom-left-radius: 4px; }
        .msg-image { max-width: 260px; border-radius: 12px; cursor: pointer; display: block; }
        .msg-time { font-size: .7rem; color: #adb5bd; padding: 0 4px; }
        .msg-actions { display: flex; gap: 4px; margin-top: 2px; }
        .msg-row.mine .msg-actions { justify-content: flex-end; }
        .btn-translate {
            font-size: .72rem; color: #6c757d; background: none; border: none; padding: 0 4px;
            cursor: pointer; display: flex; align-items: center; gap: 2px; transition: color .15s;
        }
        .btn-translate:hover { color: #0d6efd; }
        .msg-translation {
            margin-top: 5px; padding: 6px 10px; background: rgba(0,0,0,.04); border-radius: 8px;
            font-size: .8rem; color: #555; border-left: 3px solid #0d6efd; line-height: 1.5;
        }
        .msg-row.mine .msg-translation { border-left-color: rgba(255,255,255,.5); background: rgba(255,255,255,.15); color: rgba(255,255,255,.9); }
        .translation-label { font-size: .7rem; color: #adb5bd; margin-bottom: 2px; }
        .msg-row.mine .translation-label { color: rgba(255,255,255,.6); }

        /* 輸入區 */
        .chat-input-area {
            padding: 10px 14px; background: #fff; border-top: 1px solid #dee2e6; flex-shrink: 0;
        }
        .img-preview-bar {
            display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px;
        }
        .img-preview-item {
            position: relative; width: 64px; height: 64px; border-radius: 8px; overflow: hidden;
            border: 1px solid #dee2e6;
        }
        .img-preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .img-preview-item .remove-img {
            position: absolute; top: 2px; right: 2px; width: 18px; height: 18px; border-radius: 50%;
            background: rgba(0,0,0,.55); border: none; color: #fff; font-size: 10px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .input-row { display: flex; gap: 8px; align-items: flex-end; }
        .msg-textarea {
            flex: 1; resize: none; border-radius: 20px; padding: 8px 14px;
            border: 1px solid #dee2e6; font-size: .9rem; max-height: 120px; min-height: 38px; line-height: 1.5;
        }
        .msg-textarea:focus { outline: none; border-color: #86b7fe; box-shadow: 0 0 0 3px rgba(13,110,253,.15); }
        .no-conv { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; color: #adb5bd; gap: 12px; }

        @media (max-width: 600px) {
            .conv-list { width: 60px; min-width: 60px; }
            .conv-info, .conv-time { display: none; }
            .conv-item { padding: 10px; justify-content: center; }
        }
    </style>
</head>
<body>
<div id="site-header"></div>

<div class="msg-layout">
    <!-- 左欄：對話列表 -->
    <div class="conv-list">
        <div class="conv-list-header"><i class="bi bi-chat-dots me-2"></i>訊息</div>
        <div class="conv-items" id="convList">
            <div class="text-center text-muted py-4 small"><div class="spinner-border spinner-border-sm me-1"></div>載入中…</div>
        </div>
    </div>

    <!-- 右欄：聊天區 -->
    <div class="chat-area" id="chatArea">
        <div class="no-conv" id="noConvPlaceholder">
            <i class="bi bi-chat-square-dots display-4"></i>
            <div>選擇一個對話開始聊天</div>
        </div>
    </div>
</div>

<!-- 圖片燈箱 -->
<div class="modal fade" id="imgModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-transparent border-0">
            <img id="imgModalSrc" src="" class="img-fluid rounded" alt="圖片">
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/config/auth-config.js"></script>
<script src="/js/i18n.js"></script>
<script src="/js/site-header.js"></script>
<script>
(function () {
    var token = null;
    var currentConvId = null;
    var currentOtherUser = null;
    var myUserId = null;
    var pollTimer = null;
    var lastMsgId = null;
    var pendingImage = null; // { blob, dataUrl }

    // ── helpers ──────────────────────────────────────────────────────
    function esc(s) { return String(s == null ? '' : s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
    function fmtTime(iso) {
        if (!iso) return '';
        var d = new Date(iso);
        var now = new Date();
        var diffDays = Math.floor((now - d) / 86400000);
        if (diffDays === 0) return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        if (diffDays === 1) return '昨天';
        if (diffDays < 7) return ['日','一','二','三','四','五','六'][d.getDay()] ? '週' + ['日','一','二','三','四','五','六'][d.getDay()] : '';
        return (d.getMonth()+1) + '/' + d.getDate();
    }
    function avatarHtml(name, cls) {
        var letter = (name || '?').charAt(0).toUpperCase();
        return '<div class="' + cls + '">' + esc(letter) + '</div>';
    }
    async function authFetch(url, opts) {
        opts = opts || {};
        opts.headers = opts.headers || {};
        if (token) opts.headers['Authorization'] = 'Bearer ' + token;
        return fetch(url, opts);
    }

    // ── Image compression (Canvas) ────────────────────────────────────
    function compressImage(file) {
        return new Promise(function (resolve, reject) {
            var MAX_DIM = 2000;
            var TARGET_KB = 1800;
            var reader = new FileReader();
            reader.onload = function (e) {
                var img = new Image();
                img.onload = function () {
                    var w = img.width, h = img.height;
                    if (w > MAX_DIM || h > MAX_DIM) {
                        var r = Math.min(MAX_DIM / w, MAX_DIM / h);
                        w = Math.round(w * r); h = Math.round(h * r);
                    }
                    var canvas = document.createElement('canvas');
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    // 逐步降低品質直到大小合理
                    var q = 0.88;
                    function tryBlob() {
                        canvas.toBlob(function (blob) {
                            if (!blob) return reject(new Error('壓縮失敗'));
                            if (blob.size > TARGET_KB * 1024 && q > 0.45) {
                                q -= 0.08;
                                tryBlob();
                            } else {
                                resolve(blob);
                            }
                        }, 'image/jpeg', q);
                    }
                    tryBlob();
                };
                img.onerror = reject;
                img.src = e.target.result;
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    // ── 載入對話列表 ─────────────────────────────────────────────────
    async function loadConversations() {
        var el = document.getElementById('convList');
        try {
            var r = await authFetch('/api/direct-conversations');
            if (!r.ok) { el.innerHTML = '<div class="text-center text-muted small py-4">無法載入對話</div>'; return; }
            var data = await r.json();
            var convos = data.conversations || [];
            if (!convos.length) {
                el.innerHTML = '<div class="text-center text-muted small py-4">尚無對話<br>從廠商頁或設計頁開始聯絡</div>';
                return;
            }
            el.innerHTML = convos.map(function (c) {
                var name = esc(c.other_name || c.other_email || '使用者');
                var preview = esc(c.last_message || '（圖片）');
                var time = fmtTime(c.updated_at);
                return '<div class="conv-item" data-conv-id="' + esc(c.id) + '" data-other-id="' + esc(c.other_id || '') + '" data-other-name="' + name + '">' +
                    '<div class="conv-avatar">' + (name.charAt(0) || '?') + '</div>' +
                    '<div class="conv-info">' +
                        '<div class="conv-name">' + name + '</div>' +
                        '<div class="conv-preview">' + preview + '</div>' +
                    '</div>' +
                    '<div class="conv-time">' + esc(time) + '</div>' +
                '</div>';
            }).join('');
            el.querySelectorAll('.conv-item').forEach(function (item) {
                item.addEventListener('click', function () {
                    el.querySelectorAll('.conv-item').forEach(function (i) { i.classList.remove('active'); });
                    item.classList.add('active');
                    openConversation(item.dataset.convId, item.dataset.otherName);
                });
            });
        } catch (e) {
            el.innerHTML = '<div class="text-center text-danger small py-4">載入失敗</div>';
        }
    }

    // ── 開啟對話 ─────────────────────────────────────────────────────
    function openConversation(convId, otherName) {
        currentConvId = convId;
        currentOtherUser = otherName;
        lastMsgId = null;
        if (pollTimer) clearInterval(pollTimer);

        var area = document.getElementById('chatArea');
        area.innerHTML =
            '<div class="chat-header">' +
                '<div class="msg-avatar">' + esc((otherName || '?').charAt(0)) + '</div>' +
                '<div class="fw-semibold">' + esc(otherName || '對話') + '</div>' +
            '</div>' +
            '<div class="chat-messages" id="chatMessages"><div class="chat-empty"><i class="bi bi-chat-square display-5"></i><div class="mt-2 small">載入訊息中…</div></div></div>' +
            '<div class="chat-input-area">' +
                '<div class="img-preview-bar" id="imgPreviewBar" style="display:none"></div>' +
                '<div class="input-row">' +
                    '<label class="btn btn-outline-secondary btn-sm" title="附加圖片" style="border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0">' +
                        '<i class="bi bi-image"></i>' +
                        '<input type="file" id="imgFileInput" accept="image/*" style="display:none">' +
                    '</label>' +
                    '<textarea class="msg-textarea" id="msgInput" rows="1" placeholder="輸入訊息…"></textarea>' +
                    '<button class="btn btn-primary btn-sm" id="sendBtn" style="border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;flex-shrink:0">' +
                        '<i class="bi bi-send-fill"></i>' +
                    '</button>' +
                '</div>' +
            '</div>';

        bindInputEvents();
        loadMessages(convId, true);
        pollTimer = setInterval(function () { loadMessages(convId, false); }, 5000);
    }

    function bindInputEvents() {
        var textarea = document.getElementById('msgInput');
        var sendBtn = document.getElementById('sendBtn');
        var fileInput = document.getElementById('imgFileInput');

        // auto-resize textarea
        textarea.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
        // Enter 送出（Shift+Enter 換行）
        textarea.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); doSend(); }
        });
        sendBtn.addEventListener('click', doSend);

        // 圖片選擇
        fileInput.addEventListener('change', async function () {
            var file = this.files[0];
            if (!file) return;
            this.value = '';
            if (file.size > 15 * 1024 * 1024) { alert('圖片不可超過 15 MB'); return; }
            try {
                var blob = await compressImage(file);
                var dataUrl = await new Promise(function (res) {
                    var fr = new FileReader(); fr.onload = function (e) { res(e.target.result); }; fr.readAsDataURL(blob);
                });
                pendingImage = { blob: blob, dataUrl: dataUrl };
                var bar = document.getElementById('imgPreviewBar');
                bar.style.display = 'flex';
                bar.innerHTML = '<div class="img-preview-item">' +
                    '<img src="' + esc(dataUrl) + '" alt="預覽">' +
                    '<button class="remove-img" id="removeImgBtn" title="移除"><i class="bi bi-x"></i></button>' +
                '</div>';
                document.getElementById('removeImgBtn').addEventListener('click', function () {
                    pendingImage = null;
                    bar.style.display = 'none';
                    bar.innerHTML = '';
                });
            } catch (e) {
                alert('圖片處理失敗：' + e.message);
            }
        });
    }

    async function doSend() {
        if (!currentConvId) return;
        var textarea = document.getElementById('msgInput');
        var text = (textarea ? textarea.value : '').trim();
        var hasPic = !!pendingImage;
        if (!text && !hasPic) return;

        var sendBtn = document.getElementById('sendBtn');
        if (sendBtn) sendBtn.disabled = true;

        try {
            // 先送圖片
            if (hasPic) {
                var fd = new FormData();
                fd.append('image', pendingImage.blob, 'photo.jpg');
                var r = await authFetch('/api/direct-conversations/' + currentConvId + '/messages/image', { method: 'POST', body: fd });
                if (!r.ok) { var e = await r.json(); alert(e.error || '圖片發送失敗'); }
                pendingImage = null;
                var bar = document.getElementById('imgPreviewBar');
                if (bar) { bar.style.display = 'none'; bar.innerHTML = ''; }
            }
            // 再送文字
            if (text) {
                if (textarea) { textarea.value = ''; textarea.style.height = 'auto'; }
                var r2 = await authFetch('/api/direct-conversations/' + currentConvId + '/messages', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ body: text })
                });
                if (!r2.ok) { var e2 = await r2.json(); alert(e2.error || '發送失敗'); }
            }
            await loadMessages(currentConvId, false);
        } finally {
            if (sendBtn) sendBtn.disabled = false;
            if (textarea) textarea.focus();
        }
    }

    // ── 載入訊息 ─────────────────────────────────────────────────────
    async function loadMessages(convId, scrollToBottom) {
        if (convId !== currentConvId) return;
        try {
            var r = await authFetch('/api/direct-conversations/' + convId + '/messages');
            if (!r.ok) return;
            var data = await r.json();
            var msgs = data.messages || [];
            var container = document.getElementById('chatMessages');
            if (!container) return;

            // 若無新訊息且非首次載入則跳過
            var newest = msgs.length ? msgs[msgs.length - 1].id : null;
            if (!scrollToBottom && newest === lastMsgId) return;
            lastMsgId = newest;

            // 重新渲染
            if (!msgs.length) {
                container.innerHTML = '<div class="chat-empty"><i class="bi bi-chat-square display-5"></i><div class="mt-2 small">開始對話吧！</div></div>';
                return;
            }
            container.innerHTML = msgs.map(function (m) { return renderMsg(m); }).join('');

            // 綁定翻譯按鈕
            container.querySelectorAll('.btn-translate').forEach(function (btn) {
                btn.addEventListener('click', function () { doTranslate(btn); });
            });
            // 圖片點擊放大
            container.querySelectorAll('.msg-image').forEach(function (img) {
                img.addEventListener('click', function () {
                    document.getElementById('imgModalSrc').src = img.src;
                    new bootstrap.Modal(document.getElementById('imgModal')).show();
                });
            });

            if (scrollToBottom || container.scrollTop + container.clientHeight >= container.scrollHeight - 80) {
                container.scrollTop = container.scrollHeight;
            }
        } catch (e) { /* silent */ }
    }

    function renderMsg(m) {
        var cls = m.is_mine ? 'mine' : 'theirs';
        var name = m.is_mine ? '我' : (currentOtherUser || '對方');
        var letter = (name || '?').charAt(0).toUpperCase();
        var time = fmtTime(m.created_at);
        var content = '';
        if (m.image_url) {
            content += '<img src="' + esc(m.image_url) + '" class="msg-image" alt="圖片" loading="lazy">';
        }
        if (m.body) {
            content += (m.image_url ? '<div class="mt-1">' : '') + esc(m.body).replace(/\n/g, '<br>') + (m.image_url ? '</div>' : '');
        }
        var translateBtn = (m.body && m.body.trim())
            ? '<button class="btn-translate" data-msg-id="' + esc(m.id) + '"><i class="bi bi-translate"></i> 翻譯（1點）</button>'
            : '';
        return '<div class="msg-row ' + cls + '" data-msg-id="' + esc(m.id) + '">' +
            '<div class="msg-avatar">' + esc(letter) + '</div>' +
            '<div class="msg-bubble-wrap">' +
                '<div class="msg-bubble">' + content + '</div>' +
                '<div class="msg-actions">' +
                    '<span class="msg-time">' + esc(time) + '</span>' +
                    translateBtn +
                '</div>' +
                '<div class="msg-translation-area"></div>' +
            '</div>' +
        '</div>';
    }

    async function doTranslate(btn) {
        var msgId = btn.dataset.msgId;
        if (!msgId) return;
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> 翻譯中…';
        try {
            var r = await authFetch('/api/direct-messages/' + msgId + '/translate', { method: 'POST' });
            var data = await r.json();
            if (!r.ok) { alert(data.error || '翻譯失敗'); btn.disabled = false; btn.innerHTML = '<i class="bi bi-translate"></i> 翻譯（1點）'; return; }
            // 顯示翻譯結果
            var row = btn.closest('.msg-row');
            var area = row && row.querySelector('.msg-translation-area');
            if (area) {
                var langLabel = data.target_lang === 'zh' || data.target_lang === 'zh-TW' ? '中文譯文' : 'English';
                area.innerHTML = '<div class="msg-translation"><div class="translation-label">' + esc(langLabel) + '</div>' + esc(data.translated_text).replace(/\n/g,'<br>') + '</div>';
            }
            btn.innerHTML = '<i class="bi bi-check2"></i> 已翻譯';
            // 顯示剩餘點數提示
            showPointsToast(data.balance_after);
        } catch (e) {
            alert('翻譯失敗：' + e.message);
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-translate"></i> 翻譯（1點）';
        }
    }

    function showPointsToast(balance) {
        var toast = document.createElement('div');
        toast.style.cssText = 'position:fixed;bottom:80px;right:20px;background:#333;color:#fff;padding:8px 14px;border-radius:8px;font-size:.82rem;z-index:9999;opacity:0;transition:opacity .3s';
        toast.textContent = '已扣 1 點，剩餘 ' + balance + ' 點';
        document.body.appendChild(toast);
        requestAnimationFrame(function () { toast.style.opacity = '1'; });
        setTimeout(function () { toast.style.opacity = '0'; setTimeout(function () { toast.remove(); }, 400); }, 2500);
    }

    // ── 初始化 ─────────────────────────────────────────────────────
    async function init() {
        if (typeof AuthService === 'undefined') { setTimeout(init, 300); return; }
        try {
            var s = await AuthService.getSession();
            token = s && (s.access_token || (s.session && s.session.access_token));
            if (s && s.user) myUserId = s.user.id;
            else if (s && s.session && s.session.user) myUserId = s.session.user.id;
        } catch (_) {}
        if (!token) {
            document.getElementById('chatArea').innerHTML = '<div class="no-conv"><i class="bi bi-lock display-4"></i><div>請先<a href="/login.html">登入</a>以查看訊息</div></div>';
            return;
        }
        loadConversations();

        // 若 URL 帶 conv 參數，自動開啟
        var params = new URLSearchParams(window.location.search);
        var convIdParam = params.get('conv');
        var otherIdParam = params.get('with');
        if (otherIdParam && !convIdParam) {
            // 與指定用戶開啟 / 建立對話
            try {
                var r = await authFetch('/api/direct-conversations', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ other_user_id: otherIdParam }) });
                if (r.ok) { var d = await r.json(); convIdParam = d.conversation && d.conversation.id; }
            } catch (_) {}
        }
        if (convIdParam) {
            // 等列表載入後點選
            setTimeout(function () {
                var item = document.querySelector('.conv-item[data-conv-id="' + convIdParam + '"]');
                if (item) { item.click(); }
                else { openConversation(convIdParam, params.get('name') || '對方'); }
            }, 800);
        }
    }

    document.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>
