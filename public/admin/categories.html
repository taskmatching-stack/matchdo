<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MATCHDO åˆ†é¡ç®¡ç†</title>
  <link href="../iStudio-1.0.0/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
  <!-- å…±ç”¨å¾Œå°æ¨™é ­ï¼ˆç”± admin-common.js è¼‰å…¥ï¼‰ -->
  <div id="admin-header"></div>

  <div class="container-fluid">
    <div class="row">
      <!-- å…±ç”¨å¾Œå°å´æ¬„ï¼ˆç”± admin-common.js è¼‰å…¥ï¼‰ -->
      <aside id="admin-sidebar" class="col-md-3 col-lg-2 bg-white border-end min-vh-100"></aside>
      <main class="col-md-9 col-lg-10 py-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="mb-0">åˆ†é¡åˆ—è¡¨</h4>
          <div class="btn-group">
            <button id="saveBtn" class="btn btn-primary">å„²å­˜è®Šæ›´</button>
            <button id="addRow" class="btn btn-secondary">æ–°å¢ä¸»åˆ†é¡</button>
            <button id="previewDefault" class="btn btn-outline-secondary" title="æŸ¥çœ‹é è¨­æª”å…§å®¹">é è¦½é è¨­</button>
            <button id="importDefault" class="btn btn-outline-primary" title="è£œé½Šç¼ºæ¼çš„ä¸»åˆ†é¡èˆ‡å­åˆ†é¡ï¼Œä¸æœƒè¦†å¯«æ‚¨å·²å¡«å¯«çš„æç¤ºè©">ä¸€éµåŒ¯å…¥ï¼ˆä¿ç•™ç¾æœ‰æç¤ºè©ï¼‰</button>
            <button id="collapseAll" class="btn btn-outline-secondary" title="å…¨éƒ¨æ”¶åˆå­åˆ†é¡">å…¨éƒ¨æ”¶åˆ</button>
            <button id="expandAll" class="btn btn-outline-secondary" title="å…¨éƒ¨å±•é–‹å­åˆ†é¡">å…¨éƒ¨å±•é–‹</button>
            <button id="checkHealth" class="btn btn-outline-info">æª¢æŸ¥å¥åº·</button>
          </div>
        </div>
        <p class="text-muted small mb-2">å„²å­˜è®Šæ›´ï¼å°‡ç›®å‰åˆ—è¡¨å¯«å…¥è³‡æ–™åº«ã€‚ä¸€éµåŒ¯å…¥ï¼ä¾é è¨­æª”è£œé½Šç¼ºæ¼ï¼Œ<strong>ä¸æœƒè¦†å¯«æ‚¨å·²å¡«å¯«çš„ä¸»åˆ†é¡æç¤ºè©</strong>ã€‚å¯ã€Œæ–°å¢ä¸»åˆ†é¡ã€ã€ç”¨ã€Œâ†‘ã€ã€Œâ†“ã€èª¿æ•´ä¸»åˆ†é¡é †åºã€åœ¨ä»»ä¸€å¤§é …æŒ‰ã€Œï¼‹ å­åˆ†é¡ã€å¢åˆ—ï¼Œå†æŒ‰å„²å­˜ã€‚è‹¥å„²å­˜æ™‚å‡ºç¾ sort_order éŒ¯èª¤ï¼Œè«‹åœ¨ Supabase SQL Editor åŸ·è¡Œ <code>docs/add-ai-categories-sort-order.sql</code>ã€‚</p>
        <div id="statusWrap" class="alert mb-3 py-2" style="display:none;" role="alert">
          <span id="status"></span>
        </div>

        <div id="dataSourceIndicator" class="alert alert-info mb-3" style="display:none;">
          <strong>æ•¸æ“šä¾†æºï¼š</strong><span id="dataSourceText"></span>
        </div>

        <div class="table-responsive">
          <table class="table table-bordered" id="catTable">
            <thead class="table-light">
              <tr>
                <th style="width:15%;">é¡å‹</th>
                <th style="width:15%;">key</th>
                <th style="width:15%;">åç¨±</th>
                <th style="width:35%;">æç¤ºè© (Prompt) <small class="text-muted" title="å»ºè­°çµæ§‹ï¼šè§’è‰²èªªæ˜ â†’ ã€åˆ†ææµç¨‹ã€‘â†’ è¼¸å‡ºæ ¼å¼ JSON é™£åˆ— [{\"item_name\",\"spec\",\"quantity\",\"unit\"}] â†’ ã€æ³¨æ„äº‹é …ã€‘ï¼›å¯ç”¨ {subcategory} ä»£è¡¨å­åˆ†é¡">â“˜</small></th>
                <th style="width:10%;">æ’åº</th>
                <th style="width:10%;">åˆªé™¤</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="mt-3">
          <details class="mb-3">
            <summary class="text-muted">ğŸ“ æç¤ºè©æ’°å¯«æ–¹å¼ï¼ˆç‚ºä½•æœ‰äº›é€™éº¼å®Œæ•´ï¼Ÿï¼‰</summary>
            <div class="p-3 bg-light border rounded small">
              <p class="mb-2"><strong>ç‚ºä»€éº¼è¦å¯«å¾—å®Œæ•´ï¼Ÿ</strong> ç³»çµ±æœƒæŠŠ AI çš„å›æ‡‰ç•¶æˆ JSON è§£æï¼Œç”¨ä¾†é¡¯ç¤ºã€Œé …ç›®ã€è¦æ ¼ã€æ•¸é‡ã€å–®ä½ã€ã€‚è‹¥æç¤ºè©æ²’è¦æ±‚å›ºå®šæ ¼å¼ï¼ŒAI å¯èƒ½å›ä¸€èˆ¬æ–‡å­—ï¼Œå‰ç«¯å°±ç„¡æ³•æ­£ç¢ºé¡¯ç¤ºä¼°åƒ¹è¡¨ã€‚</p>
              <p class="mb-2"><strong>ä½ ä¸€å®šè¦æœ‰çš„ï¼š</strong></p>
              <ol class="mb-2">
                <li><strong>è§’è‰²</strong>ï¼šä¸€å¥è©±èªªæ˜ AI æ˜¯èª°ï¼ˆä¾‹ï¼šä½ æ˜¯å°ˆæ¥­â—‹â—‹é¡§å•ï¼‰ã€‚</li>
                <li><strong>è¼¸å‡ºæ ¼å¼</strong>ï¼šæ˜ç¢ºå¯«ã€Œè«‹è¼¸å‡º JSON é™£åˆ—ã€ï¼Œä¸¦åˆ—å‡ºæ¬„ä½ï¼š<code>item_name</code>ï¼ˆé …ç›®åç¨±ï¼‰ã€<code>spec</code>ï¼ˆè¦æ ¼ï¼‰ã€<code>quantity</code>ï¼ˆæ•¸é‡ï¼Œæ•¸å­—ï¼‰ã€<code>unit</code>ï¼ˆå–®ä½ï¼‰ã€‚</li>
                <li>è‹¥è©²åˆ†é¡æœ‰å­åˆ†é¡ï¼Œå¯å¯« <code>{subcategory}</code>ï¼Œç³»çµ±æœƒè‡ªå‹•æ›¿æ›æˆä½¿ç”¨è€…é¸çš„å­åˆ†é¡åç¨±ã€‚</li>
              </ol>
              <p class="mb-2"><strong>é¸å¡«ä½†å»ºè­°åŠ ï¼š</strong>ã€åˆ†ææµç¨‹ã€‘è®“ AI ä¾æ­¥é©Ÿæ€è€ƒï¼›ã€æ³¨æ„äº‹é …ã€‘å¯å¯«å–®ä½åå¥½ã€ç„¡åœ–ç‰‡æ™‚çš„è™•ç†ç­‰ã€‚</p>
              <p class="mb-0"><strong>æœ€ç²¾ç°¡ç¯„ä¾‹ï¼š</strong></p>
              <pre class="bg-white p-2 border rounded mt-1 mb-0" style="font-size:0.85em;">ä½ æ˜¯â—‹â—‹é¡§å•ã€‚ä¾æ‰€é¸å­åˆ†é¡ã€Œ{subcategory}ã€èˆ‡ç”¨æˆ¶æè¿°ï¼Œåˆ—å‡ºé …ç›®ã€‚è«‹<strong>åªè¼¸å‡º</strong> JSON é™£åˆ—ï¼š[{"item_name":"é …ç›®","spec":"è¦æ ¼","quantity":æ•¸é‡,"unit":"å–®ä½"}]ï¼Œquantity ç‚ºæ•¸å­—ã€‚</pre>
            </div>
          </details>
          <details>
            <summary>é™¤éŒ¯è³‡è¨Š</summary>
            <div class="mt-2">
              <pre id="debugPanel" class="bg-light p-3 border" style="white-space:pre-wrap;"></pre>
            </div>
          </details>
        </div>
      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
  <script>

    async function loadCategories() {
      try {
        const res = await fetch('/api/categories', { cache: 'no-store' });
        const data = await res.json();
        
        console.log('API è¿”å›æ•¸æ“š:', data);
        const list = Array.isArray(data.categories) ? data.categories : [];
        
        // é¡¯ç¤ºæ•¸æ“šä¾†æº
        const indicator = document.getElementById('dataSourceIndicator');
        const sourceText = document.getElementById('dataSourceText');
        if (data.via) {
          indicator.style.display = 'block';
          const isNewSchema = data.via === 'normalized-db' || data.via === 'split-db';
          indicator.className = isNewSchema ? 'alert alert-success mb-3' : 'alert alert-info mb-3';
          sourceText.textContent = isNewSchema ? 'âœ“ ä¸»åˆ†é¡/å­åˆ†é¡ç¨ç«‹è¡¨ (æ–°æ¶æ§‹)' : 'âœ“ èˆŠç‰ˆè³‡æ–™åº« (ç›¸å®¹æ¨¡å¼)';
        }
        
        const tbody = document.querySelector('#catTable tbody');
        tbody.innerHTML = '';
        
        if (list.length === 0) {
          document.getElementById('status').textContent = 'âš  ç›®å‰æ²’æœ‰åˆ†é¡ï¼Œè«‹é»é¸ã€Œä¸€éµåŒ¯å…¥é è¨­åˆ†é¡ã€';
          return;
        }
        
        list.forEach((cat, catIdx) => {
          // ä¸»åˆ†é¡è¡Œ
          const mainTr = document.createElement('tr');
          mainTr.className = 'table-primary main-category-row';
          mainTr.dataset.categoryKey = cat.key;
          const subCount = Array.isArray(cat.sub) ? cat.sub.length : (cat.subcategories || []).length;
          mainTr.innerHTML = `
            <td><strong>ä¸»åˆ†é¡</strong>
              <button type="button" class="btn btn-sm btn-outline-primary toggle-subs" title="æ”¶åˆ/å±•é–‹å­åˆ†é¡" data-collapsed="0">â–¼ æ”¶åˆ</button>
              <span class="text-muted small ms-1">(${subCount} é …)</span>
              <button type="button" class="btn btn-sm btn-outline-secondary move-main-up" title="ä¸Šç§»">â†‘</button>
              <button type="button" class="btn btn-sm btn-outline-secondary move-main-down" title="ä¸‹ç§»">â†“</button>
              <button type="button" class="btn btn-sm btn-outline-success add-sub-under" data-key="${(cat.key || '').replace(/"/g, '&quot;')}" title="åœ¨æ­¤ä¸»åˆ†é¡ä¸‹æ–°å¢ä¸€ç­†å­åˆ†é¡">ï¼‹ å­åˆ†é¡</button>
            </td>
            <td><input class="form-control form-control-sm fw-bold" value="${cat.key || ''}" data-field="key" data-level="main" /></td>
            <td><input class="form-control form-control-sm fw-bold" value="${cat.name || ''}" data-field="name" data-level="main" /></td>
            <td><textarea class="form-control" rows="2" data-field="prompt" data-level="main" placeholder="å»ºè­°å«ï¼šè§’è‰²ã€ã€åˆ†ææµç¨‹ã€‘ã€{subcategory}ã€è¼¸å‡ºæ ¼å¼ JSON é™£åˆ—ã€ã€æ³¨æ„äº‹é …ã€‘">${(cat.prompt || '').replace(/<\/textarea>/gi, '<\\/textarea>')}</textarea></td>
            <td>-</td>
            <td><button class="btn btn-sm btn-danger del-main" data-key="${cat.key}">åˆªé™¤</button></td>
          `;
          tbody.appendChild(mainTr);
          
          // å­åˆ†é¡è¡Œï¼ˆéœ€è¦å¾ ai_subcategories è¡¨ç²å– promptï¼‰
          const subs = cat.subcategories || cat.sub || [];
          if (Array.isArray(subs) && subs.length > 0) {
            subs.forEach((sub, subIdx) => {
              const subTr = document.createElement('tr');
              subTr.className = 'subcategory-row sub-row-of-main';
              subTr.dataset.parentKey = cat.key;
              subTr.dataset.subName = sub;
              const subConfig = cat.sub_configs && cat.sub_configs[sub] ? cat.sub_configs[sub] : null;
              const subPrompt = (subConfig && !Array.isArray(subConfig) && typeof subConfig.prompt !== 'undefined') ? subConfig.prompt : '';
              const configToStore = Array.isArray(subConfig) ? { _formFields: subConfig } : (subConfig && typeof subConfig === 'object' ? subConfig : {});
              subTr.dataset.subConfig = JSON.stringify(configToStore);
              subTr.innerHTML = `
                <td class="ps-4"><span class="text-muted">â”” å­åˆ†é¡</span></td>
                <td><input class="form-control form-control-sm" value="${cat.key}__${sub}" data-field="key" data-level="sub" readonly /></td>
                <td><input class="form-control form-control-sm" value="${sub}" data-field="name" data-level="sub" data-original="${sub}" /></td>
                <td><textarea class="form-control form-control-sm" rows="2" data-field="prompt" data-level="sub" placeholder="ç©ºç™½å‰‡ç¹¼æ‰¿ä¸»åˆ†é¡ï¼›å¯å« {subcategory}">${subPrompt}</textarea></td>
                <td><input type="number" class="form-control form-control-sm" value="${subIdx}" data-field="sort" style="width:60px;" /></td>
                <td><button class="btn btn-sm btn-danger del-sub" data-parent="${cat.key}" data-name="${sub}">åˆªé™¤</button></td>
              `;
              tbody.appendChild(subTr);
            });
          }
        });
        
        // é è¨­å…¨éƒ¨æ”¶åˆï¼Œç¸®çŸ­ç‰ˆé¢
        tbody.querySelectorAll('tr.main-category-row').forEach(mainTr => {
          const key = mainTr.dataset.categoryKey;
          const btn = mainTr.querySelector('.toggle-subs');
          if (!btn) return;
          let n = 0;
          let next = mainTr.nextElementSibling;
          while (next && next.classList.contains('subcategory-row') && next.dataset.parentKey === key) {
            next.style.display = 'none';
            n++;
            next = next.nextElementSibling;
          }
          btn.dataset.collapsed = '1';
          btn.textContent = 'â–¶ å±•é–‹ (' + n + ' é …)';
        });
        
        document.getElementById('status').textContent = `âœ“ å·²è¼‰å…¥ ${list.length} ç­†åˆ†é¡ï¼ˆé è¨­æ”¶åˆï¼Œé»ã€Œå±•é–‹ã€æˆ–ã€Œå…¨éƒ¨å±•é–‹ã€å¯é¡¯ç¤ºå­åˆ†é¡ï¼‰`;
      } catch (e) {
        console.error('è¼‰å…¥åˆ†é¡å¤±æ•—:', e);
        document.getElementById('status').textContent = 'âœ– è¼‰å…¥å¤±æ•—ï¼š' + e.message;
      }
    }

    document.addEventListener('click', (e) => {
      if (e.target && e.target.id === 'addRow') {
        const tr = document.createElement('tr');
        tr.className = 'table-primary main-category-row';
        tr.innerHTML = `
          <td><strong>ä¸»åˆ†é¡</strong>
              <button type="button" class="btn btn-sm btn-outline-primary toggle-subs" title="æ”¶åˆ/å±•é–‹å­åˆ†é¡" data-collapsed="0">â–¼ æ”¶åˆ</button>
              <span class="text-muted small ms-1">(0 é …)</span>
              <button type="button" class="btn btn-sm btn-outline-secondary move-main-up" title="ä¸Šç§»">â†‘</button>
              <button type="button" class="btn btn-sm btn-outline-secondary move-main-down" title="ä¸‹ç§»">â†“</button>
              <button type="button" class="btn btn-sm btn-outline-success add-sub-under" data-key="" title="åœ¨æ­¤ä¸»åˆ†é¡ä¸‹æ–°å¢å­åˆ†é¡">ï¼‹ å­åˆ†é¡</button>
            </td>
          <td><input class="form-control form-control-sm" data-field="key" data-level="main" /></td>
          <td><input class="form-control form-control-sm" data-field="name" data-level="main" /></td>
          <td><textarea class="form-control" rows="2" data-field="prompt" data-level="main"></textarea></td>
          <td>-</td>
          <td><button class="btn btn-sm btn-danger del-main">åˆªé™¤</button></td>
        `;
        document.querySelector('#catTable tbody').appendChild(tr);
      }
      if (e.target && e.target.classList.contains('toggle-subs')) {
        const mainTr = e.target.closest('tr');
        if (!mainTr || !mainTr.classList.contains('main-category-row')) return;
        const key = mainTr.dataset.categoryKey;
        const btn = e.target;
        const collapsed = btn.dataset.collapsed === '1';
        let n = 0;
        let next = mainTr.nextElementSibling;
        while (next && next.classList.contains('subcategory-row') && next.dataset.parentKey === key) {
          next.style.display = collapsed ? '' : 'none';
          n++;
          next = next.nextElementSibling;
        }
        btn.dataset.collapsed = collapsed ? '0' : '1';
        const subCount = n;
        btn.textContent = collapsed ? 'â–¼ æ”¶åˆ' : 'â–¶ å±•é–‹ (' + subCount + ' é …)';
      }
      if (e.target && (e.target.classList.contains('move-main-up') || e.target.classList.contains('move-main-down'))) {
        const mainTr = e.target.closest('tr');
        if (!mainTr || !mainTr.classList.contains('main-category-row')) return;
        const tbody = document.querySelector('#catTable tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const idx = rows.indexOf(mainTr);
        if (idx < 0) return;
        let endIdx = idx + 1;
        while (endIdx < rows.length && rows[endIdx].classList.contains('subcategory-row')) endIdx++;
        const isUp = e.target.classList.contains('move-main-up');
        if (isUp) {
          if (idx === 0) return;
          let prevIdx = idx - 1;
          while (prevIdx >= 0 && rows[prevIdx].classList.contains('subcategory-row')) prevIdx--;
          if (prevIdx < 0) return;
          const fragment = document.createDocumentFragment();
          for (let i = idx; i < endIdx; i++) fragment.appendChild(rows[idx]);
          tbody.insertBefore(fragment, rows[prevIdx]);
        } else {
          if (endIdx >= rows.length) return;
          const nextMain = rows[endIdx];
          let nextEnd = endIdx + 1;
          while (nextEnd < rows.length && rows[nextEnd].classList.contains('subcategory-row')) nextEnd++;
          const fragment = document.createDocumentFragment();
          for (let i = idx; i < endIdx; i++) fragment.appendChild(rows[idx]);
          const afterNextBlock = nextEnd < rows.length ? rows[nextEnd] : null;
          if (afterNextBlock) tbody.insertBefore(fragment, afterNextBlock);
          else tbody.appendChild(fragment);
        }
      }
      if (e.target && e.target.classList.contains('add-sub-under')) {
        const mainTr = e.target.closest('tr');
        const keyInput = mainTr.querySelector('[data-field="key"][data-level="main"]');
        const mainKey = keyInput ? keyInput.value.trim() : (e.target.dataset.key || '');
        let insertAfter = mainTr;
        let next = mainTr.nextElementSibling;
        while (next && next.classList.contains('subcategory-row')) {
          insertAfter = next;
          next = next.nextElementSibling;
        }
        const subTr = document.createElement('tr');
        subTr.className = 'subcategory-row';
        subTr.dataset.parentKey = mainKey;
        subTr.dataset.subConfig = '{}';
        const keyPlaceholder = mainKey ? mainKey + '__' : '';
        subTr.innerHTML = `
          <td class="ps-4"><span class="text-muted">â”” å­åˆ†é¡</span></td>
          <td><input class="form-control form-control-sm" value="${keyPlaceholder}" data-field="key" data-level="sub" readonly placeholder="å„²å­˜å¾Œè‡ªå‹•ç”¢ç”Ÿ" /></td>
          <td><input class="form-control form-control-sm" data-field="name" data-level="sub" placeholder="è¼¸å…¥å­åˆ†é¡åç¨±" /></td>
          <td><textarea class="form-control form-control-sm" rows="2" data-field="prompt" data-level="sub" placeholder="ç©ºç™½å‰‡ç¹¼æ‰¿ä¸»åˆ†é¡ï¼›å¯å« {subcategory}"></textarea></td>
          <td><input type="number" class="form-control form-control-sm" value="0" data-field="sort" style="width:60px;" /></td>
          <td><button class="btn btn-sm btn-danger del-sub" data-parent="${mainKey}">åˆªé™¤</button></td>
        `;
        insertAfter.insertAdjacentElement('afterend', subTr);
      }
      if (e.target && (e.target.classList.contains('del-main') || e.target.classList.contains('del-sub'))) {
        e.target.closest('tr').remove();
      }
      if (e.target && e.target.id === 'saveBtn') {
        saveCategories();
      }
      if (e.target && e.target.id === 'previewDefault') {
        previewDefaultCategories();
      }
      if (e.target && e.target.id === 'importDefault') {
        importDefaultCategories();
      }
      if (e.target && e.target.id === 'collapseAll') {
        document.querySelectorAll('#catTable tbody tr.main-category-row').forEach(mainTr => {
          const key = mainTr.dataset.categoryKey;
          const btn = mainTr.querySelector('.toggle-subs');
          if (!btn || btn.dataset.collapsed === '1') return;
          let n = 0;
          let next = mainTr.nextElementSibling;
          while (next && next.classList.contains('subcategory-row') && next.dataset.parentKey === key) {
            next.style.display = 'none';
            n++;
            next = next.nextElementSibling;
          }
          if (btn) { btn.dataset.collapsed = '1'; btn.textContent = 'â–¶ å±•é–‹ (' + n + ' é …)'; }
        });
      }
      if (e.target && e.target.id === 'expandAll') {
        document.querySelectorAll('#catTable tbody tr.main-category-row').forEach(mainTr => {
          const key = mainTr.dataset.categoryKey;
          const btn = mainTr.querySelector('.toggle-subs');
          if (!btn || btn.dataset.collapsed === '0') return;
          let n = 0;
          let next = mainTr.nextElementSibling;
          while (next && next.classList.contains('subcategory-row') && next.dataset.parentKey === key) {
            next.style.display = '';
            n++;
            next = next.nextElementSibling;
          }
          if (btn) { btn.dataset.collapsed = '0'; btn.textContent = 'â–¼ æ”¶åˆ'; }
        });
      }
      if (e.target && e.target.id === 'checkHealth') {
        checkHealth();
      }
    });

    async function saveCategories() {
      const rows = document.querySelectorAll('#catTable tbody tr');
      const mainCategories = [];
      let currentMain = null;
      
      rows.forEach(row => {
        if (row.classList.contains('main-category-row')) {
          // ä¸»åˆ†é¡
          const keyInput = row.querySelector('[data-field="key"][data-level="main"]');
          const nameInput = row.querySelector('[data-field="name"][data-level="main"]');
          const promptTextarea = row.querySelector('[data-field="prompt"][data-level="main"]');
          
          if (keyInput && nameInput) {
            const key = keyInput.value.trim();
            const name = nameInput.value.trim();
            if (!key || !name) {
              statusWrap.style.display = 'block';
              statusWrap.className = 'alert alert-danger mb-3 py-2';
              status.textContent = 'âœ– è«‹å¡«å¯«æ¯ä¸€ç­†ä¸»åˆ†é¡çš„ keyï¼ˆè‹±æ–‡ï¼‰èˆ‡åç¨±ï¼Œä¸å¯ç•™ç™½ã€‚';
              return;
            }
            currentMain = {
              key,
              name,
              prompt: promptTextarea ? promptTextarea.value.trim() : '',
              sub: [],
              sort_order: mainCategories.length
            };
            mainCategories.push(currentMain);
          }
        } else if (row.classList.contains('subcategory-row') && currentMain) {
          const nameInput = row.querySelector('[data-field="name"][data-level="sub"]');
          const promptTextarea = row.querySelector('[data-field="prompt"][data-level="sub"]');
          if (nameInput) {
            const subName = nameInput.value.trim();
            if (subName) {
              currentMain.sub.push(subName);
              if (!currentMain.sub_configs) currentMain.sub_configs = {};
              let existing = {};
              try {
                const raw = row.dataset.subConfig;
                if (raw) existing = JSON.parse(raw);
              } catch (_) {}
              currentMain.sub_configs[subName] = Object.assign({}, existing, { prompt: promptTextarea ? promptTextarea.value.trim() : '' });
            }
          }
        }
      });
      
      const status = document.getElementById('status');
      const statusWrap = document.getElementById('statusWrap');
      if (mainCategories.length === 0) {
        statusWrap.style.display = 'block';
        statusWrap.className = 'alert alert-warning mb-3 py-2';
        status.textContent = 'âœ– æ²’æœ‰ä»»ä½•ä¸»åˆ†é¡å¯å„²å­˜ï¼Œè«‹è‡³å°‘ä¿ç•™ä¸€ç­†ä¸»åˆ†é¡ã€‚';
        return;
      }
      statusWrap.style.display = 'block';
      statusWrap.className = 'alert alert-secondary mb-3 py-2';
      status.textContent = 'å„²å­˜ä¸­...';
      
      try {
        const res = await fetch('/api/categories', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ categories: mainCategories })
        });
        const data = await res.json();
        if (data && data.success) {
          statusWrap.className = 'alert alert-success mb-3 py-2';
          status.innerHTML = `âœ” å·²å„²å­˜ï¼ˆ${data.count != null ? data.count : ''} ç­†ä¸»åˆ†é¡å·²å¯«å…¥ï¼‰ã€‚<button type="button" class="btn btn-sm btn-link p-0 ms-1" onclick="loadCategories()">é‡æ–°è¼‰å…¥åˆ—è¡¨</button>`;
          // ä¸å†è‡ªå‹•é‡æ•´åˆ—è¡¨ï¼Œé¿å…æ‰“æ–·ç·¨è¼¯
        } else {
          statusWrap.className = 'alert alert-danger mb-3 py-2';
          status.textContent = 'âœ– å„²å­˜å¤±æ•—' + (data && data.error ? 'ï¼š' + data.error : '');
        }
      } catch (e) {
        statusWrap.className = 'alert alert-danger mb-3 py-2';
        status.textContent = 'âœ– å„²å­˜å¤±æ•—ï¼ˆç¶²è·¯éŒ¯èª¤ï¼‰';
      }
    }

    // è¼‰å…¥å…±ç”¨æ¨™é ­èˆ‡å´æ¬„
    document.addEventListener('DOMContentLoaded', () => {
      loadCategories();
    });

    async function previewDefaultCategories() {
      const status = document.getElementById('status');
      const statusWrap = document.getElementById('statusWrap');
      statusWrap.style.display = 'block';
      statusWrap.className = 'alert alert-info mb-3 py-2';
      status.textContent = 'è®€å–ä¸­...';
      try {
        const res = await fetch('/api/categories/preview-default', { cache: 'no-store' });
        const data = await res.json();
        if (data && data.summary) {
          const lines = data.summary.map(s => `${s.name}ï¼ˆ${s.key}ï¼‰ï¼š${s.subCount} å€‹å­åˆ†é¡`).join('ï¼›');
          status.innerHTML = `é è¨­æª”å°‡åŒ¯å…¥ï¼š${lines}ã€‚<br><small>ç¢ºèªç„¡èª¤å¾Œè«‹æŒ‰ã€Œä¸€éµåŒ¯å…¥é è¨­åˆ†é¡ã€å¯«å…¥è³‡æ–™åº«ã€‚</small>`;
        } else {
          status.textContent = data.error || 'ç„¡æ³•è®€å–é è¨­æª”';
          statusWrap.className = 'alert alert-warning mb-3 py-2';
        }
      } catch (e) {
        status.textContent = 'é è¦½å¤±æ•—ï¼š' + (e.message || String(e));
        statusWrap.className = 'alert alert-danger mb-3 py-2';
      }
    }

    async function importDefaultCategories() {
      const status = document.getElementById('status');
      const statusWrap = document.getElementById('statusWrap');
      statusWrap.style.display = 'block';
      statusWrap.className = 'alert alert-secondary mb-3 py-2';
      status.textContent = 'åŒ¯å…¥é è¨­ä¸­...';
      try {
        const res = await fetch('/api/categories/import-default', { method: 'POST' });
        const data = await res.json();
        if (data && data.success) {
          const subCount = data.subCount != null ? data.subCount : 0;
          status.innerHTML = `âœ” ${data.message || 'å·²åŒ¯å…¥'}ï¼ˆ${data.count} ç­†ä¸»åˆ†é¡ã€${subCount} ç­†å­åˆ†é¡ï¼‰ã€‚<button type="button" class="btn btn-sm btn-link p-0 ms-1" onclick="loadCategories()">é‡æ–°è¼‰å…¥åˆ—è¡¨</button>`;
          document.getElementById('statusWrap').style.display = 'block';
          document.getElementById('statusWrap').className = 'alert alert-success mb-3 py-2';
          // ä¸è‡ªå‹•é‡æ•´ï¼Œé¿å…æ‰“æ–·ç·¨è¼¯ï¼›éœ€è¦çœ‹æ–°è³‡æ–™æ™‚å†æŒ‰ã€Œé‡æ–°è¼‰å…¥åˆ—è¡¨ã€
        } else {
          // åŒ¯å…¥å¤±æ•—ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
          const msg = (data && data.error) ? data.error : 'æœªçŸ¥éŒ¯èª¤';
          status.innerHTML = `âœ– åŒ¯å…¥å¤±æ•—ï¼š${msg}<br><small>${data.details || ''}</small>`;
          if (data.via === 'local-only') {
            status.innerHTML += '<br><span style="color:#f39c12;">âš  è³‡æ–™åº«é€£ç·šç•°å¸¸ï¼Œè«‹ä½¿ç”¨ SQL Editor æ‰‹å‹•åŒ¯å…¥</span>';
            status.innerHTML += '<br><a href="#" onclick="loadFromLocal(); return false;" class="btn btn-sm btn-warning mt-2">æš«æ™‚è¼‰å…¥æœ¬åœ°é è¨­æª”</a>';
            showDebug('è³‡æ–™åº«é€£ç·šå¤±æ•—', suggest(msg));
          }
        }
      } catch (e) {
        status.innerHTML = 'âœ– åŒ¯å…¥å¤±æ•—ï¼ˆç¶²è·¯éŒ¯èª¤ï¼‰<br><a href="#" onclick="loadFromLocal(); return false;" class="btn btn-sm btn-warning mt-2">æš«æ™‚è¼‰å…¥æœ¬åœ°é è¨­æª”</a>';
        showDebug('åŒ¯å…¥å¤±æ•—ï¼ˆç¶²è·¯ï¼‰', e.message || String(e));
      }
    }

    // è‡¨æ™‚æ–¹æ¡ˆï¼šç›´æ¥è®€å–æœ¬åœ°é è¨­æª”æ¡ˆ
    async function loadFromLocal() {
      const status = document.getElementById('status');
      try {
        const res = await fetch('/config/default-categories.json');
        const json = await res.json();
        const list = Array.isArray(json.categories) ? json.categories : [];
        
        const indicator = document.getElementById('dataSourceIndicator');
        const sourceText = document.getElementById('dataSourceText');
        indicator.style.display = 'block';
        indicator.className = 'alert alert-warning mb-3';
        sourceText.textContent = 'âš  æœ¬åœ°é è¨­åˆ†é¡ï¼ˆåƒ…ä¾›ç·¨è¼¯ï¼Œå„²å­˜æ™‚æœƒå˜—è©¦å¯«å…¥è³‡æ–™åº«ï¼‰';
        
        const tbody = document.querySelector('#catTable tbody');
        tbody.innerHTML = '';
        list.forEach(cat => {
          const tr = document.createElement('tr');
          const subs = cat.sub || [];
          const subsStr = Array.isArray(subs) ? subs.join(',') : '';
          tr.innerHTML = `
            <td><input class="form-control" value="${cat.key || ''}" /></td>
            <td><input class="form-control" value="${cat.name || ''}" /></td>
            <td><textarea class="form-control" rows="3">${cat.prompt || ''}</textarea></td>
            <td><textarea class="form-control" rows="4">${subsStr}</textarea></td>
            <td><button class="btn btn-sm btn-danger del">åˆªé™¤</button></td>
          `;
          tbody.appendChild(tr);
        });
        status.textContent = `âœ” å·²è¼‰å…¥ ${list.length} ç­†æœ¬åœ°é è¨­åˆ†é¡ï¼ˆè«‹ä¿®å¾©è³‡æ–™åº«å¾Œå†å„²å­˜ï¼‰`;
      } catch (e) {
        status.textContent = 'âœ– æœ¬åœ°é è¨­æª”è®€å–å¤±æ•—';
      }
    }

    async function checkHealth() {
      const status = document.getElementById('status');
      status.textContent = 'æª¢æŸ¥ä¸­...';
      try {
        const res = await fetch('/api/health');
        const data = await res.json();
        status.textContent = 'å¥åº·æª¢æŸ¥å®Œæˆ';
        showDebug('å¥åº·æª¢æŸ¥', JSON.stringify(data, null, 2));
        // é¡å¤–æç¤º
        if (data && data.supabase && data.supabase.error) {
          showDebug('Supabase éŒ¯èª¤æç¤º', suggest(data.supabase.error));
        }
        if (data && data.db && data.db.error) {
          showDebug('PG ç›´é€£éŒ¯èª¤æç¤º', suggest(data.db.error));
        }
      } catch (e) {
        status.textContent = 'æª¢æŸ¥å¤±æ•—';
        showDebug('å¥åº·æª¢æŸ¥å¤±æ•—', e.message || String(e));
      }
    }

    function showDebug(title, details) {
      const panel = document.getElementById('debugPanel');
      const prev = panel.textContent ? panel.textContent + "\n\n" : '';
      panel.textContent = prev + `[${new Date().toLocaleString()}] ${title}\n` + (typeof details === 'string' ? details : JSON.stringify(details, null, 2));
    }

    function suggest(errorText) {
      const t = (errorText || '').toLowerCase();
      let tips = '';
      if (t.includes('schema cache') || t.includes('relation does not exist')) {
        tips = `å¯èƒ½åŸå› ï¼šPostgREST å°šæœªçœ‹åˆ° ai_categoriesã€‚\nè™•ç½®ï¼š\n1) åœ¨ Supabase SQL Editor å»ºè¡¨ public.ai_categoriesã€‚\n2) åŸ·è¡Œ ALTER ä¿ƒä½¿å¿«å–åˆ·æ–°ï¼š\n   alter table public.ai_categories alter column prompt set default '';`;
      }
      if (t.includes('enotfound') || t.includes('getaddrinfo')) {
        tips += (tips ? '\n\n' : '') + `å¯èƒ½åŸå› ï¼šç›´é€£ PostgreSQL DNS è§£æå¤±æ•—ã€‚\nè™•ç½®ï¼š\n1) æ¸¬è©¦æ™‚å¯å¿½ç•¥ï¼Œæ”¹ç”¨ Supabase RESTï¼ˆä¸éœ€ç›´é€£ï¼‰ã€‚\n2) å¦‚éœ€ç›´é€£ï¼Œç¢ºèª SUPABASE_DB_URL ç¶²è·¯/é˜²ç«ç‰†èˆ‡å¯†ç¢¼ URL encodeï¼ˆ@â†’%40ï¼‰ã€‚`;
      }
      if (!tips) tips = errorText;
      return tips;
    }

  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/config/auth-config.js"></script>
  <script src="/admin/js/admin-common.js"></script>
</body>
</html>
