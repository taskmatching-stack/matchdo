<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MATCHDO 媒合標籤過濾詞管理</title>
  <link href="../iStudio-1.0.0/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
  <div id="admin-header"></div>

  <div class="container-fluid">
    <div class="row">
      <aside id="admin-sidebar" class="col-md-3 col-lg-2 bg-white border-end min-vh-100"></aside>
      <main class="col-md-9 col-lg-10 py-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="mb-0">媒合標籤過濾詞管理</h4>
          <a href="/admin/index.html" class="btn btn-outline-secondary">返回儀表板</a>
        </div>

        <div class="alert alert-info mb-3">
          <strong>說明：</strong>媒合時會將工項與專家標籤的「尾字」刪除後再比對，刪除後兩邊相同即算相符。<br>
          例如「櫥櫃<strong>工程</strong>」與「櫥櫃」會視為相符。此處管理要刪除的「通用尾字」清單，不需重啟伺服器。
        </div>

        <div class="card shadow-sm mb-3">
          <div class="card-body">
            <div class="d-flex gap-2 mb-3">
              <input type="text" id="newWord" class="form-control" placeholder="新增尾字（例：工程）" maxlength="20" />
              <button type="button" id="addBtn" class="btn btn-primary">新增</button>
            </div>
            <ul id="wordList" class="list-group list-group-flush"></ul>
          </div>
        </div>
        <div class="mb-3">
          <button id="saveBtn" class="btn btn-success">儲存變更</button>
          <span id="status" class="ms-3"></span>
        </div>
      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/config/auth-config.js"></script>
  <script src="/admin/js/admin-common.js"></script>
  <script>
    let suffixes = [];

    async function load() {
      try {
        const res = await fetch('/api/admin/tag-strip-suffixes', { cache: 'no-store' });
        const data = await res.json();
        if (data.suffixes) suffixes = [...data.suffixes];
        else suffixes = [];
        render();
      } catch (e) {
        document.getElementById('status').textContent = '載入失敗：' + e.message;
      }
    }

    function render() {
      const ul = document.getElementById('wordList');
      ul.innerHTML = suffixes.length === 0
        ? '<li class="list-group-item text-muted">尚無過濾詞，請新增。</li>'
        : suffixes.map((w, i) => `
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span>${escapeHtml(w)}</span>
              <button type="button" class="btn btn-sm btn-outline-danger" data-index="${i}">刪除</button>
            </li>
          `).join('');
      ul.querySelectorAll('[data-index]').forEach(btn => {
        btn.addEventListener('click', () => {
          const i = parseInt(btn.dataset.index, 10);
          suffixes.splice(i, 1);
          render();
        });
      });
    }

    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    document.getElementById('addBtn').addEventListener('click', () => {
      const input = document.getElementById('newWord');
      const w = (input.value || '').trim();
      if (!w) {
        document.getElementById('status').textContent = '請輸入要新增的尾字';
        return;
      }
      if (suffixes.includes(w)) {
        document.getElementById('status').textContent = '已存在：' + w;
        return;
      }
      suffixes.push(w);
      input.value = '';
      document.getElementById('status').textContent = '';
      render();
    });

    document.getElementById('newWord').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') document.getElementById('addBtn').click();
    });

    document.getElementById('saveBtn').addEventListener('click', async () => {
      const status = document.getElementById('status');
      status.textContent = '儲存中…';
      try {
        const res = await fetch('/api/admin/tag-strip-suffixes', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ suffixes })
        });
        const data = await res.json();
        if (res.ok) {
          status.textContent = '✓ 已儲存，共 ' + (data.suffixes || []).length + ' 個過濾詞';
          status.className = 'ms-3 text-success';
        } else {
          status.textContent = '儲存失敗：' + (data.error || res.statusText);
          status.className = 'ms-3 text-danger';
        }
      } catch (e) {
        status.textContent = '儲存失敗：' + e.message;
        status.className = 'ms-3 text-danger';
      }
    });

    load();
  </script>
</body>
</html>
