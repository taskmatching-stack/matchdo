<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI 放大 - MATCHDO 後台</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    .upload-zone { border: 2px dashed #dee2e6; border-radius: 12px; padding: 2rem; text-align: center; background: #f8f9fa; cursor: pointer; }
    .upload-zone.dragover { border-color: #0d6efd; background: #e7f1ff; }
    .upload-zone.has-file { border-style: solid; border-color: #198754; background: #d1e7dd; }
    .preview-img { max-width: 100%; max-height: 240px; object-fit: contain; border-radius: 8px; }
    .result-image { max-width: 100%; max-height: 70vh; border-radius: 8px; border: 1px solid #dee2e6; }
  </style>
</head>
<body class="bg-light">
  <div id="admin-header"></div>
  <div class="container-fluid">
    <div class="row">
      <aside id="admin-sidebar" class="col-md-3 col-lg-2 bg-white border-end min-vh-100"></aside>
      <main class="col-md-9 col-lg-10 py-4">
        <h4 class="mb-3">AI 放大</h4>
        <p class="text-muted small mb-4">管理員專用：上傳圖片後以 Stability Fast 進行 4 倍放大，不扣點數。</p>

        <div id="authRequired" class="alert alert-warning mb-3" style="display:none;">
          請先<a href="/login.html" class="alert-link">登入</a>且帳號具管理員權限後再使用。
        </div>

        <div id="mainPanel" class="card mb-4">
          <div class="card-body">
            <label class="form-label fw-bold">選擇圖片</label>
            <div class="upload-zone" id="uploadZone">
              <input type="file" id="fileInput" accept="image/jpeg,image/png,image/webp" class="d-none">
              <p class="mb-2 text-muted" id="uploadHint"><i class="bi bi-cloud-arrow-up me-2"></i>拖曳或點擊選擇圖片（JPEG / PNG / WebP）</p>
              <div id="previewWrap" class="mt-2" style="display:none;">
                <img id="previewImg" class="preview-img" alt="預覽">
                <p class="small text-muted mt-2 mb-0" id="previewName"></p>
              </div>
            </div>
            <div class="mt-3">
              <button type="button" class="btn btn-primary" id="btnUpscale" disabled><i class="bi bi-zoom-in me-2"></i>開始放大</button>
            </div>
          </div>
        </div>

        <div id="statusWrap" class="alert mb-3 py-2" style="display:none;" role="alert"><span id="statusText"></span></div>

        <div class="card" id="resultCard" style="display:none;">
          <div class="card-header">放大結果</div>
          <div class="card-body text-center">
            <img id="resultImage" class="result-image" src="" alt="放大結果" />
            <div class="mt-3">
              <a id="downloadLink" href="#" download="admin-upscaled.png" class="btn btn-success"><i class="bi bi-download me-2"></i>下載圖片</a>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/config/auth-config.js"></script>
  <script src="/admin/js/admin-common.js"></script>
  <script>
(function(){
  const uploadZone = document.getElementById('uploadZone');
  const fileInput = document.getElementById('fileInput');
  const previewWrap = document.getElementById('previewWrap');
  const previewImg = document.getElementById('previewImg');
  const previewName = document.getElementById('previewName');
  const btnUpscale = document.getElementById('btnUpscale');
  const resultCard = document.getElementById('resultCard');
  const resultImage = document.getElementById('resultImage');
  const downloadLink = document.getElementById('downloadLink');
  const statusWrap = document.getElementById('statusWrap');
  const statusText = document.getElementById('statusText');
  const authRequired = document.getElementById('authRequired');
  const mainPanel = document.getElementById('mainPanel');

  let selectedFile = null;

  function showStatus(msg, isError) {
    statusWrap.style.display = 'block';
    statusWrap.className = 'alert mb-3 py-2 ' + (isError ? 'alert-danger' : 'alert-info');
    statusText.textContent = msg;
  }
  function hideStatus() { statusWrap.style.display = 'none'; }

  uploadZone.addEventListener('click', function() { fileInput.click(); });
  uploadZone.addEventListener('dragover', function(e) { e.preventDefault(); uploadZone.classList.add('dragover'); });
  uploadZone.addEventListener('dragleave', function() { uploadZone.classList.remove('dragover'); });
  uploadZone.addEventListener('drop', function(e) {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]) setFile(e.dataTransfer.files[0]);
  });
  fileInput.addEventListener('change', function() {
    if (fileInput.files && fileInput.files[0]) setFile(fileInput.files[0]);
  });

  function setFile(file) {
    if (!file || !file.type.match(/^image\/(jpeg|png|webp)/)) return;
    selectedFile = file;
    uploadZone.classList.add('has-file');
    document.getElementById('uploadHint').style.display = 'none';
    previewWrap.style.display = 'block';
    previewImg.src = URL.createObjectURL(file);
    previewName.textContent = file.name;
    btnUpscale.disabled = false;
  }

  btnUpscale.addEventListener('click', async function() {
    if (!selectedFile) return;
    var session = (window.getSessionFromStorage && window.getSessionFromStorage()) || (window.AuthService && (await AuthService.getSession())) || null;
    var token = session && (session.access_token || session.session && session.session.access_token);
    if (!token) {
      showStatus('請先登入', true);
      return;
    }
    hideStatus();
    resultCard.style.display = 'none';
    showStatus('正在放大…', false);
    btnUpscale.disabled = true;

    var form = new FormData();
    form.append('image', selectedFile);

    try {
      var res = await fetch('/api/upscale-image', {
        method: 'POST',
        headers: { Authorization: 'Bearer ' + token },
        body: form
      });
      var data = await res.json().catch(function() { return {}; });

      if (!res.ok) {
        showStatus(data.error || '放大失敗', true);
        btnUpscale.disabled = false;
        return;
      }
      if (data.success && data.imageData) {
        resultImage.src = data.imageData;
        downloadLink.href = data.imageData;
        downloadLink.download = 'admin-upscaled.png';
        resultCard.style.display = 'block';
        resultCard.scrollIntoView({ behavior: 'smooth' });
        hideStatus();
      } else {
        showStatus(data.error || '未取得結果', true);
      }
    } catch (e) {
      showStatus('網路錯誤', true);
    }
    btnUpscale.disabled = false;
  });

  document.addEventListener('DOMContentLoaded', async function() {
    var session = (window.getSessionFromStorage && window.getSessionFromStorage()) || (window.AuthService && (await AuthService.getSession())) || null;
    if (!session || !session.user) {
      authRequired.style.display = 'block';
      mainPanel.style.display = 'none';
      return;
    }
    var token = session.access_token || (session.session && session.session.access_token);
    if (!token) {
      authRequired.style.display = 'block';
      mainPanel.style.display = 'none';
      return;
    }
    var profileRes = await fetch('/api/admin/points-config', { headers: { Authorization: 'Bearer ' + token } });
    if (profileRes.status === 401 || profileRes.status === 403) {
      authRequired.style.display = 'block';
      mainPanel.style.display = 'none';
    }
  });
})();
  </script>
</body>
</html>
