<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>服務地區管理 - MATCHDO 後台</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    .group-header { background: #f0f4f8; font-weight: 600; }
    .top-area-row { background: #fff; }
    .sub-area-row  { background: #fafcff; }
    .sub-area-row td:first-child { padding-left: 2rem; color: #666; }
    .add-sub-row td { background: #f8fafc; padding: 0.4rem 0.75rem; }
    code { font-size: .8rem; color: #c0392b; }
    .btn-xs { font-size: .72rem; padding: 1px 7px; }
  </style>
</head>
<body class="bg-light">
  <div id="admin-header"></div>
  <div class="container-fluid">
    <div class="row">
      <aside id="admin-sidebar" class="col-md-3 col-lg-2 bg-white border-end min-vh-100"></aside>
      <main class="col-md-9 col-lg-10 py-4">
        <h4 class="mb-1">服務地區管理</h4>
        <p class="text-muted small mb-1">
          管理廠商可選擇的服務地區。台灣縣市直接掛在大區下；海外國家可再新增子城市。<br>
          ⚠ 請先在 Supabase SQL Editor 執行 <code>docs/service-areas-add-parent.sql</code>（加入 parent_code 欄位）。
        </p>

        <div id="statusWrap" class="alert mb-3 py-2 d-none"><span id="statusMsg"></span></div>

        <!-- 新增頂層地區 -->
        <div class="card mb-4">
          <div class="card-header fw-semibold">新增頂層地區（縣市 / 國家）</div>
          <div class="card-body">
            <div class="row g-2 align-items-end">
              <div class="col-6 col-md-2">
                <label class="form-label small mb-0">code <span class="text-danger">*</span></label>
                <input id="newCode" class="form-control form-control-sm text-uppercase" placeholder="GB / TW-TPE">
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label small mb-0">中文名 <span class="text-danger">*</span></label>
                <input id="newZh" class="form-control form-control-sm" placeholder="英國">
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label small mb-0">英文名 <span class="text-danger">*</span></label>
                <input id="newEn" class="form-control form-control-sm" placeholder="UK">
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label small mb-0">大區 <span class="text-danger">*</span></label>
                <select id="newGroupCode" class="form-select form-select-sm">
                  <option value="">— 選大區 —</option>
                  <option value="TW-N">TW-N 北部</option>
                  <option value="TW-C">TW-C 中部</option>
                  <option value="TW-S">TW-S 南部</option>
                  <option value="TW-E">TW-E 東部</option>
                  <option value="TW-O">TW-O 離島</option>
                  <option value="OVERSEAS">OVERSEAS 海外</option>
                </select>
              </div>
              <div class="col-4 col-md-1">
                <label class="form-label small mb-0">排序</label>
                <input id="newSort" type="number" class="form-control form-control-sm" value="0" min="0">
              </div>
              <div class="col-8 col-md-2">
                <button id="btnAdd" class="btn btn-primary btn-sm w-100"><i class="bi bi-plus-lg me-1"></i>新增</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 列表 -->
        <div class="card">
          <div class="card-header d-flex align-items-center justify-content-between">
            <span class="fw-semibold">地區列表</span>
            <button id="btnReload" class="btn btn-sm btn-outline-secondary">重新載入</button>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-sm table-bordered mb-0" id="areaTable">
                <thead class="table-light">
                  <tr>
                    <th style="width:14%">code</th>
                    <th style="width:12%">中文</th>
                    <th style="width:12%">英文</th>
                    <th style="width:10%">大區</th>
                    <th style="width:6%">排序</th>
                    <th style="width:6%">狀態</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="areaBody">
                  <tr><td colspan="7" class="text-center text-muted py-4">載入中…</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- 編輯 Modal -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header py-2">
          <h6 class="modal-title mb-0">編輯地區</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editCode">
          <div class="row g-2">
            <div class="col-12">
              <label class="form-label small">code（唯讀）</label>
              <input id="editCodeDisp" class="form-control form-control-sm" readonly>
            </div>
            <div class="col-6">
              <label class="form-label small">中文名</label>
              <input id="editZh" class="form-control form-control-sm">
            </div>
            <div class="col-6">
              <label class="form-label small">英文名</label>
              <input id="editEn" class="form-control form-control-sm">
            </div>
            <div class="col-6">
              <label class="form-label small">大區 code</label>
              <select id="editGroupCode" class="form-select form-select-sm">
                <option value="TW-N">TW-N 北部</option>
                <option value="TW-C">TW-C 中部</option>
                <option value="TW-S">TW-S 南部</option>
                <option value="TW-E">TW-E 東部</option>
                <option value="TW-O">TW-O 離島</option>
                <option value="OVERSEAS">OVERSEAS 海外</option>
              </select>
            </div>
            <div class="col-3">
              <label class="form-label small">排序</label>
              <input id="editSort" type="number" class="form-control form-control-sm" min="0">
            </div>
            <div class="col-3 d-flex align-items-end">
              <div class="form-check mb-1">
                <input class="form-check-input" type="checkbox" id="editActive">
                <label class="form-check-label small" for="editActive">啟用</label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer py-2">
          <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">取消</button>
          <button class="btn btn-primary btn-sm" id="editSaveBtn">儲存</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/config/auth-config.js"></script>
  <script src="/admin/js/admin-common.js"></script>
  <script>
(function () {
  const API = '/api/admin/service-areas';
  const GROUP_META = {
    'TW-N': { zh:'北部', en:'North Taiwan' },
    'TW-C': { zh:'中部', en:'Central Taiwan' },
    'TW-S': { zh:'南部', en:'South Taiwan' },
    'TW-E': { zh:'東部', en:'East Taiwan' },
    'TW-O': { zh:'離島', en:'Outlying Islands' },
    'OVERSEAS': { zh:'海外', en:'Overseas' }
  };
  const GROUP_ORDER = ['TW-N','TW-C','TW-S','TW-E','TW-O','OVERSEAS'];
  let allAreas = [];

  async function getHeaders() {
    const s = await (window.AuthService?.getSession().catch(()=>null));
    const t = s?.access_token || s?.session?.access_token;
    return t ? { Authorization:'Bearer '+t, 'Content-Type':'application/json' } : {};
  }

  function esc(s) { const d=document.createElement('div'); d.textContent=s||''; return d.innerHTML; }

  function showStatus(msg, type) {
    const w=document.getElementById('statusWrap');
    const s=document.getElementById('statusMsg');
    w.className='alert alert-'+(type||'info')+' mb-3 py-2';
    s.textContent=msg; w.classList.remove('d-none');
    if(type==='success') setTimeout(()=>w.classList.add('d-none'), 3000);
  }

  async function loadList() {
    document.getElementById('areaBody').innerHTML = '<tr><td colspan="7" class="text-center text-muted py-3">載入中…</td></tr>';
    const h = await getHeaders();
    try {
      const r = await fetch(API, { headers: h });
      const d = await r.json();
      if (!r.ok) throw new Error(d.error||'載入失敗');
      allAreas = d.areas || [];
      renderTable();
    } catch(e) {
      document.getElementById('areaBody').innerHTML = '<tr><td colspan="7" class="text-danger p-3">'+esc(e.message)+'</td></tr>';
    }
  }

  function renderTable() {
    const tbody = document.getElementById('areaBody');
    if (!allAreas.length) {
      tbody.innerHTML = '<tr><td colspan="7" class="text-muted p-3">尚無資料，請先執行 docs/service-areas-schema.sql 和 docs/service-areas-add-parent.sql</td></tr>';
      return;
    }

    // 分離頂層與子地區
    const topLevel  = allAreas.filter(a => !a.parent_code);
    const childMap  = {};
    allAreas.filter(a => a.parent_code).forEach(a => {
      if (!childMap[a.parent_code]) childMap[a.parent_code] = [];
      childMap[a.parent_code].push(a);
    });

    // 依大區分組
    const groupMap = {};
    topLevel.forEach(a => {
      if (!groupMap[a.group_code]) groupMap[a.group_code] = [];
      groupMap[a.group_code].push(a);
    });
    const keys = GROUP_ORDER.filter(k=>groupMap[k]).concat(Object.keys(groupMap).filter(k=>!GROUP_ORDER.includes(k)));

    let html = '';
    keys.forEach(gk => {
      const gMeta = GROUP_META[gk] || { zh: gk, en: gk };
      html += `<tr class="group-header"><td colspan="7" class="py-1 px-3 small">
        ${esc(gMeta.zh)} / ${esc(gMeta.en)} &nbsp;<code>${esc(gk)}</code></td></tr>`;

      (groupMap[gk]||[]).forEach(a => {
        const badge = a.is_active ? '<span class="badge bg-success">啟用</span>' : '<span class="badge bg-secondary">停用</span>';
        html += `<tr class="top-area-row">
          <td><code>${esc(a.code)}</code></td>
          <td>${esc(a.name_zh)}</td><td>${esc(a.name_en)}</td>
          <td><code>${esc(a.group_code)}</code></td>
          <td>${a.sort_order}</td><td>${badge}</td>
          <td>
            <button class="btn btn-xs btn-outline-primary me-1 edit-btn" data-code="${esc(a.code)}">編輯</button>
            <button class="btn btn-xs btn-outline-danger delete-btn" data-code="${esc(a.code)}">刪除</button>
          </td></tr>`;

        // 子地區列
        (childMap[a.code]||[]).forEach(sub => {
          const subBadge = sub.is_active ? '<span class="badge bg-success">啟用</span>' : '<span class="badge bg-secondary">停用</span>';
          html += `<tr class="sub-area-row">
            <td>└ <code>${esc(sub.code)}</code></td>
            <td>${esc(sub.name_zh)}</td><td>${esc(sub.name_en)}</td>
            <td><code>${esc(sub.group_code)}</code></td>
            <td>${sub.sort_order}</td><td>${subBadge}</td>
            <td>
              <button class="btn btn-xs btn-outline-primary me-1 edit-btn" data-code="${esc(sub.code)}">編輯</button>
              <button class="btn btn-xs btn-outline-danger delete-btn" data-code="${esc(sub.code)}">刪除</button>
            </td></tr>`;
        });

        // 新增子地區列
        html += `<tr class="add-sub-row">
          <td colspan="7">
            <div class="d-flex flex-wrap align-items-end gap-2 add-sub-form" data-parent="${esc(a.code)}" data-group="${esc(a.group_code)}">
              <span class="small text-muted">└ 新增子地區：</span>
              <input type="text" class="form-control form-control-sm" style="width:90px" placeholder="code" data-f="code">
              <input type="text" class="form-control form-control-sm" style="width:90px" placeholder="中文名" data-f="zh">
              <input type="text" class="form-control form-control-sm" style="width:90px" placeholder="English" data-f="en">
              <input type="number" class="form-control form-control-sm" style="width:60px" value="0" placeholder="排序" data-f="sort">
              <button class="btn btn-success btn-xs sub-add-btn">新增</button>
            </div>
          </td></tr>`;
      });
    });

    tbody.innerHTML = html;

    // 事件綁定
    tbody.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', () => openEdit(btn.dataset.code)));
    tbody.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', () => deleteArea(btn.dataset.code)));
    tbody.querySelectorAll('.sub-add-btn').forEach(btn => {
      btn.addEventListener('click', async function() {
        const form = btn.closest('.add-sub-form');
        const parentCode = form.dataset.parent;
        const groupCode  = form.dataset.group;
        const code   = (form.querySelector('[data-f="code"]').value||'').trim().toUpperCase();
        const zh     = (form.querySelector('[data-f="zh"]').value||'').trim();
        const en     = (form.querySelector('[data-f="en"]').value||'').trim();
        const sort   = parseInt(form.querySelector('[data-f="sort"]').value)||0;
        if (!code||!zh||!en) { showStatus('請填寫子地區 code、中文名、英文名','warning'); return; }
        const gMeta = GROUP_META[groupCode]||{zh:groupCode,en:groupCode};
        await addArea({ code, name_zh:zh, name_en:en, group_code:groupCode, group_zh:gMeta.zh, group_en:gMeta.en, sort_order:sort, parent_code:parentCode });
        form.querySelectorAll('input').forEach(i=>{ if(i.type!=='number') i.value=''; else i.value='0'; });
      });
    });
  }

  async function addArea(body) {
    const h = await getHeaders();
    try {
      const r = await fetch(API, { method:'POST', headers:h, body:JSON.stringify(body) });
      const d = await r.json();
      if (!r.ok) throw new Error(d.error);
      showStatus('已新增 '+body.code, 'success');
      loadList();
    } catch(e) { showStatus('新增失敗：'+e.message, 'danger'); }
  }

  // 頂層新增
  document.getElementById('btnAdd').addEventListener('click', async function() {
    const code = (document.getElementById('newCode').value||'').trim().toUpperCase();
    const zh   = (document.getElementById('newZh').value||'').trim();
    const en   = (document.getElementById('newEn').value||'').trim();
    const gk   = document.getElementById('newGroupCode').value;
    const sort = parseInt(document.getElementById('newSort').value)||0;
    if (!code||!zh||!en||!gk) { showStatus('請填寫所有必填欄位','warning'); return; }
    const gMeta = GROUP_META[gk]||{zh:gk,en:gk};
    await addArea({ code, name_zh:zh, name_en:en, group_code:gk, group_zh:gMeta.zh, group_en:gMeta.en, sort_order:sort, parent_code:null });
    ['newCode','newZh','newEn'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('newSort').value='0';
  });

  function openEdit(code) {
    const a = allAreas.find(x=>x.code===code);
    if (!a) return;
    document.getElementById('editCode').value = a.code;
    document.getElementById('editCodeDisp').value = a.code;
    document.getElementById('editZh').value = a.name_zh;
    document.getElementById('editEn').value = a.name_en;
    document.getElementById('editGroupCode').value = a.group_code;
    document.getElementById('editSort').value = a.sort_order;
    document.getElementById('editActive').checked = a.is_active;
    new bootstrap.Modal(document.getElementById('editModal')).show();
  }

  document.getElementById('editSaveBtn').addEventListener('click', async function() {
    const code = document.getElementById('editCode').value;
    const gk   = document.getElementById('editGroupCode').value;
    const gMeta = GROUP_META[gk]||{zh:gk,en:gk};
    const body = {
      name_zh: document.getElementById('editZh').value.trim(),
      name_en: document.getElementById('editEn').value.trim(),
      group_code: gk, group_zh: gMeta.zh, group_en: gMeta.en,
      sort_order: parseInt(document.getElementById('editSort').value)||0,
      is_active: document.getElementById('editActive').checked
    };
    const h = await getHeaders();
    try {
      const r = await fetch(API+'/'+encodeURIComponent(code), { method:'PUT', headers:h, body:JSON.stringify(body) });
      const d = await r.json();
      if (!r.ok) throw new Error(d.error);
      bootstrap.Modal.getInstance(document.getElementById('editModal'))?.hide();
      showStatus('已更新','success'); loadList();
    } catch(e) { showStatus('更新失敗：'+e.message,'danger'); }
  });

  async function deleteArea(code) {
    const a = allAreas.find(x=>x.code===code);
    const hasChildren = allAreas.some(x=>x.parent_code===code);
    const msg = hasChildren
      ? `確定刪除「${code}」及其所有子地區？` 
      : `確定刪除「${code}」？`;
    if (!confirm(msg)) return;
    const h = await getHeaders();
    try {
      const r = await fetch(API+'/'+encodeURIComponent(code), { method:'DELETE', headers:h });
      const d = await r.json();
      if (!r.ok) throw new Error(d.error);
      showStatus('已刪除 '+code,'success'); loadList();
    } catch(e) { showStatus('刪除失敗：'+e.message,'danger'); }
  }

  document.getElementById('btnReload').addEventListener('click', loadList);

  // Enter 快捷
  ['newCode','newZh','newEn','newSort'].forEach(id => {
    document.getElementById(id).addEventListener('keydown', e => { if(e.key==='Enter') document.getElementById('btnAdd').click(); });
  });

  document.addEventListener('DOMContentLoaded', loadList);
})();
  </script>
</body>
</html>
