<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>服務地區管理 - MATCHDO 後台</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    /* 層級視覺 */
    tr.row-country td { background:#dce8f5; font-weight:600; }
    tr.row-tw-city  td { background:#fff; }
    tr.row-tw-city  td:first-child { padding-left:2.2rem; }
    tr.row-state    td { background:#eef3fb; }
    tr.row-state    td:first-child { padding-left:2.2rem; }
    tr.row-city     td { background:#f7faff; }
    tr.row-city     td:first-child { padding-left:3.8rem; }
    tr.row-group    td { background:#f0f5f0; font-size:.73rem; color:#555; padding:2px 12px; }
    tr.row-add      td { background:#f5f8fc; padding:.3rem .75rem; }
    tr.row-add.l1   td:first-child { padding-left:2.2rem; }
    tr.row-add.l2   td:first-child { padding-left:3.8rem; }
    code { font-size:.78rem; color:#c0392b; }
    .btn-xs { font-size:.72rem; padding:1px 7px; }
    .tbadge { font-size:.62rem; padding:1px 5px; border-radius:3px; font-weight:600; }
    .tb-country { background:#2c5f9e; color:#fff; }
    .tb-tw-city { background:#27ae60; color:#fff; }
    .tb-state   { background:#7d3c98; color:#fff; }
    .tb-city    { background:#7f8c8d; color:#fff; }
  </style>
</head>
<body class="bg-light">
  <div id="admin-header"></div>
  <div class="container-fluid">
    <div class="row">
      <aside id="admin-sidebar" class="col-md-3 col-lg-2 bg-white border-end min-vh-100"></aside>
      <main class="col-md-9 col-lg-10 py-4">

        <h4 class="mb-1">服務地區管理</h4>
        <div class="alert alert-info small py-2 mb-3">
          <strong>層級說明：</strong>
          <span class="tbadge tb-country">國家</span> 台灣 / 海外頂層 →
          <span class="tbadge tb-tw-city">台灣縣市</span> 葉節點 →
          <span class="tbadge tb-state">州/地區</span> 海外第二層 →
          <span class="tbadge tb-city">城市</span> 葉節點<br>
          ⚠ 若後台層級混亂，請先在 Supabase 執行 <code>docs/service-areas-complete.sql</code>，再執行 <code>docs/service-areas-i18n.sql</code>。
        </div>

        <div id="statusWrap" class="alert mb-3 py-2 d-none"><span id="statusMsg"></span></div>

        <!-- 新增頂層國家 -->
        <div class="card mb-3">
          <div class="card-header fw-semibold">新增頂層國家</div>
          <div class="card-body py-2">
            <div class="row g-2 align-items-end">
              <div class="col-6 col-md-2">
                <label class="form-label small mb-0">Code <span class="text-danger">*</span></label>
                <input id="newCode" class="form-control form-control-sm text-uppercase" placeholder="GB / US / JP">
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label small mb-0">中文名 <span class="text-danger">*</span></label>
                <input id="newZh" class="form-control form-control-sm" placeholder="英國">
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label small mb-0">英文名 <span class="text-danger">*</span></label>
                <input id="newEn" class="form-control form-control-sm" placeholder="UK">
              </div>
              <div class="col-4 col-md-1">
                <label class="form-label small mb-0">排序</label>
                <input id="newSort" type="number" class="form-control form-control-sm" value="0">
              </div>
              <div class="col-8 col-md-2">
                <button id="btnAdd" class="btn btn-primary btn-sm w-100">
                  <i class="bi bi-plus-lg me-1"></i>新增國家
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- 地區列表 -->
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-semibold">地區列表</span>
            <button id="btnReload" class="btn btn-sm btn-outline-secondary">
              <i class="bi bi-arrow-clockwise"></i> 重新載入
            </button>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-sm table-bordered mb-0">
                <thead class="table-light">
                  <tr>
                    <th style="width:18%">code / 類型</th>
                    <th style="width:13%">中文名</th>
                    <th style="width:13%">英文名</th>
                    <th style="width:8%">日文</th>
                    <th style="width:8%">韓文</th>
                    <th style="width:5%">排序</th>
                    <th style="width:5%">狀態</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="areaBody">
                  <tr><td colspan="8" class="text-center text-muted py-4">載入中…</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </main>
    </div>
  </div>

  <!-- 編輯 Modal -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header py-2">
          <h6 class="modal-title mb-0" id="editModalTitle">編輯地區</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editCode">
          <div class="row g-2">
            <div class="col-12">
              <label class="form-label small">Code（唯讀）</label>
              <input id="editCodeDisp" class="form-control form-control-sm bg-light" readonly>
            </div>
            <div class="col-6">
              <label class="form-label small">中文名 <span class="text-danger">*</span></label>
              <input id="editZh" class="form-control form-control-sm">
            </div>
            <div class="col-6">
              <label class="form-label small">英文名 <span class="text-danger">*</span></label>
              <input id="editEn" class="form-control form-control-sm">
            </div>
          </div>

          <hr class="my-2">
          <p class="small text-muted mb-2">其他語系（選填，預留）</p>
          <div class="row g-2">
            <div class="col-6 col-md-3">
              <label class="form-label small">日文</label>
              <input id="editJa" class="form-control form-control-sm" placeholder="東京都">
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label small">韓文</label>
              <input id="editKo" class="form-control form-control-sm" placeholder="도쿄">
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label small">法文</label>
              <input id="editFr" class="form-control form-control-sm" placeholder="Tokyo">
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label small">德文</label>
              <input id="editDe" class="form-control form-control-sm" placeholder="Tokio">
            </div>
          </div>

          <hr class="my-2">
          <div class="row g-2 align-items-center">
            <div class="col-4">
              <label class="form-label small">排序</label>
              <input id="editSort" type="number" class="form-control form-control-sm" min="0">
            </div>
            <div class="col-8 d-flex align-items-end pb-1">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="editActive">
                <label class="form-check-label small" for="editActive">啟用</label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer py-2">
          <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">取消</button>
          <button class="btn btn-primary btn-sm" id="editSaveBtn">儲存</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/config/auth-config.js"></script>
  <script src="/admin/js/admin-common.js"></script>
  <script>
(function () {
  const API = '/api/admin/service-areas';
  const TW_GROUPS = { 'TW-N':'北部', 'TW-C':'中部', 'TW-S':'南部', 'TW-E':'東部', 'TW-O':'離島' };
  const TW_ORDER  = ['TW-N','TW-C','TW-S','TW-E','TW-O'];
  let allAreas = [];

  /* ── 工具 ── */
  async function getHeaders() {
    const s = await (window.AuthService?.getSession().catch(() => null));
    const t = s?.access_token || s?.session?.access_token;
    return t ? { Authorization: 'Bearer ' + t, 'Content-Type': 'application/json' } : {};
  }
  function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
  function showStatus(msg, type) {
    const w = document.getElementById('statusWrap'), s = document.getElementById('statusMsg');
    w.className = 'alert alert-' + (type || 'info') + ' mb-3 py-2';
    s.textContent = msg; w.classList.remove('d-none');
    if (type === 'success') setTimeout(() => w.classList.add('d-none'), 3000);
  }
  function tbadge(t) {
    const m = { country:'tb-country 國家', tw_city:'tb-tw-city 台灣縣市', state:'tb-state 州/地區', city:'tb-city 城市' };
    const [cls, lbl] = (m[t] || 'tb-country 國家').split(' ');
    return `<span class="tbadge ${cls}">${lbl}</span>`;
  }
  function abadge(a) { return a ? '<span class="badge bg-success">啟用</span>' : '<span class="badge bg-secondary">停用</span>'; }
  function i18nVal(area, lang) { return (area.name_i18n && area.name_i18n[lang]) || ''; }
  function sorted(arr) { return (arr||[]).sort((a,b) => (a.sort_order-b.sort_order)||a.code.localeCompare(b.code)); }

  /* ── 載入 ── */
  async function loadList() {
    document.getElementById('areaBody').innerHTML =
      '<tr><td colspan="8" class="text-center text-muted py-3">載入中…</td></tr>';
    const h = await getHeaders();
    try {
      const r = await fetch(API, { headers: h });
      const d = await r.json();
      if (!r.ok) throw new Error(d.error || '載入失敗');
      allAreas = d.areas || [];
      renderTable();
    } catch (e) {
      document.getElementById('areaBody').innerHTML =
        '<tr><td colspan="8" class="text-danger p-3">' + esc(e.message) + '</td></tr>';
    }
  }

  /* ── 渲染 ── */
  function renderTable() {
    const tbody = document.getElementById('areaBody');
    if (!allAreas.length) {
      tbody.innerHTML = '<tr><td colspan="8" class="text-muted p-3">尚無資料，請執行 docs/service-areas-complete.sql</td></tr>';
      return;
    }

    const childMap = {};
    allAreas.forEach(a => {
      const p = a.parent_code || '__root__';
      if (!childMap[p]) childMap[p] = [];
      childMap[p].push(a);
    });

    let html = '';

    sorted(childMap['__root__'] || []).forEach(country => {
      // ── 頂層：國家 ──
      html += row('row-country', country, tbadge(country.area_type || 'country'));

      if (country.code === 'TW') {
        // 台灣縣市：按大區分組
        const twCities = sorted(childMap['TW'] || []);
        const grouped = {};
        twCities.forEach(c => {
          const g = c.group_code || 'TW-N';
          if (!grouped[g]) grouped[g] = [];
          grouped[g].push(c);
        });
        TW_ORDER.forEach(gk => {
          if (!grouped[gk]) return;
          html += `<tr class="row-group"><td colspan="8">　─ ${esc(TW_GROUPS[gk] || gk)}</td></tr>`;
          grouped[gk].forEach(city => {
            html += row('row-tw-city', city, tbadge('tw_city'));
          });
        });
        // 台灣新增縣市
        html += addRow('TW', country.group_code || 'OVERSEAS', 'tw_city', 'l1', '新增縣市');

      } else {
        // 海外：州/地區
        sorted(childMap[country.code] || []).forEach(state => {
          html += row('row-state', state, tbadge('state'));

          // 州下城市
          sorted(childMap[state.code] || []).forEach(city => {
            html += row('row-city', city, tbadge('city'));
          });
          // 新增城市
          html += addRow(state.code, country.group_code || 'OVERSEAS', 'city', 'l2', '新增城市');
        });
        // 新增州/地區
        html += addRow(country.code, country.group_code || 'OVERSEAS', 'state', 'l1', '新增州/地區');
      }
    });

    tbody.innerHTML = html;
    bindEvents();
  }

  /* ── 一行資料 ── */
  function row(cls, a, badge) {
    return `<tr class="${cls}">
      <td><code>${esc(a.code)}</code> ${badge}</td>
      <td>${esc(a.name_zh)}</td>
      <td>${esc(a.name_en)}</td>
      <td class="text-muted small">${esc(i18nVal(a,'ja'))}</td>
      <td class="text-muted small">${esc(i18nVal(a,'ko'))}</td>
      <td>${a.sort_order}</td>
      <td>${abadge(a.is_active)}</td>
      <td>
        <button class="btn btn-xs btn-outline-primary me-1 js-edit" data-code="${esc(a.code)}">編輯</button>
        <button class="btn btn-xs btn-outline-danger js-del" data-code="${esc(a.code)}">刪除</button>
      </td></tr>`;
  }

  /* ── 新增子項表單 ── */
  function addRow(parentCode, groupCode, areaType, lvl, label) {
    return `<tr class="row-add ${lvl}">
      <td colspan="8">
        <div class="d-flex flex-wrap align-items-end gap-2 py-1 js-add-form"
             data-parent="${esc(parentCode)}" data-group="${esc(groupCode)}" data-type="${esc(areaType)}">
          <span class="small text-muted">└ ${esc(label)}：</span>
          <div>
            <div class="form-label small mb-0" style="font-size:.65rem;color:#999">Code</div>
            <input class="form-control form-control-sm" style="width:88px" placeholder="code" data-f="code">
          </div>
          <div>
            <div class="form-label small mb-0" style="font-size:.65rem;color:#999">中文名</div>
            <input class="form-control form-control-sm" style="width:88px" placeholder="中文名" data-f="zh">
          </div>
          <div>
            <div class="form-label small mb-0" style="font-size:.65rem;color:#999">English</div>
            <input class="form-control form-control-sm" style="width:88px" placeholder="English" data-f="en">
          </div>
          <div>
            <div class="form-label small mb-0" style="font-size:.65rem;color:#999">排序</div>
            <input type="number" class="form-control form-control-sm" style="width:55px" value="0" data-f="sort">
          </div>
          <button class="btn btn-success btn-xs js-sub-add align-self-end">新增</button>
        </div>
      </td></tr>`;
  }

  /* ── 事件綁定 ── */
  function bindEvents() {
    const tbody = document.getElementById('areaBody');
    tbody.querySelectorAll('.js-edit').forEach(btn =>
      btn.addEventListener('click', () => openEdit(btn.dataset.code)));
    tbody.querySelectorAll('.js-del').forEach(btn =>
      btn.addEventListener('click', () => doDelete(btn.dataset.code)));
    tbody.querySelectorAll('.js-sub-add').forEach(btn => {
      btn.addEventListener('click', async function () {
        const form = btn.closest('.js-add-form');
        const parentCode = form.dataset.parent;
        const groupCode  = form.dataset.group;
        const areaType   = form.dataset.type;
        const code = (form.querySelector('[data-f="code"]').value || '').trim().toUpperCase();
        const zh   = (form.querySelector('[data-f="zh"]').value || '').trim();
        const en   = (form.querySelector('[data-f="en"]').value || '').trim();
        const sort = parseInt(form.querySelector('[data-f="sort"]').value) || 0;
        if (!code || !zh || !en) { showStatus('請填寫 code、中文名、英文名', 'warning'); return; }
        // 繼承 group_zh / group_en
        const parent = allAreas.find(a => a.code === parentCode) || {};
        const gZh = parent.group_zh || '海外';
        const gEn = parent.group_en || 'Overseas';
        btn.disabled = true;
        await doAdd({ code, name_zh: zh, name_en: en, group_code: groupCode,
          group_zh: gZh, group_en: gEn, sort_order: sort, parent_code: parentCode, area_type: areaType });
        btn.disabled = false;
        form.querySelectorAll('input').forEach(i => { i.value = i.type === 'number' ? '0' : ''; });
      });
    });
  }

  /* ── CRUD ── */
  async function doAdd(body) {
    const h = await getHeaders();
    try {
      const r = await fetch(API, { method: 'POST', headers: h, body: JSON.stringify(body) });
      const d = await r.json();
      if (!r.ok) throw new Error(d.error);
      showStatus('✓ 已新增 ' + body.code, 'success');
      loadList();
    } catch (e) { showStatus('新增失敗：' + e.message, 'danger'); }
  }

  function openEdit(code) {
    const a = allAreas.find(x => x.code === code);
    if (!a) return;
    const i18n = a.name_i18n || {};
    document.getElementById('editCode').value    = a.code;
    document.getElementById('editCodeDisp').value = a.code;
    document.getElementById('editModalTitle').textContent = '編輯：' + a.name_zh + ' (' + a.code + ')';
    document.getElementById('editZh').value   = a.name_zh;
    document.getElementById('editEn').value   = a.name_en;
    document.getElementById('editJa').value   = i18n.ja || '';
    document.getElementById('editKo').value   = i18n.ko || '';
    document.getElementById('editFr').value   = i18n.fr || '';
    document.getElementById('editDe').value   = i18n.de || '';
    document.getElementById('editSort').value  = a.sort_order;
    document.getElementById('editActive').checked = a.is_active;
    new bootstrap.Modal(document.getElementById('editModal')).show();
  }

  document.getElementById('editSaveBtn').addEventListener('click', async function () {
    const code = document.getElementById('editCode').value;
    const i18n = {};
    ['ja','ko','fr','de'].forEach(lang => {
      const v = (document.getElementById('edit' + lang.charAt(0).toUpperCase() + lang.slice(1)).value || '').trim();
      if (v) i18n[lang] = v;
    });
    const body = {
      name_zh:    document.getElementById('editZh').value.trim(),
      name_en:    document.getElementById('editEn').value.trim(),
      sort_order: parseInt(document.getElementById('editSort').value) || 0,
      is_active:  document.getElementById('editActive').checked,
      name_i18n:  i18n
    };
    const h = await getHeaders();
    try {
      const r = await fetch(API + '/' + encodeURIComponent(code), { method: 'PUT', headers: h, body: JSON.stringify(body) });
      const d = await r.json();
      if (!r.ok) throw new Error(d.error);
      bootstrap.Modal.getInstance(document.getElementById('editModal'))?.hide();
      showStatus('✓ 已更新', 'success'); loadList();
    } catch (e) { showStatus('更新失敗：' + e.message, 'danger'); }
  });

  async function doDelete(code) {
    const hasChildren = allAreas.some(a => a.parent_code === code);
    if (!confirm(hasChildren
      ? `「${code}」底下還有子地區，刪除後子地區也會一併移除。確定？`
      : `確定刪除「${code}」？`)) return;
    const h = await getHeaders();
    try {
      const r = await fetch(API + '/' + encodeURIComponent(code), { method: 'DELETE', headers: h });
      const d = await r.json();
      if (!r.ok) throw new Error(d.error);
      showStatus('✓ 已刪除 ' + code, 'success'); loadList();
    } catch (e) { showStatus('刪除失敗：' + e.message, 'danger'); }
  }

  /* ── 頂層新增 ── */
  document.getElementById('btnAdd').addEventListener('click', async function () {
    const code = (document.getElementById('newCode').value || '').trim().toUpperCase();
    const zh   = (document.getElementById('newZh').value || '').trim();
    const en   = (document.getElementById('newEn').value || '').trim();
    const sort = parseInt(document.getElementById('newSort').value) || 0;
    if (!code || !zh || !en) { showStatus('請填寫所有必填欄位', 'warning'); return; }
    await doAdd({ code, name_zh: zh, name_en: en,
      group_code: 'OVERSEAS', group_zh: '海外', group_en: 'Overseas',
      sort_order: sort, parent_code: null, area_type: 'country' });
    ['newCode','newZh','newEn'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('newSort').value = '0';
  });

  document.getElementById('btnReload').addEventListener('click', loadList);
  ['newCode','newZh','newEn','newSort'].forEach(id => {
    document.getElementById(id).addEventListener('keydown', e => {
      if (e.key === 'Enter') document.getElementById('btnAdd').click();
    });
  });

  document.addEventListener('DOMContentLoaded', loadList);
})();
  </script>
</body>
</html>
