<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æœå‹™åœ°å€ç®¡ç† - MATCHDO å¾Œå°</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    /* ä¸‰å±¤çµæ§‹é¡è‰² */
    tr.row-country td { background:#e8f0fb; font-weight:600; }
    tr.row-tw-city td { background:#fff; }
    tr.row-tw-city td:first-child { padding-left:2rem; }
    tr.row-state  td { background:#f5f8ff; }
    tr.row-state  td:first-child { padding-left:2rem; }
    tr.row-city   td { background:#fafcff; }
    tr.row-city   td:first-child { padding-left:3.5rem; }
    tr.row-add    td { background:#f0f5ff; padding:0.3rem 0.75rem; }
    tr.row-add.indent-1 td:first-child { padding-left:2rem; }
    tr.row-add.indent-2 td:first-child { padding-left:3.5rem; }
    code { font-size:.78rem; color:#c0392b; }
    .btn-xs { font-size:.72rem; padding:1px 7px; }
    .type-badge { font-size:.65rem; padding:1px 5px; border-radius:3px; }
    .badge-country { background:#2c5f9e; color:#fff; }
    .badge-tw-city { background:#27ae60; color:#fff; }
    .badge-state   { background:#8e44ad; color:#fff; }
    .badge-city    { background:#7f8c8d; color:#fff; }
  </style>
</head>
<body class="bg-light">
  <div id="admin-header"></div>
  <div class="container-fluid">
    <div class="row">
      <aside id="admin-sidebar" class="col-md-3 col-lg-2 bg-white border-end min-vh-100"></aside>
      <main class="col-md-9 col-lg-10 py-4">
        <h4 class="mb-1">æœå‹™åœ°å€ç®¡ç†</h4>
        <div class="alert alert-info small mb-3 py-2">
          <strong>çµæ§‹èªªæ˜ï¼š</strong><br>
          ğŸŒ <span class="type-badge badge-country">country</span> å°ç£ / æµ·å¤–åœ‹å®¶ï¼ˆç¬¬ä¸€å±¤ï¼‰<br>
          ğŸ™ <span class="type-badge badge-tw-city">tw_city</span> å°ç£ç¸£å¸‚ï¼ˆè‘‰ç¯€é»ï¼Œä¸å¯å†ç´°åˆ†ï¼‰<br>
          ğŸ—º <span class="type-badge badge-state">state</span> æµ·å¤–å·ï¼åœ°å€ï¼ˆç¬¬äºŒå±¤ï¼Œå¯æ–°å¢å­åŸå¸‚ï¼‰<br>
          ğŸ“ <span class="type-badge badge-city">city</span> æµ·å¤–åŸå¸‚ï¼ˆè‘‰ç¯€é»ï¼‰<br>
          âš  è«‹å…ˆåœ¨ Supabase SQL Editor åŸ·è¡Œ <code>docs/service-areas-v2.sql</code>
        </div>

        <div id="statusWrap" class="alert mb-3 py-2 d-none"><span id="statusMsg"></span></div>

        <!-- æ–°å¢é ‚å±¤åœ‹å®¶ -->
        <div class="card mb-3">
          <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
            <span>æ–°å¢é ‚å±¤åœ‹å®¶ï¼åœ°å€</span>
            <small class="text-muted">å°ç£ç¸£å¸‚è«‹åœ¨ã€Œå°ç£ã€åˆ—ä¸‹æ–¹æ–°å¢ï¼›æµ·å¤–åŸå¸‚è«‹åœ¨å°æ‡‰å·ä¸‹æ–¹æ–°å¢</small>
          </div>
          <div class="card-body py-2">
            <div class="row g-2 align-items-end">
              <div class="col-6 col-md-2">
                <label class="form-label small mb-0">code <span class="text-danger">*</span></label>
                <input id="newCode" class="form-control form-control-sm text-uppercase" placeholder="GB / US / JP">
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label small mb-0">ä¸­æ–‡å <span class="text-danger">*</span></label>
                <input id="newZh" class="form-control form-control-sm" placeholder="è‹±åœ‹">
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label small mb-0">è‹±æ–‡å <span class="text-danger">*</span></label>
                <input id="newEn" class="form-control form-control-sm" placeholder="UK">
              </div>
              <div class="col-4 col-md-1">
                <label class="form-label small mb-0">æ’åº</label>
                <input id="newSort" type="number" class="form-control form-control-sm" value="0">
              </div>
              <div class="col-8 col-md-2">
                <button id="btnAdd" class="btn btn-primary btn-sm w-100">
                  <i class="bi bi-plus-lg me-1"></i>æ–°å¢åœ‹å®¶
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- åœ°å€åˆ—è¡¨ -->
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-semibold">åœ°å€åˆ—è¡¨ï¼ˆä¾å±¤ç´šï¼‰</span>
            <button id="btnReload" class="btn btn-sm btn-outline-secondary">
              <i class="bi bi-arrow-clockwise"></i> é‡æ–°è¼‰å…¥
            </button>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-sm table-bordered mb-0">
                <thead class="table-light">
                  <tr>
                    <th style="width:16%">code / å±¤ç´š</th>
                    <th style="width:13%">ä¸­æ–‡å</th>
                    <th style="width:13%">è‹±æ–‡å</th>
                    <th style="width:7%">æ’åº</th>
                    <th style="width:6%">ç‹€æ…‹</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="areaBody">
                  <tr><td colspan="6" class="text-center text-muted py-4">è¼‰å…¥ä¸­â€¦</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- ç·¨è¼¯ Modal -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header py-2">
          <h6 class="modal-title mb-0" id="editModalTitle">ç·¨è¼¯åœ°å€</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editCode">
          <div class="row g-2">
            <div class="col-12">
              <label class="form-label small">codeï¼ˆå”¯è®€ï¼‰</label>
              <input id="editCodeDisp" class="form-control form-control-sm bg-light" readonly>
            </div>
            <div class="col-6">
              <label class="form-label small">ä¸­æ–‡å</label>
              <input id="editZh" class="form-control form-control-sm">
            </div>
            <div class="col-6">
              <label class="form-label small">è‹±æ–‡å</label>
              <input id="editEn" class="form-control form-control-sm">
            </div>
            <div class="col-6">
              <label class="form-label small">æ’åº</label>
              <input id="editSort" type="number" class="form-control form-control-sm" min="0">
            </div>
            <div class="col-6 d-flex align-items-end pb-1">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="editActive">
                <label class="form-check-label small" for="editActive">å•Ÿç”¨</label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer py-2">
          <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button class="btn btn-primary btn-sm" id="editSaveBtn">å„²å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/config/auth-config.js"></script>
  <script src="/admin/js/admin-common.js"></script>
  <script>
(function () {
  const API = '/api/admin/service-areas';
  let allAreas = [];

  /* â”€â”€ å·¥å…· â”€â”€ */
  async function getHeaders() {
    const s = await (window.AuthService?.getSession().catch(() => null));
    const t = s?.access_token || s?.session?.access_token;
    return t ? { Authorization: 'Bearer ' + t, 'Content-Type': 'application/json' } : {};
  }
  function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
  function showStatus(msg, type) {
    const w = document.getElementById('statusWrap'), s = document.getElementById('statusMsg');
    w.className = 'alert alert-' + (type || 'info') + ' mb-3 py-2';
    s.textContent = msg; w.classList.remove('d-none');
    if (type === 'success') setTimeout(() => w.classList.add('d-none'), 3000);
  }
  function typeBadge(t) {
    const map = { country:'badge-country', tw_city:'badge-tw-city', state:'badge-state', city:'badge-city' };
    const lbl = { country:'åœ‹å®¶', tw_city:'å°ç£ç¸£å¸‚', state:'å·/åœ°å€', city:'åŸå¸‚' };
    return `<span class="type-badge ${map[t]||''}">${esc(lbl[t]||t)}</span>`;
  }
  function activeBadge(a) { return a ? '<span class="badge bg-success">å•Ÿç”¨</span>' : '<span class="badge bg-secondary">åœç”¨</span>'; }

  /* â”€â”€ è¼‰å…¥ â”€â”€ */
  async function loadList() {
    document.getElementById('areaBody').innerHTML = '<tr><td colspan="6" class="text-center text-muted py-3">è¼‰å…¥ä¸­â€¦</td></tr>';
    const h = await getHeaders();
    try {
      const r = await fetch(API, { headers: h });
      const d = await r.json();
      if (!r.ok) throw new Error(d.error || 'è¼‰å…¥å¤±æ•—');
      allAreas = d.areas || [];
      renderTable();
    } catch (e) {
      document.getElementById('areaBody').innerHTML =
        '<tr><td colspan="6" class="text-danger p-3">' + esc(e.message) + '</td></tr>';
    }
  }

  /* â”€â”€ æ¸²æŸ“ä¸‰å±¤çµæ§‹ â”€â”€ */
  function renderTable() {
    const tbody = document.getElementById('areaBody');
    if (!allAreas.length) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-muted p-3">å°šç„¡è³‡æ–™ï¼Œè«‹å…ˆåŸ·è¡Œ docs/service-areas-v2.sql</td></tr>';
      return;
    }

    // ä¾ parent_code å»ºç«‹ children map
    const childMap = {};
    allAreas.forEach(a => {
      const p = a.parent_code || '__ROOT__';
      if (!childMap[p]) childMap[p] = [];
      childMap[p].push(a);
    });

    // æ’åºè¼”åŠ©
    function sorted(arr) { return (arr || []).sort((a, b) => (a.sort_order - b.sort_order) || a.code.localeCompare(b.code)); }

    let html = '';

    // é ‚å±¤ï¼šcountriesï¼ˆparent_code ç‚º nullï¼‰
    sorted(childMap['__ROOT__'] || []).forEach(country => {
      const isTW = country.code === 'TW';
      html += `<tr class="row-country">
        <td><code>${esc(country.code)}</code> ${typeBadge(country.area_type || 'country')}</td>
        <td>${esc(country.name_zh)}</td>
        <td>${esc(country.name_en)}</td>
        <td>${country.sort_order}</td>
        <td>${activeBadge(country.is_active)}</td>
        <td>
          <button class="btn btn-xs btn-outline-primary me-1 edit-btn" data-code="${esc(country.code)}">ç·¨è¼¯</button>
          <button class="btn btn-xs btn-outline-danger delete-btn" data-code="${esc(country.code)}">åˆªé™¤</button>
        </td></tr>`;

      if (isTW) {
        // å°ç£ â†’ ç¸£å¸‚ï¼ˆè‘‰ç¯€é»ï¼Œä¾ group_code åˆ†çµ„é¡¯ç¤ºï¼‰
        const TW_GROUPS = {
          'TW-N': 'åŒ—éƒ¨', 'TW-C': 'ä¸­éƒ¨', 'TW-S': 'å—éƒ¨',
          'TW-E': 'æ±éƒ¨', 'TW-O': 'é›¢å³¶'
        };
        const grouped = {};
        sorted(childMap['TW'] || []).forEach(c => {
          const g = c.group_code || 'OTHER';
          if (!grouped[g]) grouped[g] = [];
          grouped[g].push(c);
        });
        Object.entries(TW_GROUPS).forEach(([gk, gName]) => {
          if (!grouped[gk]) return;
          // å°æ¨™é¡Œè¡Œ
          html += `<tr><td colspan="6" class="py-0 ps-4 pe-2" style="background:#f0f5f0;font-size:.75rem;color:#666;">
            â”€ ${esc(gName)}</td></tr>`;
          grouped[gk].forEach(city => {
            html += `<tr class="row-tw-city">
              <td><code>${esc(city.code)}</code> ${typeBadge('tw_city')}</td>
              <td>${esc(city.name_zh)}</td><td>${esc(city.name_en)}</td>
              <td>${city.sort_order}</td><td>${activeBadge(city.is_active)}</td>
              <td>
                <button class="btn btn-xs btn-outline-primary me-1 edit-btn" data-code="${esc(city.code)}">ç·¨è¼¯</button>
                <button class="btn btn-xs btn-outline-danger delete-btn" data-code="${esc(city.code)}">åˆªé™¤</button>
              </td></tr>`;
          });
        });
        // æ–°å¢å°ç£ç¸£å¸‚ï¼ˆç¬¬äºŒå±¤è‘‰ç¯€é»ï¼‰
        html += addRowHtml('TW', 'TW', 'tw_city', 'indent-1', 'æ–°å¢ç¸£å¸‚');

      } else {
        // æµ·å¤–åœ‹å®¶ â†’ å·/åœ°å€ï¼ˆç¬¬äºŒå±¤ï¼‰
        sorted(childMap[country.code] || []).forEach(state => {
          html += `<tr class="row-state">
            <td><code>${esc(state.code)}</code> ${typeBadge('state')}</td>
            <td>${esc(state.name_zh)}</td><td>${esc(state.name_en)}</td>
            <td>${state.sort_order}</td><td>${activeBadge(state.is_active)}</td>
            <td>
              <button class="btn btn-xs btn-outline-primary me-1 edit-btn" data-code="${esc(state.code)}">ç·¨è¼¯</button>
              <button class="btn btn-xs btn-outline-danger delete-btn" data-code="${esc(state.code)}">åˆªé™¤</button>
            </td></tr>`;

          // å· â†’ åŸå¸‚ï¼ˆç¬¬ä¸‰å±¤è‘‰ç¯€é»ï¼‰
          sorted(childMap[state.code] || []).forEach(city => {
            html += `<tr class="row-city">
              <td><code>${esc(city.code)}</code> ${typeBadge('city')}</td>
              <td>${esc(city.name_zh)}</td><td>${esc(city.name_en)}</td>
              <td>${city.sort_order}</td><td>${activeBadge(city.is_active)}</td>
              <td>
                <button class="btn btn-xs btn-outline-primary me-1 edit-btn" data-code="${esc(city.code)}">ç·¨è¼¯</button>
                <button class="btn btn-xs btn-outline-danger delete-btn" data-code="${esc(city.code)}">åˆªé™¤</button>
              </td></tr>`;
          });
          // æ–°å¢åŸå¸‚è¡¨å–®ï¼ˆæ›åœ¨ state ä¸‹ï¼‰
          html += addRowHtml(state.code, country.group_code || 'OVERSEAS', 'city', 'indent-2', 'æ–°å¢åŸå¸‚');
        });

        // æ–°å¢å·/åœ°å€è¡¨å–®ï¼ˆæ›åœ¨ country ä¸‹ï¼‰
        html += addRowHtml(country.code, country.group_code || 'OVERSEAS', 'state', 'indent-1', 'æ–°å¢å·/åœ°å€');
      }
    });

    tbody.innerHTML = html;
    bindEvents();
  }

  /* â”€â”€ æ–°å¢å­é …è¡¨å–®åˆ— â”€â”€ */
  function addRowHtml(parentCode, groupCode, areaType, indentCls, label) {
    return `<tr class="row-add ${indentCls}">
      <td colspan="6">
        <div class="d-flex flex-wrap align-items-end gap-2 py-1"
             data-parent="${esc(parentCode)}" data-group="${esc(groupCode)}" data-type="${esc(areaType)}">
          <span class="small text-muted">â”” ${esc(label)}ï¼š</span>
          <input class="form-control form-control-sm" style="width:90px" placeholder="code" data-f="code">
          <input class="form-control form-control-sm" style="width:90px" placeholder="ä¸­æ–‡å" data-f="zh">
          <input class="form-control form-control-sm" style="width:90px" placeholder="English" data-f="en">
          <input type="number" class="form-control form-control-sm" style="width:60px" value="0" placeholder="æ’åº" data-f="sort">
          <button class="btn btn-success btn-xs sub-add-btn">æ–°å¢</button>
        </div>
      </td></tr>`;
  }

  /* â”€â”€ äº‹ä»¶ç¶å®š â”€â”€ */
  function bindEvents() {
    const tbody = document.getElementById('areaBody');

    tbody.querySelectorAll('.edit-btn').forEach(btn =>
      btn.addEventListener('click', () => openEdit(btn.dataset.code)));

    tbody.querySelectorAll('.delete-btn').forEach(btn =>
      btn.addEventListener('click', () => deleteArea(btn.dataset.code)));

    tbody.querySelectorAll('.sub-add-btn').forEach(btn => {
      btn.addEventListener('click', async function () {
        const form      = btn.closest('[data-parent]');
        const parentCode = form.dataset.parent;
        const groupCode  = form.dataset.group;
        const areaType   = form.dataset.type;
        const code = (form.querySelector('[data-f="code"]').value || '').trim().toUpperCase();
        const zh   = (form.querySelector('[data-f="zh"]').value || '').trim();
        const en   = (form.querySelector('[data-f="en"]').value || '').trim();
        const sort = parseInt(form.querySelector('[data-f="sort"]').value) || 0;
        if (!code || !zh || !en) { showStatus('è«‹å¡«å¯« codeã€ä¸­æ–‡åã€è‹±æ–‡å', 'warning'); return; }

        // group_zh / group_en å¾ç¾æœ‰è³‡æ–™å–
        const parentArea  = allAreas.find(a => a.code === parentCode) || {};
        const countryArea = allAreas.find(a => a.code === (parentArea.parent_code || parentCode)) || parentArea;
        const gZh = countryArea.group_zh || parentArea.group_zh || '';
        const gEn = countryArea.group_en || parentArea.group_en || '';

        await addArea({ code, name_zh: zh, name_en: en, group_code: groupCode,
          group_zh: gZh, group_en: gEn, sort_order: sort,
          parent_code: parentCode, area_type: areaType });
        form.querySelectorAll('input').forEach(i => { i.value = i.type === 'number' ? '0' : ''; });
      });
    });
  }

  /* â”€â”€ CRUD â”€â”€ */
  async function addArea(body) {
    const h = await getHeaders();
    try {
      const r = await fetch(API, { method: 'POST', headers: h, body: JSON.stringify(body) });
      const d = await r.json();
      if (!r.ok) throw new Error(d.error);
      showStatus('å·²æ–°å¢ ' + body.code, 'success');
      loadList();
    } catch (e) { showStatus('æ–°å¢å¤±æ•—ï¼š' + e.message, 'danger'); }
  }

  function openEdit(code) {
    const a = allAreas.find(x => x.code === code);
    if (!a) return;
    document.getElementById('editCode').value    = a.code;
    document.getElementById('editCodeDisp').value = a.code;
    document.getElementById('editModalTitle').textContent = 'ç·¨è¼¯ï¼š' + a.name_zh + ' (' + a.code + ')';
    document.getElementById('editZh').value      = a.name_zh;
    document.getElementById('editEn').value      = a.name_en;
    document.getElementById('editSort').value    = a.sort_order;
    document.getElementById('editActive').checked = a.is_active;
    new bootstrap.Modal(document.getElementById('editModal')).show();
  }

  document.getElementById('editSaveBtn').addEventListener('click', async function () {
    const code = document.getElementById('editCode').value;
    const body = {
      name_zh: document.getElementById('editZh').value.trim(),
      name_en: document.getElementById('editEn').value.trim(),
      sort_order: parseInt(document.getElementById('editSort').value) || 0,
      is_active: document.getElementById('editActive').checked
    };
    const h = await getHeaders();
    try {
      const r = await fetch(API + '/' + encodeURIComponent(code), { method: 'PUT', headers: h, body: JSON.stringify(body) });
      const d = await r.json();
      if (!r.ok) throw new Error(d.error);
      bootstrap.Modal.getInstance(document.getElementById('editModal'))?.hide();
      showStatus('å·²æ›´æ–°', 'success'); loadList();
    } catch (e) { showStatus('æ›´æ–°å¤±æ•—ï¼š' + e.message, 'danger'); }
  });

  async function deleteArea(code) {
    const hasChildren = allAreas.some(a => a.parent_code === code);
    const msg = hasChildren
      ? `ã€Œ${code}ã€ä¸‹é‚„æœ‰å­åœ°å€ï¼Œåˆªé™¤å¾Œå­åœ°å€ä¹Ÿæœƒä¸€ä½µåˆªé™¤ã€‚ç¢ºå®šï¼Ÿ`
      : `ç¢ºå®šåˆªé™¤ã€Œ${code}ã€ï¼Ÿ`;
    if (!confirm(msg)) return;
    const h = await getHeaders();
    try {
      const r = await fetch(API + '/' + encodeURIComponent(code), { method: 'DELETE', headers: h });
      const d = await r.json();
      if (!r.ok) throw new Error(d.error);
      showStatus('å·²åˆªé™¤ ' + code, 'success'); loadList();
    } catch (e) { showStatus('åˆªé™¤å¤±æ•—ï¼š' + e.message, 'danger'); }
  }

  /* â”€â”€ é ‚å±¤æ–°å¢åœ‹å®¶ â”€â”€ */
  document.getElementById('btnAdd').addEventListener('click', async function () {
    const code = (document.getElementById('newCode').value || '').trim().toUpperCase();
    const zh   = (document.getElementById('newZh').value || '').trim();
    const en   = (document.getElementById('newEn').value || '').trim();
    const sort = parseInt(document.getElementById('newSort').value) || 0;
    if (!code || !zh || !en) { showStatus('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½', 'warning'); return; }
    await addArea({ code, name_zh: zh, name_en: en,
      group_code: 'OVERSEAS', group_zh: 'æµ·å¤–', group_en: 'Overseas',
      sort_order: sort, parent_code: null, area_type: 'country' });
    ['newCode','newZh','newEn'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('newSort').value = '0';
  });

  document.getElementById('btnReload').addEventListener('click', loadList);
  ['newCode','newZh','newEn','newSort'].forEach(id => {
    document.getElementById(id).addEventListener('keydown', e => {
      if (e.key === 'Enter') document.getElementById('btnAdd').click();
    });
  });

  document.addEventListener('DOMContentLoaded', loadList);
})();
  </script>
</body>
</html>
