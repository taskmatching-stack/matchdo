<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <title>聯絡資訊設定 - MatchDO 合做</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link href="../img/favicon.ico" rel="icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&family=Space+Grotesk&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/config/auth-config.js"></script>
    <script src="/js/auth-middleware.js"></script>
</head>
<body>
    <div id="site-header"></div>

    <div class="container-fluid page-title-bar">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="mb-0 text-dark">聯絡資訊設定</h3>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="/index.html">首頁</a></li>
                        <li class="breadcrumb-item active">聯絡資訊</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <div class="container-xxl py-3">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <!-- 說明區塊 -->
                    <div class="alert alert-info mb-3">
                        <h5><i class="fas fa-info-circle me-2"></i>聯絡資訊說明</h5>
                        <ul class="mb-0">
                            <li>勾選「公開顯示」的欄位，會在您的廠商頁面上對所有訪客顯示</li>
                            <li>官網、Email 及社群帳號建議公開，有助於客戶直接聯繫</li>
                            <li>您可以隨時調整哪些資訊要公開、哪些要隱藏</li>
                        </ul>
                    </div>

                    <!-- 聯絡資訊表單 -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-address-card me-2"></i>我的聯絡資訊</h5>
                        </div>
                        <div class="card-body p-4">
                            <form id="contactInfoForm">
                                <!-- 基本資訊 -->
                                <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-building me-2"></i>基本資訊</h6>
                                <div class="row g-3 mb-4">
                                    <div class="col-md-6">
                                        <label class="form-label">公司/工作室名稱</label>
                                        <input type="text" class="form-control" id="companyName" placeholder="選填">
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">服務地區 <small class="text-muted">（可複選）</small></label>
                                        <div id="serviceAreaSelector" class="border rounded p-2" style="background:#fafafa;">
                                            <!-- 由 JS 渲染分組標籤 -->
                                        </div>
                                        <input type="hidden" id="selectedServiceAreas" value="">
                                        <div class="mt-1 small text-muted" id="selectedAreaPreview"></div>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">自我介紹</label>
                                        <textarea class="form-control" id="bio" rows="3" placeholder="簡單介紹您的服務特色或專長..."></textarea>
                                    </div>
                                </div>

                                <!-- 電話資訊 -->
                                <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-phone me-2"></i>電話資訊</h6>
                                <div class="row g-3 mb-4">
                                    <div class="col-md-6">
                                        <label class="form-label">市話</label>
                                        <input type="tel" class="form-control" id="phone" placeholder="例：02-12345678">
                                        <div class="form-check mt-2">
                                            <input class="form-check-input" type="checkbox" id="phoneVisible">
                                            <label class="form-check-label" for="phoneVisible">
                                                <small>✅ 公開顯示（建議）</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">手機</label>
                                        <input type="tel" class="form-control" id="mobile" placeholder="例：0912-345678">
                                        <div class="form-check mt-2">
                                            <input class="form-check-input" type="checkbox" id="mobileVisible">
                                            <label class="form-check-label" for="mobileVisible">
                                                <small>✅ 公開顯示（建議）</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- 即時通訊 -->
                                <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-comments me-2"></i>即時通訊</h6>
                                <div class="row g-3 mb-4">
                                    <div class="col-md-4">
                                        <label class="form-label">LINE ID</label>
                                        <input type="text" class="form-control" id="lineId" placeholder="您的 LINE ID">
                                        <div class="form-check mt-2">
                                            <input class="form-check-input" type="checkbox" id="lineVisible">
                                            <label class="form-check-label" for="lineVisible">
                                                <small>✅ 公開顯示（建議）</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">WeChat ID</label>
                                        <input type="text" class="form-control" id="wechatId" placeholder="選填">
                                        <div class="form-check mt-2">
                                            <input class="form-check-input" type="checkbox" id="wechatVisible">
                                            <label class="form-check-label" for="wechatVisible">
                                                <small>✅ 公開顯示（建議）</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Telegram</label>
                                        <input type="text" class="form-control" id="telegramId" placeholder="選填">
                                        <div class="form-check mt-2">
                                            <input class="form-check-input" type="checkbox" id="telegramVisible">
                                            <label class="form-check-label" for="telegramVisible">
                                                <small>✅ 公開顯示（建議）</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Email -->
                                <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-envelope me-2"></i>Email</h6>
                                <div class="row g-3 mb-4">
                                    <div class="col-md-6">
                                        <label class="form-label">聯絡 Email</label>
                                        <input type="email" class="form-control" id="email" placeholder="例：contact@example.com">
                                        <div class="form-check mt-2">
                                            <input class="form-check-input" type="checkbox" id="emailVisible">
                                            <label class="form-check-label" for="emailVisible">
                                                <small>✅ 公開顯示（建議）</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- 社群網站 -->
                                <h6 class="border-bottom pb-2 mb-3"><i class="fab fa-facebook me-2"></i>社群網站</h6>
                                <div class="row g-3 mb-4">
                                    <div class="col-md-6">
                                        <label class="form-label"><i class="fab fa-facebook text-primary me-1"></i>Facebook</label>
                                        <input type="url" class="form-control" id="facebookUrl" placeholder="https://facebook.com/...">
                                        <div class="form-check mt-2">
                                            <input class="form-check-input" type="checkbox" id="facebookVisible">
                                            <label class="form-check-label" for="facebookVisible">
                                                <small>✅ 公開顯示（建議）</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label"><i class="fab fa-instagram text-danger me-1"></i>Instagram</label>
                                        <input type="url" class="form-control" id="instagramUrl" placeholder="https://instagram.com/...">
                                        <div class="form-check mt-2">
                                            <input class="form-check-input" type="checkbox" id="instagramVisible">
                                            <label class="form-check-label" for="instagramVisible">
                                                <small>✅ 公開顯示（建議）</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label"><i class="fab fa-youtube text-danger me-1"></i>YouTube</label>
                                        <input type="url" class="form-control" id="youtubeUrl" placeholder="https://youtube.com/...">
                                        <div class="form-check mt-2">
                                            <input class="form-check-input" type="checkbox" id="youtubeVisible">
                                            <label class="form-check-label" for="youtubeVisible">
                                                <small>✅ 公開顯示（建議）</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label"><i class="fab fa-linkedin text-info me-1"></i>LinkedIn</label>
                                        <input type="url" class="form-control" id="linkedinUrl" placeholder="https://linkedin.com/in/...">
                                        <div class="form-check mt-2">
                                            <input class="form-check-input" type="checkbox" id="linkedinVisible">
                                            <label class="form-check-label" for="linkedinVisible">
                                                <small>✅ 公開顯示（建議）</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- 專業連結 -->
                                <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-globe me-2"></i>專業連結（建議公開）</h6>
                                <div class="row g-3 mb-4">
                                    <div class="col-md-6">
                                        <label class="form-label">官方網站</label>
                                        <input type="url" class="form-control" id="websiteUrl" placeholder="https://...">
                                        <div class="form-check mt-2">
                                            <input class="form-check-input" type="checkbox" id="websiteVisible" checked>
                                            <label class="form-check-label" for="websiteVisible">
                                                <small>✅ 公開顯示（建議）</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">作品集</label>
                                        <input type="url" class="form-control" id="portfolioUrl" placeholder="https://...">
                                        <div class="form-check mt-2">
                                            <input class="form-check-input" type="checkbox" id="portfolioVisible" checked>
                                            <label class="form-check-label" for="portfolioVisible">
                                                <small>✅ 公開顯示（建議）</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- 偏好聯絡方式 -->
                                <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-star me-2"></i>偏好聯絡方式（可複選）</h6>
                                <div class="row g-2 mb-4">
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="phone" id="prefer_phone">
                                            <label class="form-check-label" for="prefer_phone">電話</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="line" id="prefer_line">
                                            <label class="form-check-label" for="prefer_line">LINE</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="email" id="prefer_email">
                                            <label class="form-check-label" for="prefer_email">Email</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="facebook" id="prefer_facebook">
                                            <label class="form-check-label" for="prefer_facebook">Facebook</label>
                                        </div>
                                    </div>
                                </div>

                                <!-- 營業時間 -->
                                <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-clock me-2"></i>營業時間</h6>
                                <div class="row g-3 mb-4">
                                    <div class="col-md-6">
                                        <label class="form-label">平日</label>
                                        <input type="text" class="form-control" id="weekdaysHours" placeholder="例：09:00-18:00">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">假日</label>
                                        <input type="text" class="form-control" id="weekendHours" placeholder="例：10:00-17:00 或 休息">
                                    </div>
                                </div>

                                <!-- 儲存按鈕 -->
                                <div class="text-center">
                                    <button type="submit" class="btn btn-primary btn-lg px-5">
                                        <i class="fas fa-save me-2"></i>儲存設定
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid bg-dark text-body footer mt-5 pt-5">
        <div class="container py-5">
            <div class="row g-5">
                <div class="col-lg-12 text-center">
                    <p class="mb-0">&copy; <a class="text-primary" href="#">MatchDO 合做</a>. All Rights Reserved.</p>
                </div>
            </div>
        </div>
    </div>

    <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="bi bi-arrow-up"></i></a>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/main.js"></script>
    <script src="/js/area-codes.js"></script>
    <script src="/js/i18n.js"></script>
    <script src="../js/site-header.js"></script>

    <style>
        /* 基本地區標籤 */
        .area-tag-btn { display:inline-flex; align-items:center; padding:0.2rem 0.55rem; font-size:0.8rem; border-radius:5px; border:1px solid #8a96a6; color:#5c6470; background:#fff; cursor:pointer; transition:all .12s; margin:1px; user-select:none; }
        .area-tag-btn:hover { border-color:#445D7E; color:#445D7E; background:#f0f4f8; }
        .area-tag-btn.active { border-color:#445D7E; background:#445D7E; color:#fff; }
        .area-tag-btn.area-group-open { background:#f0f4f8; border-color:#445D7E; color:#445D7E; }
        .area-tag-btn.city-tag { font-size:0.76rem; padding:0.18rem 0.45rem; }
        .area-tag-btn.subcity-tag { font-size:0.72rem; padding:0.15rem 0.4rem; }
        /* 可展開的分裂標籤（左=選取，右=展開） */
        .area-split-tag { display:inline-flex; align-items:stretch; border-radius:5px; border:1px solid #7a9ac5; color:#445D7E; background:#fff; font-size:0.78rem; margin:1px; overflow:hidden; cursor:default; transition:border-color .12s; }
        .area-split-tag.active { border-color:#445D7E; }
        .area-split-tag.active .split-label { background:#445D7E; color:#fff; }
        .area-split-tag .split-label { padding:0.2rem 0.45rem; cursor:pointer; transition:background .12s, color .12s; }
        .area-split-tag .split-label:hover { background:#e8f0f8; }
        .area-split-tag.active .split-label:hover { background:#3a5169; }
        .area-split-tag .split-expand { padding:0.2rem 0.35rem; border-left:1px solid #b0c0d8; cursor:pointer; font-size:0.65rem; display:flex; align-items:center; color:#7a9ac5; transition:background .12s; }
        .area-split-tag .split-expand:hover { background:#e8f0f8; color:#445D7E; }
        .area-split-tag.open .split-expand { background:#e8f0f8; color:#445D7E; }
        /* 面板 */
        .area-cities-panel { border-left:2px solid #445D7E; padding:0.3rem 0.5rem; background:#f8fafc; border-radius:0 4px 4px 0; margin-left:0.25rem; margin-bottom:0.25rem; }
        .area-subcities-panel { border-left:2px dashed #7a9ac5; padding:0.2rem 0.4rem; background:#f0f5ff; border-radius:0 4px 4px 0; margin-left:0.5rem; margin-top:0.25rem; }
    </style>
    <script>
        // ── 服務地區選取（v2：台灣+國家同級第一層）──
        var selectedAreas = [];      // 存 code
        var _expandedCountry = {};   // 國家/台灣 展開狀態
        var _expandedState = {};     // 海外州/地區 展開狀態

        var TW_GROUP_NAMES = { 'TW-N':'北部','TW-C':'中部','TW-S':'南部','TW-E':'東部','TW-O':'離島' };
        var TW_GROUP_ORDER = ['TW-N','TW-C','TW-S','TW-E','TW-O'];

        function countSelected(node) {
            var n = selectedAreas.indexOf(node.code) >= 0 ? 1 : 0;
            (node.children || []).forEach(function(c) { n += countSelected(c); });
            return n;
        }

        function renderAreaSelector() {
            var container = document.getElementById('serviceAreaSelector');
            if (!container) return;
            var ac = window.AreaCodes;
            var countries = (ac && ac.countries) || [];
            var html = '';

            // 第一層：台灣 + 海外國家同級
            html += '<div class="d-flex flex-wrap gap-1 mb-2">';
            countries.forEach(function(c) {
                var selN = countSelected(c);
                var isOpen = !!_expandedCountry[c.code];
                var activeCls = selN > 0 ? ' active' : '';
                var openCls   = isOpen ? ' area-group-open' : '';
                var lbl = c.zh + (selN > 0 ? ' <sup style="font-size:.65em;">+'+selN+'</sup>' : '');
                html += '<span class="area-tag-btn' + activeCls + openCls + '" data-country="' + c.code + '">'
                      + lbl + ' <small style="font-size:.7em;">' + (isOpen?'▲':'▼') + '</small></span>';
            });
            html += '</div>';

            // 第二層：展開的國家/台灣
            countries.forEach(function(country) {
                if (!_expandedCountry[country.code]) return;

                if (country.code === 'TW') {
                    // 台灣：縣市按大區分組顯示（葉節點，直接選取）
                    html += '<div class="area-cities-panel mb-2">';
                    var grouped = {};
                    (country.children || []).forEach(function(city) {
                        var gk = city.group_code || 'TW-N';
                        if (!grouped[gk]) grouped[gk] = [];
                        grouped[gk].push(city);
                    });
                    TW_GROUP_ORDER.forEach(function(gk) {
                        if (!grouped[gk]) return;
                        html += '<div class="mb-1"><small class="text-muted me-1">' + (TW_GROUP_NAMES[gk]||gk) + '：</small>';
                        grouped[gk].forEach(function(city) {
                            var isAct = selectedAreas.indexOf(city.code) >= 0;
                            html += '<span class="area-tag-btn city-tag' + (isAct?' active':'') + '" data-area="' + city.code + '">' + city.zh + '</span>';
                        });
                        html += '</div>';
                    });
                    html += '</div>';
                } else {
                    // 海外國家：有子州→分裂標籤；無子州→直接選取
                    html += '<div class="area-cities-panel mb-2">';
                    var states = country.children || [];
                    if (!states.length) {
                        // 無子地區：只顯示整個國家選取鈕
                        var isAct = selectedAreas.indexOf(country.code) >= 0;
                        html += '<span class="area-tag-btn city-tag' + (isAct?' active':'') + '" data-area="' + country.code + '">'
                              + country.zh + '（整個國家）</span>';
                    } else {
                        // 有子州：分裂標籤
                        states.forEach(function(state) {
                            var hasCities = state.children && state.children.length > 0;
                            var isStateAct = selectedAreas.indexOf(state.code) >= 0;
                            var isOpen = !!_expandedState[state.code];
                            var subSel = 0;
                            (state.children||[]).forEach(function(ct){ if(selectedAreas.indexOf(ct.code)>=0) subSel++; });
                            var activeCls = (isStateAct || subSel > 0) ? ' active' : '';
                            var cnt = subSel > 0 ? ' <sup style="font-size:.65em;">+'+subSel+'</sup>' : '';

                            if (hasCities) {
                                html += '<span class="area-split-tag' + activeCls + (isOpen?' open':'') + '">'
                                      + '<span class="split-label" data-area="' + state.code + '">' + state.zh + cnt + '</span>'
                                      + '<span class="split-expand" data-state="' + state.code + '">' + (isOpen?'▲':'▼') + '</span>'
                                      + '</span>';
                                // 第三層：城市
                                if (isOpen) {
                                    html += '<div class="area-subcities-panel ms-1 mb-1"><small class="text-muted me-1">' + state.zh + '：</small>';
                                    (state.children||[]).forEach(function(ct) {
                                        var isCtAct = selectedAreas.indexOf(ct.code) >= 0;
                                        html += '<span class="area-tag-btn subcity-tag' + (isCtAct?' active':'') + '" data-area="' + ct.code + '">' + ct.zh + '</span>';
                                    });
                                    html += '</div>';
                                }
                            } else {
                                html += '<span class="area-tag-btn city-tag' + (isStateAct?' active':'') + '" data-area="' + state.code + '">' + state.zh + '</span>';
                            }
                        });
                    }
                    html += '</div>';
                }
            });

            container.innerHTML = html;

            // 第一層：國家/台灣展開
            container.querySelectorAll('[data-country]').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    _expandedCountry[btn.getAttribute('data-country')] ^= 1;
                    renderAreaSelector();
                });
            });
            // 州展開箭頭
            container.querySelectorAll('.split-expand[data-state]').forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    _expandedState[btn.getAttribute('data-state')] ^= 1;
                    renderAreaSelector();
                });
            });
            // 選取（任意層級）
            container.querySelectorAll('[data-area]').forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    var code = btn.getAttribute('data-area');
                    var idx = selectedAreas.indexOf(code);
                    if (idx >= 0) selectedAreas.splice(idx, 1);
                    else selectedAreas.push(code);
                    syncAreaInput();
                    renderAreaSelector();
                });
            });

            syncAreaInput();
        }

        function syncAreaInput() {
            var hidden = document.getElementById('selectedServiceAreas');
            var preview = document.getElementById('selectedAreaPreview');
            if (hidden) hidden.value = selectedAreas.join(',');
            var ac = window.AreaCodes;
            var labels = selectedAreas.map(function(c){ return ac ? ac.getLabel(c,'zh') : c; });
            if (preview) preview.textContent = labels.length > 0 ? '已選：' + labels.join('、') : '（尚未選擇）';
        }

        function loadAreas(areaStr) {
            selectedAreas = [];
            _expandedCountry = {};
            _expandedState = {};
            if (areaStr) {
                areaStr.split(/[,，、\s]+/).forEach(function(a) {
                    a = a.trim(); if (!a) return;
                    var code = window.AreaCodes ? window.AreaCodes.zhToCode(a) : a;
                    selectedAreas.push(code);
                    // 自動展開已選地區所屬層級
                    var countries = (window.AreaCodes && window.AreaCodes.countries) || [];
                    countries.forEach(function(country) {
                        if (country.code === code) { _expandedCountry[country.code] = true; return; }
                        (country.children || []).forEach(function(state) {
                            if (state.code === code || (state.children||[]).some(function(ct){ return ct.code===code; })) {
                                _expandedCountry[country.code] = true;
                                if (state.code !== code) _expandedState[state.code] = true;
                            }
                        });
                    });
                });
            }
            renderAreaSelector();
        }

        let currentUser = null;

        $(document).ready(async function () {
            const { data: { user } } = await AuthService.getUser();
            if (!user) {
                window.location.href = (AuthService.getLoginUrl && AuthService.getLoginUrl()) || '/login.html';
                return;
            }
            currentUser = user;
            renderAreaSelector();
            // API 資料更新後重繪（area-codes.js 非同步載入 DB 地區資料）
            document.addEventListener('areacodes:updated', renderAreaSelector);
            await loadContactInfo();

            $('#contactInfoForm').submit(async function (e) {
                e.preventDefault();
                await saveContactInfo();
            });
        });

        async function loadContactInfo() {
            try {
                const { data, error } = await AuthService.supabase
                    .from('contact_info')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                if (data) {
                    // 填充表單
                    $('#companyName').val(data.company_name || '');
                    loadAreas(data.company_address || '');
                    $('#bio').val(currentUser.user_metadata?.bio || '');
                    $('#phone').val(data.phone || '');
                    $('#phoneVisible').prop('checked', data.phone_visible || false);
                    $('#mobile').val(data.mobile || '');
                    $('#mobileVisible').prop('checked', data.mobile_visible || false);
                    $('#lineId').val(data.line_id || '');
                    $('#lineVisible').prop('checked', data.line_visible || false);
                    $('#wechatId').val(data.wechat_id || '');
                    $('#wechatVisible').prop('checked', data.wechat_visible || false);
                    $('#telegramId').val(data.telegram_id || '');
                    $('#telegramVisible').prop('checked', data.telegram_visible || false);
                    $('#email').val(data.email || '');
                    $('#emailVisible').prop('checked', data.email_visible || false);
                    $('#facebookUrl').val(data.facebook_url || '');
                    $('#facebookVisible').prop('checked', data.facebook_visible || false);
                    $('#instagramUrl').val(data.instagram_url || '');
                    $('#instagramVisible').prop('checked', data.instagram_visible || false);
                    $('#youtubeUrl').val(data.youtube_url || '');
                    $('#youtubeVisible').prop('checked', data.youtube_visible || false);
                    $('#linkedinUrl').val(data.linkedin_url || '');
                    $('#linkedinVisible').prop('checked', data.linkedin_visible || false);
                    $('#websiteUrl').val(data.website_url || '');
                    $('#websiteVisible').prop('checked', data.website_visible !== false);
                    $('#portfolioUrl').val(data.portfolio_url || '');
                    $('#portfolioVisible').prop('checked', data.portfolio_visible !== false);

                    // 偏好聯絡方式
                    if (data.preferred_contact_methods) {
                        data.preferred_contact_methods.forEach(method => {
                            $(`#prefer_${method}`).prop('checked', true);
                        });
                    }

                    // 營業時間
                    if (data.business_hours) {
                        $('#weekdaysHours').val(data.business_hours.weekdays || '');
                        $('#weekendHours').val(data.business_hours.weekend || '');
                    }
                }
            } catch (error) {
                console.error('載入聯絡資訊失敗:', error);
            }
        }

        async function saveContactInfo() {
            const btn = $('#contactInfoForm button[type="submit"]');
            btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>儲存中...');

            try {
                // 收集偏好聯絡方式
                const preferredMethods = [];
                $('input[id^="prefer_"]:checked').each(function() {
                    preferredMethods.push($(this).val());
                });

                const contactData = {
                    user_id: currentUser.id,
                    company_name: $('#companyName').val(),
                    company_address: selectedAreas.join(','),
                    phone: $('#phone').val(),
                    phone_visible: $('#phoneVisible').is(':checked'),
                    mobile: $('#mobile').val(),
                    mobile_visible: $('#mobileVisible').is(':checked'),
                    line_id: $('#lineId').val(),
                    line_visible: $('#lineVisible').is(':checked'),
                    wechat_id: $('#wechatId').val(),
                    wechat_visible: $('#wechatVisible').is(':checked'),
                    telegram_id: $('#telegramId').val(),
                    telegram_visible: $('#telegramVisible').is(':checked'),
                    email: $('#email').val(),
                    email_visible: $('#emailVisible').is(':checked'),
                    facebook_url: $('#facebookUrl').val(),
                    facebook_visible: $('#facebookVisible').is(':checked'),
                    instagram_url: $('#instagramUrl').val(),
                    instagram_visible: $('#instagramVisible').is(':checked'),
                    youtube_url: $('#youtubeUrl').val(),
                    youtube_visible: $('#youtubeVisible').is(':checked'),
                    linkedin_url: $('#linkedinUrl').val(),
                    linkedin_visible: $('#linkedinVisible').is(':checked'),
                    website_url: $('#websiteUrl').val(),
                    website_visible: $('#websiteVisible').is(':checked'),
                    portfolio_url: $('#portfolioUrl').val(),
                    portfolio_visible: $('#portfolioVisible').is(':checked'),
                    preferred_contact_methods: preferredMethods,
                    business_hours: {
                        weekdays: $('#weekdaysHours').val(),
                        weekend: $('#weekendHours').val()
                    }
                };

                const { error } = await AuthService.supabase
                    .from('contact_info')
                    .upsert(contactData);

                if (error) throw error;

                alert('✅ 聯絡資訊已儲存！');
            } catch (error) {
                console.error('儲存失敗:', error);
                alert('❌ 儲存失敗：' + error.message);
            } finally {
                btn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>儲存設定');
            }
        }
    </script>
</body>
</html>
