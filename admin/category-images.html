<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="utf-8">
    <title>分類圖片管理 - MatchDO 管理後台</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <!-- Favicon -->
    <link href="/img/favicon.ico" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&family=Space+Grotesk&display=swap" rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="/css/style.css" rel="stylesheet">

    <!-- Supabase Auth -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/config/auth-config.js"></script>
    <script src="/js/auth-middleware.js"></script>
    <script src="/js/site-header.js"></script>

    <!-- Category Default Images -->
    <script src="/config/category-default-images.js"></script>
</head>

<body>
    <!-- 共用導覽 -->
    <div id="site-header"></div>

    <!-- Page Header Start -->
    <div class="container-fluid page-title-bar">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="mb-0 text-dark">
                    <i class="fas fa-images me-2"></i>分類預設圖片管理
                </h3>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="/index.html">首頁</a></li>
                        <li class="breadcrumb-item"><a href="/admin/index.html">管理後台</a></li>
                        <li class="breadcrumb-item active">分類圖片管理</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
    <!-- Page Header End -->

    <!-- Main Content Start -->
    <div class="container-xxl py-3">
        <div class="container">
            <!-- 說明區塊 -->
            <div class="alert alert-info mb-4">
                <h5 class="alert-heading">
                    <i class="fas fa-info-circle me-2"></i>分類預設圖片說明
                </h5>
                <p class="mb-2">為每個專案分類設置預設封面圖片，當使用者建立專案時會自動使用對應的預設圖。</p>
                <ul class="mb-0">
                    <li>建議尺寸：<strong>1200 x 800 px</strong>（3:2 比例）</li>
                    <li>檔案格式：JPG、PNG 或 WebP</li>
                    <li>檔案大小：< 500KB</li>
                    <li>風格：專業、清晰、符合分類主題</li>
                </ul>
            </div>

            <!-- 統計資訊 -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <h3 class="text-primary mb-2" id="totalCategories">0</h3>
                            <p class="text-muted mb-0">總分類數</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <h3 class="text-success mb-2" id="uploadedImages">0</h3>
                            <p class="text-muted mb-0">已上傳圖片</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <h3 class="text-warning mb-2" id="defaultImages">0</h3>
                            <p class="text-muted mb-0">使用預設圖</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <button class="btn btn-primary w-100" onclick="uploadBulkImages()">
                                <i class="fas fa-cloud-upload-alt me-2"></i>批量上傳
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 分類列表 -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="mb-0">分類圖片列表</h5>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" id="searchInput" 
                                       placeholder="搜尋分類名稱..." 
                                       onkeyup="filterCategories()">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- 載入中 -->
                    <div id="loadingSection" class="text-center py-5">
                        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
                        <p class="mt-3 text-muted">載入分類資料中...</p>
                    </div>

                    <!-- 分類網格 -->
                    <div id="categoriesGrid" class="row g-3 p-4 d-none">
                        <!-- 動態生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Main Content End -->

    <!-- 上傳圖片 Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-upload me-2"></i>上傳分類圖片
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">分類名稱</label>
                        <input type="text" class="form-control" id="modalCategoryName" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">目前圖片</label>
                        <div class="border rounded p-3 text-center">
                            <img id="modalCurrentImage" src="" class="img-fluid" 
                                 style="max-height: 300px; object-fit: contain;" alt="目前圖片">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">選擇新圖片</label>
                        <input type="file" class="form-control" id="modalFileInput" 
                               accept="image/*" onchange="previewImage(this)">
                        <small class="text-muted">建議尺寸：1200 x 800 px，檔案大小 < 500KB</small>
                    </div>
                    <div class="mb-3 d-none" id="previewSection">
                        <label class="form-label">預覽新圖片</label>
                        <div class="border rounded p-3 text-center">
                            <img id="modalPreviewImage" src="" class="img-fluid" 
                                 style="max-height: 300px; object-fit: contain;" alt="預覽">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="confirmUpload()">
                        <i class="fas fa-check me-2"></i>確認上傳
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Category Default Images -->
    <script src="/config/category-default-images.js"></script>

    <!-- Main Script -->
    <script>
        let currentUser = null;
        let currentCategory = null;
        let uploadModal = null;
        let allCategories = [];

        // 初始化
        document.addEventListener('DOMContentLoaded', async () => {
            // Phase 1.7：後台需登入且 role=admin
            const ok = await AuthMiddleware.requireAdmin();
            if (!ok) return;
            currentUser = await AuthService.getCurrentUser();

            // 初始化 Modal
            uploadModal = new bootstrap.Modal(document.getElementById('uploadModal'));

            // 載入分類資料
            await loadCategories();
        });

        // 載入所有分類 (結構化版本)
        async function loadCategories() {
            try {
                // 1. 從 API 取得結構化分類資料
                const res = await fetch('/api/categories', { cache: 'no-store' });
                const data = await res.json();
                const mainCategories = data.categories || [];
                
                const grid = document.getElementById('categoriesGrid');
                grid.innerHTML = ''; // 清空
                
                let totalSubCount = 0;
                let uploadedCount = 0;

                // 2. 遍歷主分類
                mainCategories.forEach(mainCat => {
                    const subs = mainCat.sub || [];
                    if (subs.length === 0) return;

                    // 建立主分類區塊標題
                    const sectionHeader = document.createElement('div');
                    sectionHeader.className = 'col-12 mt-4 mb-3';
                    sectionHeader.innerHTML = `
                        <div class="d-flex align-items-center">
                            <h4 class="mb-0 text-primary"><i class="fas fa-folder-open me-2"></i>${mainCat.name}</h4>
                            <hr class="flex-grow-1 ms-3">
                            <span class="badge bg-secondary ms-2">${subs.length} 個子分類</span>
                        </div>
                    `;
                    grid.appendChild(sectionHeader);

                    // 3. 建立子分類卡片
                    subs.forEach(subName => {
                        totalSubCount++;
                        const imageUrl = CategoryDefaultImages[subName] || '/img/categories/default-project.svg';
                        const isUploaded = !imageUrl.includes('default-project');
                        if (isUploaded) uploadedCount++;

                        const col = document.createElement('div');
                        col.className = 'col-md-4 col-lg-3 mb-4 category-card';
                        col.dataset.category = subName.toLowerCase();
                        col.innerHTML = `
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="position-relative">
                                    <img src="${imageUrl}" class="card-img-top" 
                                         alt="${subName}" 
                                         style="height: 180px; object-fit: cover;"
                                         onerror="this.src='/img/categories/default-project.svg'">
                                    <span class="position-absolute top-0 end-0 m-2 badge ${isUploaded ? 'bg-success' : 'bg-warning'}">
                                        ${isUploaded ? '已上傳' : '預設圖'}
                                    </span>
                                </div>
                                <div class="card-body p-3">
                                    <h6 class="card-title mb-2 text-truncate" title="${subName}">${subName}</h6>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-sm btn-primary" onclick="openUploadModal('${subName}')">
                                            <i class="fas fa-upload me-1"></i>更換圖片
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        grid.appendChild(col);
                    });
                });

                // 更新統計
                document.getElementById('totalCategories').textContent = totalSubCount;
                document.getElementById('uploadedImages').textContent = uploadedCount;
                document.getElementById('defaultImages').textContent = totalSubCount - uploadedCount;

                // 隱藏載入中
                document.getElementById('loadingSection').classList.add('d-none');
                document.getElementById('categoriesGrid').classList.remove('d-none');

            } catch (error) {
                console.error('載入分類失敗:', error);
                alert('載入失敗：' + error.message);
            }
        }

        // 搜尋過濾
        function filterCategories() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const cards = document.querySelectorAll('.category-card');

            cards.forEach(card => {
                const categoryName = card.dataset.category.toLowerCase();
                if (categoryName.includes(searchTerm)) {
                    card.classList.remove('d-none');
                } else {
                    card.classList.add('d-none');
                }
            });
        }

        // 開啟上傳 Modal
        function openUploadModal(categoryName) {
            currentCategory = categoryName;
            const category = allCategories.find(c => c.name === categoryName);

            document.getElementById('modalCategoryName').value = categoryName;
            document.getElementById('modalCurrentImage').src = category.imageUrl;
            document.getElementById('modalFileInput').value = '';
            document.getElementById('previewSection').classList.add('d-none');

            uploadModal.show();
        }

        // 預覽圖片
        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    document.getElementById('modalPreviewImage').src = e.target.result;
                    document.getElementById('previewSection').classList.remove('d-none');
                };
                
                reader.readAsDataURL(input.files[0]);
            }
        }

        // 確認上傳
        async function confirmUpload() {
            const fileInput = document.getElementById('modalFileInput');
            const file = fileInput.files[0];

            if (!file) {
                alert('請選擇圖片檔案');
                return;
            }

            // 檢查檔案大小
            if (file.size > 500 * 1024) {
                alert('檔案大小不可超過 500KB');
                return;
            }

            try {
                // 顯示載入中
                const btn = event.target;
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>上傳中...';

                // 上傳到 Supabase Storage
                const fileName = `categories/${currentCategory.replace(/\s+/g, '-').toLowerCase()}-${Date.now()}.${file.name.split('.').pop()}`;
                const { data, error } = await AuthService.supabase.storage
                    .from('project-images')
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: true
                    });

                if (error) throw error;

                // 取得公開 URL
                const { data: { publicUrl } } = AuthService.supabase.storage
                    .from('project-images')
                    .getPublicUrl(fileName);

                // 更新設定檔（需要後端 API）
                await updateCategoryImage(currentCategory, publicUrl);

                alert('✅ 圖片已更新！請重新整理頁面查看。');
                uploadModal.hide();
                
                // 重新載入
                location.reload();

            } catch (error) {
                console.error('上傳失敗:', error);
                alert('❌ 上傳失敗：' + error.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check me-2"></i>確認上傳';
            }
        }

        // 更新分類圖片（需要後端 API）
        async function updateCategoryImage(categoryName, imageUrl) {
            // 暫時更新本地記憶體
            CategoryDefaultImages[categoryName] = imageUrl;
            
            // TODO: 呼叫後端 API 永久儲存
            // await fetch('/api/admin/category-images', {
            //     method: 'POST',
            //     body: JSON.stringify({ category: categoryName, imageUrl })
            // });
        }

        // 刪除圖片
        async function deleteImage(categoryName) {
            if (!confirm(`確定要刪除「${categoryName}」的圖片嗎？將恢復為預設圖。`)) {
                return;
            }

            try {
                // TODO: 實作刪除邏輯
                alert('刪除功能開發中');
            } catch (error) {
                console.error('刪除失敗:', error);
                alert('❌ 刪除失敗：' + error.message);
            }
        }

        // 批量上傳
        function uploadBulkImages() {
            alert('批量上傳功能開發中\n\n您可以：\n1. 將圖片命名為分類名稱\n2. 一次選擇多個檔案\n3. 自動匹配對應分類');
        }
    </script>
</body>

</html>
