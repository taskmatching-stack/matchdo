# MatchDO「合做」落地 TODO 清單（分階段）

更新日期：2026-02-05

---

## 🎉 今日完成（2026-02-05 晚間）

### 核心功能完成
- [x] **用戶管理後台**（user-management.html）
  - 用戶列表展示（頭像、Email、角色、註冊時間）
  - 角色管理（管理員/一般用戶切換）
  - 統計儀表板（總用戶、已驗證、管理員、本月新用戶）
  - 權限控制（只有管理員可訪問）
- [x] **權限系統整合**
  - site-header.js 根據角色動態顯示選單
  - 管理功能（用戶管理、分類管理）只對管理員顯示
  - profiles 表結構建立與用戶同步
  - 角色檢查機制（user_metadata + profiles 雙重來源）
- [x] **UI/UX 優化**
  - 消除所有頁面的過度留白（py-5 → py-2）
  - 修復無限載入 spinner 問題（專家控制台、媒合專案、用戶管理）
  - 頁面頭部改為緊湊橫向布局（標題左、麵包屑右）
  - 所有空狀態都顯示友善提示而非無限轉圈
- [x] **AuthService 增強**
  - 新增 getUser() 相容方法
  - 新增 supabase 屬性暴露
  - 改進 getUserProfile() 支援多表查詢
  - 完整錯誤處理與回退機制
- [x] **資料庫架構**
  - user-roles-schema.sql（profiles 表 + RLS policies）
  - sync-profiles.sql（同步 auth.users 到 profiles）
  - 自動觸發器（新用戶自動建立 profile）
  - 完整的權限控制策略

### 技術問題解決
- [x] 修復 AuthService 載入檢查問題
- [x] 修復 Supabase 查詢語法錯誤（count: 'exact'）
- [x] 修復 profiles 表不存在時的友善提示
- [x] 修復用戶管理頁面語法錯誤（HTML 結構損壞）
- [x] 建立測試頁面診斷工具（test-profiles.html）

---

## 🎯 本機開發路線圖（上雲端前完成）

> **策略**：在本機完成所有核心功能與測試，確保平台可正常運作後再部署到雲端
> 
> **測試策略**：自動生成測試數據（帳號、專案、報價），模擬完整媒合流程

---

### 📅 階段一：資料庫基礎（今天，預計 2-3 小時）

**目標**：執行所有資料表 Schema，讓系統有完整的資料結構

**⚠️ 重要：必須按照正確順序執行，避免依賴錯誤！**

#### 📋 Schema 檔案清單

已建立的 Schema 檔案：
- ✅ `user-roles-schema.sql` (2.8 KB) - 用戶角色與權限
- ✅ `contact-info-schema.sql` (10.9 KB) - 聯絡資訊管理
- ✅ `matches-schema.sql` (4.9 KB) - 媒合記錄
- ✅ `project-items-schema.sql` (14.3 KB) - 統包分包系統
- ✅ `contact-unlocks-schema.sql` (5.8 KB) - 聯絡解鎖
- ✅ `notifications-schema.sql` (9.2 KB) - 通知系統
- ⏳ `subscriptions-schema.sql` - **待建立**（訂閱方案與點數系統）

#### 執行順序（依賴關係）

**步驟 1：建立 profiles 表（用戶角色系統）** ⭐⭐⭐
```sql
-- 在 Supabase SQL Editor 執行
-- File: docs/user-roles-schema.sql
-- 內容：
--   - profiles 表（id, role, email, email_verified, avatar_url, full_name）
--   - RLS policies（查看所有、更新自己、管理員更新任何人）
--   - 自動觸發器（新用戶自動建立 profile）
-- 依賴：auth.users（Supabase 內建）
-- 預計時間：5 分鐘
```

**步驟 2：同步現有用戶到 profiles** ⭐⭐⭐
```sql
-- File: docs/sync-profiles.sql
-- 內容：
--   - INSERT INTO profiles FROM auth.users（同步現有用戶）
--   - UPDATE profiles SET role='admin' WHERE email='liutsaiiu@gmail.com'
-- 預計時間：2 分鐘
```

**步驟 3：建立聯絡資訊表** ⭐⭐⭐
```sql
-- File: docs/contact-info-schema.sql
-- 內容：
--   - users 表擴充（phone, line_id, website_url, company_name, address, bio）
--   - contact_info 表（詳細聯絡資訊 + 隱私控制）
--   - 12 種聯絡方式（phone, mobile, email, line, facebook, instagram, linkedin,
--     youtube, website, portfolio, wechat, telegram, whatsapp）
--   - 每個聯絡方式都有 _visible 欄位控制是否公開
-- 依賴：users（既有表）
-- 預計時間：5 分鐘
```

**步驟 4：建立訂閱方案與點數系統** ⭐⭐⭐（新增）
```sql
-- File: docs/subscriptions-schema.sql（待建立）
-- 內容：
--   - subscription_plans 表（方案設定 + 數量限制 + 價格顯示設定）
--   - user_subscriptions 表（用戶訂閱記錄）
--   - user_usage_stats 表（使用量追蹤）
--   - user_credits 表（點數餘額）
--   - credit_transactions 表（點數交易記錄）
-- 依賴：auth.users
-- 預計時間：10 分鐘
```

**步驟 5：建立媒合記錄表** ⭐⭐⭐
```sql
-- File: docs/matches-schema.sql
-- 內容：
--   - matches 表（專案 <-> 報價的媒合記錄）
--   - 欄位：project_id, expert_listing_id, expert_id, client_id,
--     match_score (0-100), match_reasons (jsonb), status
--   - 8 個索引（優化查詢效能）
--   - 5 個 RLS policies
-- 依賴：projects, expert_listings（既有表）
-- 預計時間：5 分鐘
```

**步驟 6：建立統包分包系統表** ⭐⭐⭐
```sql
-- File: docs/project-items-schema.sql
-- 內容：
--   - projects 表擴充（project_type, total_items, published_items）
--   - project_items 表（分包項目 + 統包組合）
--   - 欄位：package_group, package_group_id, is_bundled
--   - VIEW: project_items_summary（專案分包統計）
--   - VIEW: package_groups_detail（統包組合明細）
--   - 函數：create_package_group(), ungroup_package(), publish_project_items()
-- 依賴：projects, ai_categories（既有表）
-- 預計時間：8 分鐘
```

**步驟 7：建立聯絡解鎖表** ⭐⭐⭐
```sql
-- File: docs/contact-unlocks-schema.sql
-- 內容：
--   - contact_unlocks 表（聯絡資訊解鎖申請）
--   - 欄位：requester_id, target_id, match_id, status, unlocked_fields[],
--     request_message, response_message, expires_at
--   - VIEW: unlocked_contacts（已解鎖的聯絡資訊檢視）
-- 依賴：contact_info, matches
-- 預計時間：5 分鐘
```

**步驟 8：建立通知系統表** ⭐⭐⭐
```sql
-- File: docs/notifications-schema.sql
-- 內容：
--   - notifications 表（38 種通知類型）
--   - 通知類型：媒合、解鎖、專家服務、專案、訂閱、點數、付款、
--     廠商列表、系統通知
--   - 關聯欄位：related_match_id, related_unlock_id, related_project_id, 
--     related_listing_id
--   - 函數：get_unread_notification_count(), mark_notifications_as_read()
-- 依賴：matches, contact_unlocks, projects, expert_listings
-- 預計時間：5 分鐘
```

**步驟 9：測試用戶管理後台** ⭐⭐
- 訪問 `/admin/user-management.html`
- 確認可以看到用戶列表
- 測試角色切換功能
- 預計時間：5 分鐘

**預期結果**：所有資料表結構完整，可以開始寫業務邏輯

#### 📊 資料表依賴關係圖

```
auth.users (Supabase 內建)
    ├─→ profiles (步驟1)
    ├─→ contact_info (步驟3)
    ├─→ subscription_plans (步驟4)
    ├─→ user_subscriptions (步驟4)
    ├─→ user_usage_stats (步驟4)
    ├─→ user_credits (步驟4)
    └─→ credit_transactions (步驟4)

projects (既有表)
    ├─→ project_items (步驟6) - 統包分包系統
    └─→ matches (步驟5)

expert_listings (既有表)
    └─→ matches (步驟5)

matches (步驟5)
    ├─→ contact_unlocks (步驟7)
    └─→ notifications (步驟8)

contact_info (步驟3)
    └─→ contact_unlocks (步驟7)

contact_unlocks (步驟7)
    └─→ notifications (步驟8)

project_items (步驟6)
    └─→ notifications (步驟8, 透過 related_project_id)
```

#### 🎯 執行檢查清單

完成後確認：
- [ ] 所有 8 個 SQL 檔案執行成功，無錯誤
- [ ] profiles 表有資料（至少有你的帳號）
- [ ] 你的帳號 role 是 'admin'
- [ ] user-management.html 可以正常顯示用戶列表
- [ ] 資料庫總表數：+8 個新表
- [ ] 資料庫總 VIEW 數：+3 個
- [ ] 資料庫總函數數：+8 個
    ↓
notifications (依賴 matches, contact_unlocks)
```

---

### 📅 階段二：兩端基本介面（第二週前半，預計 1-2 天）

**目標**：先把發案者端和專家端的基本介面做好，才能測試媒合邏輯

**📌 為什麼要先做介面？**
- ✅ 兩端都有介面才能完整測試媒合流程
- ✅ 可以手動測試各個功能點
- ✅ 確保資料格式正確（前後端串接）

#### A. 發案者端基本介面 ⭐⭐⭐

**現況盤點：**
- ✅ `client/my-projects.html` - 已存在（需檢查功能）
- ✅ `client/my-custom-products.html` - 已存在
- ❌ `client/dashboard.html` - **缺少**（控制台）
- ❌ `client/project-detail.html` - **缺少**（專案詳情）

**待完成：**
- [ ] 建立 `client/dashboard.html`
  - 統計卡片（專案數、媒合數）
  - 最新專案列表（前 5 筆）
  - 最新媒合專家列表（前 5 筆）
  - 快速操作按鈕

- [ ] 建立 `client/project-detail.html`
  - 專案完整資訊
  - **統包/分包模式切換**（已廢除全案統包，改為自選統包組合）
  - **分包項目管理區塊**（可新增/編輯/刪除分項）
  - **統包組合管理**
    - 顯示所有統包組（A組、B組...）
    - 每個統包組顯示包含的項目清單
    - 每個統包組的媒合專家列表
    - 可新增/編輯/解散統包組
  - **單獨分包項目區塊**
    - 顯示未組入統包的單獨分項
    - 每個分項的媒合專家列表
  - 媒合專家列表
    - **統包組：顯示能承接該組所有項目的廠商**
    - **單獨分項：顯示該項目的媒合廠商**
  - 預留「申請聯繫」按鈕位置

- [ ] 建立 `client/project-items.html`（分包項目管理）
  - 分包項目列表（項目名稱、分類、預算、狀態）
  - 新增分包項目表單
  - 編輯/刪除分包項目
  - **自選統包組合功能** ⭐⭐⭐
    - 勾選多個分項 → 「組成統包」按鈕
    - 可建立多個統包組合（例如：水電+泥作一組、油漆+木工一組）
    - 每個統包組可命名（A組、B組 或 自訂名稱）
    - 統包組可拆回單獨分包
    - 顯示每個統包組的項目清單與預算總計
  - **彈性發包選擇**
    - 可選擇單一分項發包
    - 可選擇整個統包組發包
    - 可選擇多個統包組 + 單獨分項一起發包
    - **不強制全部一起發包**
  - 每個分項/統包組的發包狀態追蹤
  - 批量操作（全部發包、取消發包）

- [ ] 檢查 `client/my-projects.html`
  - 確認能正確載入專案列表
  - **顯示專案發包狀態**
    - 顯示統包組數量（X 個統包組）
    - 顯示單獨分項數量（Y 個單項）
    - 已發包進度（已發 M / 總計 N）
  - 確認能跳轉到詳情頁

#### B. 專家端基本介面檢查 ⭐⭐

**現況盤點：**
- ✅ `expert/dashboard.html` - 已存在並修復
- ✅ `expert/matched-projects.html` - 已存在並修復（但無真實資料）
- ✅ `expert/my-listings.html` - 已存在
- ❌ `expert/listing-detail.html` - **缺少**（報價詳情）

**待完成：**
- [ ] 建立 `expert/listing-detail.html`
  - 報價完整資訊
  - 媒合到的專案列表（準備好接收媒合結果的欄位）
  - 編輯/下架按鈕

#### C. 廠商列表頁（長期訂閱專屬）⭐⭐⭐

**現況盤點：**
- ❌ `public/vendors.html` - **缺少**（廠商列表頁）
- ❌ `public/vendor-profile.html` - **缺少**（廠商詳細資料頁）

**待完成：**
- [ ] 建立 `public/vendors.html`（公開頁面，無需登入）
  - 廠商列表卡片展示（半年/一年訂閱用戶）
  - 篩選功能（分類、服務地區、評價）
  - 搜尋功能（公司名稱、服務項目）
  - 分頁功能
  - 只顯示已啟用公開資料的長期訂閱用戶

- [ ] 建立 `public/vendor-profile.html`（公開頁面）
  - 廠商完整資料展示
  - 公開聯絡資訊（電話、Email、Line、地址）
  - 服務項目與價格範圍
  - 作品集/案例展示
  - 用戶評價區塊
  - 聯繫按鈕（直接撥打或發送訊息）

- [ ] 建立 `expert/vendor-settings.html`（專家後台）
  - 廠商資料管理介面
  - 公開資訊編輯（公司名稱、簡介、服務地區）
  - 選擇公開的聯絡方式（電話、Email、Line 等）
  - 作品集上傳與管理
  - 預覽廠商頁面
  - 啟用/停用公開展示

**功能邏輯：**
- 只有半年/一年訂閱用戶才能啟用廠商列表展示
- 用戶可自行選擇要公開哪些聯絡方式
- 廠商列表頁 SEO 友善（利於搜尋引擎曝光）
- 廠商資料被查看時發送通知（`vendor_profile_viewed`）

**預期結果**：兩端基本介面齊全，廠商列表頁提供長期訂閱用戶額外曝光價值

---

### 📅 階段三：測試數據生成（第二週後半，預計 0.5-1 天）⭐⭐⭐

**目標**：自動生成數十筆測試資料，模擬真實使用場景

#### A. 建立測試數據生成腳本 📝

- [ ] **建立 `scripts/generate-test-data.js`**
  
  **功能規劃：**
  ```javascript
  // 1. 生成測試帳號（20個）
  - 10 個發案者帳號（client_01 ~ client_10）
  - 10 個專家帳號（expert_01 ~ expert_10）
  - 自動在 profiles 表建立資料
  
  // 2. 生成測試專案（30個）
  - 每個發案者 2-4 個專案
  - 涵蓋不同分類（裝潢、家具、設計、建材等）
  - 不同預算範圍（5萬 ~ 300萬）
  - 不同狀態（open, in_progress, closed）
  - 隨機生成需求描述（使用預設範本）
  
  // 3. 生成專家報價（40個）
  - 每個專家 3-5 個報價
  - 涵蓋不同服務類型
  - 不同價格範圍
  - 隨機專長標籤
  
  // 4. 生成聯絡資訊（20組）
  - 每個帳號的聯絡方式
  - 電話（格式：09XX-XXX-XXX）
  - Line ID、Email、地址
  ```

- [ ] **建立執行命令**
  ```bash
  # 在 package.json 加入
  "scripts": {
    "seed": "node scripts/generate-test-data.js",
    "seed:clean": "node scripts/clean-test-data.js"
  }
  ```

#### B. 數據生成範例規劃

**發案者帳號範例：**
```
Email: client_01@test.com ~ client_10@test.com
密碼: Test1234!
姓名: 測試發案者01 ~ 10
角色: user (發案者)
```

**專家帳號範例：**
```
Email: expert_01@test.com ~ expert_10@test.com
密碼: Test1234!
姓名: 測試專家01 ~ 10
角色: user (專家)
專長: 木工/水電/室內設計/景觀設計/泥作/油漆等
```

**專案範例：**
```
專案1: 新成屋全室裝潢（預算 80-120萬，分類：裝潢，3房2廳）
專案2: 客製化實木餐桌（預算 3-5萬，分類：家具，6人座）
專案3: 庭院景觀改造（預算 15-25萬，分類：景觀，20坪）
...共30個
```

**報價範例：**
```
報價1: 室內裝潢統包服務（木工專家，經驗15年，$80-150萬）
報價2: 客製化木工家具（家具專家，經驗8年，$3-10萬）
報價3: 景觀設計施工（景觀專家，經驗10年，$15-50萬）
...共40個
```

**預期結果**：一鍵生成完整測試數據，可立即測試媒合功能

---

### 📅 階段四：媒合邏輯實作（第三週前半，預計 1-2 天）

**目標**：實現真實的 AI 媒合算法

#### A. 建立 matches 資料表與 API ⭐⭐⭐
- [ ] 建立 `matches` 資料表
  ```sql
  CREATE TABLE matches (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id uuid REFERENCES projects(id),
    expert_listing_id uuid REFERENCES expert_listings(id),
    match_score decimal,
    match_reason jsonb,
    status text DEFAULT 'pending',
    created_at timestamptz DEFAULT now()
  );
  ```

- [ ] 實作媒合 API `/api/match/run`
  - 分析專案需求（AI 分析結果）
  - **判斷發包類型（統包組 or 單獨分項）**
  - 查詢所有專家報價
  - **統包組媒合**：計算每個專家能滿足該組所有項目的能力，只推薦能全部承接的廠商
  - **單獨分項媒合**：針對每個分項分別媒合對應專家
  - 計算匹配分數（關鍵字、預算、地區、經驗）
  - 儲存媒合記錄到 matches 表
  - 觸發通知（雙方）

- [ ] **實作統包組媒合算法** `/api/match/run-package-group`
  - 讀取指定統包組的所有項目（package_group_id）
  - 查詢所有專家的服務範圍（expert_listings）
  - **篩選出能承接該組「所有項目」的專家**（必須全滿足）
  - 不能承接全部項目的專家不納入推薦
  - 計算每個合格專家的總評分
  - 按評分排序，回傳前 10 名
  - **重點：只推薦能全包該組的廠商，不推薦部分符合的**

- [ ] **實作分包媒合 API** `/api/match/run-split`
  - 讀取專案的分包項目清單
  - **可選擇要發包的項目/統包組**（不需一次全發）
  - 針對每個已勾選的統包組，執行統包組媒合
  - 針對每個已勾選的單獨分項，執行單項媒合
  - 每個分項/統包組產生獨立的 matches 記錄
  - 標記分項發包狀態（未發包 → 已發包 → 已媒合）

- [ ] 更新專家控制台 `matched-projects.html`
  - 從 matches 表讀取真實資料（不再是空的）
  - **顯示媒合類型**（統包組/單獨分項）
  - **統包組專案顯示：「統包組X - 包含 Y 個項目」**
  - **列出統包組包含的項目清單**
  - 顯示匹配分數與原因
  - 快速操作（查看詳情、報價）

#### D. 聯絡資訊解鎖流程 ⭐⭐⭐
- [ ] 實作「申請查看聯絡方式」功能
  - 在 project-detail 或 matched-experts 顯示按鈕
  - 發送解鎖請求（建立 contact_unlocks 記錄）
  - 對方收到通知

- [ ] 實作「同意/拒絕解鎖」功能
  - 在通知中心顯示待處理請求
  - 同意後雙方可查看聯絡資訊
  - 使用 unlocked_contacts 視圖查詢

- [ ] 建立聯絡資訊顯示區塊
  - 已解鎖：顯示完整資訊（電話、Line、Email、地址）
  - 未解鎖：顯示遮罩「***-****-1234」+ 申請按鈕
  - 待審核：顯示「對方審核中...」

**預期結果**：平台核心功能完整，媒合 → 申請聯繫 → 查看聯絡方式全流程可跑

- [ ] **實作解鎖申請 API** `/api/contacts/request-unlock`
  - 發案者申請查看專家聯絡方式
  - 建立 contact_unlocks 記錄（status: pending）
  - 觸發通知給專家

- [ ] **實作解鎖審核 API** `/api/contacts/approve` 和 `/api/contacts/reject`
  - 專家同意/拒絕解鎖請求
  - 更新 contact_unlocks 狀態
  - 同意後雙方可透過 unlocked_contacts 視圖查看資訊

- [ ] **前端顯示邏輯**
  - 在 `client/project-detail.html` 顯示專家聯絡資訊
    - 未申請：顯示「***-****-1234」+ 申請按鈕
    - 審核中：顯示「等待對方同意...」
    - 已解鎖：顯示完整資訊（電話、Line、Email）
    - 已拒絕：顯示「對方拒絕分享聯絡方式」
  
  - 在 `expert/matched-projects.html` 對應顯示
    - 收到申請：通知圖示 + 「同意/拒絕」按鈕
    - 已同意：顯示發案者聯絡資訊

**預期結果**：聯絡解鎖流程完整運作，保護雙方隱私

---

### 📅 階段七：通知系統（第四週後半，預計 1 天）

**目標**：讓使用者即時知道平台動態

#### A. 通知系統實作 ⭐⭐⭐
- [ ] 建立 `notifications` 資料表
  ```sql
  CREATE TABLE notifications (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id uuid REFERENCES auth.users(id),
    type text, -- 'new_match', 'unlock_request', 'unlock_approved'
    title text,
    message text,
    link text,
    is_read boolean DEFAULT false,
    created_at timestamptz DEFAULT now()
  );
  ```

- [ ] 導航欄通知圖示
  - 未讀數量紅點提示
  - 下拉選單顯示最新 5 筆
  - 點擊標記為已讀並跳轉

- [ ] 通知中心頁面 `notifications.html`
  - 完整通知列表（分頁）
  - 篩選（全部/未讀/已讀）
  - 批量操作（全部標記已讀、刪除）

**預期結果**：使用者可以即時收到平台通知，提升互動率

- [ ] 建立 `notifications` 資料表
  ```sql
  CREATE TABLE notifications (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id uuid REFERENCES auth.users(id),
    type text, -- 'new_match', 'unlock_request', 'unlock_approved', 'unlock_rejected'
    title text,
    me補充缺少的頁面
  - `client/matched-experts.html`（查看所有媒合專家）
  - `expert/project-detail.html`（專家查看專案詳情）

- [ ] UI/UX 優化
  - 統一卡片樣式
  - 統一按鈕樣式
  - 統一載入動畫
  - 統一空狀態提示

#### B. 完整測試轉

- [ ] 通知中心頁面 `/notifications.html`
  - 完整通知列表（分頁）
  - 篩選（全部/未讀/已讀）
  - 批量操作（全部標記已讀）

- [ ] 整合通知觸發點
  - 新媒合產生 → 通知雙方
  - 收到解鎖申請 → 通知專家
  - 解鎖被同意/拒絕 → 通知發案者

**預期結果**：使用者可即時收到平台通知

---

### 📅 階段八：金流與訂閱系統（第五週，預計 2-3 天）⭐⭐⭐

**目標**：整合綠界金流，實現訂閱方案付款與點數購買

#### A. 綠界 ECPay 金流整合 💰

**階段 8.1：綠界基礎設定**

> ⚠️ **重要提醒**：綠界需要**網站正式上線後**才能申請正式商家帳號。
> 
> **開發階段流程**：
> 1. 先使用綠界測試環境（免申請，立即可用）
> 2. 完成所有金流功能開發與測試
> 3. 網站部署上線後，申請正式商家帳號
> 4. 取得正式 MerchantID/HashKey/HashIV 後切換環境變數

- [ ] **使用綠界測試環境（開發階段）**
  - 前往 [綠界科技測試平台](https://payment-stage.ecpay.com.tw/)
  - 使用測試用 MerchantID: `2000132`（範例）
  - 使用測試用 HashKey 和 HashIV（從測試後台取得）
  - 測試環境支援完整功能，可模擬付款成功/失敗
  - **無需真實金流，可使用測試信用卡號進行測試**

- [ ] **建立綠界設定檔** `config/ecpay-config.js`
  ```javascript
  module.exports = {
    // 測試環境與正式環境自動切換
    merchantID: process.env.ECPAY_MERCHANT_ID || '2000132', // 預設測試用
    hashKey: process.env.ECPAY_HASH_KEY,
    hashIV: process.env.ECPAY_HASH_IV,
    
    // 付款完成後導向的頁面
    returnURL: process.env.ECPAY_RETURN_URL || 
               `${process.env.BASE_URL || 'http://localhost:3000'}/payment/return`,
    
    // 綠界後台通知的 API（必須是公開 URL）
    notifyURL: process.env.ECPAY_NOTIFY_URL || 
               `${process.env.BASE_URL || 'http://localhost:3000'}/api/payment/notify`,
    
    // 環境切換（test: 測試環境, production: 正式環境）
    environment: process.env.NODE_ENV === 'production' ? 'production' : 'test',
    
    // API 端點
    apiURL: process.env.NODE_ENV === 'production'
      ? 'https://payment.ecpay.com.tw/Cashier/AioCheckOut/V5'
      : 'https://payment-stage.ecpay.com.tw/Cashier/AioCheckOut/V5'
  };
  ```

- [ ] **正式上線後的切換步驟（階段十執行）**
  1. 網站部署到 Vercel 並取得正式網址
  2. 前往 [綠界科技](https://www.ecpay.com.tw/) 申請正式商家帳號
  3. 提供：公司資料、統編、銀行帳戶、網站網址
  4. 審核通過後取得正式 MerchantID、HashKey、HashIV
  5. 在 Vercel 環境變數中更新為正式金鑰
  6. 將 `NODE_ENV` 設為 `production`
  7. 測試正式環境付款流程

- [ ] **建立訂閱方案表** `subscriptions-schema.sql`
  ```sql
  CREATE TABLE subscription_plans (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    name text NOT NULL,                    -- 方案名稱
    price integer NOT NULL,                -- 價格（台幣）
    duration_months integer NOT NULL,      -- 訂閱月數
    credits_monthly integer DEFAULT 0,     -- 每月贈送點數
    
    -- 方案限制設定（可在管理後台調整）
    max_projects integer DEFAULT -1,       -- 發案數量上限（-1=無限制）
    max_listings integer DEFAULT -1,       -- 報價刊登數量上限（-1=無限制）
    max_active_projects integer DEFAULT -1, -- 同時進行中專案數上限（-1=無限制）
    max_project_items integer DEFAULT -1,  -- 單一專案分包項目數上限（-1=無限制）
    
    features jsonb DEFAULT '[]'::jsonb,    -- 方案特色
    is_vendor_listing boolean DEFAULT false, -- 是否可公開廠商資料
    is_active boolean DEFAULT true,
    sort_order integer DEFAULT 0,          -- 排序順序
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now()
  );
  
  CREATE TABLE user_subscriptions (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id uuid REFERENCES auth.users(id),
    plan_id uuid REFERENCES subscription_plans(id),
    start_date timestamptz DEFAULT now(),
    end_date timestamptz NOT NULL,
    status text DEFAULT 'active', -- active, expired, cancelled
    auto_renew boolean DEFAULT false,
    created_at timestamptz DEFAULT now()
  );
  
  -- 使用量追蹤表
  CREATE TABLE user_usage_stats (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id uuid REFERENCES auth.users(id) UNIQUE,
    current_projects integer DEFAULT 0,        -- 當前專案總數
    current_active_projects integer DEFAULT 0, -- 當前進行中專案數
    current_listings integer DEFAULT 0,        -- 當前報價刊登數
    monthly_projects_created integer DEFAULT 0,-- 本月建立專案數
    monthly_listings_created integer DEFAULT 0,-- 本月建立報價數
    last_reset_at timestamptz DEFAULT now(),   -- 上次重置時間（每月1號）
    updated_at timestamptz DEFAULT now()
  );
  
  -- 建立點數表
  CREATE TABLE user_credits (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id uuid REFERENCES auth.users(id) UNIQUE,
    balance integer DEFAULT 0,             -- 點數餘額
    total_earned integer DEFAULT 0,        -- 累計獲得
    total_spent integer DEFAULT 0,         -- 累計消費
    updated_at timestamptz DEFAULT now()
  );
  
  -- 點數交易記錄
  CREATE TABLE credit_transactions (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id uuid REFERENCES auth.users(id),
    type text NOT NULL, -- purchase, granted, consumed, refund
    amount integer NOT NULL,               -- 正數為獲得，負數為消費
    balance_after integer NOT NULL,        -- 交易後餘額
    source text,                           -- subscription, purchase, ai_service
    description text,
    metadata jsonb DEFAULT '{}'::jsonb,
    created_at timestamptz DEFAULT now()
  );
  ```
  
  **💡 價格顯示邏輯說明**：
  - 承包商設定報價時填寫 `price_min` 和 `price_max`
  - **發案者永遠只看到價格區間**（例如：$50萬-$100萬）
  - 承包商如果想顯示固定價格，可將上下限設為相同（例如：$80萬-$80萬）
  - 這樣保留承包商報價彈性，避免價格被過早揭露

**階段 8.2：訂閱方案購買流程**
- [ ] **建立訂閱方案頁面** `public/pricing.html`
  - 展示所有訂閱方案（免費、399、899、1999、一次性刊登250）
  - 方案對比表格（功能差異、點數差異、廠商列表權益）
  - 立即訂閱按鈕

- [ ] **實作訂閱購買 API** `/api/subscription/purchase`
  - 產生綠界付款訂單
  - 呼叫綠界 API 取得付款表單
  - 導向綠界付款頁面

- [ ] **實作綠界付款回調** `/api/payment/notify`
  - 接收綠界付款結果通知
  - 驗證 CheckMacValue（防止偽造）
  - 付款成功 → 啟用訂閱、發送點數、發送通知
  - 付款失敗 → 記錄日誌、通知用戶

- [ ] **訂閱管理頁面** `user/subscription.html`
  - 顯示當前訂閱狀態
  - 剩餘天數、每月點數
  - 升級/降級/取消訂閱按鈕
  - 訂閱歷史記錄

**階段 8.3：點數購買與管理**
- [ ] **建立點數購買頁面** `user/credits.html`
  - 顯示當前點數餘額
  - 點數購買方案（100點/$50、500點/$200、1000點/$350）
  - 點數消費記錄（AI生圖、AI拆包）

- [ ] **實作點數購買 API** `/api/credits/purchase`
  - 產生綠界付款訂單
  - 付款成功後增加點數餘額
  - 記錄到 credit_transactions

- [ ] **點數消費 API** `/api/credits/consume`
  - AI生圖消費（每次 20-50 點）
  - AI拆包消費（每次 10-30 點）
  - 檢查餘額是否足夠
  - 扣點並記錄交易

**階段 8.4：訂閱自動續費與通知**
- [ ] **建立定期任務** `scripts/subscription-cron.js`
  - 每天檢查即將到期的訂閱（7天前提醒）
  - 發送 `subscription_expiring` 通知
  - 已過期訂閱自動更新為 expired 狀態

- [ ] **每月自動發放點數**
  - 檢查所有 active 訂閱
  - 根據方案發放每月點數
  - 發送 `credits_granted` 通知

- [ ] **每月重置使用量統計**
  - 每月1號重置 monthly_projects_created
  - 每月1號重置 monthly_listings_created
  - 保留 current_* 累計數據

**階段 8.5：管理後台 - 訂閱方案管理** ⭐⭐⭐
- [ ] **建立訂閱方案管理頁面** `admin/subscription-plans.html`
  - 方案列表展示（名稱、價格、期限、限制設定）
  - 新增方案按鈕
  - 編輯方案按鈕
  - 啟用/停用方案
  - 方案排序功能

- [ ] **方案編輯表單** `admin/edit-plan.html`
  - 基本資訊（名稱、價格、期限、每月點數）
  - **數量限制設定區塊** ⭐
    - 發案數量上限（-1=無限制）
    - 報價刊登數量上限（-1=無限制）
    - 同時進行中專案數上限（-1=無限制）
    - 單一專案分包項目數上限（-1=無限制）
  - 方案特色（可新增多個特色點）
  - 廠商列表權益（checkbox）
  - 儲存/取消按鈕

- [ ] **實作方案管理 API**
  - `/api/admin/plans` - 取得所有方案
  - `/api/admin/plans/create` - 新增方案
  - `/api/admin/plans/:id/update` - 更新方案
  - `/api/admin/plans/:id/toggle` - 啟用/停用方案
  - `/api/admin/plans/reorder` - 調整排序

- [ ] **前端限制檢查功能**
  - 新增專案前檢查：`checkProjectQuota()`
  - 新增報價前檢查：`checkListingQuota()`
  - 新增分包項目前檢查：`checkProjectItemsQuota()`
  - 價格顯示模式檢查：`getPriceDisplayMode()`
  - 達到上限時顯示升級方案提示

- [ ] **使用量追蹤 API**
  - `/api/usage/stats` - 取得當前使用量
  - `/api/usage/check-quota` - 檢查是否可執行操作
  - 自動觸發器：專案建立/刪除時更新統計
  - 自動觸發器：報價建立/下架時更新統計

**預期結果**：完整的付款流程，訂閱方案和點數購買都能正常運作，管理員可在後台靈活調整方案限制

---

### 📅 階段九：完善細節（部署前，預計 1-2 天）

**目標**：修復 bugs、補充缺少的頁面、優化體驗

#### A. 細節完善 ⭐⭐
- [ ] `expert/listing-detail.html`（專家報價詳情）
  - 顯示報價完整資訊
  - 顯示媒合到的專案
  - 編輯/下架按鈕

- [ ] `expert/project-detail.html`（專家查看專案）
  - 從媒合列表點進來的專案詳情
  - 顯示媒合分數與原因
  - 快速報價/聯繫按鈕

#### G. 測試與修復 ⭐⭐⭐
- [ ] **用真實帳號完整流程測試**
  - [ ] 註冊新帳號 → 發案 → 等待媒合 → 收到通知
  - [ ] 註冊新帳號 → 刊登報價 → 收到媒合 → 申請聯繫
  - [ ] 完整跑通「發案 → 媒合 → 解鎖 → 聯繫」全流程
  
- [ ] **用測試數據大規模測試**
  - [ ] 生成 50 個專案 + 100 個報價
  - [ ] 執行媒合算法
  - [ ] 檢查媒合品質與系統效能
  - [ ] 檢查是否有資料庫錯誤或查詢超時

- [ ] **邊界情況測試**
  - [ ] 專案沒有媒合結果 → 顯示空狀態
  - [ ] 報價沒有媒合專案 → 顯示引導
  - [ ] 網路錯誤 → 顯示錯誤提示
  - [ ] 同時多個解鎖請求 → 狀態正確

- [ ] **效能優化**
  - [ ] 查詢優化（加索引：project_id, expert_id, status）
  - [ ] 圖片載入優化（lazy loading）
  - [ ] 媒合算法優化（避免 N+1 查詢）

**預期結果**：平台穩定、流暢、無明顯 bugs

---

### 📅 階段十：部署準備（最後 0.5 天）

- [ ] **檔案上傳遷移到 Supabase Storage** ⭐⭐⭐
  - 建立 `product-images` bucket
  - 修改 multer 為 memory storage
  - 更新所有上傳邏輯
  
- [ ] **建立 .gitignore**
  - 排除 `node_modules/`, `.env`, `uploads/`, `*.log`

- [ ] **整理環境變數**
  - 確認所有 `.env` 變數
  - 準備部署平台的環境變數清單

- [ ] **最終檢查**
  - 所有重要功能測試通過
  - 沒有 console.error 或明顯警告
  - 資料庫 RLS policies 正確設定

### 優先級 3：後台管理功能（之後完成）

#### H. 管理後台首頁優化 ⭐
- [ ] admin/index.html 改為真實儀表板
- [ ] 顯示系統統計（用戶、專案、媒合成功率）
- [ ] 最新活動時間軸
- [ ] 快速操作入口

#### I. 審計日誌 ⭐
- [ ] 記錄重要操作（分類修改、用戶角色變更）
- [ ] 顯示操作者、時間、變更內容
- [ ] 後台審計日誌頁面

---

## 🎯 建議執行順序（本週任務）

### Day 1-2: 核心媒合流程
1. 建立 `matches` 表
2. 實作 AI 媒合算法
3. 修復 matched-projects.html 顯示真實資料

### Day 3-4: 雙邊控制台
1. 建立 client/dashboard.html
2. 建立 client/matched-experts.html（對應 expert 的 matched-projects）
3. 整合到導航選單

### Day 5-6: 聯絡資訊解鎖
1. 實作申請解鎖流程
2. 建立通知系統基礎
3. 在詳情頁顯示解鎖按鈕和已解鎖資訊

### Day 7: 測試與優化
1. 端到端測試完整流程
2. 修復發現的 bug
3. UI/UX 細節打磨

---

## 📊 進度總覽

### Phase 1 (MVP) — 介面＋Auth＋Schema
- ✅ Phase 1.1 - Auth 系統（100%）
- ✅ Phase 1.2 - 資料表設計（100%）
- ✅ Phase 1.3 - 介面與導航（100%）
- ✅ Phase 1.3.5 - 聯絡資訊系統（100%）
- ✅ Phase 1.4 - 專家功能（100%）
  - 專家控制台 ✅
  - 報價列表與表單 ✅
  - 媒合專案頁面 ✅（UI 完成，待接真實資料）
- ⏳ Phase 1.5 - 發案者功能（30% → 第二週前半完成）
  - ✅ 我的專案列表（已有頁面，需檢查功能）
  - ✅ 客製產品相關頁面
  - ⏳ 發案者控制台（待建立）
  - ⏳ 專案詳情頁（待建立）
  - ⏳ 媒合專家頁面（待建立）
  - **依據新路線圖：先完成階段一（資料庫）再做這部分**

### 系統完整度評估
- **認證系統**：✅ 95%（缺郵件驗證）
- **權限系統**：✅ 100%
- **專家端**：✅ 85%（缺真實媒合資料）
- **發案者端**：⏳ 30%（有基礎頁面，缺控制台）
- **媒合引擎**：⏳ 20%（邏輯未實作）
- **通知系統**：⏳ 0%
- **管理後台**：✅ 70%（用戶管理✅、分類管理✅、缺審計）

---

## 🗂️ 技術債務與優化項目

### 需要重構的部分
1. **custom-product.js**：圖片生成錯誤處理可以更優雅
2. **AI 分類系統**：前後台雙重來源需統一
3. **檔案上傳**：目前只支援本地預覽，需整合 Supabase Storage

### 資料庫待執行腳本
- [x] user-roles-schema.sql（已執行）
- [x] sync-profiles.sql（已執行）
- [ ] contact-info-schema.sql（待執行）
- [ ] matches-schema.sql（待建立並執行）
- [ ] notifications-schema.sql（待建立並執行）

---

## 🚀 GitHub + 雲端部署計劃

### 部署可行性評估

#### 當前專案架構分析
```
專案結構：
├── 前端：靜態 HTML/CSS/JS（iStudio-1.0.0/）
├── 後端：Node.js + Express（server.js）
├── 資料庫：Supabase（PostgreSQL）
├── 檔案儲存：本地暫存（uploads/）→ 需改為 Supabase Storage
└── 外部 API：Google Gemini AI
```

#### ✅ 適合的部署方案

**🎯 最終選擇：Vercel（原生 Node.js 支援）**

**為何選 Vercel？**
1. ✅ **零架構調整** - Express app 直接部署，server.js 完全不用改
2. ✅ **20+ API endpoints 保持不變** - 所有路由都正常運作
3. ✅ **執行時間充足** - Hobby 免費版 10秒，你的 AI API 都在 2-8 秒
4. ✅ **自動從 GitHub 部署** - 推送即部署，內建 CI/CD
5. ✅ **支援 multer 檔案上傳** - 不需要改成 base64
6. ✅ **免費 HTTPS + CDN**
7. 💰 **成本合理** - 免費版夠用，Pro 版 $20/月 (vs 2-3天重構時間)

**時間成本分析：**
- Vercel 部署時間：**半天** (只需處理環境變數 + Supabase Storage)
- Netlify 重構時間：**2-3天** (20+ endpoints 逐一改寫)
- **結論：時間 > 金錢，直接用 Vercel**

---

**替代方案（僅供參考，不採用）**

**Railway**
- ✅ 完整支援 Node.js 應用（跟 Vercel 類似）
- ✅ 不需修改程式碼架構
- 💰 免費額度：$5/月

**Render**
- ✅ 免費方案支援 Web Services
- ⚠️ 免費版會自動休眠（15分鐘無活動）

**❌ Netlify（不推薦）**
- ❌ 只支援 Serverless Functions，不支援 Express app
- ❌ 需要 **2-3 天重構** 所有 API endpoints
- ❌ 不支援 multer，需改檔案上傳邏輯
- ⚠️ 執行時間：免費 10秒，Pro $19/月 26秒（但架構問題更嚴重）

#### 📋 部署前需要完成的工作

1. **檔案上傳改為 Supabase Storage** ⭐⭐⭐
   - 目前：本地 `uploads/` 資料夾
   - 需改為：Supabase Storage Bucket
   - 原因：雲端環境無持久化本地儲存

2. **環境變數整理** ⭐⭐⭐
   - 確認所有 `.env` 變數
   - 在部署平台設定環境變數
   - 檢查敏感資訊不被提交到 GitHub

3. **建立 .gitignore** ⭐⭐⭐
   ```
   node_modules/
   .env
   .env.local
   uploads/
   *.log
   .DS_Store
   ```

4. **資料庫 Schema 確認** ⭐⭐
   - 確保所有表都已在 Supabase 建立
   - RLS policies 都已設定
   - 測試資料準備

5. **API 路由調整**（如果選 Vercel）⭐⭐
   - Express routes → Vercel Serverless Functions
   - 或使用 `@vercel/node` adapter

---

### 🎯 建議部署時間點

#### ✅ 可以立即部署（Alpha 測試版）
**條件：**
- [x] 基本認證系統完成
- [x] 核心頁面可運作
- [x] 資料庫架構穩定
- [ ] 檔案上傳改為 Supabase Storage
- [ ] 完整測試一次完整流程

**適合場景：**
- 團隊內部測試
- 展示給客戶看 Demo
- 收集早期用戶反饋

#### 🎯 建議部署時間點（Beta 版）
**條件：**
- [ ] Phase 1 全部完成（發案者 + 專家雙邊功能）
- [ ] 媒合邏輯已實作並測試
- [ ] 聯絡資訊解鎖流程完整
- [ ] 通知系統基本可用
- [ ] 無重大 Bug

**時間估計：** 2-3 週後（約 2026-02-20）

**適合場景：**
- 邀請真實用戶測試
- 收集產品反饋
- SEO 開始索引

#### 🚀 正式上線（Production）
**條件：**
- [ ] 所有核心功能完成
- [ ] 性能優化完成
- [ ] 安全性檢查通過
- [ ] 錯誤監控設置（Sentry）
- [ ] 備份策略確立
- [ ] 使用條款 & 隱私政策

**時間估計：** 1-2 個月後

---

### 📝 GitHub + Vercel 部署步驟（推薦方案）

#### Phase A：準備工作（約 2-4 小時）

##### A1. 檔案上傳改為 Supabase Storage
```javascript
// 在 Supabase 建立 Storage Bucket
// Dashboard → Storage → Create Bucket: "product-images"

// 修改 server.js 的上傳邏輯
const upload = multer({ 
    storage: multer.memoryStorage() // 改為記憶體暫存
});

app.post('/api/upload', upload.single('file'), async (req, res) => {
    const file = req.file;
    const fileName = `${Date.now()}-${file.originalname}`;
    
    // 上傳到 Supabase Storage
    const { data, error } = await supabase.storage
        .from('product-images')
        .upload(fileName, file.buffer, {
            contentType: file.mimetype
        });
    
    if (error) return res.status(500).json({ error: error.message });
    
    // 取得公開 URL
    const { data: { publicUrl } } = supabase.storage
        .from('product-images')
        .getPublicUrl(fileName);
    
    res.json({ url: publicUrl });
});
```

##### A2. 建立 .gitignore
```bash
# 在專案根目錄建立 .gitignore
cat > .gitignore << 'EOF'
# Dependencies
node_modules/

# Environment variables
.env
.env.local
.env.production

# Uploads (改用 Supabase Storage)
uploads/

# Logs
*.log
npm-debug.log*

# OS files
.DS_Store
Thumbs.db

# IDE
.vscode/
.idea/

# Vercel
.vercel
EOF
```

##### A3. 建立 vercel.json 配置
```json
{
  "version": 2,
  "builds": [
    {
      "src": "server.js",
      "use": "@vercel/node"
    }
  ],
  "routes": [
    {
      "src": "/api/(.*)",
      "dest": "/server.js"
    },
    {
      "src": "/(.*)",
      "dest": "/public/$1"
    }
  ],
  "env": {
    "NODE_ENV": "production"
  }
}
```

##### A4. 更新 package.json
```json
{
  "engines": {
    "node": "18.x"
  },
  "scripts": {
    "start": "node server.js",
    "build": "echo 'No build step required'"
  }
}
```

#### Phase B：GitHub 設定（約 30 分鐘）

##### B1. 初始化 Git Repository
```bash
# 在專案根目錄執行
cd d:\AI建站\ai-matching

# 初始化 Git
git init

# 添加所有檔案
git add .

# 第一次提交
git commit -m "Initial commit: MatchDO 合做平台 MVP"

# 檢查狀態
git status
```

##### B2. 建立 GitHub Repository
1. 前往 https://github.com/new
2. Repository name: `matchdo-platform`（或您喜歡的名稱）
3. Description: `MatchDO 合做 - AI 驅動的專業服務媒合平台`
4. 選擇 **Private**（建議先用私有，測試完再公開）
5. 不要勾選 README、.gitignore（我們已經有了）
6. Create repository

##### B3. 連接並推送到 GitHub
```bash
# 連接遠端倉庫（替換為您的 GitHub 用戶名）
git remote add origin https://github.com/YOUR_USERNAME/matchdo-platform.git

# 推送代碼
git branch -M main
git push -u origin main
```

#### Phase C：Vercel 部署（約 20 分鐘）

##### C1. 註冊並連接 GitHub
1. 前往 https://vercel.com/signup
2. 選擇「Continue with GitHub」
3. 授權 Vercel 存取您的 GitHub

##### C2. 匯入專案
1. 點擊「Import Project」
2. 選擇您的 `matchdo-platform` repository
3. 點擊「Import」

##### C3. 配置環境變數
在 Vercel 專案設定中添加：
```
GEMINI_API_KEY=your_gemini_api_key
SUPABASE_URL=your_supabase_url
SUPABASE_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
SUPABASE_DB_URL=your_database_url
NODE_ENV=production
```

##### C4. 部署
1. 點擊「Deploy」
2. 等待建置完成（約 2-3 分鐘）
3. 取得部署 URL：`https://matchdo-platform.vercel.app`

#### Phase D：測試與驗證（約 1 小時）

##### D1. 功能測試清單
- [ ] 首頁載入正常
- [ ] Google 登入功能運作
- [ ] 專家控制台可訪問
- [ ] 報價表單可提交
- [ ] AI 估價功能正常
- [ ] 客製產品圖片生成
- [ ] 管理後台（用戶管理、分類管理）
- [ ] 圖片上傳到 Supabase Storage

##### D2. 性能檢查
- [ ] Lighthouse 分數 > 80
- [ ] 首次載入 < 3 秒
- [ ] API 回應時間 < 2 秒

##### D3. 安全性檢查
- [ ] 環境變數未洩漏
- [ ] HTTPS 正常運作
- [ ] RLS policies 生效
- [ ] 管理後台權限控制

---

### 🔄 持續部署流程（部署後）

#### 開發工作流程
```bash
# 1. 本地開發
git checkout -b feature/new-feature
# ... 開發 ...

# 2. 提交變更
git add .
git commit -m "feat: 新增 XXX 功能"

# 3. 推送到 GitHub
git push origin feature/new-feature

# 4. 建立 Pull Request（可選）
# 在 GitHub 上建立 PR 並審查

# 5. 合併到 main
git checkout main
git merge feature/new-feature
git push origin main

# 6. Vercel 自動部署
# Vercel 會自動偵測 main 分支變更並重新部署
```

#### 環境變數更新
```bash
# 使用 Vercel CLI（推薦）
npm i -g vercel
vercel env add GEMINI_API_KEY production

# 或在 Vercel Dashboard 手動更新
```

---

### ⚠️ 注意事項與最佳實踐

#### 安全性
1. **絕對不要提交 .env 到 GitHub**
   - 使用 .gitignore 排除
   - 檢查歷史記錄：`git log --all -- .env`
   - 如不小心提交，立即換新 API Key

2. **Supabase RLS 必須啟用**
   - 每個表都要有 RLS policies
   - 測試未授權存取會被拒絕

3. **API Key 輪替**
   - 定期更換 GEMINI_API_KEY
   - 使用 Supabase Service Role Key 時要特別小心

#### 性能優化
1. **圖片優化**
   - 使用 WebP 格式
   - 壓縮後再上傳
   - CDN 加速（Vercel 自動提供）

2. **API 快取**
   - 分類資料可以快取
   - 使用 `Cache-Control` headers

3. **資料庫查詢優化**
   - 添加必要的索引
   - 避免 N+1 查詢問題

#### 監控與除錯
1. **錯誤追蹤**（建議加入）
   ```bash
   npm install @sentry/node
   # 在 server.js 初始化 Sentry
   ```

2. **Log 管理**
   - Vercel 提供即時 Logs
   - 在 Dashboard → Deployments → Logs

3. **效能監控**
   - Vercel Analytics（免費）
   - Google Analytics

---

### 📅 建議部署時程表

| 時間點 | 任務 | 預計完成度 |
|--------|------|-----------|
| **本週末**<br>2026-02-08 | Phase A: 準備工作<br>- 檔案上傳改 Supabase Storage<br>- 建立 .gitignore | 可部署 Alpha 版 |
| **下週中**<br>2026-02-12 | Phase B+C: GitHub + Vercel<br>- 上傳代碼<br>- 首次部署 | Alpha 版上線 |
| **下週末**<br>2026-02-15 | Phase D: 測試與修復<br>- 功能測試<br>- Bug 修復 | Alpha 穩定版 |
| **第三週**<br>2026-02-20 | 完成核心功能<br>- 媒合邏輯<br>- 通知系統 | Beta 版準備 |
| **第四週**<br>2026-02-27 | Beta 測試<br>- 邀請用戶<br>- 收集反饋 | Beta 版上線 |

---

## 今日更新（Delta）- 詳細記錄
- [x] 新增「客製產品」頁面與功能模組
- [x] 整合 Gemini 3 Pro Image Preview（AI 生成圖片）✅ 升級為專業級圖片生成
- [x] 新增 `/api/generate-product-image` API（文字生成圖片）✅ 支援 2K/4K 解析度
- [x] 新增 `/api/analyze-custom-product` API（產品分析與廠商媒合）
- [x] 修改導航選單：「AI 估價」→「服務媒合」+ 新增「客製產品」
- [x] 更新架構文件：新增客製產品功能說明與資料表設計
- [x] 建立完整資料表結構（custom_products、manufacturers、custom_product_matches）
- [x] 實作 5 個客製產品 API endpoints（CRUD + 媒合 + 聯繫）
- [x] 建立客製產品歷史記錄頁面（列表展示 + 狀態管理）
- [x] 修正 listing-form.html 分類載入問題（API 返回格式不匹配）
- [x] 建立客製產品詳細頁面（產品資訊 + AI 分析結果 + 廠商列表）
- [x] 實作聯繫廠商 Modal 與狀態更新
- [x] 導航選單整合客製產品入口（頂部選單 + 用戶下拉選單）
- [x] 改善 AI 圖片生成錯誤處理（重試按鈕 + 切換上傳模式）
- [x] 升級圖片生成模型為 gemini-3-pro-image-preview（專業素材製作）
  - 支援自訂解析度（1K/2K/4K）
  - 支援自訂比例（1:1, 16:9, 4:3 等）
  - 增強 prompt 引導產生專業產品攝影效果
  - 改善錯誤處理與重試機制

### 架構調整說明
**雙軌並行模式**：
1. **服務媒合**（原有功能）：用戶上傳現場圖片 → AI 分析工項 → 找服務提供商
2. **客製產品**（新增功能）：用戶輸入描述/上傳示意圖 → AI 生成/分析產品 → 找訂製廠商

### 待完善項目
### 待完善項目
- [ ] 建立 `custom_products` 資料表
- [ ] 建立 `manufacturers` 廠商資料表
- [ ] 實作真實廠商媒合邏輯（目前為模擬資料）
- [ ] 完善 AI 圖片生成錯誤處理
- [ ] 新增產品分析結果儲存功能
- [ ] 實作「聯繫廠商」功能
- [ ] 客製產品歷史記錄頁面

舊項目（2026-02-04）：
- [x] 新增 `ai_categories` 資料表與初始種子（請在 Supabase SQL Editor 執行新增段落）。
- [x] 新增後台頁面：`public/admin/categories.html`（可編輯 key/名稱/提示詞/子分類）。
- [x] 新增 API：`GET /api/categories`、`PUT /api/categories`（前台載入、後台儲存）。
- [x] 前台改為優先從 API 載入分類，API 失敗時回退使用 `js/ai-categories.js`。
- [x] 導覽列新增「後台：分類管理」入口（首頁右側）。

後續建議：
- [ ] 後台頁面加上登入保護（Supabase Auth），避免匿名修改。
- [ ] 將 `js/ai-categories.js` 移除或改為純備援，避免雙重來源混淆。
- [ ] 新增基本審計紀錄（誰在何時修改了哪些分類）。

## Phase 1 (MVP) — 介面＋Auth＋Schema

### 決策紀錄（2026-02-05）
- **執行策略**：選項 A（完整雙邊市場：發案者 vs 專家）
- **登入方式**：Supabase Auth + Google OAuth
- **檔案儲存**：Supabase Storage（已比較 GCS，因整合性選用 Supabase）

### Phase 1.1 - Auth 系統（Week 1）✅
- [x] 在 Supabase Dashboard 啟用 Google OAuth Provider
- [x] 建立 `public/config/auth-config.js`（Supabase Auth SDK 初始化）
- [x] 建立 `public/login.html`（Google 登入頁面）
- [x] ~~建立 `public/register.html`~~（改為雙重身份，不需選角色）
- [x] 建立 `public/js/auth-middleware.js`（導航保護邏輯）
- [x] 修改首頁載入時檢查登入狀態並自動建立用戶

### Phase 1.2 - 資料表設計（Week 1）✅
- [x] 導入 Supabase 專案,建立 `.env` 並接 Supabase JS SDK（已完成連線）。
- [x] 建立 `users` 表（不限制角色，雙重身份）
- [x] 建立 `experts_profile` 表（專長、評分、作品集、認證狀態）
- [x] 建立 `listings` 表（專家上架的報價項目，含 AI Tags）
- [x] 修改 `projects` 表（新增 owner_id, status 欄位）
- [x] 建立 RLS policies（用戶只能存取自己資料）

### Phase 1.3 - 介面與導航（Week 1-2）✅
- [x] 建立統一導航系統 `site-header.js`，根據登入狀態顯示不同選單
- [x] 已登入用戶顯示個人資訊下拉選單（頭像 + 姓名）
- [x] 未登入用戶顯示「登入」按鈕
- [x] 新增「我的功能」下拉選單（我的報價、我的專案）
- [x] 新增專家控制台和媒合專案入口
- [x] 分層選單：專家功能 / 發案功能 / 設定
- [x] 新增聯絡資訊設定入口

### Phase 1.3.5 - 聯絡資訊系統（Week 2）✅
- [x] 建立 `contact_info` 表（詳細聯絡資訊 + 可見性控制）
  - 電話、手機、LINE、WeChat、Telegram ✅
  - Email、Facebook、Instagram、YouTube、LinkedIn ✅
  - 官網、作品集、公司資訊 ✅
  - 每項資訊獨立的「公開/隱藏」開關 ✅
  - 偏好聯絡方式（可複選）✅
  - 營業時間設定 ✅
- [x] 建立 `contact_unlocks` 表（解鎖記錄）
  - 記錄誰對誰解鎖、基於哪個媒合 ✅
  - 支援解鎖狀態管理（pending/accepted/expired）✅
  - 支援部分欄位解鎖 ✅
  - 可設定有效期限 ✅
- [x] 建立 `unlocked_contacts` 檢視（已解鎖聯絡資訊）
  - 自動根據權限過濾可見欄位 ✅
- [x] 建立聯絡資訊管理頁面 `profile/contact-info.html`
  - 完整表單（電話/即時通訊/社群/專業連結）✅
  - 每項資訊獨立的「媒合後公開」勾選 ✅
  - 隱私保護說明 ✅
  - 官網和作品集建議公開 ✅
- [x] 實作 RLS policies（隱私保護）
  - 用戶只能讀寫自己的聯絡資訊 ✅
  - 解鎖後才能看到對方資訊 ✅
- [x] 建立輔助函數 `check_contact_unlock_permission`

### Phase 1.4 - 專家端功能（Week 2）✅
- [x] 建立 `public/expert/dashboard.html`（專家控制台）
  - 統計卡片（報價數量、媒合專案、待處理、評分）✅
  - 快速動作區（新增報價、查看媒合、管理報價）✅
  - 最新媒合專案預覽 ✅
- [x] 建立 `public/expert/listing-form.html`（報價上架表單）
  - 品名、價格、分類（對應 ai_categories）✅
  - 服務說明、交期、單位 ✅
  - 儲存到 listings 表 ✅
  - 圖片上傳預覽（待改用 Supabase Storage）⏳
- [x] 建立 `public/expert/my-listings.html`（我的報價列表）
- [x] 建立 `public/expert/matched-projects.html`（被媒合的專案）
  - 媒合專案列表展示 ✅
  - 篩選與排序功能（狀態、分數、時間）✅
  - 媒合分數顯示與進度條 ✅
  - 聯繫客戶 Modal（報價、工期、留言）✅
  - 空狀態提示與引導 ✅

### Phase 1.5 - 發案者端功能（第二週前半，依階段二規劃）⏳
**對應新路線圖：階段二（兩端基本介面）**

**現況盤點：**
- [x] 圖片上傳功能（已有 index.html）
- [x] 建立 `public/client/my-projects.html`（我的專案列表）- 需檢查功能
- [x] 建立 `public/client/my-custom-products.html`（客製產品列表）
- [x] 建立 `public/client/custom-product-detail.html`（客製產品詳情）

**待完成（按新規劃順序）：**
- [ ] **階段一先做**：執行資料庫 Schema（profiles、matches、contact_unlocks、notifications）
- [ ] 建立 `public/client/dashboard.html`（發案者控制台）
  - 統計卡片
  - 最新專案與媒合列表
  - 快速操作按鈕
- [ ] 建立 `public/client/project-detail.html`（專案詳情）
  - 專案完整資訊
  - 媒合專家列表（準備接收媒合結果）
  - 預留申請聯繫按鈕
- [ ] 建立 `public/client/matched-experts.html`（查看媒合的專家）
- [ ] 檢查並完善 `my-projects.html`（確認 API 串接正確）

### Phase 1.6 - Supabase Storage 遷移（Week 2）
- [ ] 在 Supabase Dashboard 建立 Storage Bucket: `project-images`
- [ ] 在 Supabase Dashboard 建立 Storage Bucket: `custom-products`
- [ ] 修改 `server.js` 上傳邏輯（使用 Supabase Storage API）
- [ ] 建立遷移腳本：將 `uploads/` 檔案搬到 Supabase Storage
- [ ] 更新圖片 URL 格式（從本地路徑改為 Supabase public URL）
- [ ] 設定 Storage RLS policies（用戶只能上傳/讀取自己檔案）

### Phase 1.7 - 權限與保護（Week 3）
- [ ] 後台頁面加上登入保護（Supabase Auth）,避免匿名修改。
- [ ] 專家頁面需驗證 role='expert'
- [ ] 發案者頁面需驗證 role='client'
- [ ] API endpoints 加上 JWT 驗證

## Phase 2 (AI Core) — Edge Functions 串 Gemini
- [ ] 建立 Edge Function：`generate-listing-tags`（輸入品名／價格 → 回傳 8 個隱藏 Tags）。
- [ ] 建立 Edge Function：`extract-project-specs`（輸入 image_url → 3 個工項 × 每項 3 個規格 Tags）。
- [ ] 於前端串呼 Edge Functions，讓上架／上傳後能顯示 AI 結果並寫入 DB。
- [ ] 設計基本錯誤處理：AI 失敗時允許人工補充／重試。

## Phase 3 (Matching) — SQL 邏輯與排名
- [ ] 寫 PostgreSQL 函數／檢視：計算 `tags_overlap_count` + 價格適配度（範圍可調）。
- [ ] 建立 `matches` 表，保存比對結果（含 score、price_fit、created_at）。
- [ ] 在發案者端顯示候選廠商清單（按分數排序）。
- [ ] 在專家端顯示被媒合的專案與狀態。
- [ ] 加入「合做」按鈕 → 觸發解鎖聯繫（建立對話）。

## Phase 4 (Business) — 金流與期限
- [ ] 串 Stripe 或綠界：會員訂閱（月費）與單次刊登費。
- [ ] 建立 `payment-webhook` Edge Function，驗證與更新 `payments`／`listings` 狀態。
- [ ] 刊登期限：90 天到期通知／續期；定時任務掃描並標記 `expired`。
- [ ] 後台審核入口：專家身分審核、檢舉處理、熱門工項統計報表。

## 機能與前端細節
- [ ] 任務牆（專家端）：顯示 AI 媒合中的項目＋歷史「合做」紀錄。
- [ ] 私訊對話：建立 `conversations`，可使用 Supabase Realtime（channels）。
- [ ] 隱私控管：未解鎖前遮蔽廠商聯絡資訊；解鎖後僅雙方可見。
- [ ] 風控：建立檢舉入口與後台標記流程（`admin_flags`）。
- [ ] UI 文案校正：全站以「MatchDO 合做」為準（非「合作」）。

## 開發環境與建置
- [ ] 新增 `README.md`（專案啟動、環境變數、部署流程）。
- [ ] 規劃打包工具（建議 Vite + ES Modules；先以原生 JS 落地再逐步升級）。
- [ ] 撰寫最小單元測試（Edge Functions）與 SQL 檢視驗證。

## 技術決策紀錄

### 檔案儲存方案：Supabase Storage vs Google Cloud Storage
**決策**：採用 Supabase Storage  
**理由**：
1. 與 Supabase Auth 無縫整合,自動權限管理
2. JS SDK 簡單（3 行代碼 vs GCS 20+ 行）
3. 內建 CDN + 圖片轉換功能
4. 免費 1GB,超出後 $0.021/GB/月（vs GCS $0.023/GB/月）
5. 初期流量小,整合性 > 企業級功能

**何時考慮 GCS**：
- 月流量 > 10TB
- 需要跨 GCP 服務整合（BigQuery、Vertex AI）
- 需要企業 SLA 合約

## 里程碑核對與驗證
- [ ] P1 完成標準：Google 登入可用、角色區分正常、專家能上架報價、發案者能上傳圖片至 Supabase Storage、DB 寫入成功。
- [ ] P2 完成標準：AI 拆圖與隱藏 Tags 正常、JSON 結構落地。
- [ ] P3 完成標準：媒合 SQL 正確、候選清單排序合理、可合做並開啟對話。
- [ ] P4 完成標準：金流入帳、webhook 驗證成功、刊登期限管理可用。

---

## 下一步（優先順序建議）

### A. 資料層（本週）
- [x] 建立 `custom_products` 資料表（欄位：id、owner_id、title、description、reference_image_url、ai_image_url、analysis_json、status、created_at）。
- [x] 建立 `manufacturers` 資料表（欄位：id、name、categories、location、rating、contact_json、created_at）。
- [x] 建立對應 RLS policies（owner_id 可讀寫；公開欄位可讀）。
- [x] 建立 `custom_product_matches` 媒合記錄表。
- [x] 新增 5 筆示範廠商資料。

### B. API 層（本週）
- [x] `POST /api/custom-products`：儲存客製需求（文字/示意圖）
- [x] `GET /api/custom-products`：依登入者列出歷史紀錄
- [x] `GET /api/custom-products/:id`：取得單一產品詳情
- [x] `POST /api/custom-products/:id/match`：觸發媒合並儲存結果
- [x] `POST /api/custom-products/:id/contact`：建立「聯繫廠商」流程（先記錄事件）

### C. 前端（下週）
- [x] 客製產品歷史記錄頁面（列表）`/client/my-custom-products.html`
- [x] 客製產品詳細頁面 `custom-product-detail.html`（查看分析結果 + 媒合廠商）
- [x] 媒合結果呈現（依分數排序 + 一鍵聯繫）
- [x] AI 圖片生成錯誤處理 UI（重試、備援提示）
- [x] 導航選單新增「我的客製產品」入口

### D. 媒合邏輯（下週）
- [ ] 以 `analysis_json` 解析 tags 與需求條件
- [ ] 先用簡單規則媒合（類別 + 地區 + 產能）
- [ ] 儲存媒合結果（`matches` 或 `custom_product_matches`）
