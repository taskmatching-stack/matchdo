# MatchDO「合做」落地 TODO 清單（分階段）

更新日期：2026-02-05

### 今日更新（Delta）
- [x] 新增「客製產品」頁面與功能模組
- [x] 整合 Gemini 3 Pro Image Preview（AI 生成圖片）
- [x] 新增 `/api/generate-product-image` API（文字生成圖片）
- [x] 新增 `/api/analyze-custom-product` API（產品分析與廠商媒合）
- [x] 修改導航選單：「AI 估價」→「服務媒合」+ 新增「客製產品」
- [x] 更新架構文件：新增客製產品功能說明與資料表設計

### 架構調整說明
**雙軌並行模式**：
1. **服務媒合**（原有功能）：用戶上傳現場圖片 → AI 分析工項 → 找服務提供商
2. **客製產品**（新增功能）：用戶輸入描述/上傳示意圖 → AI 生成/分析產品 → 找訂製廠商

### 待完善項目
### 待完善項目
- [ ] 建立 `custom_products` 資料表
- [ ] 建立 `manufacturers` 廠商資料表
- [ ] 實作真實廠商媒合邏輯（目前為模擬資料）
- [ ] 完善 AI 圖片生成錯誤處理
- [ ] 新增產品分析結果儲存功能
- [ ] 實作「聯繫廠商」功能
- [ ] 客製產品歷史記錄頁面

舊項目（2026-02-04）：
- [x] 新增 `ai_categories` 資料表與初始種子（請在 Supabase SQL Editor 執行新增段落）。
- [x] 新增後台頁面：`public/admin/categories.html`（可編輯 key/名稱/提示詞/子分類）。
- [x] 新增 API：`GET /api/categories`、`PUT /api/categories`（前台載入、後台儲存）。
- [x] 前台改為優先從 API 載入分類，API 失敗時回退使用 `js/ai-categories.js`。
- [x] 導覽列新增「後台：分類管理」入口（首頁右側）。

後續建議：
- [ ] 後台頁面加上登入保護（Supabase Auth），避免匿名修改。
- [ ] 將 `js/ai-categories.js` 移除或改為純備援，避免雙重來源混淆。
- [ ] 新增基本審計紀錄（誰在何時修改了哪些分類）。

## Phase 1 (MVP) — 介面＋Auth＋Schema

### 決策紀錄（2026-02-05）
- **執行策略**：選項 A（完整雙邊市場：發案者 vs 專家）
- **登入方式**：Supabase Auth + Google OAuth
- **檔案儲存**：Supabase Storage（已比較 GCS，因整合性選用 Supabase）

### Phase 1.1 - Auth 系統（Week 1）✅
- [x] 在 Supabase Dashboard 啟用 Google OAuth Provider
- [x] 建立 `public/config/auth-config.js`（Supabase Auth SDK 初始化）
- [x] 建立 `public/login.html`（Google 登入頁面）
- [x] ~~建立 `public/register.html`~~（改為雙重身份，不需選角色）
- [x] 建立 `public/js/auth-middleware.js`（導航保護邏輯）
- [x] 修改首頁載入時檢查登入狀態並自動建立用戶

### Phase 1.2 - 資料表設計（Week 1）✅
- [x] 導入 Supabase 專案,建立 `.env` 並接 Supabase JS SDK（已完成連線）。
- [x] 建立 `users` 表（不限制角色，雙重身份）
- [x] 建立 `experts_profile` 表（專長、評分、作品集、認證狀態）
- [x] 建立 `listings` 表（專家上架的報價項目，含 AI Tags）
- [x] 修改 `projects` 表（新增 owner_id, status 欄位）
- [x] 建立 RLS policies（用戶只能存取自己資料）

### Phase 1.3 - 介面與導航（Week 1-2）✅
- [x] 建立統一導航系統 `site-header.js`，根據登入狀態顯示不同選單
- [x] 已登入用戶顯示個人資訊下拉選單（頭像 + 姓名）
- [x] 未登入用戶顯示「登入」按鈕
- [x] 新增「我的功能」下拉選單（我的報價、我的專案）

### Phase 1.4 - 專家端功能（Week 2）
- [ ] 建立 `public/expert/dashboard.html`（專家控制台）
- [ ] 建立 `public/expert/listing-form.html`（報價上架表單）
  - 品名、價格、分類（對應 ai_categories）
  - 服務說明、交期、備註
  - 儲存到 listings 表
- [ ] 建立 `public/expert/my-listings.html`（我的報價列表）
- [ ] 建立 `public/expert/matched-projects.html`（被媒合的專案）

### Phase 1.5 - 發案者端功能（Week 2）
- [ ] 建立 `public/client/dashboard.html`（發案者控制台）
- [x] 圖片上傳功能（已有 index.html，需改用 Supabase Storage）
- [ ] 建立 `public/client/my-projects.html`（我的專案列表）
- [ ] 建立 `public/client/matched-experts.html`（媒合到的專家）

### Phase 1.6 - Supabase Storage 遷移（Week 2）
- [ ] 在 Supabase Dashboard 建立 Storage Bucket: `project-images`
- [ ] 在 Supabase Dashboard 建立 Storage Bucket: `custom-products`
- [ ] 修改 `server.js` 上傳邏輯（使用 Supabase Storage API）
- [ ] 建立遷移腳本：將 `uploads/` 檔案搬到 Supabase Storage
- [ ] 更新圖片 URL 格式（從本地路徑改為 Supabase public URL）
- [ ] 設定 Storage RLS policies（用戶只能上傳/讀取自己檔案）

### Phase 1.7 - 權限與保護（Week 3）
- [ ] 後台頁面加上登入保護（Supabase Auth）,避免匿名修改。
- [ ] 專家頁面需驗證 role='expert'
- [ ] 發案者頁面需驗證 role='client'
- [ ] API endpoints 加上 JWT 驗證

## Phase 2 (AI Core) — Edge Functions 串 Gemini
- [ ] 建立 Edge Function：`generate-listing-tags`（輸入品名／價格 → 回傳 5 個隱藏 Tags）。
- [ ] 建立 Edge Function：`extract-project-specs`（輸入 image_url → 3 個工項 × 每項 3 個規格 Tags）。
- [ ] 於前端串呼 Edge Functions，讓上架／上傳後能顯示 AI 結果並寫入 DB。
- [ ] 設計基本錯誤處理：AI 失敗時允許人工補充／重試。

## Phase 3 (Matching) — SQL 邏輯與排名
- [ ] 寫 PostgreSQL 函數／檢視：計算 `tags_overlap_count` + 價格適配度（範圍可調）。
- [ ] 建立 `matches` 表，保存比對結果（含 score、price_fit、created_at）。
- [ ] 在發案者端顯示候選廠商清單（按分數排序）。
- [ ] 在專家端顯示被媒合的專案與狀態。
- [ ] 加入「合做」按鈕 → 觸發解鎖聯繫（建立對話）。

## Phase 4 (Business) — 金流與期限
- [ ] 串 Stripe 或綠界：會員訂閱（月費）與單次刊登費。
- [ ] 建立 `payment-webhook` Edge Function，驗證與更新 `payments`／`listings` 狀態。
- [ ] 刊登期限：90 天到期通知／續期；定時任務掃描並標記 `expired`。
- [ ] 後台審核入口：專家身分審核、檢舉處理、熱門工項統計報表。

## 機能與前端細節
- [ ] 任務牆（專家端）：顯示 AI 媒合中的項目＋歷史「合做」紀錄。
- [ ] 私訊對話：建立 `conversations`，可使用 Supabase Realtime（channels）。
- [ ] 隱私控管：未解鎖前遮蔽廠商聯絡資訊；解鎖後僅雙方可見。
- [ ] 風控：建立檢舉入口與後台標記流程（`admin_flags`）。
- [ ] UI 文案校正：全站以「MatchDO 合做」為準（非「合作」）。

## 開發環境與建置
- [ ] 新增 `README.md`（專案啟動、環境變數、部署流程）。
- [ ] 規劃打包工具（建議 Vite + ES Modules；先以原生 JS 落地再逐步升級）。
- [ ] 撰寫最小單元測試（Edge Functions）與 SQL 檢視驗證。

## 技術決策紀錄

### 檔案儲存方案：Supabase Storage vs Google Cloud Storage
**決策**：採用 Supabase Storage  
**理由**：
1. 與 Supabase Auth 無縫整合,自動權限管理
2. JS SDK 簡單（3 行代碼 vs GCS 20+ 行）
3. 內建 CDN + 圖片轉換功能
4. 免費 1GB,超出後 $0.021/GB/月（vs GCS $0.023/GB/月）
5. 初期流量小,整合性 > 企業級功能

**何時考慮 GCS**：
- 月流量 > 10TB
- 需要跨 GCP 服務整合（BigQuery、Vertex AI）
- 需要企業 SLA 合約

## 里程碑核對與驗證
- [ ] P1 完成標準：Google 登入可用、角色區分正常、專家能上架報價、發案者能上傳圖片至 Supabase Storage、DB 寫入成功。
- [ ] P2 完成標準：AI 拆圖與隱藏 Tags 正常、JSON 結構落地。
- [ ] P3 完成標準：媒合 SQL 正確、候選清單排序合理、可合做並開啟對話。
- [ ] P4 完成標準：金流入帳、webhook 驗證成功、刊登期限管理可用。
