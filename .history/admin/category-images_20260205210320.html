<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="utf-8">
    <title>分類圖片管理 - MatchDO 管理後台</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <!-- Favicon -->
    <link href="/iStudio-1.0.0/img/favicon.ico" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&family=Space+Grotesk&display=swap" rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="/iStudio-1.0.0/css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="/iStudio-1.0.0/css/style.css" rel="stylesheet">

    <!-- Supabase Auth -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/config/auth-config.js"></script>
    <script src="/js/auth-middleware.js"></script>
    <script src="/iStudio-1.0.0/js/site-header.js"></script>
</head>

<body>
    <!-- 共用導覽 -->
    <div id="site-header"></div>

    <!-- Page Header Start -->
    <div class="container-fluid bg-primary py-2">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="text-white mb-0">
                    <i class="fas fa-images me-2"></i>分類預設圖片管理
                </h3>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb bg-transparent mb-0">
                        <li class="breadcrumb-item"><a class="text-white" href="/">首頁</a></li>
                        <li class="breadcrumb-item"><a class="text-white" href="/admin/index.html">管理後台</a></li>
                        <li class="breadcrumb-item text-white active">分類圖片管理</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
    <!-- Page Header End -->

    <!-- Main Content Start -->
    <div class="container-xxl py-3">
        <div class="container">
            <!-- 說明區塊 -->
            <div class="alert alert-info mb-4">
                <h5 class="alert-heading">
                    <i class="fas fa-info-circle me-2"></i>分類預設圖片說明
                </h5>
                <p class="mb-2">為每個專案分類設置預設封面圖片，當使用者建立專案時會自動使用對應的預設圖。</p>
                <ul class="mb-0">
                    <li>建議尺寸：<strong>1200 x 800 px</strong>（3:2 比例）</li>
                    <li>檔案格式：JPG、PNG 或 WebP</li>
                    <li>檔案大小：< 500KB</li>
                    <li>風格：專業、清晰、符合分類主題</li>
                </ul>
            </div>

            <!-- 統計資訊 -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <h3 class="text-primary mb-2" id="totalCategories">0</h3>
                            <p class="text-muted mb-0">總分類數</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <h3 class="text-success mb-2" id="uploadedImages">0</h3>
                            <p class="text-muted mb-0">已上傳圖片</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <h3 class="text-warning mb-2" id="defaultImages">0</h3>
                            <p class="text-muted mb-0">使用預設圖</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <button class="btn btn-primary w-100" onclick="uploadBulkImages()">
                                <i class="fas fa-cloud-upload-alt me-2"></i>批量上傳
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 分類列表 -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="mb-0">分類圖片列表</h5>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" id="searchInput" 
                                       placeholder="搜尋分類名稱..." 
                                       onkeyup="filterCategories()">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- 載入中 -->
                    <div id="loadingSection" class="text-center py-5">
                        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
                        <p class="mt-3 text-muted">載入分類資料中...</p>
                    </div>

                    <!-- 分類網格 -->
                    <div id="categoriesGrid" class="row g-3 p-4 d-none">
                        <!-- 動態生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Main Content End -->

    <!-- 上傳圖片 Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-upload me-2"></i>上傳分類圖片
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">分類名稱</label>
                        <input type="text" class="form-control" id="modalCategoryName" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">目前圖片</label>
                        <div class="border rounded p-3 text-center">
                            <img id="modalCurrentImage" src="" class="img-fluid" 
                                 style="max-height: 300px; object-fit: contain;" alt="目前圖片">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">選擇新圖片</label>
                        <input type="file" class="form-control" id="modalFileInput" 
                               accept="image/*" onchange="previewImage(this)">
                        <small class="text-muted">建議尺寸：1200 x 800 px，檔案大小 < 500KB</small>
                    </div>
                    <div class="mb-3 d-none" id="previewSection">
                        <label class="form-label">預覽新圖片</label>
                        <div class="border rounded p-3 text-center">
                            <img id="modalPreviewImage" src="" class="img-fluid" 
                                 style="max-height: 300px; object-fit: contain;" alt="預覽">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="confirmUpload()">
                        <i class="fas fa-check me-2"></i>確認上傳
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Category Default Images Config -->
    <script src="/config/category-default-images.js"></script>

    <!-- Main Script -->
    <script>
        let currentUser = null;
        let currentCategory = null;
        let uploadModal = null;
        let allCategories = [];

        // 初始化
        document.addEventListener('DOMContentLoaded', async () => {
            // 檢查登入與權限
            if (!window.AuthService) {
                alert('認證服務未載入');
                window.location.href = '/login.html';
                return;
            }

            currentUser = await AuthService.getCurrentUser();
            if (!currentUser) {
                window.location.href = '/login.html';
                return;
            }

            // 檢查是否為管理員
            const isAdmin = await AuthService.isAdmin();
            if (!isAdmin) {
                alert('⚠️ 您沒有權限訪問此頁面');
                window.location.href = '/';
                return;
            }

            // 初始化 Modal
            uploadModal = new bootstrap.Modal(document.getElementById('uploadModal'));

            // 載入分類資料
            await loadCategories();
        });

        // 載入所有分類
        async function loadCategories() {
            try {
                // 從資料庫讀取主分類
                const { data: categories, error } = await AuthService.supabase
                    .from('ai_categories')
                    .select('*')
                    .is('parent_key', null)
                    .order('name', { ascending: true });
                
                if (error) {
                    console.error('資料庫查詢錯誤:', error);
                    throw error;
                }
                
                if (!categories || categories.length === 0) {
                    document.getElementById('loadingSection').innerHTML = 
                        '<p class="text-muted text-center py-5">資料庫中暫無分類資料</p>';
                    document.getElementById('loadingSection').classList.remove('d-none');
                    return;
                }
                
                console.log('從資料庫載入:', categories.length, '個主分類');
                
                // 展開成主分類 + 子分類的扁平陣列
                allCategories = [];
                
                categories.forEach(cat => {
                    const imageUrl = cat.image_url || CategoryDefaultImages[cat.name] || CategoryDefaultImages.default;
                    
                    // 加入主分類
                    allCategories.push({
                        id: cat.key,
                        name: cat.name,
                        key: cat.key,
                        isParent: true,
                        imageUrl: imageUrl,
                        isUploaded: !!cat.image_url,
                        description: `主分類 - ${cat.name}`
                    });
                    
                    // 展開子分類（從 subcategories jsonb 陣列）
                    if (cat.subcategories && Array.isArray(cat.subcategories) && cat.subcategories.length > 0) {
                        cat.subcategories.forEach((subName, index) => {
                            const subImageUrl = CategoryDefaultImages[subName] || CategoryDefaultImages.default;
                            allCategories.push({
                                id: `${cat.key}_sub_${index}`,
                                name: subName,
                                parentKey: cat.key,
                                parentName: cat.name,
                                isParent: false,
                                imageUrl: subImageUrl,
                                isUploaded: false,
                                description: `${cat.name} > ${subName}`
                            });
                        });
                    }
                });

                console.log('載入分類成功:', allCategories.length, '個（主分類:', categories.length, '個，子分類:', allCategories.length - categories.length, '個）');

                // 更新統計
                document.getElementById('totalCategories').textContent = allCategories.length;
                document.getElementById('uploadedImages').textContent = 
                    allCategories.filter(c => c.isUploaded).length;
                document.getElementById('defaultImages').textContent = 
                    allCategories.filter(c => !c.isUploaded).length;

                // 顯示分類網格
                renderCategories(allCategories);

                // 隱藏載入中
                document.getElementById('loadingSection').classList.add('d-none');
                document.getElementById('categoriesGrid').classList.remove('d-none');

            } catch (error) {
                console.error('載入分類失敗:', error);
                document.getElementById('loadingSection').innerHTML = `
                    <div class="alert alert-danger m-4">
                        <h5>載入失敗</h5>
                        <p>錯誤訊息：${error.message}</p>
                        <p class="mb-0">請檢查：</p>
                        <ul>
                            <li>ai_categories 表是否存在</li>
                            <li>是否有查詢權限</li>
                            <li>RLS policies 是否正確設定</li>
                        </ul>
                    </div>
                `;
            }
        }

        // 渲染分類網格
        function renderCategories(categories) {
            const grid = document.getElementById('categoriesGrid');
            
            // 分組：主分類和子分類
            const parentCategories = categories.filter(c => c.isParent);
            const childCategories = categories.filter(c => !c.isParent);
            
            let html = '';
            
            // 先顯示主分類
            if (parentCategories.length > 0) {
                html += '<div class="col-12"><h5 class="text-primary"><i class="fas fa-folder me-2"></i>主分類</h5><hr></div>';
                html += parentCategories.map(category => renderCategoryCard(category)).join('');
            }
            
            // 再顯示子分類
            if (childCategories.length > 0) {
                html += '<div class="col-12 mt-4"><h5 class="text-success"><i class="fas fa-folder-open me-2"></i>子分類</h5><hr></div>';
                html += childCategories.map(category => renderCategoryCard(category)).join('');
            }

            grid.innerHTML = html;
        }
        
        // 渲染單一分類卡片
        function renderCategoryCard(category) {
            return `
                <div class="col-md-4 col-lg-3 category-card" data-category="${category.name}">
                    <div class="card h-100 border-0 shadow-sm">
                        <div class="position-relative">
                            <img src="${category.imageUrl}" class="card-img-top" 
                                 alt="${category.name}" 
                                 style="height: 200px; object-fit: cover;"
                                 onerror="this.src='/iStudio-1.0.0/img/categories/default-project.svg'">
                            <span class="position-absolute top-0 start-0 m-2 badge ${category.isParent ? 'bg-primary' : 'bg-success'}">
                                ${category.isParent ? '主分類' : '子分類'}
                            </span>
                            <span class="position-absolute top-0 end-0 m-2 badge ${category.isUploaded ? 'bg-success' : 'bg-warning'}">
                                ${category.isUploaded ? '已上傳' : '預設圖'}
                            </span>
                        </div>
                        <div class="card-body">
                            <h6 class="card-title mb-2">${category.name}</h6>
                            ${category.description ? `<small class="text-muted d-block mb-2">${category.description}</small>` : ''}
                            <div class="d-grid gap-2">
                                <button class="btn btn-sm btn-primary" onclick="openUploadModal('${category.id}', '${category.name}')">
                                    <i class="fas fa-upload me-1"></i>更換圖片
                                </button>
                                ${category.isUploaded ? `
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteImage('${category.id}', '${category.name}')">
                                        <i class="fas fa-trash me-1"></i>刪除
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 搜尋過濾
        function filterCategories() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const cards = document.querySelectorAll('.category-card');

            cards.forEach(card => {
                const categoryName = card.dataset.category.toLowerCase();
                if (categoryName.includes(searchTerm)) {
                    card.classList.remove('d-none');
                } else {
                    card.classList.add('d-none');
                }
            });
        }

        // 開啟上傳 Modal
        function openUploadModal(categoryId, categoryName) {
            currentCategory = { id: categoryId, name: categoryName };
            const category = allCategories.find(c => c.id === categoryId);

            document.getElementById('modalCategoryName').value = categoryName;
            document.getElementById('modalCurrentImage').src = category.imageUrl;
            document.getElementById('modalFileInput').value = '';
            document.getElementById('previewSection').classList.add('d-none');

            uploadModal.show();
        }

        // 預覽圖片
        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    document.getElementById('modalPreviewImage').src = e.target.result;
                    document.getElementById('previewSection').classList.remove('d-none');
                };
                
                reader.readAsDataURL(input.files[0]);
            }
        }

        // 確認上傳
        async function confirmUpload() {
            const fileInput = document.getElementById('modalFileInput');
            const file = fileInput.files[0];

            if (!file) {
                alert('請選擇圖片檔案');
                return;
            }

            // 檢查檔案大小
            if (file.size > 500 * 1024) {
                alert('檔案大小不可超過 500KB');
                return;
            }

            try {
                // 顯示載入中
                const btn = event.target;
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>上傳中...';

                // 上傳到 Supabase Storage
                const fileName = `categories/${currentCategory.name.replace(/\s+/g, '-').toLowerCase()}-${Date.now()}.${file.name.split('.').pop()}`;
                const { data, error } = await AuthService.supabase.storage
                    .from('project-images')
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: true
                    });

                if (error) throw error;

                // 取得公開 URL
                const { data: { publicUrl } } = AuthService.supabase.storage
                    .from('project-images')
                    .getPublicUrl(fileName);

                // 更新資料庫（使用 key 而不是 id）
                const { error: updateError } = await AuthService.supabase
                    .from('ai_categories')
                    .update({ image_url: publicUrl })
                    .eq('key', currentCategory.id);
                
                if (updateError) throw updateError;

                alert('✅ 圖片已更新！');
                uploadModal.hide();
                
                // 重新載入
                location.reload();

            } catch (error) {
                console.error('上傳失敗:', error);
                alert('❌ 上傳失敗：' + error.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check me-2"></i>確認上傳';
            }
        }

        // 更新分類圖片（已整合到上方）

        // 刪除圖片
        async function deleteImage(categoryId, categoryName) {
            if (!confirm(`確定要刪除「${categoryName}」的圖片嗎？將恢復為預設圖。`)) {
                return;
            }

            try {
                // 更新資料庫，清除 image_url（使用 key）
                const { error } = await AuthService.supabase
                    .from('ai_categories')
                    .update({ image_url: null })
                    .eq('key', categoryId);
                
                if (error) throw error;
                
                alert('✅ 已恢復為預設圖片');
                location.reload();
            } catch (error) {
                console.error('刪除失敗:', error);
                alert('❌ 刪除失敗：' + error.message);
            }
        }

        // 批量上傳
        function uploadBulkImages() {
            alert('批量上傳功能開發中\n\n您可以：\n1. 將圖片命名為分類名稱\n2. 一次選擇多個檔案\n3. 自動匹配對應分類');
        }
    </script>
</body>

</html>
