<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Session æ¸¬è©¦</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #f5f5f5;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        pre {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-success { background: #28a745; color: white; }
    </style>
</head>
<body>
    <h1>ğŸ” Supabase Session æ¸¬è©¦å·¥å…·</h1>
    
    <div class="section">
        <h2>1. localStorage ä¸­çš„ Session</h2>
        <button class="btn-success" onclick="checkLocalStorage()">æª¢æŸ¥ localStorage</button>
        <button class="btn-danger" onclick="clearLocalStorage()">æ¸…é™¤ localStorage</button>
        <pre id="localStorage-output">é»æ“ŠæŒ‰éˆ•æª¢æŸ¥...</pre>
    </div>

    <div class="section">
        <h2>2. Supabase getSession()</h2>
        <button class="btn-success" onclick="checkSupabaseSession()">æª¢æŸ¥ Supabase Session</button>
        <pre id="supabase-session-output">é»æ“ŠæŒ‰éˆ•æª¢æŸ¥...</pre>
    </div>

    <div class="section">
        <h2>3. Supabase getUser()</h2>
        <button class="btn-success" onclick="checkSupabaseUser()">æª¢æŸ¥ç•¶å‰ç”¨æˆ¶</button>
        <pre id="supabase-user-output">é»æ“ŠæŒ‰éˆ•æª¢æŸ¥...</pre>
    </div>

    <div class="section">
        <h2>4. å¿«é€Ÿæ¸¬è©¦ç™»å…¥</h2>
        <input type="email" id="test-email" placeholder="Email" style="padding: 8px; width: 200px;">
        <input type="password" id="test-password" placeholder="å¯†ç¢¼" style="padding: 8px; width: 200px;">
        <button class="btn-primary" onclick="testLogin()">æ¸¬è©¦ç™»å…¥</button>
        <button class="btn-danger" onclick="testLogout()">æ¸¬è©¦ç™»å‡º</button>
        <pre id="test-output"></pre>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">
        import AuthService from '/js/auth-service.js';
        window.AuthService = AuthService;
        window.supabaseClient = AuthService.supabase;

        window.checkLocalStorage = function() {
            const output = document.getElementById('localStorage-output');
            const keys = Object.keys(localStorage).filter(key => key.includes('supabase'));
            
            if (keys.length === 0) {
                output.textContent = 'âŒ æ²’æœ‰æ‰¾åˆ° Supabase ç›¸é—œçš„ localStorage é …ç›®';
                return;
            }

            let result = `âœ… æ‰¾åˆ° ${keys.length} å€‹ Supabase localStorage é …ç›®:\n\n`;
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                result += `Key: ${key}\n`;
                try {
                    const parsed = JSON.parse(value);
                    result += `Value: ${JSON.stringify(parsed, null, 2)}\n\n`;
                } catch (e) {
                    result += `Value: ${value}\n\n`;
                }
            });
            output.textContent = result;
        };

        window.clearLocalStorage = function() {
            const keys = Object.keys(localStorage).filter(key => key.includes('supabase'));
            keys.forEach(key => localStorage.removeItem(key));
            alert(`âœ… å·²æ¸…é™¤ ${keys.length} å€‹ Supabase localStorage é …ç›®`);
            checkLocalStorage();
        };

        window.checkSupabaseSession = async function() {
            const output = document.getElementById('supabase-session-output');
            output.textContent = 'â³ æ­£åœ¨æª¢æŸ¥...';
            
            try {
                const { data, error } = await window.supabaseClient.auth.getSession();
                if (error) {
                    output.textContent = `âŒ éŒ¯èª¤: ${error.message}\n\n${JSON.stringify(error, null, 2)}`;
                } else if (data.session) {
                    output.textContent = `âœ… Session å­˜åœ¨:\n\n${JSON.stringify({
                        user: {
                            id: data.session.user.id,
                            email: data.session.user.email
                        },
                        access_token: data.session.access_token.substring(0, 50) + '...',
                        expires_at: new Date(data.session.expires_at * 1000).toLocaleString()
                    }, null, 2)}`;
                } else {
                    output.textContent = 'âš ï¸ Session ä¸å­˜åœ¨';
                }
            } catch (err) {
                output.textContent = `âŒ ç•°å¸¸: ${err.message}`;
            }
        };

        window.checkSupabaseUser = async function() {
            const output = document.getElementById('supabase-user-output');
            output.textContent = 'â³ æ­£åœ¨æª¢æŸ¥...';
            
            try {
                const { data, error } = await window.supabaseClient.auth.getUser();
                if (error) {
                    output.textContent = `âŒ éŒ¯èª¤: ${error.message}\n\n${JSON.stringify(error, null, 2)}`;
                } else if (data.user) {
                    output.textContent = `âœ… ç”¨æˆ¶å­˜åœ¨:\n\n${JSON.stringify({
                        id: data.user.id,
                        email: data.user.email,
                        created_at: data.user.created_at
                    }, null, 2)}`;
                } else {
                    output.textContent = 'âš ï¸ ç”¨æˆ¶ä¸å­˜åœ¨';
                }
            } catch (err) {
                output.textContent = `âŒ ç•°å¸¸: ${err.message}`;
            }
        };

        window.testLogin = async function() {
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;
            const output = document.getElementById('test-output');
            
            if (!email || !password) {
                output.textContent = 'âŒ è«‹è¼¸å…¥ email å’Œå¯†ç¢¼';
                return;
            }

            output.textContent = 'â³ æ­£åœ¨ç™»å…¥...';
            
            try {
                const result = await AuthService.signInWithEmail(email, password);
                output.textContent = `âœ… ç™»å…¥æˆåŠŸ!\n\n${JSON.stringify({
                    user: {
                        id: result.user.id,
                        email: result.user.email
                    },
                    session_exists: !!result.session
                }, null, 2)}`;
                
                // è‡ªå‹•æª¢æŸ¥ localStorage å’Œ session
                setTimeout(() => {
                    checkLocalStorage();
                    checkSupabaseSession();
                    checkSupabaseUser();
                }, 500);
            } catch (err) {
                output.textContent = `âŒ ç™»å…¥å¤±æ•—: ${err.message}`;
            }
        };

        window.testLogout = async function() {
            const output = document.getElementById('test-output');
            output.textContent = 'â³ æ­£åœ¨ç™»å‡º...';
            
            try {
                await AuthService.signOut();
                output.textContent = 'âœ… ç™»å‡ºæˆåŠŸ!';
                
                // è‡ªå‹•æª¢æŸ¥
                setTimeout(() => {
                    checkLocalStorage();
                    checkSupabaseSession();
                    checkSupabaseUser();
                }, 500);
            } catch (err) {
                output.textContent = `âŒ ç™»å‡ºå¤±æ•—: ${err.message}`;
            }
        };

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥
        window.addEventListener('load', () => {
            checkLocalStorage();
            checkSupabaseSession();
            checkSupabaseUser();
        });
    </script>
</body>
</html>
