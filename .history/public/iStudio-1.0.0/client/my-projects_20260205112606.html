<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="utf-8">
    <title>我的專案 - MatchDO 合做</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <!-- Favicon -->
    <link href="../img/favicon.ico" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&family=Space+Grotesk&display=swap" rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="../css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="../css/style.css" rel="stylesheet">
</head>

<body>
    <!-- 共用前台導覽 -->
    <div id="site-header"></div>

    <!-- Page Header Start -->
    <div class="container-fluid page-header py-2">
        <div class="container">
            <h1 class="display-3 text-white mb-3 animated slideInDown">我的專案</h1>
            <nav aria-label="breadcrumb animated slideInDown">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a class="text-white" href="../index.html">首頁</a></li>
                    <li class="breadcrumb-item text-white active" aria-current="page">我的專案</li>
                </ol>
            </nav>
        </div>
    </div>
    <!-- Page Header End -->

    <!-- My Projects Start -->
    <div class="container-xxl py-2">
        <div class="container">
            <div class="text-center mx-auto mb-3" style="max-width: 600px;">
                <h6 class="text-primary">My Projects</h6>
                <h1 class="mb-3">查看您的所有專案</h1>
            </div>

            <!-- 專案列表 -->
            <div id="projectsContainer">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">載入中...</span>
                    </div>
                    <p class="mt-3">載入專案中...</p>
                </div>
            </div>
        </div>
    </div>
    <!-- My Projects End -->

    <!-- Footer Start -->
    <div class="container-fluid bg-dark text-body footer mt-3 pt-3">
        <div class="container py-3">
            <div class="row g-5">
                <div class="col-lg-12 text-center">
                    <p class="mb-0">&copy; <a class="text-primary" href="#">MatchDO 合做</a>. All Rights Reserved.</p>
                </div>
            </div>
        </div>
    </div>
    <!-- Footer End -->

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Supabase Auth -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/config/auth-config.js"></script>
    <script src="/js/auth-middleware.js"></script>
    <script src="../js/site-header.js"></script>

    <script>
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async () => {
            // 檢查登入狀態
            const isAuth = await AuthMiddleware.requireAuth();
            if (!isAuth) return;

            currentUser = await AuthService.getCurrentUser();
            loadMyProjects();
        });

        async function loadMyProjects() {
            const container = document.getElementById('projectsContainer');
            
            try {
                const { data: projects, error } = await supabaseClient
                    .from('projects')
                    .select('*')
                    .eq('owner_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!projects || projects.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <i class="bi bi-folder-x" style="font-size: 4rem; color: #ddd;"></i>
                            <h4 class="mt-3">尚無專案</h4>
                            <p class="text-muted">前往<a href="../index.html#ai-estimate">服務媒合</a>開始您的第一個專案</p>
                        </div>
                    `;
                    return;
                }

                const projectsHTML = projects.map(project => {
                    const statusBadge = {
                        'analyzing': '<span class="badge bg-info">分析中</span>',
                        'matched': '<span class="badge bg-success">已媒合</span>',
                        'in_progress': '<span class="badge bg-primary">進行中</span>',
                        'completed': '<span class="badge bg-secondary">已完成</span>',
                        'cancelled': '<span class="badge bg-danger">已取消</span>'
                    };

                    const analysisData = project.analysis || {};
                    const items = analysisData.items || [];

                    return `
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    ${project.images && project.images.length > 0 ? `
                                        <img src="${project.images[0]}" class="img-fluid rounded" alt="專案圖片">
                                    ` : `
                                        <div class="bg-light d-flex align-items-center justify-content-center rounded" style="height: 150px;">
                                            <i class="bi bi-image" style="font-size: 3rem; color: #ccc;"></i>
                                        </div>
                                    `}
                                </div>
                                <div class="col-md-9">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <h5 class="card-title">專案 #${project.id.substring(0, 8)}</h5>
                                        ${statusBadge[project.status] || statusBadge.analyzing}
                                    </div>
                                    
                                    ${project.category ? `<p class="mb-2"><strong>分類:</strong> ${project.category}</p>` : ''}
                                    
                                    ${items.length > 0 ? `
                                        <p class="mb-2"><strong>分析項目:</strong></p>
                                        <ul class="mb-3">
                                            ${items.slice(0, 3).map(item => `
                                                <li>${item.name || item.item_name} - ${item.estimated_price || 'N/A'}</li>
                                            `).join('')}
                                            ${items.length > 3 ? `<li class="text-muted">...等 ${items.length - 3} 項</li>` : ''}
                                        </ul>
                                    ` : ''}
                                    
                                    <div class="text-muted small">
                                        <i class="bi bi-clock me-1"></i>
                                        ${new Date(project.created_at).toLocaleString('zh-TW')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');

                container.innerHTML = projectsHTML;

            } catch (error) {
                console.error('載入專案失敗:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        載入失敗：${error.message}
                    </div>
                `;
            }
        }
    </script>
</body>

</html>
