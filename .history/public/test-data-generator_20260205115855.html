<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¬è©¦æ•¸æ“šç”Ÿæˆå™¨</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h2>ğŸ§ª æ¸¬è©¦æ•¸æ“šç”Ÿæˆå™¨</h2>
        <p class="text-muted">ç‚º MatchDO å¹³å°ç”Ÿæˆæ¸¬è©¦ç”¨çš„å°ˆæ¡ˆæ•¸æ“š</p>
        
        <div class="card">
            <div class="card-body">
                <button id="generateBtn" class="btn btn-primary btn-lg">
                    <i class="bi bi-play-fill"></i> ç”Ÿæˆæ¸¬è©¦æ•¸æ“š
                </button>
                <button id="clearBtn" class="btn btn-danger btn-lg ms-2">
                    <i class="bi bi-trash"></i> æ¸…é™¤æ‰€æœ‰æ¸¬è©¦æ•¸æ“š
                </button>
            </div>
        </div>

        <div id="output" class="mt-4">
            <pre id="log" class="bg-dark text-light p-3 rounded" style="min-height: 400px; max-height: 600px; overflow-y: auto;"></pre>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/config/auth-config.js"></script>
    <script src="/js/auth-middleware.js"></script>

    <script>
        const logEl = document.getElementById('log');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            logEl.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        const projectTemplates = [
            { title: 'å…¬å¸å½¢è±¡ç¶²ç«™è¨­è¨ˆ', description: 'éœ€è¦è¨­è¨ˆä¸€å€‹å°ˆæ¥­çš„ä¼æ¥­å½¢è±¡ç¶²ç«™ï¼ŒåŒ…å«é¦–é ã€é—œæ–¼æˆ‘å€‘ã€æœå‹™ä»‹ç´¹ã€è¯çµ¡æˆ‘å€‘ç­‰é é¢ã€‚éœ€æ”¯æ´RWDéŸ¿æ‡‰å¼è¨­è¨ˆã€‚', category: 'ç¶²é è¨­è¨ˆ', budget: 80000 },
            { title: 'é›»å•†å¹³å°é–‹ç™¼', description: 'å»ºç«‹å®Œæ•´çš„é›»å•†å¹³å°ï¼Œéœ€åŒ…å«å•†å“ç®¡ç†ã€è³¼ç‰©è»Šã€é‡‘æµä¸²æ¥ã€æœƒå“¡ç³»çµ±ç­‰åŠŸèƒ½ã€‚', category: 'APPé–‹ç™¼', budget: 300000 },
            { title: 'å“ç‰ŒLogoè¨­è¨ˆ', description: 'ç‚ºæ–°å‰µå…¬å¸è¨­è¨ˆå“ç‰ŒLogoï¼Œéœ€è¦3-5å€‹ææ¡ˆï¼Œå¯ä¿®æ”¹3æ¬¡ï¼ŒåŒ…å«åŸºæœ¬æ‡‰ç”¨ï¼ˆåç‰‡ã€ä¿¡å°ï¼‰ã€‚', category: 'Logoè¨­è¨ˆ', budget: 15000 },
            { title: 'è¾¦å…¬å®¤å®¤å…§è¨­è¨ˆ', description: 'ç´„30åªçš„è¾¦å…¬å®¤ç©ºé–“ï¼Œéœ€è¦è¦åŠƒå·¥ä½œå€ã€æœƒè­°å®¤å’Œä¼‘æ¯å€ã€‚é¢¨æ ¼å¸Œæœ›æ˜¯ç¾ä»£ç°¡ç´„ã€‚', category: 'å®¤å…§è¨­è¨ˆ', budget: 250000 },
            { title: 'ç”¢å“å®£å‚³å½±ç‰‡', description: 'æ‹æ”ä¸¦å‰ªè¼¯3åˆ†é˜çš„ç”¢å“ä»‹ç´¹å½±ç‰‡ï¼Œéœ€åŒ…å«è…³æœ¬æ’°å¯«ã€é…éŸ³ã€å­—å¹•ã€‚', category: 'å½±ç‰‡å‰ªè¼¯', budget: 50000 },
            { title: 'ç¤¾ç¾¤åª’é«”å»£å‘Šè¨­è¨ˆ', description: 'è¨­è¨ˆä¸€ç³»åˆ—FB/IGå»£å‘Šåœ–ç‰‡ï¼Œå…±20å¼µï¼ŒåŒ…å«æ–‡æ¡ˆæ’°å¯«ã€‚éœ€ç¬¦åˆå“ç‰Œèª¿æ€§ã€‚', category: 'å¹³é¢è¨­è¨ˆ', budget: 25000 },
            { title: 'SEOç¶²ç«™å„ªåŒ–', description: 'æ”¹å–„ç¶²ç«™SEOï¼Œæå‡é—œéµå­—æ’åï¼ŒåŒ…å«3å€‹æœˆçš„ç¶­è­·å’Œæœˆå ±ã€‚', category: 'SEOå„ªåŒ–', budget: 60000 },
            { title: 'å“ç‰Œè¡ŒéŠ·ç­–ç•¥è¦åŠƒ', description: 'åˆ¶å®šå®Œæ•´çš„å¹´åº¦è¡ŒéŠ·ç­–ç•¥ï¼ŒåŒ…å«å¸‚å ´åˆ†æã€ç«¶å“åˆ†æå’ŒåŸ·è¡Œè¨ˆç•«ã€‚', category: 'è¡ŒéŠ·ä¼åŠƒ', budget: 120000 }
        ];

        document.getElementById('generateBtn').addEventListener('click', async () => {
            logEl.textContent = '';
            log('ğŸš€ é–‹å§‹ç”Ÿæˆæ¸¬è©¦æ•¸æ“š...\n');

            try {
                // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
                const user = await AuthService.getCurrentUser();
                if (!user) {
                    log('è«‹å…ˆç™»å…¥ç³»çµ±', 'error');
                    alert('è«‹å…ˆç™»å…¥å¾Œå†ä½¿ç”¨æ­¤åŠŸèƒ½');
                    window.location.href = '/login.html';
                    return;
                }

                log(`ä½¿ç”¨ç”¨æˆ¶: ${user.email}`, 'success');
                log('');

                // ç”Ÿæˆå°ˆæ¡ˆ
                log('ğŸ“¦ é–‹å§‹ç”Ÿæˆæ¸¬è©¦å°ˆæ¡ˆ...');
                const projects = [];

                for (let i = 0; i < projectTemplates.length; i++) {
                    const template = projectTemplates[i];
                    const project = {
                        owner_id: user.id,
                        category: template.category,
                        budget: template.budget + Math.floor(Math.random() * 20000),
                        description: template.description,
                        status: ['analyzing', 'matched', 'in_progress'][Math.floor(Math.random() * 3)],
                        images: [],
                        analysis: {
                            summary: template.title,
                            items: []
                        },
                        created_at: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString()
                    };

                    const { data, error } = await supabaseClient
                        .from('projects')
                        .insert(project)
                        .select()
                        .single();

                    if (error) {
                        log(`å°ˆæ¡ˆ ${i + 1} å»ºç«‹å¤±æ•—: ${error.message}`, 'error');
                    } else {
                        projects.push(data);
                        log(`å°ˆæ¡ˆ ${i + 1}: ${template.title} (ID: ${data.id.substring(0, 8)}...)`, 'success');
                    }

                    // é¿å…è«‹æ±‚éå¿«
                    await new Promise(resolve => setTimeout(resolve, 200));
                }

                log('');
                log('='.repeat(50));
                log(`âœ¨ æ¸¬è©¦æ•¸æ“šç”Ÿæˆå®Œæˆï¼`, 'success');
                log('='.repeat(50));
                log(`ç¸½å…±å»ºç«‹: ${projects.length} å€‹å°ˆæ¡ˆ`, 'success');
                log('');
                log('ğŸ’¡ æ¥ä¸‹ä¾†å¯ä»¥:');
                log('   - è¨ªå•ã€Œæˆ‘çš„å°ˆæ¡ˆã€æŸ¥çœ‹åˆ—è¡¨');
                log('   - è¨ªå•ã€Œç™¼æ¡ˆæ§åˆ¶å°ã€æŸ¥çœ‹çµ±è¨ˆ');
                log('');

                if (projects.length > 0) {
                    log(`ğŸ”— æ¸¬è©¦é€£çµ:`);
                    log(`   æ§åˆ¶å°: /client/dashboard.html`);
                    log(`   å°ˆæ¡ˆåˆ—è¡¨: /client/my-projects.html`);
                    log(`   ç¬¬ä¸€å€‹å°ˆæ¡ˆ: /client/project-detail.html?id=${projects[0].id}`);
                }

            } catch (error) {
                log(`ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
                console.error(error);
            }
        });

        document.getElementById('clearBtn').addEventListener('click', async () => {
            if (!confirm('âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ¸¬è©¦æ•¸æ“šå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                return;
            }

            logEl.textContent = '';
            log('ğŸ—‘ï¸ é–‹å§‹æ¸…é™¤æ¸¬è©¦æ•¸æ“š...\n');

            try {
                const user = await AuthService.getCurrentUser();
                if (!user) {
                    log('è«‹å…ˆç™»å…¥ç³»çµ±', 'error');
                    return;
                }

                // åˆªé™¤ç•¶å‰ç”¨æˆ¶çš„æ‰€æœ‰å°ˆæ¡ˆ
                const { data, error } = await supabaseClient
                    .from('projects')
                    .delete()
                    .eq('owner_id', user.id)
                    .select();

                if (error) {
                    log(`æ¸…é™¤å¤±æ•—: ${error.message}`, 'error');
                } else {
                    log(`æˆåŠŸæ¸…é™¤ ${data?.length || 0} å€‹å°ˆæ¡ˆ`, 'success');
                }

            } catch (error) {
                log(`ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
            }
        });
    </script>
</body>
</html>
