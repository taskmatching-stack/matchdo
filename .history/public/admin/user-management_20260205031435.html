<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <title>ç”¨æˆ¶ç®¡ç† - MatchDO ç®¡ç†å¾Œå°</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <!-- Favicon -->
    <link href="../iStudio-1.0.0/img/favicon.ico" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="../iStudio-1.0.0/lib/animate/animate.min.css" rel="stylesheet">
    <link href="../iStudio-1.0.0/lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="../iStudio-1.0.0/css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="../iStudio-1.0.0/css/style.css" rel="stylesheet">

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../config/auth-config.js"></script>

    <style>
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        .role-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .action-buttons .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .table-responsive {
            max-height: calc(100vh - 400px);
            overflow-y: auto;
        }
        .filters {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
    </style>
</head>

<body>
    <!-- Site Header -->
    <div id="site-header"></div>

    <!-- Page Header Start -->
    <div class="container-fluid bg-primary py-2 mb-3">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h3 class="text-white mb-0">
                        <i class="fas fa-users-cog me-2"></i>ç”¨æˆ¶ç®¡ç†
                    </h3>
                </div>
                <div class="col-md-6 text-md-end">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb justify-content-md-end mb-0">
                            <li class="breadcrumb-item"><a href="index.html" class="text-white">ç®¡ç†å¾Œå°</a></li>
                            <li class="breadcrumb-item text-white active">ç”¨æˆ¶ç®¡ç†</li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>
    </div>
    <!-- Page Header End -->

    <!-- User Management Start -->
    <div class="container-xxl py-3">
        <div class="container">
            <!-- Statistics Cards -->
            <div class="row g-3 mb-3">
                <div class="col-lg-3 col-md-6">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <div class="bg-primary bg-gradient rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 50px; height: 50px;">
                                <i class="fas fa-users fa-lg text-white"></i>
                            </div>
                            <h4 class="mb-1" id="totalUsers">
                                <span class="spinner-border spinner-border-sm"></span>
                            </h4>
                            <small class="text-muted">ç¸½ç”¨æˆ¶æ•¸</small>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <div class="bg-success bg-gradient rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 50px; height: 50px;">
                                <i class="fas fa-user-check fa-lg text-white"></i>
                            </div>
                            <h4 class="mb-1" id="verifiedUsers">
                                <span class="spinner-border spinner-border-sm"></span>
                            </h4>
                            <small class="text-muted">å·²é©—è­‰ç”¨æˆ¶</small>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <div class="bg-info bg-gradient rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 50px; height: 50px;">
                                <i class="fas fa-user-tie fa-lg text-white"></i>
                            </div>
                            <h4 class="mb-1" id="adminUsers">
                                <span class="spinner-border spinner-border-sm"></span>
                            </h4>
                            <small class="text-muted">ç®¡ç†å“¡</small>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <div class="bg-warning bg-gradient rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 50px; height: 50px;">
                                <i class="fas fa-clock fa-lg text-white"></i>
                            </div>
                            <h4 class="mb-1" id="recentUsers">
                                <span class="spinner-border spinner-border-sm"></span>
                            </h4>
                            <small class="text-muted">æœ¬æœˆæ–°ç”¨æˆ¶</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters">
                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label small mb-1">æœå°‹ç”¨æˆ¶</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="å§“åã€Email...">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small mb-1">è§’è‰²ç¯©é¸</label>
                        <select class="form-select" id="roleFilter">
                            <option value="">å…¨éƒ¨è§’è‰²</option>
                            <option value="admin">ç®¡ç†å“¡</option>
                            <option value="user">ä¸€èˆ¬ç”¨æˆ¶</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small mb-1">ç‹€æ…‹ç¯©é¸</label>
                        <select class="form-select" id="statusFilter">
                            <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                            <option value="verified">å·²é©—è­‰</option>
                            <option value="unverified">æœªé©—è­‰</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" onclick="loadUsers()">
                            <i class="fas fa-search me-1"></i>æœå°‹
                        </button>
                    </div>
                </div>
            </div>

            <!-- Users Table -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>ç”¨æˆ¶åˆ—è¡¨
                        </h5>
                        <button class="btn btn-sm btn-primary" onclick="loadUsers()">
                            <i class="fas fa-sync-alt me-1"></i>é‡æ–°æ•´ç†
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="bg-light sticky-top">
                                <tr>
                                    <th style="width: 50px;">#</th>
                                    <th style="width: 60px;">é ­åƒ</th>
                                    <th>å§“å</th>
                                    <th>Email</th>
                                    <th style="width: 100px;">è§’è‰²</th>
                                    <th style="width: 100px;">ç‹€æ…‹</th>
                                    <th style="width: 150px;">è¨»å†Šæ™‚é–“</th>
                                    <th style="width: 180px;" class="text-center">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr>
                                    <td colspan="8" class="text-center py-5">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
                                        </div>
                                        <p class="mt-2 text-muted">è¼‰å…¥ç”¨æˆ¶è³‡æ–™ä¸­...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-white border-top">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted" id="userCount">å…± 0 ä½ç”¨æˆ¶</small>
                        <nav id="pagination"></nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- User Management End -->

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-edit me-2"></i>ç·¨è¼¯ç”¨æˆ¶
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editUserId">
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="editUserEmail" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">å§“å</label>
                        <input type="text" class="form-control" id="editUserName">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">è§’è‰² *</label>
                        <select class="form-select" id="editUserRole">
                            <option value="user">ä¸€èˆ¬ç”¨æˆ¶</option>
                            <option value="admin">ç®¡ç†å“¡</option>
                        </select>
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            ç®¡ç†å“¡å¯ä»¥å­˜å–ç®¡ç†å¾Œå°å’Œåˆ†é¡ç®¡ç†åŠŸèƒ½
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="saveUser()">
                        <i class="fas fa-save me-1"></i>å„²å­˜è®Šæ›´
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="container-fluid bg-dark text-light footer mt-5 pt-5 wow fadeIn" data-wow-delay="0.1s">
        <div class="container py-5">
            <div class="row g-5">
                <div class="col-lg-12 text-center">
                    <p class="mb-2">&copy; 2026 MatchDO åˆåš. All Rights Reserved.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Back to Top -->
    <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="bi bi-arrow-up"></i></a>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../iStudio-1.0.0/lib/wow/wow.min.js"></script>
    <script src="../iStudio-1.0.0/lib/easing/easing.min.js"></script>
    <script src="../iStudio-1.0.0/lib/waypoints/waypoints.min.js"></script>
    <script src="../iStudio-1.0.0/lib/owlcarousel/owl.carousel.min.js"></script>

    <!-- Template Javascript -->
    <script src="../iStudio-1.0.0/js/main.js"></script>
    <script src="../iStudio-1.0.0/js/site-header.js"></script>

    <!-- User Management Logic -->
    <script>
        let currentPage = 1;
        const pageSize = 20;

        $(document).ready(async function () {
            try {
                // ç¢ºä¿ AuthService å·²è¼‰å…¥
                if (!window.AuthService) {
                    console.error('AuthService æœªè¼‰å…¥');
                    alert('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                    return;
                }

                // æª¢æŸ¥ç™»å…¥ç‹€æ…‹å’Œç®¡ç†å“¡æ¬Šé™
                const { data: { user }, error: userError } = await AuthService.getUser();
                if (userError || !user) {
                    console.error('ç”¨æˆ¶æœªç™»å…¥:', userError);
                    window.location.href = '/login.html';
                    return;
                }

                // æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
                const profile = await AuthService.getUserProfile();
                const isAdmin = user.user_metadata?.role === 'admin' || profile?.role === 'admin';
                
                if (!isAdmin) {
                    alert('æ‚¨æ²’æœ‰æ¬Šé™è¨ªå•æ­¤é é¢');
                    window.location.href = '/iStudio-1.0.0/index.html';
                    return;
                }

                // è¼‰å…¥çµ±è¨ˆè³‡æ–™
                await loadStatistics();

                // è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨
                await loadUsers();

                // æœå°‹äº‹ä»¶
                $('#searchInput').on('keyup', function(e) {
                    if (e.key === 'Enter') {
                        loadUsers();
                    }
                });
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±æ•—:', error);
                alert('è¼‰å…¥å¤±æ•—ï¼š' + error.message);
                $('#totalUsers, #verifiedUsers, #adminUsers, #recentUsers').text('éŒ¯èª¤');
                $('#usersTableBody').html(`
                    <tr>
                        <td colspan="8" class="text-center py-5">
                            <div class="alert alert-danger mb-0">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                è¼‰å…¥å¤±æ•—ï¼š${error.message}
                            </div>
                        </td>
                    </tr>
                `);
                    </tr>
                `);
            }
        });

        async function loadStatistics() {
            try {
                console.log('é–‹å§‹è¼‰å…¥çµ±è¨ˆè³‡æ–™...');
                
                // ä½¿ç”¨ Auth Admin API å–å¾—æ‰€æœ‰ç”¨æˆ¶
                // æ³¨æ„ï¼šé€™éœ€è¦ç®¡ç†å“¡æ¬Šé™ï¼Œæˆ‘å€‘æ”¹ç”¨å®¢æˆ¶ç«¯å¯ç”¨çš„æ–¹æ³•
                
                // æš«æ™‚é¡¯ç¤ºéœæ…‹è³‡æ–™ï¼Œå› ç‚º profiles è¡¨ä¸å­˜åœ¨
                // å¯¦éš›ç’°å¢ƒéœ€è¦å…ˆå»ºç«‹ profiles è¡¨æˆ–ä½¿ç”¨ Auth Admin API
                
                $('#totalUsers').text('éœ€å»ºç«‹è¡¨');
                $('#verifiedUsers').text('éœ€å»ºç«‹è¡¨');
                $('#adminUsers').text('éœ€å»ºç«‹è¡¨');
                $('#recentUsers').text('éœ€å»ºç«‹è¡¨');

                // é¡¯ç¤ºæç¤º
                console.warn('profiles è¡¨ä¸å­˜åœ¨ï¼Œè«‹åŸ·è¡Œ docs/user-roles-schema.sql');

            } catch (error) {
                console.error('è¼‰å…¥çµ±è¨ˆå¤±æ•—:', error);
                $('#totalUsers, #verifiedUsers, #adminUsers, #recentUsers').text('éŒ¯èª¤');
            }
        }

        async function loadUsers() {
            const tbody = $('#usersTableBody');
            tbody.html(`
                <tr>
                    <td colspan="8" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2 text-muted">è¼‰å…¥ä¸­...</p>
                    </td>
                </tr>
            `);

            try {
                console.log('é–‹å§‹è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨...');
                
                const searchTerm = $('#searchInput').val().toLowerCase();
                const roleFilter = $('#roleFilter').val();
                const statusFilter = $('#statusFilter').val();

                // å»ºç«‹æŸ¥è©¢
                let query = AuthService.supabase
                    .from('profiles')
                    .select('*')
                    .order('created_at', { ascending: false });

                // å¥—ç”¨ç¯©é¸
                if (roleFilter) {
                    query = query.eq('role', roleFilter);
                }

                const { data: users, error } = await query;

                if (error) {
                    console.error('æŸ¥è©¢ç”¨æˆ¶åˆ—è¡¨å¤±æ•—:', error);
                    
                    // å¦‚æœ profiles è¡¨ä¸å­˜åœ¨ï¼Œé¡¯ç¤ºå»ºç«‹èªªæ˜
                    if (error.code === 'PGRST204' || error.message.includes('Could not find')) {
                        tbody.html(`
                    <tr>
                        <td colspan="8" class="text-center py-5">
                            <div class="alert alert-warning mb-4">
                                <i class="fas fa-database fa-3x mb-3"></i>
                                <h5><strong>éœ€è¦å»ºç«‹ profiles è¡¨</strong></h5>
                                <p class="mb-3">ç”¨æˆ¶ç®¡ç†åŠŸèƒ½éœ€è¦ profiles è¡¨ä¾†å„²å­˜ç”¨æˆ¶è³‡æ–™å’Œè§’è‰²ã€‚</p>
                                
                                <div class="text-start bg-light p-3 rounded mb-3">
                                    <strong>ğŸ“‹ å»ºç«‹æ­¥é©Ÿï¼š</strong>
                                    <ol class="mb-0 mt-2">
                                        <li>ç™»å…¥ Supabase Dashboard: <a href="https://uuhxyaggbrhaytmyaqmo.supabase.co" target="_blank">é–‹å•Ÿ</a></li>
                                        <li>é»æ“Šå·¦å´é¸å–®çš„ã€ŒSQL Editorã€</li>
                                        <li>é»æ“Šã€Œ+ New queryã€</li>
                                        <li>è¤‡è£½ä»¥ä¸‹æª”æ¡ˆçš„å…§å®¹ä¸¦è²¼ä¸ŠåŸ·è¡Œï¼š<br>
                                            <code>d:\\AIå»ºç«™\\ai-matching\\docs\\user-roles-schema.sql</code>
                                        </li>
                                        <li>é»æ“Šã€ŒRunã€åŸ·è¡Œ SQL</li>
                                        <li>å›åˆ°æ­¤é é¢é‡æ–°æ•´ç†</li>
                                    </ol>
                                </div>
                                
                                <div class="text-start bg-info bg-opacity-10 p-3 rounded">
                                    <strong>ğŸ’¡ å¿«é€Ÿå»ºç«‹ï¼ˆè¤‡è£½ä»¥ä¸‹ SQLï¼‰ï¼š</strong>
                                    <pre class="mb-0 mt-2" style="font-size: 0.85rem;">-- å»ºç«‹ profiles è¡¨
CREATE TABLE IF NOT EXISTS public.profiles (
    id uuid PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    email text,
    full_name text,
    avatar_url text,
    role text DEFAULT 'user' CHECK (role IN ('user', 'admin')),
    email_verified boolean DEFAULT false,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now()
);

-- å•Ÿç”¨ RLS
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

-- å…è¨±ç”¨æˆ¶æŸ¥çœ‹æ‰€æœ‰ profiles
CREATE POLICY "Users can view all profiles"
    ON public.profiles FOR SELECT
    USING (true);

-- å…è¨±ç”¨æˆ¶æ›´æ–°è‡ªå·±çš„ profile
CREATE POLICY "Users can update own profile"
    ON public.profiles FOR UPDATE
    USING (auth.uid() = id);

-- å…è¨±ç®¡ç†å“¡æ›´æ–°ä»»ä½• profile
CREATE POLICY "Admins can update any profile"
    ON public.profiles FOR UPDATE
    USING (
        EXISTS (
            SELECT 1 FROM public.profiles
            WHERE id = auth.uid() AND role = 'admin'
        )
    );

-- è‡ªå‹•å»ºç«‹ profile è§¸ç™¼å™¨
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger AS $$
BEGIN
    INSERT INTO public.profiles (id, email, full_name, avatar_url, email_verified)
    VALUES (
        new.id,
        new.email,
        COALESCE(new.raw_user_meta_data->>'full_name', new.email),
        new.raw_user_meta_data->>'avatar_url',
        new.email_confirmed_at IS NOT NULL
    );
    RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
    AFTER INSERT ON auth.users
    FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();

-- å°‡ç•¶å‰ç”¨æˆ¶è¨­ç‚ºç®¡ç†å“¡ï¼ˆè¨˜å¾—æ”¹ emailï¼‰
-- UPDATE public.profiles SET role = 'admin' WHERE email = 'liutsaiiu@gmail.com';</pre>
                                </div>
                                
                                <button class="btn btn-primary mt-3" onclick="location.reload()">
                                    <i class="fas fa-sync-alt me-2"></i>é‡æ–°æ•´ç†é é¢
                                </button>
                            </div>
                        </td>
                    </tr>
                `);
                        return;
                    }
                    
                    throw error;
                }

                console.log('æˆåŠŸå–å¾—ç”¨æˆ¶åˆ—è¡¨:', users);

                // å®¢æˆ¶ç«¯ç¯©é¸
                let filteredUsers = users || [];
                if (searchTerm) {
                    filteredUsers = filteredUsers.filter(u => 
                        (u.full_name || '').toLowerCase().includes(searchTerm) ||
                        (u.email || '').toLowerCase().includes(searchTerm)
                    );
                }
                if (statusFilter === 'verified') {
                    filteredUsers = filteredUsers.filter(u => u.email_verified);
                } else if (statusFilter === 'unverified') {
                    filteredUsers = filteredUsers.filter(u => !u.email_verified);
                }

                $('#userCount').text(`å…± ${filteredUsers.length} ä½ç”¨æˆ¶`);

                if (filteredUsers.length === 0) {
                    tbody.html(`
                        <tr>
                            <td colspan="8" class="text-center py-5">
                                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                <p class="text-muted">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ç”¨æˆ¶</p>
                            </td>
                        </tr>
                    `);
                    return;
                }

                // åˆ†é 
                const start = (currentPage - 1) * pageSize;
                const end = start + pageSize;
                const paginatedUsers = filteredUsers.slice(start, end);

                // é¡¯ç¤ºç”¨æˆ¶åˆ—è¡¨
                let html = '';
                paginatedUsers.forEach((user, index) => {
                    const avatarUrl = user.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.full_name || user.email)}&background=667eea&color=fff`;
                    const roleBadge = user.role === 'admin' 
                        ? '<span class="badge bg-danger role-badge">ç®¡ç†å“¡</span>'
                        : '<span class="badge bg-secondary role-badge">ç”¨æˆ¶</span>';
                    const statusBadge = user.email_verified
                        ? '<span class="badge bg-success role-badge">å·²é©—è­‰</span>'
                        : '<span class="badge bg-warning role-badge">æœªé©—è­‰</span>';

                    html += `
                        <tr>
                            <td>${start + index + 1}</td>
                            <td>
                                <img src="${avatarUrl}" class="user-avatar" alt="Avatar">
                            </td>
                            <td>${user.full_name || '<span class="text-muted">æœªè¨­å®š</span>'}</td>
                            <td>${user.email || ''}</td>
                            <td>${roleBadge}</td>
                            <td>${statusBadge}</td>
                            <td><small>${new Date(user.created_at).toLocaleDateString('zh-TW')}</small></td>
                            <td class="text-center action-buttons">
                                <button class="btn btn-sm btn-outline-primary" onclick="editUser('${user.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="viewUserDetails('${user.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });

                tbody.html(html);

                // ç”Ÿæˆåˆ†é 
                generatePagination(filteredUsers.length);

            } catch (error) {
                console.error('è¼‰å…¥ç”¨æˆ¶å¤±æ•—:', error);
                tbody.html(`
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <div class="alert alert-danger mb-0">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦
                            </div>
                        </td>
                    </tr>
                `);
            }
        }

        function generatePagination(totalCount) {
            const totalPages = Math.ceil(totalCount / pageSize);
            if (totalPages <= 1) {
                $('#pagination').html('');
                return;
            }

            let html = '<ul class="pagination pagination-sm mb-0">';
            
            // ä¸Šä¸€é 
            html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">Â«</a>
            </li>`;

            // é ç¢¼
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                    </li>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }

            // ä¸‹ä¸€é 
            html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">Â»</a>
            </li>`;

            html += '</ul>';
            $('#pagination').html(html);
        }

        function changePage(page) {
            currentPage = page;
            loadUsers();
        }

        async function editUser(userId) {
            try {
                const { data: user, error } = await AuthService.supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();

                if (error) throw error;

                $('#editUserId').val(user.id);
                $('#editUserEmail').val(user.email);
                $('#editUserName').val(user.full_name || '');
                $('#editUserRole').val(user.role || 'user');

                new bootstrap.Modal($('#editUserModal')).show();

            } catch (error) {
                console.error('è¼‰å…¥ç”¨æˆ¶è³‡æ–™å¤±æ•—:', error);
                alert('è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        async function saveUser() {
            const userId = $('#editUserId').val();
            const fullName = $('#editUserName').val();
            const role = $('#editUserRole').val();

            if (!userId) {
                alert('ç”¨æˆ¶ ID éŒ¯èª¤');
                return;
            }

            try {
                // æ›´æ–° profiles è¡¨
                const { error: profileError } = await AuthService.supabase
                    .from('profiles')
                    .update({
                        full_name: fullName,
                        role: role,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', userId);

                if (profileError) throw profileError;

                // å¦‚æœéœ€è¦åŒæ™‚æ›´æ–° auth.users çš„ metadata
                // éœ€è¦ä½¿ç”¨æœå‹™ç«¯ API (admin æ¬Šé™)
                // é€™è£¡å…ˆåªæ›´æ–° profiles è¡¨

                alert('ç”¨æˆ¶è³‡æ–™å·²æ›´æ–°ï¼');
                bootstrap.Modal.getInstance($('#editUserModal')).hide();
                
                await loadStatistics();
                await loadUsers();

            } catch (error) {
                console.error('å„²å­˜å¤±æ•—:', error);
                alert('å„²å­˜å¤±æ•—ï¼š' + error.message);
            }
        }

        function viewUserDetails(userId) {
            // TODO: å°å‘ç”¨æˆ¶è©³æƒ…é é¢æˆ–é¡¯ç¤ºè©³æƒ…æ¨¡æ…‹æ¡†
            alert('ç”¨æˆ¶è©³æƒ…åŠŸèƒ½é–‹ç™¼ä¸­...');
        }
    </script>
</body>
</html>
