<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="utf-8">
    <title>å°ˆæ¡ˆè©³æƒ… - MatchDO åˆåš</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <!-- Favicon -->
    <link href="/img/favicon.ico" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&family=Space+Grotesk&display=swap" rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="/css/style.css" rel="stylesheet">

    <!-- Supabase Auth -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/config/auth-config.js"></script>
    <script src="/js/auth-middleware.js"></script>
    <script src="/js/site-header.js"></script>
</head>

<body>
    <!-- å…±ç”¨å‰å°å°è¦½ -->
    <div id="site-header"></div>

    <!-- Page Header Start -->
    <div class="container-fluid bg-primary py-2">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="text-white mb-0">å°ˆæ¡ˆè©³æƒ…</h3>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb bg-transparent mb-0">
                        <li class="breadcrumb-item"><a class="text-white" href="/index.html">é¦–é </a></li>
                        <li class="breadcrumb-item"><a class="text-white" href="dashboard.html">æ§åˆ¶å°</a></li>
                        <li class="breadcrumb-item"><a class="text-white" href="my-projects.html">æˆ‘çš„å°ˆæ¡ˆ</a></li>
                        <li class="breadcrumb-item text-white active">å°ˆæ¡ˆè©³æƒ…</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
    <!-- Page Header End -->

    <!-- Project Detail Start -->
    <div class="container-xxl py-3">
        <div class="container">
            <!-- è¼‰å…¥ä¸­ -->
            <div id="loadingSection" class="text-center py-5">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
                <p class="mt-3 text-muted">è¼‰å…¥å°ˆæ¡ˆè³‡æ–™ä¸­...</p>
            </div>

            <!-- éŒ¯èª¤è¨Šæ¯ -->
            <div id="errorSection" class="d-none">
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-circle fa-4x text-warning mb-4"></i>
                    <h4 class="mb-3" id="errorMessage">è¼‰å…¥å¤±æ•—</h4>
                    <p class="text-muted mb-4">è«‹ç¢ºèªå°ˆæ¡ˆ ID æ˜¯å¦æ­£ç¢ºï¼Œæˆ–å¾å°ˆæ¡ˆåˆ—è¡¨é¸æ“‡è¦æŸ¥çœ‹çš„å°ˆæ¡ˆ</p>
                    <div class="d-flex gap-2 justify-content-center">
                        <a href="/client/my-projects.html" class="btn btn-primary">
                            <i class="fas fa-list me-2"></i>è¿”å›å°ˆæ¡ˆåˆ—è¡¨
                        </a>
                        <a href="/index.html#ai-estimate" class="btn btn-success">
                            <i class="fas fa-plus me-2"></i>å»ºç«‹æ–°å°ˆæ¡ˆ
                        </a>
                    </div>
                </div>
            </div>

            <!-- å°ˆæ¡ˆå…§å®¹ -->
            <div id="projectContent" class="d-none">
                <!-- å°ˆæ¡ˆåŸºæœ¬è³‡è¨Š -->
                <div class="row mb-4">
                    <!-- å°ˆæ¡ˆå°é¢åœ–ç‰‡ -->
                    <div class="col-lg-4 mb-3">
                        <div class="card border-0 shadow-sm">
                            <img id="projectCoverImage" src="" class="card-img-top" alt="å°ˆæ¡ˆå°é¢" style="height: 300px; object-fit: cover;">
                            <div class="card-body">
                                <h6 class="mb-2">å°é¢åœ–ç‰‡</h6>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="uploadCoverImage()">
                                        <i class="fas fa-upload me-1"></i>ä¸Šå‚³ç…§ç‰‡
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="generateAICoverImage()">
                                        <i class="fas fa-magic me-1"></i>AI ç”Ÿæˆï¼ˆ20 é»ï¼‰
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="useDefaultImage()">
                                        <i class="fas fa-undo me-1"></i>ä½¿ç”¨é è¨­åœ–
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-8">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body p-4">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h2 class="mb-0" id="projectTitle">å°ˆæ¡ˆåç¨±</h2>
                                    <span id="projectStatus" class="badge bg-primary">é€²è¡Œä¸­</span>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <p class="text-muted mb-2">
                                            <i class="fas fa-tag me-2"></i>
                                            ä¸»åˆ†é¡ï¼š<span id="projectCategory">å±…å®¶</span>
                                        </p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="text-muted mb-2">
                                            <i class="fas fa-calendar me-2"></i>
                                            å»ºç«‹æ™‚é–“ï¼š<span id="projectCreated">2026-02-05</span>
                                        </p>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <h5 class="mb-2">å°ˆæ¡ˆæè¿°</h5>
                                    <p id="projectDescription" class="text-muted">å°ˆæ¡ˆæè¿°è¼‰å…¥ä¸­...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å³å´å¿«é€Ÿæ“ä½œç§»åˆ°ä¸‹æ–¹ -->
                </div>
                
                <!-- å¿«é€Ÿæ“ä½œ -->
                <div class="row mb-4">
                    <div class="col-lg-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body p-4">
                                <h5 class="mb-3">å¿«é€Ÿæ“ä½œ</h5>
                                <div class="d-flex gap-2 flex-wrap">
                                    <button class="btn btn-primary" onclick="editProject()">
                                        <i class="fas fa-edit me-2"></i>ç·¨è¼¯å°ˆæ¡ˆ
                                    </button>
                                    <button class="btn btn-success" onclick="manageItems()">
                                        <i class="fas fa-tasks me-2"></i>ç®¡ç†åˆ†åŒ…é …ç›®
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteProject()">
                                        <i class="fas fa-trash me-2"></i>åˆªé™¤å°ˆæ¡ˆ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- åˆ†åŒ…é …ç›®èˆ‡çµ±åŒ…çµ„åˆ -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-white py-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h4 class="mb-0">
                                        <i class="fas fa-boxes me-2 text-primary"></i>
                                        åˆ†åŒ…é …ç›®ç®¡ç†
                                    </h4>
                                    <button class="btn btn-primary btn-sm" onclick="addNewItem()">
                                        <i class="fas fa-plus me-1"></i>æ–°å¢é …ç›®
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-4">
                                <!-- æ‰¹é‡æ“ä½œæŒ‰éˆ• -->
                                <div class="mb-3" id="batchActionsBar" style="display: none;">
                                    <div class="d-flex gap-2">
                                        <span class="badge bg-secondary align-self-center" id="selectedCount">å·²é¸ 0 é …</span>
                                        <button class="btn btn-primary btn-sm" onclick="createPackageFromSelected()">
                                            <i class="fas fa-box me-1"></i>çµ„æˆçµ±åŒ…çµ„
                                        </button>
                                        <button class="btn btn-success btn-sm" onclick="publishSelectedItems()">
                                            <i class="fas fa-paper-plane me-1"></i>é€å‡ºåª’åˆ
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm" onclick="clearSelection()">
                                            <i class="fas fa-times me-1"></i>å–æ¶ˆé¸æ“‡
                                        </button>
                                    </div>
                                </div>

                                <!-- AI è¾¨è­˜é …ç›®è¡¨æ ¼ -->
                                <div id="projectItemsSection">
                                    <div class="table-responsive">
                                        <table class="table table-bordered" id="itemsTable">
                                            <thead>
                                                <tr>
                                                    <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)"></th>
                                                    <th>é …ç›®</th>
                                                    <th>è¦æ ¼</th>
                                                    <th>æ•¸é‡</th>
                                                    <th>å–®ä½</th>
                                                    <th>åˆªé™¤</th>
                                                </tr>
                                            </thead>
                                            <tbody id="itemsTableBody">
                                                <tr>
                                                    <td colspan="5" class="text-center text-muted">è¼‰å…¥ä¸­...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <button type="button" class="btn btn-secondary mb-2" id="addRow">æ–°å¢é …ç›®</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- åª’åˆå°ˆå®¶åˆ—è¡¨ -->
                <div class="row">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-white py-3">
                                <h4 class="mb-0">
                                    <i class="fas fa-user-tie me-2 text-success"></i>
                                    åª’åˆå°ˆå®¶åˆ—è¡¨
                                </h4>
                            </div>
                            <div class="card-body p-4">
                                <div id="matchedExpertsList">
                                    <p class="text-muted text-center py-5">
                                        <i class="fas fa-info-circle fa-3x mb-3 d-block"></i>
                                        å°šæœªé–‹å§‹åª’åˆï¼Œæˆ–æš«ç„¡ç¬¦åˆçš„å°ˆå®¶
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Project Detail End -->

    <!-- ç·¨è¼¯é …ç›® Modal -->
    <div class="modal fade" id="editItemModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-edit me-2"></i>ç·¨è¼¯é …ç›®
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editItemId">
                    
                    <div class="mb-3">
                        <label class="form-label">é …ç›®åç¨± *</label>
                        <input type="text" class="form-control" id="editItemName" placeholder="ä¾‹å¦‚ï¼šå®¢å»³æœ¨åœ°æ¿æ–½å·¥">
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">æ•¸é‡</label>
                                <input type="number" class="form-control" id="editItemQuantity" min="0" step="0.01" placeholder="ä¾‹å¦‚ï¼š30">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">å–®ä½</label>
                                <select class="form-select" id="editItemUnit">
                                    <option value="">è«‹é¸æ“‡å–®ä½</option>
                                    <option value="åª">åª</option>
                                    <option value="å¹³æ–¹å…¬å°º">å¹³æ–¹å…¬å°º</option>
                                    <option value="æ‰">æ‰</option>
                                    <option value="å¼">å¼</option>
                                    <option value="çµ„">çµ„</option>
                                    <option value="å€‹">å€‹</option>
                                    <option value="ä»¶">ä»¶</option>
                                    <option value="æ”¯">æ”¯</option>
                                    <option value="ç±³">ç±³</option>
                                    <option value="å…¬åˆ†">å…¬åˆ†</option>
                                    <option value="å°º">å°º</option>
                                    <option value="æ‰¹">æ‰¹</option>
                                    <option value="é …">é …</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">å‚™è¨»</label>
                        <textarea class="form-control" id="editItemDescription" rows="3" placeholder="è£œå……èªªæ˜..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="saveItemEdit()">
                        <i class="fas fa-save me-1"></i>å„²å­˜
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Back to Top -->
    <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="bi bi-arrow-up"></i></a>

    <!-- AI ç”Ÿæˆå°é¢åœ–ç‰‡ Modal -->
    <div class="modal fade" id="aiGenerateModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-magic me-2"></i>AI ç”Ÿæˆå°ˆæ¡ˆå°é¢åœ–ç‰‡
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- èªªæ˜ -->
                    <div class="alert alert-info mb-4">
                        <h6 class="alert-heading">
                            <i class="fas fa-info-circle me-2"></i>é—œæ–¼ AI ç”Ÿæˆå°é¢åœ–
                        </h6>
                        <p class="mb-0">
                            AI å°‡æ ¹æ“šæ‚¨çš„å°ˆæ¡ˆæè¿°ç”Ÿæˆä¸€å¼µå°ˆæ¥­çš„å°é¢åœ–ç‰‡ã€‚
                            æ‚¨å¯ä»¥é¸æ“‡æ˜¯å¦é¿é–‹æ©Ÿå¯†å…§å®¹ï¼Œä»¥ä¿è­·å•†æ¥­æ©Ÿå¯†ã€‚
                        </p>
                    </div>

                    <!-- å°ˆæ¡ˆå…§å®¹é è¦½ -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-file-alt me-2"></i>å°ˆæ¡ˆå…§å®¹é è¦½
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label text-muted">å°ˆæ¡ˆåç¨±</label>
                                <p class="mb-0" id="aiModalTitle">-</p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label text-muted">åˆ†é¡</label>
                                <p class="mb-0" id="aiModalCategory">-</p>
                            </div>
                            <div class="mb-0">
                                <label class="form-label text-muted">å°ˆæ¡ˆæè¿°</label>
                                <p class="mb-0" id="aiModalDescription" style="max-height: 150px; overflow-y: auto;">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- å°ˆæ¡ˆåœ–ç‰‡é è¦½ -->
                    <div class="card mb-3" id="aiModalImagesCard">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-images me-2"></i>å°ˆæ¡ˆåœ–ç‰‡ï¼ˆ<span id="imageCount">0</span> å¼µï¼‰
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="aiModalImages" class="row g-2">
                                <!-- å‹•æ…‹ç”Ÿæˆåœ–ç‰‡ç¸®åœ– -->
                            </div>
                        </div>
                    </div>

                    <!-- æ©Ÿå¯†å…§å®¹è¨­å®š -->
                    <div class="card mb-3 border-warning">
                        <div class="card-header bg-warning bg-opacity-10">
                            <h6 class="mb-0">
                                <i class="fas fa-shield-alt me-2"></i>æ©Ÿå¯†å…§å®¹ä¿è­·è¨­å®š
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="avoidConfidential" checked>
                                <label class="form-check-label" for="avoidConfidential">
                                    <strong>é¿é–‹æ©Ÿå¯†å…§å®¹ç”Ÿæˆ</strong>
                                    <small class="d-block text-muted mt-1">
                                        AI å°‡åªä½¿ç”¨åˆ†é¡ã€é¢¨æ ¼ç­‰åŸºæœ¬è³‡è¨Šç”Ÿæˆé€šç”¨ç¤ºæ„åœ–ï¼Œä¸æœƒåƒè€ƒæ‚¨çš„å…·é«”éœ€æ±‚æè¿°å’Œåœ–ç‰‡å…§å®¹
                                    </small>
                                </label>
                            </div>
                            
                            <div id="confidentialWarning" class="alert alert-warning mb-0 d-none">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>æ³¨æ„ï¼š</strong>å–æ¶ˆå‹¾é¸å¾Œï¼ŒAI å°‡åƒè€ƒæ‚¨çš„å®Œæ•´å°ˆæ¡ˆæè¿°å’Œåœ–ç‰‡å…§å®¹ç”Ÿæˆå°é¢åœ–ã€‚
                                è«‹ç¢ºä¿æ‚¨é¡˜æ„è®“ AI åˆ†æé€™äº›å…§å®¹ã€‚
                            </div>
                        </div>
                    </div>

                    <!-- AI ç”Ÿæˆæç¤ºè©é è¦½ -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-robot me-2"></i>AI ç”Ÿæˆåƒè€ƒè³‡è¨Š
                            </h6>
                        </div>
                        <div class="card-body">
                            <textarea id="aiPromptPreview" class="form-control" rows="4" readonly 
                                      style="font-size: 0.9rem; background-color: #f8f9fa;"></textarea>
                            <small class="text-muted d-block mt-2">
                                é€™æ˜¯ AI å°‡æœƒä½¿ç”¨çš„è³‡è¨Šæ‘˜è¦ã€‚æ‚¨å¯ä»¥æª¢æŸ¥å¾Œå†æ±ºå®šæ˜¯å¦ç”Ÿæˆã€‚
                            </small>
                        </div>
                    </div>

                    <!-- é»æ•¸æ¶ˆè€—æç¤º -->
                    <div class="alert alert-success mb-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-coins me-2"></i>
                                <strong>æ¶ˆè€—é»æ•¸ï¼š</strong>20 é»
                            </div>
                            <div>
                                <i class="fas fa-wallet me-2"></i>
                                <strong>ç›®å‰é¤˜é¡ï¼š</strong><span id="currentCredits">è¼‰å…¥ä¸­...</span> é»
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>å–æ¶ˆ
                    </button>
                    <button type="button" class="btn btn-primary" onclick="confirmAIGeneration()" id="confirmAIBtn">
                        <i class="fas fa-magic me-2"></i>ç¢ºèªç”Ÿæˆï¼ˆ20 é»ï¼‰
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/lib/wow/wow.min.js"></script>
    <script src="/lib/easing/easing.min.js"></script>
    <script src="/lib/waypoints/waypoints.min.js"></script>
    <script src="/lib/owlcarousel/owl.carousel.min.js"></script>
    <script src="/lib/isotope/isotope.pkgd.min.js"></script>
    <script src="/lib/lightbox/js/lightbox.min.js"></script>

    <!-- Template Javascript -->
    <script src="/js/main.js"></script>
    <script src="/js/site-header.js"></script>
    
    <!-- Category Default Images -->
    <script src="/config/category-default-images.js"></script>

    <!-- Project Detail Script -->
    <script>
        let currentUser = null;
        let projectId = null;
        let projectData = null;
        let aiGenerateModal = null;
        let allProjectItems = []; // å­˜å„²æ‰€æœ‰é …ç›®è³‡æ–™ä¾›ç·¨è¼¯ä½¿ç”¨

        // å¾ URL å–å¾—å°ˆæ¡ˆ ID
        function getProjectIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('=== Project Detail åˆå§‹åŒ–é–‹å§‹ ===');

                // æª¢æŸ¥ç™»å…¥
                if (!window.AuthService) {
                    console.error('âŒ AuthService æœªè¼‰å…¥ï¼');
                    window.location.href = '/login.html';
                    return;
                }

                currentUser = await AuthService.getCurrentUser();
                if (!currentUser) {
                    console.warn('âš ï¸ ç”¨æˆ¶æœªç™»å…¥');
                    window.location.href = '/login.html';
                    return;
                }

                // åˆå§‹åŒ– Modal
                aiGenerateModal = new bootstrap.Modal(document.getElementById('aiGenerateModal'));
                
                // ç›£è½æ©Ÿå¯†å…§å®¹é¸é …è®ŠåŒ–
                document.getElementById('avoidConfidential').addEventListener('change', updateAIPromptPreview);

                // å–å¾—å°ˆæ¡ˆ ID
                projectId = getProjectIdFromUrl();
                if (!projectId) {
                    showError('ç¼ºå°‘å°ˆæ¡ˆ ID');
                    return;
                }

                console.log('âœ… è¼‰å…¥å°ˆæ¡ˆ:', projectId);

                // è¼‰å…¥å°ˆæ¡ˆè³‡æ–™
                await loadProjectData();
                await loadProjectItems();
                await loadMatchedExperts();

                console.log('=== Project Detail åˆå§‹åŒ–å®Œæˆ ===');
            } catch (error) {
                console.error('ğŸ’¥ åˆå§‹åŒ–å¤±æ•—:', error);
                showError(error.message);
            }
        });

        // è¼‰å…¥å°ˆæ¡ˆè³‡æ–™
        async function loadProjectData() {
            try {
                const { data, error } = await AuthService.supabase
                    .from('projects')
                    .select('*')
                    .eq('id', projectId)
                    .eq('owner_id', currentUser.id)
                    .single();

                if (error) throw error;
                if (!data) throw new Error('å°ˆæ¡ˆä¸å­˜åœ¨æˆ–ç„¡æ¬Šé™æŸ¥çœ‹');

                projectData = data;

                // é¡¯ç¤ºå°ˆæ¡ˆè³‡è¨Š
                document.getElementById('projectTitle').textContent = data.title || 'æœªå‘½åå°ˆæ¡ˆ';
                document.getElementById('projectCreated').textContent = new Date(data.created_at).toLocaleDateString('zh-TW');
                
                // è§£æ description
                let descText = 'ç„¡æè¿°';
                let descItems = [];
                if (data.description) {
                    try {
                        const descJson = JSON.parse(data.description);
                        if (descJson.prompt) {
                            descText = `Prompt: ${descJson.prompt}\n\n`; 
                        }
                        if (descJson.items) {
                            descItems = descJson.items;
                        }
                        // å˜—è©¦å°‹æ‰¾æ›´å‹å–„çš„æ–‡å­—æè¿°ï¼Œå¦‚æœæ²’æœ‰ï¼Œå°±é¡¯ç¤º prompt
                    } catch (e) {
                        descText = data.description; // é JSONï¼Œç›´æ¥é¡¯ç¤º
                    }
                }
                
                document.getElementById('projectDescription').innerText = descText; // ä½¿ç”¨ innerText ä»¥ä¿ç•™æ›è¡Œï¼Œä½†ä¸åŸ·è¡Œ HTML

                // é¡¯ç¤ºå°é¢åœ–ç‰‡
                const coverImage = getProjectCoverImage(data);
                document.getElementById('projectCoverImage').src = coverImage;
                
                // ç‹€æ…‹æ¨™ç±¤
                const statusBadge = document.getElementById('projectStatus');
                const statusMap = {
                    'draft': { text: 'ç·¨è¼¯ä¸­', class: 'bg-info' }, // æ–°å¢ draft æ”¯æ´
                    'analyzing': { text: 'ç·¨è¼¯ä¸­', class: 'bg-info' }, // ç›¸å®¹ analyzing
                    'editing': { text: 'ç·¨è¼¯ä¸­', class: 'bg-info' }, // ç›¸å®¹ editing
                    'open': { text: 'å·²ç™¼ä½ˆ', class: 'bg-primary' }, // open æ”¹ç‚ºå·²ç™¼ä½ˆ
                    'in_progress': { text: 'æ–½å·¥ä¸­', class: 'bg-warning' },
                    'completed': { text: 'å·²å®Œæˆ', class: 'bg-success' },
                    'cancelled': { text: 'å·²å–æ¶ˆ', class: 'bg-secondary' }
                };
                const status = statusMap[data.status] || { text: 'æœªçŸ¥', class: 'bg-secondary' };
                statusBadge.textContent = status.text;
                statusBadge.className = `badge ${status.class}`;

                // é¡¯ç¤ºå…§å®¹å€
                document.getElementById('loadingSection').classList.add('d-none');
                document.getElementById('projectContent').classList.remove('d-none');
                
                // å¦‚æœ description è£¡æœ‰ itemsï¼Œæ‰‹å‹•è§¸ç™¼ loadProjectItems çš„éƒ¨åˆ†é‚è¼¯ (å¦‚æœ loadProjectItems æ˜¯è®€å– project_items è¡¨)
                // ç›®å‰è³‡æ–™åº«çµæ§‹çœ‹ä¾†ï¼Œå·¥é …æ˜¯å­˜åœ¨ projects.description (items) æˆ– projects.analysis (items) ä¸­
                // æˆ‘å€‘éœ€è¦ä¿®æ”¹ loadProjectItems ä¾†æ”¯æ´å¾ projectData è®€å–
                
            } catch (error) {
                console.error('âŒ è¼‰å…¥å°ˆæ¡ˆå¤±æ•—:', error);
                throw error;
            }
        }

        // è¼‰å…¥åª’åˆå°ˆå®¶åˆ—è¡¨
        async function loadMatchedExperts() {
            try {
                const { data: matches, error } = await AuthService.supabase
                    .from('matches')
                    .select(`
                        *,
                        expert_listings (
                            id,
                            title,
                            category,
                            subcategory,
                            price_min,
                            price_max,
                            expert_profiles:expert_id (
                                id,
                                full_name,
                                company_name,
                                avatar_url,
                                contact_info (
                                    phone,
                                    email,
                                    line_id,
                                    address
                                )
                            )
                        )
                    `)
                    .eq('project_id', projectId)
                    .order('match_score', { ascending: false });

                if (error) throw error;

                if (!matches || matches.length === 0) {
                    return; // ä¿æŒé è¨­çš„ã€Œæš«ç„¡ç¬¦åˆå°ˆå®¶ã€è¨Šæ¯
                }

                renderMatchedExperts(matches);

            } catch (error) {
                console.error('âŒ è¼‰å…¥åª’åˆå°ˆå®¶å¤±æ•—:', error);
            }
        }

        // æ¸²æŸ“åª’åˆå°ˆå®¶åˆ—è¡¨
        function renderMatchedExperts(matches) {
            const container = document.getElementById('matchedExpertsList');

            const html = matches.map(match => {
                const listing = match.expert_listings;
                const profile = listing?.expert_profiles;
                const contact = profile?.contact_info?.[0];

                return `
                    <div class="card mb-3 border-0 shadow-sm">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-2 text-center">
                                    <img src="${profile?.avatar_url || '/img/default-avatar.png'}" 
                                         class="rounded-circle mb-2" 
                                         style="width: 80px; height: 80px; object-fit: cover;">
                                    <div class="badge bg-success">${match.match_score}% åŒ¹é…</div>
                                </div>
                                <div class="col-md-6">
                                    <h5 class="mb-1">${profile?.company_name || profile?.full_name || 'æœªå‘½åå°ˆå®¶'}</h5>
                                    <p class="text-muted mb-2">${listing?.title || 'æœªå‘½åæœå‹™'}</p>
                                    <div class="mb-2">
                                        <span class="badge bg-primary me-1">${listing?.category}</span>
                                        ${listing?.subcategory ? `<span class="badge bg-info">${listing?.subcategory}</span>` : ''}
                                    </div>
                                    <p class="text-muted mb-0">
                                        <i class="fas fa-dollar-sign me-1"></i>
                                        ${listing?.price_min ? `${listing.price_min.toLocaleString()} - ${listing.price_max?.toLocaleString() || 'é¢è­°'}` : 'åƒ¹æ ¼é¢è­°'}
                                    </p>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-grid gap-2">
                                        ${contact ? `
                                            ${contact.phone ? `
                                                <a href="tel:${contact.phone}" class="btn btn-sm btn-success">
                                                    <i class="fas fa-phone me-1"></i>${contact.phone}
                                                </a>
                                            ` : ''}
                                            ${contact.email ? `
                                                <a href="mailto:${contact.email}" class="btn btn-sm btn-primary">
                                                    <i class="fas fa-envelope me-1"></i>${contact.email}
                                                </a>
                                            ` : ''}
                                            ${contact.line_id ? `
                                                <button class="btn btn-sm btn-outline-success" onclick="copyToClipboard('${contact.line_id}', 'LINE ID')">
                                                    <i class="fab fa-line me-1"></i>${contact.line_id}
                                                </button>
                                            ` : ''}
                                        ` : '<p class="text-muted small mb-0">å°šæœªæä¾›è¯çµ¡è³‡è¨Š</p>'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // è¤‡è£½åˆ°å‰ªè²¼ç°¿
        function copyToClipboard(text, label) {
            navigator.clipboard.writeText(text).then(() => {
                alert(`âœ… ${label} å·²è¤‡è£½ï¼š${text}`);
            }).catch(err => {
                console.error('è¤‡è£½å¤±æ•—:', err);
                alert(`âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ï¼š${text}`);
            });
        }

        // è¼‰å…¥åˆ†åŒ…é …ç›®
        async function loadProjectItems() {
            try {
                const { data: items, error } = await AuthService.supabase
                    .from('project_items')
                    .select('*')
                    .eq('project_id', projectId)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allProjectItems = items || [];
                renderItemsTable(items || []);

            } catch (error) {
                console.error('âŒ è¼‰å…¥åˆ†åŒ…é …ç›®å¤±æ•—:', error);
            }
        }

        // æ¸²æŸ“é …ç›®è¡¨æ ¼
        function renderItemsTable(items) {
            const tbody = document.getElementById('itemsTableBody');
            
            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">å°šæœªå»ºç«‹é …ç›®</td></tr>';
                return;
            }

            const html = items.map(item => `
                <tr data-item-id="${item.id}">
                    <td><input type="checkbox" class="item-checkbox" value="${item.id}" onchange="updateSelection()"></td>
                    <td><input type="text" name="item_name" class="form-control" value="${item.item_name || ''}" onchange="updateItem('${item.id}', 'item_name', this.value)"></td>
                    <td><input type="text" name="spec" class="form-control" value="${item.spec || ''}" onchange="updateItem('${item.id}', 'spec', this.value)"></td>
                    <td><input type="number" name="quantity" class="form-control" value="${item.quantity || ''}" onchange="updateItem('${item.id}', 'quantity', this.value)"></td>
                    <td><input type="text" name="unit" class="form-control" value="${item.unit || ''}" onchange="updateItem('${item.id}', 'unit', this.value)"></td>
                    <td><button type="button" class="btn btn-sm btn-danger" onclick="deleteItem('${item.id}')">åˆªé™¤</button></td>
                </tr>
            `).join('');

            tbody.innerHTML = html;
        }

        // æ›´æ–°é …ç›®æ¬„ä½
        async function updateItem(itemId, field, value) {
            try {
                const updates = {};
                if (field === 'quantity') {
                    updates[field] = parseFloat(value) || null;
                } else {
                    updates[field] = value;
                }

                const { error } = await AuthService.supabase
                    .from('project_items')
                    .update(updates)
                    .eq('id', itemId);

                if (error) throw error;

                // æ›´æ–°å…¨åŸŸè³‡æ–™
                const item = allProjectItems.find(i => i.id === itemId);
                if (item) item[field] = updates[field];

            } catch (error) {
                console.error('âŒ æ›´æ–°å¤±æ•—:', error);
                alert('âŒ æ›´æ–°å¤±æ•—ï¼š' + error.message);
            }
        }

        // åˆªé™¤é …ç›®
        async function deleteItem(itemId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®å—ï¼Ÿ')) return;

            try {
                const { error } = await AuthService.supabase
                    .from('project_items')
                    .delete()
                    .eq('id', itemId);

                if (error) throw error;

                await loadProjectItems();
            } catch (error) {
                console.error('âŒ åˆªé™¤å¤±æ•—:', error);
                alert('âŒ åˆªé™¤å¤±æ•—ï¼š' + error.message);
            }
        }

        // æ–°å¢é …ç›®
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('addRow')?.addEventListener('click', async () => {
                const tbody = document.getElementById('itemsTableBody');
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td><input type="text" name="item_name" class="form-control" placeholder="è«‹è¼¸å…¥é …ç›®åç¨±"></td>
                    <td><input type="text" name="spec" class="form-control" placeholder="è«‹è¼¸å…¥è¦æ ¼"></td>
                    <td><input type="number" name="quantity" class="form-control" placeholder="æ•¸é‡"></td>
                    <td><input type="text" name="unit" class="form-control" placeholder="å–®ä½"></td>
                    <td><button type="button" class="btn btn-sm btn-primary" onclick="saveNewItem(this)">å„²å­˜</button></td>
                `;
                tbody.appendChild(newRow);
            });
        });

        // å„²å­˜æ–°é …ç›®
        async function saveNewItem(btn) {
            const row = btn.closest('tr');
            const item_name = row.querySelector('[name="item_name"]').value.trim();
            const spec = row.querySelector('[name="spec"]').value.trim();
            const quantity = parseFloat(row.querySelector('[name="quantity"]').value) || null;
            const unit = row.querySelector('[name="unit"]').value.trim();

            if (!item_name) {
                alert('è«‹è¼¸å…¥é …ç›®åç¨±');
                return;
            }

            try {
                const { data, error } = await AuthService.supabase
                    .from('project_items')
                    .insert([{
                        project_id: projectId,
                        item_name,
                        spec,
                        quantity,
                        unit,
                        status: 'pending'
                    }])
                    .select()
                    .single();

                if (error) throw error;

                await loadProjectItems();
            } catch (error) {
                console.error('âŒ æ–°å¢å¤±æ•—:', error);
                alert('âŒ æ–°å¢å¤±æ•—ï¼š' + error.message);
            }
        }

        // è¼‰å…¥åª’åˆå°ˆå®¶
        async function loadMatchedExperts() {
            try {
                const { data: matches, error } = await AuthService.supabase
                    .from('matches')
                    .select(`
                        *,
                        expert:expert_id (
                            id,
                            email,
                            user_metadata
                        ),
                        listing:listing_id (
                            id,
                            title,
                            description
                        )
                    `)
                    .eq('project_id', projectId)
                    .eq('status', 'active')
                    .order('score', { ascending: false });

                if (error) throw error;

                if (!matches || matches.length === 0) {
                    return; // ä¿æŒé è¨­è¨Šæ¯
                }

                // æ¸²æŸ“å°ˆå®¶åˆ—è¡¨
                renderMatchedExperts(matches);

            } catch (error) {
                console.error('âŒ è¼‰å…¥åª’åˆå°ˆå®¶å¤±æ•—:', error);
            }
        }

        // æ¸²æŸ“åª’åˆå°ˆå®¶
        function renderMatchedExperts(matches) {
            const container = document.getElementById('matchedExpertsList');

            const html = matches.map(match => {
                const expert = match.expert;
                const listing = match.listing;
                const score = Math.round(match.score || 0);

                return `
                    <div class="card mb-3 border-primary">
                        <div class="card-body p-4">
                            <div class="row">
                                <div class="col-md-8">
                                    <h5 class="mb-2">
                                        <i class="fas fa-user-circle me-2 text-primary"></i>
                                        ${expert?.user_metadata?.full_name || expert?.email || 'æœªçŸ¥å°ˆå®¶'}
                                    </h5>
                                    <p class="text-muted mb-2">${listing?.title || 'æœªå‘½åæœå‹™'}</p>
                                    <p class="mb-3">${listing?.description || ''}</p>
                                    
                                    <!-- åª’åˆåˆ†æ•¸ -->
                                    <div class="mb-3">
                                        <span class="me-3">
                                            <i class="fas fa-star text-warning me-1"></i>
                                            åª’åˆåˆ†æ•¸ï¼š<strong>${score} åˆ†</strong>
                                        </span>
                                    </div>

                                    <!-- è¯çµ¡æ–¹å¼ï¼ˆåª’åˆæˆåŠŸç›´æ¥é¡¯ç¤ºï¼‰ -->
                                    <div class="alert alert-info mb-0">
                                        <h6 class="mb-2">
                                            <i class="fas fa-phone me-2"></i>è¯çµ¡æ–¹å¼
                                        </h6>
                                        <p class="mb-1" id="contact-${match.id}">
                                            <span class="spinner-border spinner-border-sm me-2"></span>
                                            è¼‰å…¥è¯çµ¡è³‡è¨Šä¸­...
                                        </p>
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="progress mb-2" style="height: 25px;">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: ${score}%">
                                            ${score}%
                                        </div>
                                    </div>
                                    <button class="btn btn-primary w-100" onclick="contactExpert('${expert.id}')">
                                        <i class="fas fa-envelope me-2"></i>ç«‹å³è¯ç¹«
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;

            // è¼‰å…¥æ¯å€‹å°ˆå®¶çš„è¯çµ¡æ–¹å¼
            matches.forEach(match => {
                if (match.expert?.id) {
                    loadContactInfo(match.expert.id, match.id);
                }
            });
        }

        // è¼‰å…¥è¯çµ¡è³‡è¨Šï¼ˆåª’åˆæˆåŠŸç›´æ¥é¡¯ç¤ºï¼Œç„¡éœ€è§£é–ï¼‰
        async function loadContactInfo(expertId, matchId) {
            try {
                const { data, error } = await AuthService.supabase
                    .from('contact_info')
                    .select('*')
                    .eq('user_id', expertId)
                    .single();

                if (error) throw error;

                const container = document.getElementById(`contact-${matchId}`);
                
                if (!data) {
                    container.innerHTML = '<small class="text-muted">è©²å°ˆå®¶å°šæœªå¡«å¯«è¯çµ¡è³‡è¨Š</small>';
                    return;
                }

                // çµ„åˆè¯çµ¡è³‡è¨Š
                const contacts = [];
                if (data.phone) contacts.push(`<i class="fas fa-phone me-1"></i>${data.phone}`);
                if (data.mobile) contacts.push(`<i class="fas fa-mobile me-1"></i>${data.mobile}`);
                if (data.line_id) contacts.push(`<i class="fab fa-line me-1"></i>${data.line_id}`);
                if (data.email) contacts.push(`<i class="fas fa-envelope me-1"></i>${data.email}`);

                if (contacts.length === 0) {
                    container.innerHTML = '<small class="text-muted">è©²å°ˆå®¶å°šæœªå¡«å¯«è¯çµ¡è³‡è¨Š</small>';
                } else {
                    container.innerHTML = contacts.map(c => `<div class="mb-1">${c}</div>`).join('');
                }

            } catch (error) {
                console.error('âŒ è¼‰å…¥è¯çµ¡è³‡è¨Šå¤±æ•—:', error);
                const container = document.getElementById(`contact-${matchId}`);
                container.innerHTML = '<small class="text-danger">è¼‰å…¥å¤±æ•—</small>';
            }
        }

        // å·¥å…·å‡½æ•¸
        function getStatusColor(status) {
            const colors = {
                'draft': 'secondary',
                'published': 'primary',
                'matched': 'success',
                'assigned': 'info',
                'in_progress': 'warning',
                'completed': 'success',
                'cancelled': 'danger'
            };
            return colors[status] || 'secondary';
        }

        function getStatusText(status) {
            const texts = {
                'draft': 'è‰ç¨¿',
                'published': 'å·²ç™¼åŒ…',
                'matched': 'å·²åª’åˆ',
                'assigned': 'å·²æŒ‡æ´¾',
                'in_progress': 'é€²è¡Œä¸­',
                'completed': 'å·²å®Œæˆ',
                'cancelled': 'å·²å–æ¶ˆ'
            };
            return texts[status] || 'æœªçŸ¥';
        }

        function showError(message) {
            document.getElementById('loadingSection').classList.add('d-none');
            document.getElementById('errorSection').classList.remove('d-none');
            document.getElementById('errorMessage').textContent = message;
        }

        // æ“ä½œå‡½æ•¸ï¼ˆæš«æ™‚è·³è½‰æˆ–æç¤ºï¼‰
        function editProject() {
            alert('ç·¨è¼¯å°ˆæ¡ˆåŠŸèƒ½é–‹ç™¼ä¸­');
        }

        function manageItems() {
            window.location.href = `project-items.html?id=${projectId}`;
        }

        function deleteProject() {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å°ˆæ¡ˆå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                alert('åˆªé™¤åŠŸèƒ½é–‹ç™¼ä¸­');
            }
        }

        function addNewItem() {
            window.location.href = `project-items.html?id=${projectId}&action=new`;
        }

        // é¸æ“‡ç®¡ç†
        function updateSelection() {
            const checkboxes = document.querySelectorAll('.item-checkbox:checked');
            const count = checkboxes.length;
            const toolbar = document.getElementById('batchActionsBar');
            const countBadge = document.getElementById('selectedCount');
            
            if (count > 0) {
                toolbar.style.display = 'block';
                countBadge.textContent = `å·²é¸ ${count} é …`;
            } else {
                toolbar.style.display = 'none';
            }
        }

        function toggleSelectAll(checkbox) {
            const itemCheckboxes = document.querySelectorAll('.item-checkbox');
            itemCheckboxes.forEach(cb => cb.checked = checkbox.checked);
            updateSelection();
        }

        function clearSelection() {
            document.querySelectorAll('.item-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('selectAll').checked = false;
            updateSelection();
        }

        // çµ„æˆçµ±åŒ…
        async function createPackageFromSelected() {
            const selected = Array.from(document.querySelectorAll('.item-checkbox:checked'))
                .map(cb => cb.value);
            
            if (selected.length < 2) {
                alert('è«‹è‡³å°‘é¸æ“‡ 2 å€‹é …ç›®æ‰èƒ½çµ„æˆçµ±åŒ…');
                return;
            }

            const packageName = prompt('è«‹è¼¸å…¥çµ±åŒ…çµ„åç¨±:', 'çµ±åŒ…çµ„åˆ ' + new Date().toLocaleDateString());
            if (!packageName) return;

            try {
                const packageGroupId = crypto.randomUUID();

                const { error } = await AuthService.supabase
                    .from('project_items')
                    .update({
                        is_bundled: true,
                        package_group_id: packageGroupId,
                        package_group: packageName
                    })
                    .in('id', selected);

                if (error) throw error;

                alert('âœ… çµ±åŒ…çµ„åˆå·²å»ºç«‹');
                clearSelection();
                await loadProjectItems();
            } catch (error) {
                console.error('âŒ å»ºç«‹çµ±åŒ…å¤±æ•—:', error);
                alert('âŒ å»ºç«‹çµ±åŒ…å¤±æ•—ï¼š' + error.message);
            }
        }

        // é€å‡ºåª’åˆ
        async function publishSelectedItems() {
            const selected = Array.from(document.querySelectorAll('.item-checkbox:checked'))
                .map(cb => cb.value);
            
            if (selected.length === 0) {
                alert('è«‹è‡³å°‘é¸æ“‡ 1 å€‹é …ç›®');
                return;
            }

            if (!confirm(`ç¢ºå®šè¦é€å‡º ${selected.length} å€‹é …ç›®é€²è¡Œåª’åˆå—ï¼Ÿ`)) return;

            try {
                const { error } = await AuthService.supabase
                    .from('project_items')
                    .update({ status: 'published' })
                    .in('id', selected);

                if (error) throw error;

                alert('âœ… å·²é€å‡ºåª’åˆ');
                clearSelection();
                await loadProjectItems();
            } catch (error) {
                console.error('âŒ é€å‡ºå¤±æ•—:', error);
                alert('âŒ é€å‡ºå¤±æ•—ï¼š' + error.message);
            }
        }

        async function editItem(itemId) {
            const item = allProjectItems.find(i => i.id === itemId);
            if (!item) {
                alert('æ‰¾ä¸åˆ°é …ç›®è³‡æ–™');
                return;
            }

            // è®€å–è³‡æ–™åº«çš„ç¾æœ‰å€¼ï¼Œè®“ç”¨æˆ¶ä¿®æ”¹ AI åˆ†æçµæœ
            const newName = prompt('ä¿®æ”¹é …ç›®åç¨±:', item.item_name || '');
            if (newName === null) return; // ç”¨æˆ¶å–æ¶ˆ
            
            const newQuantity = prompt('ä¿®æ”¹æ•¸é‡:', item.quantity || '');
            if (newQuantity === null) return;
            
            const newUnit = prompt('ä¿®æ”¹å–®ä½:', item.unit || '');
            if (newUnit === null) return;

            try {
                const updates = {};
                if (newName && newName !== item.item_name) updates.item_name = newName;
                if (newQuantity !== '' && newQuantity !== item.quantity) updates.quantity = parseFloat(newQuantity) || null;
                if (newUnit && newUnit !== item.unit) updates.unit = newUnit;

                if (Object.keys(updates).length === 0) {
                    return; // æ²’æœ‰è®Šæ›´
                }

                const { error } = await AuthService.supabase
                    .from('project_items')
                    .update(updates)
                    .eq('id', itemId);

                if (error) throw error;

                alert('âœ… é …ç›®å·²æ›´æ–°');
                await loadProjectItems();
            } catch (error) {
                console.error('âŒ æ›´æ–°å¤±æ•—:', error);
                alert('âŒ æ›´æ–°å¤±æ•—ï¼š' + error.message);
            }
        }

        async function ungroupPackage(groupId) {
            if (!confirm('ç¢ºå®šè¦è§£æ•£æ­¤çµ±åŒ…çµ„åˆå—ï¼Ÿé …ç›®å°‡è®Šç‚ºå–®ç¨åˆ†åŒ…ã€‚')) return;

            try {
                const { error } = await AuthService.supabase
                    .from('project_items')
                    .update({ 
                        is_bundled: false, 
                        package_group_id: null,
                        package_group: null 
                    })
                    .eq('package_group_id', groupId);

                if (error) throw error;

                alert('âœ… çµ±åŒ…çµ„åˆå·²è§£æ•£');
                await loadProjectItems();
            } catch (error) {
                console.error('âŒ è§£æ•£å¤±æ•—:', error);
                alert('âŒ è§£æ•£å¤±æ•—ï¼š' + error.message);
            }
        }

        // å»ºç«‹çµ±åŒ…çµ„åˆï¼ˆä¾›æœªä¾†ä½¿ç”¨ï¼‰
        async function createPackageGroup(itemIds, groupName) {
            try {
                const groupId = `pkg_${Date.now()}`;
                
                const { error } = await AuthService.supabase
                    .from('project_items')
                    .update({ 
                        is_bundled: true, 
                        package_group_id: groupId,
                        package_group: groupName 
                    })
                    .in('id', itemIds);

                if (error) throw error;

                alert(`âœ… çµ±åŒ…çµ„åˆã€Œ${groupName}ã€å·²å»ºç«‹`);
                await loadProjectItems();
            } catch (error) {
                console.error('âŒ å»ºç«‹çµ±åŒ…å¤±æ•—:', error);
                alert('âŒ å»ºç«‹çµ±åŒ…å¤±æ•—ï¼š' + error.message);
            }
        }

        // ==================== é …ç›®é¸æ“‡èˆ‡æ‰¹é‡æ“ä½œ ====================
        
        // æ›´æ–°é¸æ“‡ç‹€æ…‹
        function updateSelection() {
            const checkboxes = document.querySelectorAll('.item-checkbox:checked');
            const count = checkboxes.length;
            
            // æ›´æ–°é¸æ“‡æ•¸é‡é¡¯ç¤º
            document.getElementById('selectedCount').textContent = `å·²é¸ ${count} é …`;
            
            // é¡¯ç¤º/éš±è—æ‰¹é‡æ“ä½œåˆ—
            const actionsBar = document.getElementById('batchActionsBar');
            if (count > 0) {
                actionsBar.style.display = 'block';
            } else {
                actionsBar.style.display = 'none';
            }
        }

        // å…¨é¸/å–æ¶ˆå…¨é¸
        function toggleSelectAll(checkbox) {
            const itemCheckboxes = document.querySelectorAll('.item-checkbox');
            itemCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
            updateSelection();
        }

        // æ¸…é™¤é¸æ“‡
        function clearSelection() {
            const checkboxes = document.querySelectorAll('.item-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            document.getElementById('selectAllItems').checked = false;
            updateSelection();
        }

        // å¾é¸ä¸­é …ç›®å»ºç«‹çµ±åŒ…çµ„
        async function createPackageFromSelected() {
            const checkboxes = document.querySelectorAll('.item-checkbox:checked');
            const selectedIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedIds.length < 2) {
                alert('âš ï¸ è«‹è‡³å°‘é¸æ“‡ 2 å€‹é …ç›®æ‰èƒ½çµ„æˆçµ±åŒ…');
                return;
            }

            const groupName = prompt('è«‹è¼¸å…¥çµ±åŒ…çµ„åç¨±:', `çµ±åŒ…çµ„ ${Date.now().toString().slice(-4)}`);
            if (!groupName) return;

            await createPackageGroup(selectedIds, groupName);
            clearSelection();
        }

        // é€å‡ºé¸ä¸­é …ç›®é€²è¡Œåª’åˆ
        async function publishSelectedItems() {
            const checkboxes = document.querySelectorAll('.item-checkbox:checked');
            const selectedIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedIds.length === 0) {
                alert('âš ï¸ è«‹è‡³å°‘é¸æ“‡ 1 å€‹é …ç›®');
                return;
            }

            if (!confirm(`ç¢ºå®šè¦å°‡é¸ä¸­çš„ ${selectedIds.length} å€‹é …ç›®é€å‡ºåª’åˆå—ï¼Ÿ`)) {
                return;
            }

            try {
                // TODO: å‘¼å«åª’åˆ API
                // const response = await fetch('/api/match/run-split', {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify({
                //         project_id: projectId,
                //         item_ids: selectedIds
                //     })
                // });

                // æš«æ™‚æ¨¡æ“¬æˆåŠŸ
                alert(`âœ… å·²é€å‡º ${selectedIds.length} å€‹é …ç›®é€²è¡Œåª’åˆ\n\nåª’åˆå¼•æ“å°‡æœƒï¼š\n1. åˆ†ææ¯å€‹é …ç›®éœ€æ±‚\n2. æœå°‹ç¬¦åˆçš„å°ˆå®¶\n3. è¨ˆç®—åª’åˆåˆ†æ•¸\n4. é€šçŸ¥å°ˆå®¶èˆ‡æ‚¨\n\né è¨ˆ 2-5 åˆ†é˜å®Œæˆåª’åˆ`);
                
                // æ›´æ–°é …ç›®ç‹€æ…‹ç‚ºã€Œå·²ç™¼åŒ…ã€
                const { error } = await AuthService.supabase
                    .from('project_items')
                    .update({ status: 'published' })
                    .in('id', selectedIds);

                if (error) throw error;

                clearSelection();
                await loadProjectItems();

            } catch (error) {
                console.error('âŒ é€å‡ºåª’åˆå¤±æ•—:', error);
                alert('âŒ é€å‡ºåª’åˆå¤±æ•—ï¼š' + error.message);
            }
        }

        function contactExpert(expertId) {
            alert(`è¯ç¹«å°ˆå®¶ ${expertId} åŠŸèƒ½é–‹ç™¼ä¸­ï¼ˆå¯é–‹å•Ÿå°è©±è¦–çª—æˆ–è·³è½‰åˆ°è¨Šæ¯é é¢ï¼‰`);
        }
        
        // ==================== å°é¢åœ–ç‰‡ç®¡ç†åŠŸèƒ½ ====================
        
        /**
         * ä¸Šå‚³å°é¢åœ–ç‰‡
         */
        async function uploadCoverImage() {
            // å»ºç«‹æª”æ¡ˆé¸æ“‡å™¨
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                // æª¢æŸ¥æª”æ¡ˆå¤§å°ï¼ˆé™åˆ¶ 5MBï¼‰
                if (file.size > 5 * 1024 * 1024) {
                    alert('æª”æ¡ˆå¤§å°ä¸å¯è¶…é 5MB');
                    return;
                }
                
                try {
                    // é¡¯ç¤ºè¼‰å…¥ä¸­
                    const img = document.getElementById('projectCoverImage');
                    const originalSrc = img.src;
                    img.style.opacity = '0.5';
                    
                    // ä¸Šå‚³åˆ° Supabase Storage
                    // æ¸…ç†æª”åï¼šç§»é™¤ä¸­æ–‡å’Œç‰¹æ®Šå­—å…ƒï¼Œé¿å… Storage éŒ¯èª¤
                    const timestamp = Date.now();
                    const ext = file.name.split('.').pop();
                    const cleanName = file.name
                        .replace(/\.[^.]+$/, '')  // ç§»é™¤å‰¯æª”å
                        .replace(/[^a-zA-Z0-9]/g, '-')  // éè‹±æ•¸å­—è½‰ -
                        .replace(/-+/g, '-')  // åˆä½µé€£çºŒ -
                        .replace(/^-|-$/g, '')  // ç§»é™¤é ­å°¾ -
                        .substring(0, 50);  // é™åˆ¶é•·åº¦
                    const fileName = `project-covers/${projectId}/${timestamp}-${cleanName || 'cover'}.${ext}`;
                    const { data, error } = await AuthService.supabase.storage
                        .from('project-images')
                        .upload(fileName, file, {
                            cacheControl: '3600',
                            upsert: false
                        });
                    
                    if (error) throw error;
                    
                    // å–å¾—å…¬é–‹ URL
                    const { data: { publicUrl } } = AuthService.supabase.storage
                        .from('project-images')
                        .getPublicUrl(fileName);
                    
                    // æ›´æ–°è³‡æ–™åº«
                    const { error: updateError } = await AuthService.supabase
                        .from('projects')
                        .update({
                            cover_image_type: 'uploaded',
                            cover_image_url: publicUrl,
                            cover_image_category: null
                        })
                        .eq('id', projectId);
                    
                    if (updateError) throw updateError;
                    
                    // æ›´æ–°é¡¯ç¤º
                    img.src = publicUrl;
                    img.style.opacity = '1';
                    projectData.cover_image_type = 'uploaded';
                    projectData.cover_image_url = publicUrl;
                    
                    alert('âœ… å°é¢åœ–ç‰‡å·²æ›´æ–°');
                    
                } catch (error) {
                    console.error('ä¸Šå‚³å¤±æ•—:', error);
                    alert('âŒ ä¸Šå‚³å¤±æ•—ï¼š' + error.message);
                    img.style.opacity = '1';
                }
            };
            
            input.click();
        }
        
        /**
         * AI ç”Ÿæˆå°é¢åœ–ç‰‡
         */
        async function generateAICoverImage() {
            try {
                // è¼‰å…¥ç”¨æˆ¶é»æ•¸
                await loadUserCredits();
                
                // å¡«å…… Modal å…§å®¹
                document.getElementById('aiModalTitle').textContent = projectData.title || 'æœªå‘½åå°ˆæ¡ˆ';
                document.getElementById('aiModalCategory').textContent = projectData.category || 'æœªåˆ†é¡';
                document.getElementById('aiModalDescription').textContent = projectData.description || 'ç„¡æè¿°';
                
                // è¼‰å…¥å°ˆæ¡ˆåœ–ç‰‡
                await loadProjectImages();
                
                // æ›´æ–° AI æç¤ºè©é è¦½
                updateAIPromptPreview();
                
                // é¡¯ç¤º Modal
                aiGenerateModal.show();
                
            } catch (error) {
                console.error('é–‹å•Ÿ AI ç”Ÿæˆå¤±æ•—:', error);
                alert('âŒ ' + error.message);
            }
        }
        
        /**
         * è¼‰å…¥ç”¨æˆ¶é»æ•¸é¤˜é¡
         */
        async function loadUserCredits() {
            try {
                const { data, error } = await AuthService.supabase
                    .from('user_credits')
                    .select('balance')
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (error && error.code !== 'PGRST116') throw error;
                
                const balance = data?.balance || 0;
                document.getElementById('currentCredits').textContent = balance;
                
                // æª¢æŸ¥é»æ•¸æ˜¯å¦è¶³å¤ 
                if (balance < 20) {
                    document.getElementById('confirmAIBtn').disabled = true;
                    document.getElementById('currentCredits').parentElement.classList.add('text-danger');
                    document.getElementById('currentCredits').parentElement.innerHTML = 
                        '<i class="fas fa-exclamation-triangle me-2"></i>é»æ•¸ä¸è¶³ï¼ˆéœ€è¦ 20 é»ï¼‰';
                }
            } catch (error) {
                console.error('è¼‰å…¥é»æ•¸å¤±æ•—:', error);
                document.getElementById('currentCredits').textContent = 'è¼‰å…¥å¤±æ•—';
            }
        }
        
        /**
         * è¼‰å…¥å°ˆæ¡ˆåœ–ç‰‡
         */
        async function loadProjectImages() {
            try {
                // å¾ project_items æˆ– projects è¡¨è¼‰å…¥åœ–ç‰‡
                const { data: items, error } = await AuthService.supabase
                    .from('project_items')
                    .select('images')
                    .eq('project_id', projectId);
                
                if (error) throw error;
                
                // æ”¶é›†æ‰€æœ‰åœ–ç‰‡
                let allImages = [];
                if (items && items.length > 0) {
                    items.forEach(item => {
                        if (item.images && Array.isArray(item.images)) {
                            allImages = allImages.concat(item.images);
                        }
                    });
                }
                
                // æ›´æ–°åœ–ç‰‡è¨ˆæ•¸
                document.getElementById('imageCount').textContent = allImages.length;
                
                // é¡¯ç¤ºåœ–ç‰‡ç¸®åœ–
                const imagesContainer = document.getElementById('aiModalImages');
                if (allImages.length === 0) {
                    imagesContainer.innerHTML = '<p class="text-muted text-center">æ­¤å°ˆæ¡ˆæš«ç„¡ä¸Šå‚³åœ–ç‰‡</p>';
                    document.getElementById('aiModalImagesCard').classList.add('d-none');
                } else {
                    document.getElementById('aiModalImagesCard').classList.remove('d-none');
                    imagesContainer.innerHTML = allImages.slice(0, 6).map(img => `
                        <div class="col-4 col-md-2">
                            <img src="${img}" class="img-fluid rounded" 
                                 style="width: 100%; height: 80px; object-fit: cover;" 
                                 alt="å°ˆæ¡ˆåœ–ç‰‡">
                        </div>
                    `).join('');
                    
                    if (allImages.length > 6) {
                        imagesContainer.innerHTML += `
                            <div class="col-4 col-md-2">
                                <div class="bg-light rounded d-flex align-items-center justify-content-center" 
                                     style="height: 80px;">
                                    <span class="text-muted">+${allImages.length - 6} å¼µ</span>
                                </div>
                            </div>
                        `;
                    }
                }
                
            } catch (error) {
                console.error('è¼‰å…¥åœ–ç‰‡å¤±æ•—:', error);
                document.getElementById('aiModalImages').innerHTML = 
                    '<p class="text-danger">è¼‰å…¥åœ–ç‰‡å¤±æ•—</p>';
            }
        }
        
        /**
         * æ›´æ–° AI æç¤ºè©é è¦½
         */
        function updateAIPromptPreview() {
            const avoidConfidential = document.getElementById('avoidConfidential').checked;
            const warningDiv = document.getElementById('confidentialWarning');
            
            // é¡¯ç¤º/éš±è—è­¦å‘Š
            if (avoidConfidential) {
                warningDiv.classList.add('d-none');
            } else {
                warningDiv.classList.remove('d-none');
            }
            
            let prompt = '';
            
            if (avoidConfidential) {
                // é¿é–‹æ©Ÿå¯†å…§å®¹ï¼šåªä½¿ç”¨åˆ†é¡å’ŒåŸºæœ¬é¢¨æ ¼
                prompt = `ç”Ÿæˆä¸€å¼µå°ˆæ¥­çš„${projectData.category || 'å°ˆæ¡ˆ'}å°é¢åœ–ç‰‡ã€‚

åƒè€ƒè³‡è¨Šï¼š
- åˆ†é¡ï¼š${projectData.category || 'æœªåˆ†é¡'}
- é¢¨æ ¼ï¼šç¾ä»£ã€å°ˆæ¥­ã€ç°¡æ½”
- è‰²èª¿ï¼šç¬¦åˆ${projectData.category || 'è©²é ˜åŸŸ'}çš„å°ˆæ¥­å½¢è±¡

âš ï¸ å·²å•Ÿç”¨æ©Ÿå¯†ä¿è­·ï¼šä¸æœƒä½¿ç”¨æ‚¨çš„å°ˆæ¡ˆæè¿°å’Œåœ–ç‰‡å…§å®¹`;
            } else {
                // ä½¿ç”¨å®Œæ•´å…§å®¹
                prompt = `æ ¹æ“šä»¥ä¸‹å°ˆæ¡ˆè³‡è¨Šç”Ÿæˆå°é¢åœ–ç‰‡ï¼š

å°ˆæ¡ˆåç¨±ï¼š${projectData.title || 'æœªå‘½å'}
åˆ†é¡ï¼š${projectData.category || 'æœªåˆ†é¡'}
æè¿°ï¼š${(projectData.description || 'ç„¡æè¿°').substring(0, 200)}${projectData.description?.length > 200 ? '...' : ''}

âš ï¸ å°‡åƒè€ƒæ‚¨çš„å®Œæ•´å°ˆæ¡ˆæè¿°å’Œåœ–ç‰‡å…§å®¹ç”Ÿæˆ`;
            }
            
            document.getElementById('aiPromptPreview').value = prompt;
        }
        
        /**
         * ç¢ºèª AI ç”Ÿæˆ
         */
        async function confirmAIGeneration() {
            const avoidConfidential = document.getElementById('avoidConfidential').checked;
            
            if (!avoidConfidential) {
                if (!confirm('ç¢ºå®šè¦ä½¿ç”¨å®Œæ•´å°ˆæ¡ˆå…§å®¹ç”Ÿæˆå°é¢åœ–å—ï¼ŸAI å°‡æœƒåˆ†ææ‚¨çš„å°ˆæ¡ˆæè¿°å’Œåœ–ç‰‡ã€‚')) {
                    return;
                }
            }
            
            try {
                const btn = document.getElementById('confirmAIBtn');
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ç”Ÿæˆä¸­...';
                
                const img = document.getElementById('projectCoverImage');
                img.style.opacity = '0.5';
                
                // å‘¼å« AI ç”Ÿæˆ API
                const response = await fetch('/api/ai/generate-project-cover', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        projectId: projectId,
                        title: projectData.title,
                        description: avoidConfidential ? null : projectData.description,
                        category: projectData.category,
                        avoidConfidential: avoidConfidential,
                        useImages: !avoidConfidential
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'ç”Ÿæˆå¤±æ•—');
                }
                
                const result = await response.json();
                
                // æ›´æ–°é¡¯ç¤º
                img.src = result.imageUrl;
                img.style.opacity = '1';
                projectData.cover_image_type = 'ai_generated';
                projectData.cover_image_url = result.imageUrl;
                
                // é—œé–‰ Modal
                aiGenerateModal.hide();
                
                alert(`âœ… AI å°é¢åœ–ç‰‡å·²ç”Ÿæˆï¼\næ¶ˆè€—é»æ•¸ï¼š${result.pointsUsed} é»\nå‰©é¤˜é»æ•¸ï¼š${result.remainingCredits} é»`);
                
                // æ›´æ–°é»æ•¸é¡¯ç¤º
                document.getElementById('currentCredits').textContent = result.remainingCredits;
                
            } catch (error) {
                console.error('AI ç”Ÿæˆå¤±æ•—:', error);
                alert('âŒ ' + error.message);
            } finally {
                const btn = document.getElementById('confirmAIBtn');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic me-2"></i>ç¢ºèªç”Ÿæˆï¼ˆ20 é»ï¼‰';
                img.style.opacity = '1';
            }
        }
        
        /**
         * ä½¿ç”¨é è¨­åœ–ç‰‡
         */
        async function useDefaultImage() {
            try {
                const img = document.getElementById('projectCoverImage');
                img.style.opacity = '0.5';
                
                // æ›´æ–°è³‡æ–™åº«
                const { error } = await AuthService.supabase
                    .from('projects')
                    .update({
                        cover_image_type: 'default',
                        cover_image_url: null,
                        cover_image_category: projectData.category
                    })
                    .eq('id', projectId);
                
                if (error) throw error;
                
                // å–å¾—é è¨­åœ–ç‰‡
                const defaultImage = getCategoryDefaultImage(projectData.category);
                
                // æ›´æ–°é¡¯ç¤º
                img.src = defaultImage;
                img.style.opacity = '1';
                projectData.cover_image_type = 'default';
                projectData.cover_image_url = null;
                projectData.cover_image_category = projectData.category;
                
                alert('âœ… å·²æ¢å¾©ç‚ºé è¨­åœ–ç‰‡');
                
            } catch (error) {
                console.error('æ›´æ–°å¤±æ•—:', error);
                alert('âŒ æ›´æ–°å¤±æ•—ï¼š' + error.message);
                img.style.opacity = '1';
            }
        }
    </script>
</body>

</html>
