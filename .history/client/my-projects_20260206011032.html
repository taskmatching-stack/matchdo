<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="utf-8">
    <title>我的專案 - MatchDO 合做</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <!-- Favicon -->
    <link href="../img/favicon.ico" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&family=Space+Grotesk&display=swap" rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="../css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="../css/style.css" rel="stylesheet">
    <!-- Tags Input Styles -->
    <style>
        .tag-chips-container {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            min-height: 38px;
            padding: 4px;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            background-color: #fff;
            align-items: center;
        }
        .tag-chip {
            background-color: #e9ecef;
            border-radius: 16px;
            padding: 2px 8px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
        }
        .tag-chip .remove-tag {
            cursor: pointer;
            margin-left: 6px;
            color: #6c757d;
            font-weight: bold;
        }
        .tag-chip .remove-tag:hover {
            color: #dc3545;
        }
        .tag-input {
            border: none;
            outline: none;
            flex-grow: 1;
            min-width: 60px;
            font-size: 0.9rem;
        }
    </style>
</head>

<body>
    <!-- 共用前台導覽 -->
    <div id="site-header"></div>

    <!-- Page Header Start -->
    <div class="container-fluid bg-primary py-2">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="text-white mb-0">我的專案</h3>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb bg-transparent mb-0">
                        <li class="breadcrumb-item"><a class="text-white" href="../index.html">首頁</a></li>
                        <li class="breadcrumb-item text-white active">我的專案</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
    <!-- Page Header End -->

    <!-- My Projects Start -->
    <div class="container-xxl py-2">
        <div class="container">
            <div class="text-center mx-auto mb-3" style="max-width: 600px;">
                <h6 class="text-primary">My Projects</h6>
                <h1 class="mb-3">查看您的所有專案</h1>
            </div>

            <!-- 專案列表 -->
            <ul class="nav nav-tabs mb-4" id="projectTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="draft-tab" data-bs-toggle="tab" data-bs-target="#drafts" type="button" role="tab">
                        <i class="fas fa-edit me-2"></i>編輯中專案
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="published-tab" data-bs-toggle="tab" data-bs-target="#published" type="button" role="tab">
                        <i class="fas fa-history me-2"></i>已發佈/歷史專案
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="projectTabsContent">
                <!-- 編輯中專案 -->
                <div class="tab-pane fade show active" id="drafts" role="tabpanel">
                    <div id="draftProjectsContainer">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">載入中...</span>
                            </div>
                            <p class="mt-3">載入專案中...</p>
                        </div>
                    </div>
                </div>

                <!-- 已發佈專案 -->
                <div class="tab-pane fade" id="published" role="tabpanel">
                    <div id="publishedProjectsContainer">
                        <!-- 載入後填入 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- My Projects End -->

    <!-- Footer Start -->
    <div class="container-fluid bg-dark text-body footer mt-3 pt-3">
        <div class="container py-3">
            <div class="row g-5">
                <div class="col-lg-12 text-center">
                    <p class="mb-0">&copy; <a class="text-primary" href="#">MatchDO 合做</a>. All Rights Reserved.</p>
                </div>
            </div>
        </div>
    </div>
    <!-- Footer End -->

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Supabase Auth -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/config/auth-config.js"></script>
    <script src="/js/auth-middleware.js"></script>
    <script src="/js/site-header.js"></script>
    
    <!-- Category Default Images -->
    <script src="/config/category-default-images.js"></script>

    <script>
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async () => {
            // 檢查登入狀態
            const isAuth = await AuthMiddleware.requireAuth();
            if (!isAuth) return;

            currentUser = await AuthService.getCurrentUser();
            loadMyProjects();
        });

        async function loadMyProjects() {
            const draftContainer = document.getElementById('draftProjectsContainer');
            const publishedContainer = document.getElementById('publishedProjectsContainer');
            
            try {
                const { data: projects, error } = await supabaseClient
                    .from('projects')
                    .select('*')
                    .eq('owner_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!projects || projects.length === 0) {
                    const emptyHTML = `
                        <div class="text-center py-5">
                            <i class="bi bi-folder-x" style="font-size: 4rem; color: #ddd;"></i>
                            <h4 class="mt-3">尚無專案</h4>
                            <p class="text-muted">前往 <a href="../index.html#ai-estimate" class="text-decoration-none">服務媒合</a> 開始您的第一個專案</p>
                        </div>
                    `;
                    draftContainer.innerHTML = emptyHTML;
                    publishedContainer.innerHTML = emptyHTML;
                    return;
                }

                // 分流專案：主要依據 status
                const drafts = [];
                const published = [];

                projects.forEach(p => {
                    let isDraft = false;
                    // 檢查 status 是否為草稿相關
                    if (['draft', 'editing', 'analyzing'].includes(p.status)) {
                        isDraft = true;
                    } 
                    // 檢查 description JSON 中的 is_draft 標記
                    else if (p.description) {
                        try {
                            const desc = JSON.parse(p.description);
                            if (desc.is_draft) isDraft = true;
                        } catch(e) {}
                    }

                    if (isDraft) {
                        drafts.push(p);
                    } else {
                        published.push(p);
                    }
                });

                renderDrafts(drafts, draftContainer);
                renderPublished(published, publishedContainer);

            } catch (error) {
                console.error('載入專案失敗:', error);
                draftContainer.innerHTML = `<div class="alert alert-danger">載入失敗：${error.message}</div>`;
            }
        }

        function renderDrafts(projects, container) {
            if (projects.length === 0) {
                container.innerHTML = '<div class="text-center py-5 text-muted">目前沒有編輯中的專案</div>';
                return;
            }

            container.innerHTML = projects.map(project => {
                let items = [];
                // 嘗試從 analysis 取得
                if (project.analysis && project.analysis.items) {
                    items = project.analysis.items;
                } else if (project.description) {
                    // 嘗試從 description 解析 JSON
                    try {
                        const descData = JSON.parse(project.description);
                        if (descData && Array.isArray(descData.items)) {
                            items = descData.items;
                        }
                    } catch (e) {
                        // 若解析失敗，表示 description 是純文字，則無 items
                        console.log('Project description is text, not JSON:', project.id);
                    }
                }
                
                return `
                <div class="card mb-4 border-primary">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-light text-primary me-2">編輯中</span>
                            <span class="h5 mb-0">${project.title || '未命名專案'}</span>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-light" onclick="saveDraft('${project.id}')">
                                <i class="fas fa-save me-1"></i>儲存變更
                            </button>
                            <button class="btn btn-sm btn-outline-light ms-2" onclick="publishProject('${project.id}')">
                                <i class="fas fa-paper-plane me-1"></i>發佈專案
                            </button>
                            <button class="btn btn-sm btn-danger ms-2" onclick="deleteProject('${project.id}')">
                                <i class="fas fa-trash-alt me-1"></i>刪除
                            </button>
                            <button class="btn btn-sm btn-link text-white ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${project.id}">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                        </div>
                    </div>
                    <div id="collapse-${project.id}" class="collapse show">
                    <div class="card-body p-0">
                        <form id="form-${project.id}">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover mb-0 align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 40px;"><input type="checkbox" class="form-check-input" onchange="toggleAll('${project.id}', this)"></th>
                                            <th style="width: 15%;">項目</th>
                                            <th style="width: 20%;">規格</th>
                                            <th style="width: 10%;">數量</th>
                                            <th style="width: 10%;">單位</th>
                                            <th style="width: 30%;">AI Tags (可用於媒合)</th>
                                            <th style="width: 5%;">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-${project.id}">
                                        ${items.map((item, idx) => renderRow(project.id, item, idx)).join('')}
                                    </tbody>
                                </table>
                            </div>
                            <div class="p-3 bg-light border-top">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addRow('${project.id}')">
                                    <i class="fas fa-plus me-1"></i>新增項目
                                </button>
                                <span class="text-muted ms-3 small"><i class="fas fa-info-circle me-1"></i>勾選項目可設定為「統包」或「分包」需求</span>
                            </div>
                        </form>
                    </div>
                </div>
                `;
            }).join('');
        }

        function renderRow(projectId, item, idx) {
            const tags = item.tags || [];
            return `
            <tr data-idx="${idx}">
                <td><input type="checkbox" name="is_package" class="form-check-input" ${item.is_package ? 'checked' : ''}></td>
                <td><input type="text" name="item_name" class="form-control form-control-sm" value="${item.item_name || ''}" placeholder="項目名稱"></td>
                <td><input type="text" name="spec" class="form-control form-control-sm" value="${item.spec || ''}" placeholder="規格描述"></td>
                <td><input type="number" name="quantity" class="form-control form-control-sm" value="${item.quantity || ''}" placeholder="0"></td>
                <td><input type="text" name="unit" class="form-control form-control-sm" value="${item.unit || ''}" placeholder="單位"></td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="tag-chips-container flex-grow-1" onclick="focusTagInput(this)">
                            ${tags.map(tag => `<span class="tag-chip">${tag}<span class="remove-tag" onclick="removeTag(this)">×</span></span>`).join('')}
                            <input type="text" class="tag-input" onkeydown="handleTagInput(event, this)" placeholder="+Tag">
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-info ms-2" onclick="generateAiTags(this)" title="AI 自動生成 Tags (扣點數)">
                            <i class="fas fa-magic"></i>
                        </button>
                    </div>
                </td>
                <td>
                    <button type="button" class="btn btn-sm text-danger" onclick="deleteRow(this)">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </td>
            </tr>
            `;
        }

        function renderPublished(projects, container) {
            if (projects.length === 0) {
                container.innerHTML = '<div class="text-center py-5 text-muted">尚無已發佈的專案</div>';
                return;
            }
            // 沿用舊的 Card 顯示邏輯
            container.innerHTML = projects.map(project => {
                const statusBadge = {
                    'matched': '<span class="badge bg-success">已媒合</span>',
                    'in_progress': '<span class="badge bg-primary">進行中</span>',
                    'completed': '<span class="badge bg-secondary">已完成</span>',
                    'cancelled': '<span class="badge bg-danger">已取消</span>'
                };
                const items = project.analysis?.items || [];
                const coverImage = getProjectCoverImage(project);

                return `
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <img src="${coverImage}" class="img-fluid rounded" alt="${project.category || '專案'}" style="width: 100%; height: 200px; object-fit: cover;">
                            </div>
                            <div class="col-md-9">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h5 class="card-title">專案 #${project.id.substring(0, 8)}</h5>
                                    ${statusBadge[project.status] || '<span class="badge bg-secondary">未知</span>'}
                                </div>
                                ${project.category ? `<p class="mb-2"><strong>分類:</strong> ${project.category}</p>` : ''}
                                ${items.length > 0 ? `
                                    <p class="mb-2"><strong>項目概覽:</strong></p>
                                    <div class="mb-3">
                                        ${items.slice(0, 5).map(item => `<span class="badge bg-light text-dark border me-1">${item.item_name}</span>`).join('')}
                                        ${items.length > 5 ? `<span class="text-muted small">+${items.length - 5}</span>` : ''}
                                    </div>
                                ` : ''}
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <div class="text-muted small">
                                        <i class="bi bi-clock me-1"></i>
                                        ${new Date(project.created_at).toLocaleString('zh-TW')}
                                    </div>
                                    <a href="/client/project-detail.html?id=${project.id}" class="btn btn-primary btn-sm">
                                        <i class="bi bi-eye me-1"></i>查看詳情
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // --- 表格操作功能 ---

        function addRow(projectId) {
            const tbody = document.getElementById(`tbody-${projectId}`);
            const newRow = renderRow(projectId, {}, Date.now());
            tbody.insertAdjacentHTML('beforeend', newRow);
        }

        function deleteRow(btn) {
            if(confirm('確定刪除此項目？')) {
                btn.closest('tr').remove();
            }
        }

        function toggleAll(projectId, checkbox) {
            const inputs = document.querySelectorAll(`#tbody-${projectId} input[name="is_package"]`);
            inputs.forEach(input => input.checked = checkbox.checked);
        }

        // --- Tags 操作功能 ---

        function focusTagInput(container) {
            const input = container.querySelector('.tag-input');
            if(input) input.focus();
        }

        function handleTagInput(event, input) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const value = input.value.trim();
                if (value) {
                    addTagChip(input.parentElement, value);
                    input.value = '';
                }
            } else if (event.key === 'Backspace' && !input.value) {
                // 刪除最後一個 tag
                const chips = input.parentElement.querySelectorAll('.tag-chip');
                if (chips.length > 0) {
                    chips[chips.length - 1].remove();
                }
            }
        }

        function addTagChip(container, text) {
            const chip = document.createElement('span');
            chip.className = 'tag-chip';
            chip.innerHTML = `${text}<span class="remove-tag" onclick="removeTag(this)">×</span>`;
            container.insertBefore(chip, container.querySelector('.tag-input'));
        }

        function removeTag(span) {
            event.stopPropagation();
            span.parentElement.remove();
        }

        async function generateAiTags(btn) {
            const tr = btn.closest('tr');
            const itemName = tr.querySelector('input[name="item_name"]').value;
            const container = tr.querySelector('.tag-chips-container');
            
            if (!itemName) {
                alert('請先輸入工項名稱');
                return;
            }

            if (!confirm('AI 生成 Tags 將扣除 5 點數，是否繼續？')) return;

            // 顯示 Loading
            const originalIcon = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            btn.disabled = true;

            try {
                // 這裡我們暫時抓取第一個專案的分類，實際應該傳入專案分類
                // 由於 UI 結構，我們可以從 card 標題或隱藏欄位抓，這裡先簡化傳空
                const res = await fetch('/api/ai-tags/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ item_name: itemName })
                });
                
                const data = await res.json();
                if (data.success && data.tags) {
                    data.tags.forEach(tag => addTagChip(container, tag));
                } else {
                    alert('生成失敗：' + (data.error || '未知錯誤'));
                }
            } catch (e) {
                console.error(e);
                alert('系統錯誤');
            } finally {
                btn.innerHTML = originalIcon;
                btn.disabled = false;
            }
        }

        // --- 儲存與發佈 ---

        async function saveDraft(projectId) {
            const items = [];
            const rows = document.querySelectorAll(`#tbody-${projectId} tr`);
            
            rows.forEach(row => {
                const tags = [];
                row.querySelectorAll('.tag-chip').forEach(chip => {
                    tags.push(chip.textContent.replace('×', '')); // 移除 x 符號
                });

                items.push({
                    is_package: row.querySelector('input[name="is_package"]').checked,
                    item_name: row.querySelector('input[name="item_name"]').value,
                    spec: row.querySelector('input[name="spec"]').value,
                    quantity: parseFloat(row.querySelector('input[name="quantity"]').value) || 0,
                    unit: row.querySelector('input[name="unit"]').value,
                    tags: tags
                });
            });

            // 改用前端直連 Supabase Client 更新，避免後端 API 權限問題
            try {
                // 1. 先取得原始資料以保留 prompt 等資訊
                const { data: currentData, error: fetchError } = await supabaseClient
                    .from('projects')
                    .select('description')
                    .eq('id', projectId)
                    .single();
                
                if (fetchError) throw fetchError;

                // 2. 解析 description 並更新 items
                let descJson = {};
                try {
                    descJson = JSON.parse(currentData.description || '{}');
                } catch(e) {}
                
                descJson.items = items;

                // 3. 寫回資料庫
                const { error: updateError } = await supabaseClient
                    .from('projects')
                    .update({ 
                        description: JSON.stringify(descJson),
                        // 這裡不更動 status，保持原狀 (draft/editing)
                    })
                    .eq('id', projectId);

                if (updateError) throw updateError;

                alert('儲存成功！');
            } catch (e) {
                console.error('儲存失敗:', e);
                alert('儲存失敗：' + (e.message || '系統錯誤'));
            }
        }

        async function publishProject(projectId) {
            if(!confirm('確定要發佈此專案嗎？發佈後將可被廠商媒合。')) return;
            
            // 先儲存
            await saveDraft(projectId);

            // 更新狀態為 open
            try {
                 const { error } = await supabaseClient
                    .from('projects')
                    .update({ status: 'open' }) // 轉為正式狀態
                    .eq('id', projectId);
                
                if (error) throw error;
                
                alert('專案已發佈！');
                loadMyProjects(); // 重整
            } catch (e) {
                alert('發佈失敗：' + e.message);
            }
        }

        async function deleteProject(projectId) {
            if(!confirm('確定要永久刪除此專案嗎？此動作無法復原。')) return;
            
            try {
                const { error } = await supabaseClient
                    .from('projects')
                    .delete()
                    .eq('id', projectId);
                
                if (error) throw error;
                
                alert('專案已刪除');
                loadMyProjects(); // 重整列表
            } catch (e) {
                console.error('刪除失敗:', e);
                alert('刪除失敗：' + e.message);
            }
        }
    </script>
</body>

</html>
