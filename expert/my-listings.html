<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="utf-8">
    <title>我的報價 - MatchDO 合做</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <!-- Favicon -->
    <link href="../img/favicon.ico" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&family=Space+Grotesk&display=swap" rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="../css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="/css/style.css" rel="stylesheet">
</head>

<body>
    <!-- 共用前台導覽 -->
    <div id="site-header"></div>

    <!-- Page Header Start -->
    <div class="container-fluid page-title-bar">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="mb-0 text-dark">我的報價</h3>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="../index.html">首頁</a></li>
                        <li class="breadcrumb-item active">我的報價</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
    <!-- Page Header End -->

    <!-- My Listings Start -->
    <div class="container-xxl py-3">
        <div class="container">
            <!-- 新增按鈕與報價健檢 -->
            <div class="mb-3 d-flex flex-wrap gap-2 align-items-center">
                <a href="listing-form.html" class="btn btn-primary py-3 px-5">
                    <i class="bi bi-plus-circle me-2"></i>新增報價
                </a>
                <button type="button" class="btn btn-outline-primary py-3 px-4" id="btnQuoteHealthCheck">
                    <i class="bi bi-graph-up me-2"></i>報價健檢
                </button>
            </div>
            <div id="quoteHealthCheckResult" class="mb-4" style="display: none;"></div>

            <!-- 報價列表 -->
            <div id="listingsContainer">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">載入中...</span>
                    </div>
                    <p class="mt-3">載入報價中...</p>
                </div>
            </div>
        </div>
    </div>
    <!-- My Listings End -->

    <!-- Footer Start -->
    <div class="container-fluid bg-dark text-body footer mt-5 pt-5">
        <div class="container py-5">
            <div class="row g-5">
                <div class="col-lg-12 text-center">
                    <p class="mb-2"><a class="text-primary" href="/contact.html">聯絡我們</a></p>
                    <p class="mb-0">&copy; <a class="text-primary" href="/index.html">MatchDO 合做</a>. All Rights Reserved.</p>
                </div>
            </div>
        </div>
    </div>
    <!-- Footer End -->

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Supabase Auth -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/config/auth-config.js"></script>
    <script src="/js/auth-middleware.js"></script>
    <script src="../js/site-header.js"></script>

    <script>
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async () => {
            // 檢查登入狀態
            const ok = await AuthMiddleware.requireExpert();
            if (!ok) return;
            currentUser = await AuthService.getCurrentUser();
            loadMyListings();
            document.getElementById('btnQuoteHealthCheck').addEventListener('click', runQuoteHealthCheck);
        });

        /** 後端 API 網址：若目前頁面不是 port 3000（例如用 Live Server 開），改打後端 */
        function getApiBase() {
            const p = window.location.port;
            if (p === '3000' || (!p && (window.location.protocol === 'https:' ? window.location.port === '443' : true))) return '';
            return window.location.protocol + '//' + window.location.hostname + ':3000';
        }
        async function getAuthHeaders() {
            const session = await AuthService.getSession();
            if (!session || !session.access_token) return {};
            return { 'Authorization': 'Bearer ' + session.access_token };
        }

        function escapeHtml(s) {
            if (s == null) return '';
            const el = document.createElement('div');
            el.textContent = s;
            return el.innerHTML;
        }

        async function runQuoteHealthCheck() {
            const btn = document.getElementById('btnQuoteHealthCheck');
            const resultEl = document.getElementById('quoteHealthCheckResult');
            resultEl.style.display = 'block';
            resultEl.innerHTML = '<p class="text-muted mb-0"><span class="spinner-border spinner-border-sm me-1"></span>健檢中…</p>';
            btn.disabled = true;
            try {
                const headers = await getAuthHeaders();
                const res = await fetch(getApiBase() + '/api/expert/quote-health-check', { headers });
                const text = await res.text();
                let data;
                try { data = text ? JSON.parse(text) : {}; } catch (_) {
                    var apiBase = getApiBase();
                    var tip = apiBase ? '您目前可能不是從後端開啟頁面。請改由 <a href="' + apiBase + '/expert/my-listings.html" class="alert-link">' + apiBase + '/expert/my-listings.html</a> 開啟，並確認已執行 <code>npm start</code>。' : '請確認已啟動後端服務（npm start）且已登入。';
                    resultEl.innerHTML = '<div class="alert alert-warning mb-0">伺服器回傳了網頁而非資料。' + tip + '</div>';
                    btn.disabled = false;
                    return;
                }
                if (!res.ok) {
                    resultEl.innerHTML = '<p class="text-danger mb-0">' + escapeHtml(data.error || data.message || '健檢失敗') + '</p>';
                    btn.disabled = false;
                    return;
                }
                const items = data.items || [];
                if (items.length === 0) {
                    resultEl.innerHTML = '<div class="alert alert-light border"><p class="mb-0">' + escapeHtml(data.message || '尚無有效報價可健檢') + '</p></div>';
                    btn.disabled = false;
                    return;
                }
                let html = '<div class="card border-0 shadow-sm"><div class="card-body"><h5 class="card-title"><i class="bi bi-graph-up me-2"></i>報價健檢結果</h5>';
                if (data.message) html += '<p class="small text-muted mb-3">' + escapeHtml(data.message) + '</p>';
                items.forEach(function (it) {
                    const bandClass = it.band === '前段' ? 'primary' : (it.band === '後段' ? 'info' : 'secondary');
                    html += '<div class="border-start border-3 border-' + bandClass + ' ps-3 py-2 mb-3">';
                    html += '<strong>' + escapeHtml(it.title) + '</strong>';
                    if (it.category) html += ' <span class="badge bg-light text-dark">' + escapeHtml(it.category) + (it.unit ? ' / ' + escapeHtml(it.unit) : '') + '</span>';
                    if (it.band) html += ' <span class="badge bg-' + bandClass + '">' + escapeHtml(it.band) + '</span>';
                    if (it.my_price != null) html += ' <span class="text-muted small">（您的單價約 ' + it.my_price.toLocaleString() + ' 元）</span>';
                    html += '<p class="mb-1 mt-1">' + (it.message || '').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') + '</p>';
                    html += '<p class="small text-muted mb-0">建議：' + (it.suggestion || '').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') + '</p>';
                    if (it.peer_count > 0) html += '<p class="small text-muted mb-0">比較基準：共 ' + it.peer_count + ' 筆同分類同單位報價</p>';
                    html += '</div>';
                });
                html += '<p class="small text-muted mb-0 mt-2"><a href="my-portfolio.html">完善作品集</a> 有助客戶了解您的服務品質。</p></div></div>';
                resultEl.innerHTML = html;
            } catch (e) {
                resultEl.innerHTML = '<p class="text-danger mb-0">' + escapeHtml(e.message || '健檢失敗') + '</p>';
            }
            btn.disabled = false;
        }

        async function loadMyListings() {
            const container = document.getElementById('listingsContainer');
            
            try {
                const { data: listings, error } = await supabaseClient
                    .from('listings')
                    .select('*')
                    .eq('expert_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!listings || listings.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <i class="bi bi-inbox" style="font-size: 4rem; color: #ddd;"></i>
                            <h4 class="mt-3">尚無報價項目</h4>
                            <p class="text-muted">點擊上方「新增報價」按鈕開始建立您的第一個報價</p>
                        </div>
                    `;
                    return;
                }

                const listingsHTML = listings.map(listing => {
                    const locationDisplay = listing.service_location && listing.service_location.length > 0
                        ? listing.service_location.join('、')
                        : '未設定';
                    const remoteTag = listing.is_remote 
                        ? '<span class="badge bg-info ms-2"><i class="bi bi-laptop"></i> 可遠端</span>' 
                        : '';
                    const imgs = Array.isArray(listing.images) ? listing.images : (listing.images ? [listing.images].flat() : []);
                    const yt = Array.isArray(listing.youtube_urls) ? listing.youtube_urls : [];
                    const embeds = Array.isArray(listing.media_embeds) ? listing.media_embeds : [];
                    const mediaLine = [imgs.length && imgs.length + ' 張圖片', yt.length && yt.length + ' 支 YouTube', embeds.length && embeds.length + ' 個嵌入'].filter(Boolean).join('、');
                    const thumb = imgs[0] ? `<img src="${String(imgs[0]).replace(/"/g, '&quot;')}" class="rounded me-2" style="width:60px;height:60px;object-fit:cover" alt="">` : '';

                    return `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row align-items-center">
                                ${thumb ? `<div class="col-md-1 text-center">${thumb}</div>` : ''}
                                <div class="col-md-${thumb ? 7 : 8}">
                                    <h5 class="card-title">${listing.title}</h5>
                                    <p class="card-text">${(listing.description || '').slice(0, 120)}${(listing.description || '').length > 120 ? '…' : ''}</p>
                                    ${mediaLine ? `<p class="small text-muted mb-1"><i class="bi bi-images me-1"></i>${mediaLine}</p>` : ''}
                                    <div class="text-muted small mb-2">
                                        <span class="badge bg-primary me-2">${listing.category}</span>
                                        <span>價格: $${listing.price_min?.toLocaleString()} - $${listing.price_max?.toLocaleString()}</span>
                                        <span class="ms-3">交期: ${listing.delivery_days || 'N/A'} 天</span>
                                    </div>
                                    <div class="text-muted small">
                                        <i class="bi bi-geo-alt"></i> 服務區域: ${locationDisplay}
                                        ${remoteTag}
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <span class="badge ${listing.status === 'active' ? 'bg-success' : 'bg-secondary'} mb-2">
                                        ${listing.status === 'active' ? '上架中' : '已下架'}
                                    </span>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary me-2" onclick="editListing('${listing.id}')">
                                            <i class="bi bi-pencil"></i> 編輯
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteListing('${listing.id}')">
                                            <i class="bi bi-trash"></i> 刪除
                                        </button>
                                    </div>
                                    <div class="mt-2 text-muted small">
                                        瀏覽: ${listing.views_count} | 詢問: ${listing.inquiries_count}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                }).join('');

                container.innerHTML = listingsHTML;

            } catch (error) {
                console.error('載入報價失敗:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        載入失敗：${error.message}
                    </div>
                `;
            }
        }

        async function editListing(listingId) {
            window.location.href = `listing-form.html?id=${listingId}`;
        }

        async function deleteListing(listingId) {
            if (!confirm('確定要刪除此報價嗎？此操作無法復原。')) return;

            try {
                const { error } = await supabaseClient
                    .from('listings')
                    .delete()
                    .eq('id', listingId);

                if (error) throw error;

                alert('刪除成功！');
                loadMyListings();
            } catch (error) {
                console.error('刪除失敗:', error);
                alert('刪除失敗：' + error.message);
            }
        }
    </script>
</body>

</html>
